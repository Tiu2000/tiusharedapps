<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TIU Trader Pro (v25 UI Fix)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --text: #f1f5f9; --text-dim: #94a3b8;
            --green: #10b981; --red: #ef4444; --blue: #3b82f6; --purple: #c084fc;
            --orange: #f59e0b; --border: #334155; --yellow: #facc15; --cyan: #06b6d4;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; padding: 15px; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        .watermark {
            position: fixed; bottom: 10px; right: 15px; font-size: 3rem; opacity: 0.05;
            pointer-events: none; font-weight: 900; z-index: 0;
        }
        /* Layout */
        .top-bar { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; z-index: 10; }
        .main-content { flex: 1; min-height: 0; display: grid; grid-template-columns: 2fr 1fr; gap: 15px; position: relative; z-index: 1; }
        .col { display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; }
        
        /* Panels & Tables */
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; position: relative; }
        .panel-head { font-weight: 600; color: var(--text-dim); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .scroll-wrap { overflow-y: auto; flex: 1; min-height: 0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: var(--text-dim); position: sticky; top: 0; background: var(--panel); padding: 5px; z-index: 10;}
        td { padding: 6px 5px; border-bottom: 1px solid #33415540; }
        
        /* Interactive Elements */
        .btn { border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; color: white; font-weight: 600; font-size: 0.75rem; transition: all 0.1s; }
        .btn:active { transform: scale(0.95); }
        .btn-buy { background: var(--green); } .btn-sell { background: var(--red); }
        .btn-call { background: var(--green); border: 1px solid #ffffff40; }
        .btn-put { background: var(--red); border: 1px solid #ffffff40; }
        .btn-ai { background: var(--purple); color: #1e293b; }
        .btn-turbo { background: var(--yellow); color: #000; font-weight: 800; }
        
        /* Specific UI */
        .price-up { color: var(--green); } .price-down { color: var(--red); }
        .log-item { font-size: 0.8rem; margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px solid #ffffff10; }
        .log-ml { border-left: 3px solid var(--purple); padding-left: 6px; color: #e9d5ff; background: #581c8720; }
        .log-opt { border-left: 3px solid var(--cyan); padding-left: 6px; color: #cffafe; background: #083344; }
        .log-risk { border-left: 3px solid var(--red); padding-left: 6px; background: #450a0a; color: #fca5a5; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .stat-box { background: #0f172a; padding: 5px; border-radius: 4px; text-align: center; }
        .stat-val { font-size: 0.9rem; font-weight: bold; }
        .stat-label { font-size: 0.7rem; color: var(--text-dim); }

        .ai-indicator { height: 4px; background: #334155; border-radius: 2px; overflow: hidden; margin-top: 2px; }
        .ai-bar { height: 100%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="watermark">TIU</div>

<div class="top-bar">
    <div>
        <h1 style="margin:0; font-size:1.3rem; color:var(--blue)">TIU Trader Pro <span style="font-size:0.7rem; opacity:0.5; color:var(--text-dim)">v25 UI Fix</span></h1>
        <div style="font-size:0.8rem; color:var(--text-dim); margin-top:2px;">
            AI State: <span id="aiStateDisplay" style="color:var(--orange)">Training...</span>
        </div>
    </div>
    
    <div style="display:flex; gap:10px; align-items:center;">
        <div style="display:flex; flex-direction:column; align-items:end; min-width:160px; background:#1e293b; padding:5px; border-radius:4px; border:1px solid var(--border);">
            
            <div style="font-size:0.7rem; color:var(--text-dim); display:flex; justify-content:space-between; width:100%; margin-bottom:4px;">
                <label style="cursor:pointer;"><input type="checkbox" id="aiOptToggle" checked> Auto-Options</label>
                <span id="volDisplay" style="color:var(--cyan)">Vol: --</span>
            </div>
            
            <div style="font-size:0.7rem; color:var(--text-dim); display:flex; justify-content:space-between; width:100%;">
                <span>Min Conf:</span>
                <span id="confValueDisplay" style="color:var(--yellow); font-weight:bold;">70%</span>
            </div>

            <input type="range" id="aiConfidenceSlider" min="55" max="95" value="70" step="5" style="width:100%; cursor:pointer;" 
                   oninput="document.getElementById('confValueDisplay').innerText = this.value + '%'">
        </div>

        <button class="btn btn-turbo" onclick="turboTrain()" title="Simulate 500 ticks">‚ö° Turbo</button>
        <button class="btn btn-ai" id="aiBtn" onclick="toggleAI()">Start AI</button>
        <button class="btn btn-sm" style="background:var(--border)" onclick="resetGame()">Reset</button>
    </div>
</div>

<div class="main-content">
    
    <div class="col">
        <div class="panel" style="flex: 1; min-height: 250px;">
            <canvas id="mainChart"></canvas>
        </div>

        <div class="panel" style="flex: 1;">
            <div class="panel-head">
                <span>Live Market</span>
                <span style="font-size:0.7rem; color:var(--cyan)">Option Cost: $150 | Exp: 45t</span>
            </div>
            <div class="scroll-wrap">
                <table id="marketTable">
                    <thead>
                        <tr>
                            <th>Sym</th> <th>Price</th> <th>Vol(SD)</th> <th>Trend</th> <th>AI Conf</th> <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="marketBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="panel">
            <div class="panel-head">Fund Status</div>
            <div style="text-align:center; margin-bottom:10px;">
                <div style="font-size:1.8rem; font-weight:bold;" id="cashDisplay">$10,000</div>
                <div style="font-size:0.8rem; color:var(--text-dim)">Available Cash</div>
            </div>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-label">Net Worth</div>
                    <div class="stat-val" id="netWorthDisplay">$10,000</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-val" id="winRateDisplay">0%</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-head">Deep Learning Models</div>
            <div style="margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                    <span>Trend Brain (Direction)</span>
                    <span id="trendAcc">Acc: 0%</span>
                </div>
                <div class="ai-indicator"><div class="ai-bar" id="trendBar" style="width:0%; background:var(--purple)"></div></div>
            </div>
            <div>
                <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                    <span>Option Brain (Profitability)</span>
                    <span id="optAcc">Acc: 0%</span>
                </div>
                <div class="ai-indicator"><div class="ai-bar" id="optBar" style="width:0%; background:var(--cyan)"></div></div>
            </div>
            <div style="font-size:0.7rem; color:var(--text-dim); margin-top:5px; font-style:italic;">
                *Option Brain learns with a 45-tick delay to validate actual profit.
            </div>
        </div>

        <div class="panel" style="flex: 1;">
            <div class="panel-head">Portfolio</div>
            <div class="scroll-wrap">
                <table id="holdingsTable">
                    <thead><tr><th>Asset</th><th>Time</th><th>P/L</th></tr></thead>
                    <tbody id="holdingsBody"></tbody>
                </table>
            </div>
        </div>

        <div class="panel" style="flex: 1;">
            <div class="panel-head">System Log</div>
            <div class="scroll-wrap" id="logs"></div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const CONFIG = {
        updateSpeed: 800,
        optionCost: 150,      // Premium paid
        optionDuration: 45,   // Time to expiry
        fee: 5,
        historySize: 50
    };

    // --- NEURAL NETWORK CLASS ---
    class Brain {
        constructor(inputSize, learningRate = 0.1) {
            this.weights = new Array(inputSize).fill(0).map(()=> Math.random()*2-1);
            this.bias = 0;
            this.lr = learningRate;
            this.total = 0;
            this.correct = 0;
        }
        sigmoid(x) { return 1 / (1 + Math.exp(-x)); }
        predict(inputs) {
            let sum = this.bias;
            for(let i=0; i<this.weights.length; i++) sum += inputs[i] * this.weights[i];
            return this.sigmoid(sum);
        }
        train(inputs, target) {
            const guess = this.predict(inputs);
            const error = target - guess;
            for(let i=0; i<this.weights.length; i++) this.weights[i] += error * inputs[i] * this.lr;
            this.bias += error * this.lr;
            
            this.total++;
            if(Math.abs(target - guess) < 0.5) this.correct++;
        }
        getAccuracy() { return this.total===0 ? 0 : Math.round((this.correct/this.total)*100); }
    }

    // --- STATE & DATA ---
    const STOCK_DEFS = [
        {sym:"NVDA", p:135, v:2.5}, {sym:"TSLA", p:240, v:3.0}, {sym:"AAPL", p:225, v:1.2},
        {sym:"AMZN", p:195, v:1.5}, {sym:"GOOG", p:175, v:1.4}
    ];

    let STOCKS = [];
    let state = {
        cash: 10000,
        holdings: {},
        options: [],
        aiActive: false,
        wins: 0,
        losses: 0,
        tick: 0,
        experienceBuffer: [] // Stores past states for "Time-Travel" training
    };

    // Two Brains:
    // 1. TrendBrain: Inputs [dPrice1, dPrice2] -> Target: 1 (Up) / 0 (Down)
    // 2. OptionBrain: Inputs [Volatility, TrendStrength] -> Target: 1 (Profit > Cost) / 0 (Loss)
    const trendBrain = new Brain(2, 0.1); 
    const optionBrain = new Brain(2, 0.05); // Lower learning rate for options to be conservative

    let chart = null;

    // --- INITIALIZATION ---
    function init() {
        STOCKS = STOCK_DEFS.map(d => ({
            ...d,
            price: d.p,
            history: Array(50).fill(d.p),
            volatility: 0,
            trend: 0
        }));
        
        buildChart();
        updateUI();
        setInterval(tick, CONFIG.updateSpeed);
        log("System Online. Dual-Network AI Loaded.", "log-ml");
    }

    // --- CORE SIMULATION ---
    function tick() {
        state.tick++;

        // 1. Update Market Prices
        STOCKS.forEach(s => {
            // Random walk with volatility
            let change = (Math.random() - 0.5) * s.v * 2;
            s.price += change;
            s.history.push(s.price);
            if(s.history.length > CONFIG.historySize) s.history.shift();

            // Calculate Volatility (Standard Deviation of last 10 ticks)
            const slice = s.history.slice(-10);
            const mean = slice.reduce((a,b)=>a+b,0)/slice.length;
            const variance = slice.reduce((a,b)=>a+Math.pow(b-mean,2),0)/slice.length;
            s.volatility = Math.sqrt(variance);

            // Calculate Trend (Simple Moving Average diff)
            s.trend = s.price - s.history[s.history.length - 5];
        });

        // 2. Process Expiring Options & Train OptionBrain
        processOptions();

        // 3. AI Predictions & Trading
        if(state.aiActive) runAI();

        // 4. Update UI
        updateChart();
        updateUI();
    }

    function processOptions() {
        // Iterate backwards to safely remove
        for (let i = state.options.length - 1; i >= 0; i--) {
            let opt = state.options[i];
            opt.life--;

            // Find current stock price
            const stock = STOCKS.find(s => s.sym === opt.sym);
            
            // Check for Expiry
            if (opt.life <= 0) {
                // Calculate Payout
                let payout = 0;
                if (opt.type === 'call') payout = Math.max(0, (stock.price - opt.strike) * 10);
                if (opt.type === 'put') payout = Math.max(0, (opt.strike - stock.price) * 10);

                const profit = payout - opt.cost;
                state.cash += payout;
                
                if (profit > 0) state.wins++; else state.losses++;

                // --- KEY: RETROACTIVE TRAINING ---
                // We go back in time (using the stored inputs in the option object)
                // If profit > 0, Target = 1. Else Target = 0.
                // This teaches the OptionBrain: "That specific setup 45 ticks ago was GOOD/BAD."
                optionBrain.train(opt.aiInputs, profit > 0 ? 1 : 0);

                const logClass = profit > 0 ? "log-opt" : "log-risk";
                log(`${opt.sym} Expired. P/L: $${profit.toFixed(0)}`, logClass);
                
                state.options.splice(i, 1);
            }
        }
    }

    function runAI() {
        // Bailout logic
        if(state.cash < 200 && state.options.length === 0) {
            state.cash += 2000;
            log("üöë Emergency Funding +$2,000", "log-risk");
        }

        const confidenceReq = document.getElementById('aiConfidenceSlider').value / 100;
        const allowOptions = document.getElementById('aiOptToggle').checked;

        STOCKS.forEach(s => {
            // Inputs for TrendBrain: Last 2 price changes
            const d1 = s.history[s.history.length-1] - s.history[s.history.length-2];
            const d2 = s.history[s.history.length-2] - s.history[s.history.length-3];
            const trendInputs = [d1, d2];
            
            // Inputs for OptionBrain: [Volatility, TrendStrength]
            const optInputs = [s.volatility, Math.abs(s.trend)];

            // Predictions
            const trendConf = trendBrain.predict(trendInputs); // >0.5 Bullish, <0.5 Bearish
            const optConf = optionBrain.predict(optInputs);    // >0.5 Profitable, <0.5 Unprofitable

            // Train TrendBrain immediately (Short term direction)
            // Target: Did price go up this tick?
            const priceWentUp = (s.price > s.history[s.history.length-2]) ? 1 : 0;
            trendBrain.train(trendInputs, priceWentUp);

            // DECISION LOGIC
            const isBullish = trendConf > confidenceReq;
            const isBearish = trendConf < (1 - confidenceReq);
            const isVolatileEnough = optConf > 0.6; // Hard threshold for option profitability

            // Execute Trades
            // 1. Stock Trade (Directional)
            if (isBullish && state.cash > s.price) {
                // Buy Stock logic (omitted for brevity, focus on options)
            }

            // 2. Option Trade (Directional + Volatility)
            if (allowOptions && state.cash > CONFIG.optionCost * 1.5) {
                // Check if we already have exposure
                const hasOpt = state.options.some(o => o.sym === s.sym);
                
                if (!hasOpt && isVolatileEnough) {
                    if (isBullish) buyOption(s, 'call', optInputs);
                    else if (isBearish) buyOption(s, 'put', optInputs);
                }
            }
            
            s.aiData = { trendConf, optConf }; // Save for UI
        });
    }

    function buyOption(stock, type, inputs) {
        if(state.cash < CONFIG.optionCost) return;
        
        state.cash -= CONFIG.optionCost;
        let strike = stock.price; 
        // Slight OTM/ITM adjustment
        if(type === 'call') strike = stock.price - 1; 
        if(type === 'put') strike = stock.price + 1;

        state.options.push({
            sym: stock.sym,
            type: type,
            strike: strike,
            cost: CONFIG.optionCost,
            life: CONFIG.optionDuration,
            aiInputs: inputs // Store inputs for retroactive training
        });

        log(`ü§ñ Bought ${type.toUpperCase()} ${stock.sym} (Vol: ${inputs[0].toFixed(2)})`, "log-opt");
    }

    // --- UI HELPERS ---
    function updateUI() {
        document.getElementById('cashDisplay').innerText = `$${state.cash.toFixed(0)}`;
        
        // Net Worth
        let optVal = 0;
        state.options.forEach(o => {
            const s = STOCKS.find(x=>x.sym===o.sym);
            if(o.type==='call') optVal += Math.max(0, (s.price - o.strike)*10);
            if(o.type==='put') optVal += Math.max(0, (o.strike - s.price)*10);
        });
        document.getElementById('netWorthDisplay').innerText = `$${(state.cash + optVal).toFixed(0)}`;

        // Stats
        const total = state.wins + state.losses;
        const rate = total === 0 ? 0 : Math.round((state.wins/total)*100);
        document.getElementById('winRateDisplay').innerText = `${rate}%`;
        
        // Brain Stats
        document.getElementById('trendAcc').innerText = `Acc: ${trendBrain.getAccuracy()}%`;
        document.getElementById('trendBar').style.width = `${trendBrain.getAccuracy()}%`;
        
        document.getElementById('optAcc').innerText = `Acc: ${optionBrain.getAccuracy()}%`;
        document.getElementById('optBar').style.width = `${optionBrain.getAccuracy()}%`;

        // Market Table
        const tbody = document.getElementById('marketBody');
        tbody.innerHTML = '';
        STOCKS.forEach(s => {
            const row = document.createElement('tr');
            const ai = s.aiData || { trendConf: 0.5, optConf: 0.5 };
            const trendStr = ai.trendConf > 0.6 ? "<span class='price-up'>Bull</span>" : (ai.trendConf < 0.4 ? "<span class='price-down'>Bear</span>" : "-");
            const optStr = ai.optConf > 0.6 ? "‚úÖ" : "‚ùå";
            
            row.innerHTML = `
                <td style="font-weight:bold">${s.sym}</td>
                <td>${s.price.toFixed(2)}</td>
                <td style="color:${s.volatility > 2 ? 'var(--green)':'var(--text-dim)'}">${s.volatility.toFixed(2)}</td>
                <td>${trendStr}</td>
                <td>Dir:${(ai.trendConf*100).toFixed(0)}% | Opt:${(ai.optConf*100).toFixed(0)}%</td>
                <td>${optStr}</td>
            `;
            tbody.appendChild(row);
        });

        // Holdings Table (Options)
        const hBody = document.getElementById('holdingsBody');
        hBody.innerHTML = '';
        state.options.forEach(o => {
            const s = STOCKS.find(x=>x.sym===o.sym);
            let curVal = 0;
            if(o.type==='call') curVal = Math.max(0, (s.price - o.strike)*10);
            if(o.type==='put') curVal = Math.max(0, (o.strike - s.price)*10);
            const pl = curVal - o.cost;
            
            hBody.innerHTML += `
                <tr>
                    <td>${o.sym} ${o.type.toUpperCase()}</td>
                    <td>${o.life}</td>
                    <td style="color:${pl>=0?'var(--green)':'var(--red)'}">$${pl.toFixed(0)}</td>
                </tr>
            `;
        });
    }

    function buildChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: Array(50).fill(''),
                datasets: STOCKS.map((s,i) => ({
                    label: s.sym,
                    data: s.history,
                    borderColor: ['#3b82f6','#10b981','#ef4444','#f59e0b','#c084fc'][i],
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4
                }))
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { grid: { color: '#33415550' } } }
            }
        });
    }

    function updateChart() {
        if(!chart) return;
        STOCKS.forEach((s, i) => {
            chart.data.datasets[i].data = s.history;
        });
        chart.update('none');
    }

    // --- CONTROLS ---
    function log(msg, cls) {
        const div = document.createElement('div');
        div.className = `log-item ${cls}`;
        div.innerText = `[T${state.tick}] ${msg}`;
        document.getElementById('logs').prepend(div);
        if(document.getElementById('logs').children.length > 50) document.getElementById('logs').lastChild.remove();
    }

    function toggleAI() {
        state.aiActive = !state.aiActive;
        document.getElementById('aiBtn').innerText = state.aiActive ? "Stop AI" : "Start AI";
        document.getElementById('aiBtn').style.background = state.aiActive ? "#ef4444" : "#c084fc";
        document.getElementById('aiStateDisplay').innerText = state.aiActive ? "ACTIVE TRADING" : "Training (Passive)";
    }

    function turboTrain() {
        log("‚ö° Turbo Training (500 ticks)...", "log-ml");
        state.aiActive = true;
        for(let i=0; i<500; i++) tick();
        log("‚ö° Turbo Complete.", "log-ml");
    }

    function resetGame() {
        if(confirm("Reset Simulation?")) location.reload();
    }

    init();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TIU Stock Simulator (Adjustable AI)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --green: #10b981;
            --red: #ef4444;
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --orange: #f59e0b;
            --border: #334155;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0; padding: 20px;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .watermark {
            position: fixed; bottom: 20px; right: 20px;
            font-size: 4rem; opacity: 0.05; pointer-events: none;
            font-weight: 900; font-family: monospace;
        }
        
        /* Layout */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 15px;
        }
        .grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px;
            height: 100%; overflow: hidden;
        }
        .col { display: flex; flex-direction: column; gap: 20px; overflow: hidden; }

        /* Panels */
        .panel {
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 8px; padding: 15px; display: flex; flex-direction: column;
            position: relative;
        }
        .panel-head { 
            font-weight: 600; color: var(--text-dim); margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Tables */
        .scroll-wrap { overflow-y: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: var(--text-dim); position: sticky; top: 0; background: var(--panel); padding: 5px; z-index: 10;}
        td { padding: 8px 5px; border-bottom: 1px solid #33415540; }
        
        /* Interactive Elements */
        .btn {
            border: none; padding: 5px 10px; border-radius: 4px;
            cursor: pointer; color: white; font-weight: 600; font-size: 0.8rem;
            transition: all 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        
        .btn-buy { background: var(--green); }
        .btn-sell { background: var(--red); }
        .btn-call { background: var(--green); border: 1px solid #ffffff40; }
        .btn-put { background: var(--red); border: 1px solid #ffffff40; }
        .btn-reset { background: var(--border); }
        .btn-ai { background: var(--purple); }
        .btn-sm { font-size: 0.7rem; padding: 2px 6px; background: var(--border); }

        /* Toggle Switch */
        .mode-switch {
            display: flex; background: var(--bg); border-radius: 4px; padding: 2px;
        }
        .mode-opt {
            padding: 4px 12px; cursor: pointer; border-radius: 3px; font-size: 0.8rem;
        }
        .mode-opt.active { background: var(--blue); color: white; font-weight: bold; }

        .price-up { color: var(--green); }
        .price-down { color: var(--red); }
        .opt-label { font-size: 0.7rem; padding: 1px 4px; border-radius: 3px; margin-right: 4px; }
        .bg-call { background: #064e3b; color: #6ee7b7; }
        .bg-put { background: #450a0a; color: #fca5a5; }

        /* Logs */
        .log-item { font-size: 0.85rem; margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid #ffffff10; }
        .log-ml { border-left: 2px solid var(--purple); padding-left: 5px; color: #d8b4fe; }
        .log-opt { border-left: 2px solid var(--orange); padding-left: 5px; }
        .log-err { color: #fca5a5; background: #450a0a; padding: 2px 5px; border-radius: 4px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab { background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 5px 15px; cursor: pointer; }
        .tab.active { background: var(--blue); color: white; border-color: var(--blue); }

        .view { display: none; height: 100%; }
        .view.active { display: block; }

        /* Stats Grid */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: #0f172a; padding: 8px; border-radius: 4px; text-align: center; }
        .stat-label { font-size: 0.75rem; color: var(--text-dim); }
        .stat-val { font-size: 1rem; font-weight: bold; }
        
        /* Chart Controls */
        #chartControls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
        .chart-toggle { 
            cursor: pointer; user-select: none; font-size: 0.8rem; 
            padding: 2px 6px; border-radius: 4px; border: 1px solid transparent;
        }
        .chart-toggle:hover { background: #ffffff10; }
        .chart-toggle input { margin-right: 5px; }

        /* Range Slider */
        input[type=range] {
            accent-color: var(--purple);
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="watermark">TIU</div>

<div class="top-bar">
    <div>
        <h1 style="margin:0; font-size:1.4rem; color:var(--blue)">TIU Trader Pro <span style="font-size:0.8rem; opacity:0.5; color:var(--text-dim)">v6</span></h1>
        <small style="color:var(--text-dim)">Fee: $5.00 â€¢ Status: <span id="marketStatus" style="color:var(--green)">LIVE</span></small>
    </div>
    
    <div style="display:flex; gap:15px; align-items:center;">
        <div style="display:flex; flex-direction:column; align-items:end; min-width:120px;">
            <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:2px;">
                AI Confidence: <span id="aiThreshDisplay" style="color:var(--purple); font-weight:bold;">70%</span>
            </div>
            <input type="range" min="50" max="95" value="70" step="5" style="width:100%" oninput="updateAiThreshold(this.value)">
        </div>

        <button class="btn btn-ai" id="aiBtn" onclick="toggleAI()">Start ML Agent</button>
        <button class="btn btn-reset" onclick="resetGame()">Reset</button>
    </div>
</div>

<div class="tabs">
    <button class="tab active" onclick="setTab('market')">Market</button>
    <button class="tab" onclick="setTab('chart')">Charts</button>
</div>

<div id="view-market" class="view active" style="height: 100%;">
    <div class="grid">
        <div class="col">
            <div class="panel" style="flex: 2;">
                <div class="panel-head">
                    <span>Live Market Prices</span>
                    <div class="mode-switch">
                        <div class="mode-opt active" id="mode-stocks" onclick="setMode('stocks')">Stocks</div>
                        <div class="mode-opt" id="mode-options" onclick="setMode('options')">Options</div>
                    </div>
                </div>
                <div class="scroll-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Price</th>
                                <th>Trend</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="marketBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="panel" style="flex: 1;">
                <div class="panel-head">
                    <span>Activity Log</span>
                </div>
                <div class="scroll-wrap" id="logs"></div>
            </div>
        </div>

        <div class="col">
            <div class="panel">
                <div class="panel-head">Wallet</div>
                <div style="text-align:center; margin-bottom:10px;">
                    <div style="font-size:2rem; font-weight:bold;" id="cashDisplay">$10,000.00</div>
                    <div style="font-size:0.9rem; color:var(--text-dim)">Available Cash</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:1.2rem; font-weight:bold;" id="netWorthDisplay">$10,000.00</div>
                    <div style="font-size:0.8rem; color:var(--text-dim)">Total Net Worth</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-head">Stats & ML</div>
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-val" id="statWinRate">0%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Profit Factor</div>
                        <div class="stat-val" id="statPF">0.00</div>
                    </div>
                    <div class="stat-box" style="border:1px solid var(--purple)">
                        <div class="stat-label" style="color:var(--purple)">ML Accuracy</div>
                        <div class="stat-val" id="mlAccuracy">--%</div>
                    </div>
                    <div class="stat-box" style="border:1px solid var(--orange)">
                        <div class="stat-label" style="color:var(--orange)">Active Options</div>
                        <div class="stat-val" id="activeOptCount">0</div>
                    </div>
                </div>
            </div>

            <div class="panel" style="flex: 1;">
                <div class="panel-head">Your Holdings</div>
                <div class="scroll-wrap">
                    <table id="holdingsTable">
                        <thead><tr><th>Asset</th><th>Qty/Exp</th><th>P/L</th></tr></thead>
                        <tbody id="holdingsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="view-chart" class="view">
    <div class="panel" style="height:100%">
        <div class="panel-head" style="flex-wrap:wrap; gap:10px;">
            <span>Market Analysis</span>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-sm" onclick="toggleAllCharts(true)">All</button>
                <button class="btn btn-sm" onclick="toggleAllCharts(false)">None</button>
            </div>
            <div id="chartControls"></div>
        </div>
        <div style="flex:1; position:relative">
            <canvas id="mainChart"></canvas>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const CONFIG = {
        fee: 5.00,
        initialCash: 10000,
        updateSpeed: 1000,
        chartWindow: 50,
        optionCost: 100, 
        optionDuration: 30 
    };

    // --- Simple ML Brain ---
    class SimpleBrain {
        constructor() {
            this.weights = [0.5, 0.2, 0.1]; 
            this.bias = 0;
            this.learningRate = 0.05;
            this.totalPredictions = 0;
            this.correctPredictions = 0;
            this.lastError = 0;
        }

        sigmoid(x) { return 1 / (1 + Math.exp(-x)); }

        predict(inputs) {
            let sum = this.bias;
            for(let i=0; i<this.weights.length; i++) sum += inputs[i] * this.weights[i];
            return this.sigmoid(sum);
        }

        train(inputs, target) {
            const guess = this.predict(inputs);
            const error = target - guess;
            for(let i=0; i<this.weights.length; i++) {
                this.weights[i] += error * inputs[i] * this.learningRate;
            }
            this.bias += error * this.learningRate;
            
            this.totalPredictions++;
            if((guess > 0.5 && target === 1) || (guess <= 0.5 && target === 0)) {
                this.correctPredictions++;
            }
            this.lastError = Math.abs(error);
        }
        
        getAccuracy() {
            if(this.totalPredictions === 0) return 0;
            return ((this.correctPredictions / this.totalPredictions) * 100).toFixed(1);
        }
    }

    const STOCKS = [
        { sym: "AAPL", price: 225.00, vol: 1.5, data: [], history: [] },
        { sym: "NVDA", price: 135.50, vol: 3.0, data: [], history: [] },
        { sym: "TSLA", price: 240.80, vol: 3.5, data: [], history: [] },
        { sym: "AMZN", price: 195.00, vol: 1.8, data: [], history: [] },
        { sym: "GOOG", price: 175.00, vol: 1.6, data: [], history: [] }
    ];

    const COLORS = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#06b6d4'];

    // --- State ---
    let state = {
        cash: CONFIG.initialCash,
        holdings: {}, 
        options: [], 
        aiActive: false,
        aiThreshold: 0.70, // Default 70%
        tradeMode: 'stocks', 
        stats: { wins: 0, losses: 0, grossProfit: 0, grossLoss: 0, totalTrades: 0 }
    };

    let globalTick = 0;
    let chartObj = null;
    let tradeMarkers = []; 
    let brain = new SimpleBrain(); 
    let predictions = {}; 

    // --- Init ---
    function init() {
        const saved = localStorage.getItem('tiu_fix_v6');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                if (!isNaN(parsed.cash)) {
                    state = parsed;
                    state.tradeMode = 'stocks';
                    // Ensure threshold exists if loading old save
                    if(!state.aiThreshold) state.aiThreshold = 0.70;
                }
            } catch(e) { console.log("Save corrupted"); }
        }

        // Init UI elements
        document.querySelector('input[type=range]').value = (state.aiThreshold * 100);
        document.getElementById('aiThreshDisplay').innerText = (state.aiThreshold * 100).toFixed(0) + "%";

        buildMarketTable();
        buildChart();
        updateUI();
        updateStats();

        setInterval(tick, CONFIG.updateSpeed);
        log("System Ready. Options Trading Available.");
    }

    // --- Core Logic ---
    function tick() {
        globalTick++;

        // 1. Train Brain
        STOCKS.forEach(s => {
            const currentMove = s.history.length > 0 ? (s.price - s.history[s.history.length-1]) : 0;
            const target = currentMove > 0 ? 1 : 0;
            if (predictions[s.sym]) brain.train(predictions[s.sym].inputs, target);
        });

        // 2. Update Prices & Options
        STOCKS.forEach(s => {
            s.history.push(s.price);
            if(s.history.length > 5) s.history.shift();

            const move = (Math.random() - 0.5) * s.vol;
            s.price = Math.max(1, s.price + move);
            s.trend = move > 0 ? "â–²" : "â–¼";
            
            s.data.push({x: globalTick, y: s.price});
            if(s.data.length > 100) s.data.shift();
        });

        // 3. Process Options Expiration
        processOptions();

        // 4. ML Inference & Trading
        STOCKS.forEach(s => {
            if(s.history.length >= 3) {
                const i1 = (s.history[s.history.length-1] - s.history[s.history.length-2]);
                const i2 = (s.history[s.history.length-2] - s.history[s.history.length-3]);
                const inputs = [i1, i2, 1];
                const confidence = brain.predict(inputs);
                
                predictions[s.sym] = { inputs: inputs, conf: confidence };
                
                if(state.aiActive) runMLTrading(s, confidence);
            }
        });

        // 5. Update UI
        updateMarketTableValues();
        updateUI();
        updateChart();
        localStorage.setItem('tiu_fix_v6', JSON.stringify(state));
    }

    function runMLTrading(stock, confidence) {
        const thresh = state.aiThreshold;
        const sellThresh = 1 - thresh; 

        // BUY Signal: Confidence > Threshold
        if (confidence > thresh && state.cash > (stock.price + 200)) {
            trade(stock.sym, 'buy'); 
            log(`ðŸ¤– AI BUY ${stock.sym} (${(confidence*100).toFixed(0)}%)`, "log-ml");
        }
        
        // SELL Signal: Confidence < (1 - Threshold)
        // e.g. if Threshold is 0.70, Sell when confidence < 0.30
        if (confidence < sellThresh && state.holdings[stock.sym]) {
            trade(stock.sym, 'sell');
            log(`ðŸ¤– AI SELL ${stock.sym} (${(confidence*100).toFixed(0)}%)`, "log-ml");
        }
    }

    function updateAiThreshold(val) {
        state.aiThreshold = val / 100;
        document.getElementById('aiThreshDisplay').innerText = val + "%";
    }

    function processOptions() {
        for (let i = state.options.length - 1; i >= 0; i--) {
            const opt = state.options[i];
            opt.ticksLeft--;
            
            if (opt.ticksLeft <= 0) {
                const stock = STOCKS.find(s => s.sym === opt.sym);
                let profit = 0;

                if (opt.type === 'call') {
                    if (stock.price > opt.strike) profit = (stock.price - opt.strike) * 10; 
                } else {
                    if (stock.price < opt.strike) profit = (opt.strike - stock.price) * 10;
                }

                state.cash += profit;
                const net = profit - opt.cost;
                
                state.stats.totalTrades++;
                if(net > 0) { state.stats.wins++; state.stats.grossProfit += net; }
                else { state.stats.losses++; state.stats.grossLoss += Math.abs(net); }

                log(`âŒ› ${opt.sym} ${opt.type.toUpperCase()} Expired. Net: $${net.toFixed(2)}`, "log-opt");

                state.options.splice(i, 1);
            }
        }
    }

    // --- Trading Logic ---
    function trade(sym, action) {
        const stock = STOCKS.find(s => s.sym === sym);
        
        // --- STOCK TRADING ---
        if (action === 'buy' || action === 'sell') {
            const fee = CONFIG.fee;
            
            if (action === 'buy') {
                const total = stock.price + fee;
                if (state.cash < total) { log("âŒ Insufficient Funds"); return; }
                
                state.cash -= total;
                if (!state.holdings[sym]) state.holdings[sym] = { qty: 0, avg: 0 };
                const h = state.holdings[sym];
                h.avg = ((h.qty * h.avg) + stock.price) / (h.qty + 1);
                h.qty++;
                
                if(!state.aiActive) log(`âœ… Bought 1 ${sym} @ $${stock.price.toFixed(2)}`);
                addChartMarker(globalTick, stock.price, 'buy');

            } else {
                if (!state.holdings[sym] || state.holdings[sym].qty <= 0) return;
                
                const revenue = stock.price - fee;
                state.cash += revenue;
                const h = state.holdings[sym];
                const profit = (stock.price - h.avg) - fee;
                
                h.qty--;
                if(h.qty === 0) delete state.holdings[sym];
                
                recordTradeStats(profit);
                if(!state.aiActive) log(`ðŸ”» Sold 1 ${sym}. P/L: $${profit.toFixed(2)}`, profit>0?"price-up":"price-down");
                addChartMarker(globalTick, stock.price, 'sell');
            }
        }
        
        // --- OPTION TRADING ---
        if (action === 'call' || action === 'put') {
            const cost = CONFIG.optionCost;
            if (state.cash < cost) { log("âŒ Need $100 for Option"); return; }
            
            state.cash -= cost;
            state.options.push({
                id: Date.now() + Math.random(),
                sym: sym,
                type: action,
                strike: stock.price,
                cost: cost,
                ticksLeft: CONFIG.optionDuration
            });
            
            log(`ðŸŽ« Bought ${sym} ${action.toUpperCase()} (Strike: ${stock.price.toFixed(2)})`, "log-opt");
        }

        updateUI();
        updateStats();
    }

    function recordTradeStats(profit) {
        state.stats.totalTrades++;
        if (profit > 0) { state.stats.wins++; state.stats.grossProfit += profit; }
        else { state.stats.losses++; state.stats.grossLoss += Math.abs(profit); }
    }

    function addChartMarker(x, y, type) {
        tradeMarkers.push({ x: x, y: y, type: type });
        if(tradeMarkers.length > 50) tradeMarkers.shift();
    }

    // --- UI Logic ---
    function setMode(mode) {
        state.tradeMode = mode;
        document.getElementById('mode-stocks').className = `mode-opt ${mode==='stocks'?'active':''}`;
        document.getElementById('mode-options').className = `mode-opt ${mode==='options'?'active':''}`;
        buildMarketTable(); // Rebuild buttons
    }

    function buildMarketTable() {
        const tbody = document.getElementById('marketBody');
        tbody.innerHTML = '';
        STOCKS.forEach(s => {
            const tr = document.createElement('tr');
            tr.id = `row-${s.sym}`;
            
            let buttons = '';
            if (state.tradeMode === 'stocks') {
                buttons = `
                    <button class="btn btn-buy" id="btn-buy-${s.sym}" onclick="trade('${s.sym}', 'buy')">Buy</button>
                    <button class="btn btn-sell" onclick="trade('${s.sym}', 'sell')">Sell</button>
                `;
            } else {
                buttons = `
                    <button class="btn btn-call" onclick="trade('${s.sym}', 'call')">Call ($100)</button>
                    <button class="btn btn-put" onclick="trade('${s.sym}', 'put')">Put ($100)</button>
                `;
            }

            tr.innerHTML = `
                <td style="font-weight:bold">${s.sym}</td>
                <td id="price-${s.sym}">...</td>
                <td id="trend-${s.sym}">-</td>
                <td>${buttons}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateMarketTableValues() {
        STOCKS.forEach(s => {
            const priceEl = document.getElementById(`price-${s.sym}`);
            if(priceEl) {
                priceEl.innerText = `$${s.price.toFixed(2)}`;
                priceEl.className = s.trend === "â–²" ? "price-up" : "price-down";
                document.getElementById(`trend-${s.sym}`).innerText = s.trend;
                
                const buyBtn = document.getElementById(`btn-buy-${s.sym}`);
                if(buyBtn) buyBtn.disabled = (state.cash < (s.price + CONFIG.fee));
            }
        });
    }

    function updateUI() {
        // Wallet
        document.getElementById('cashDisplay').innerText = `$${state.cash.toFixed(2)}`;
        
        // Holdings Table
        const tbody = document.getElementById('holdingsBody');
        tbody.innerHTML = "";
        
        let stockVal = 0;

        // 1. List Shares
        Object.keys(state.holdings).forEach(sym => {
            const h = state.holdings[sym];
            const stock = STOCKS.find(s => s.sym === sym);
            const currentVal = h.qty * stock.price;
            stockVal += currentVal;
            const totalPL = (stock.price - h.avg) * h.qty;
            const color = totalPL >= 0 ? "var(--green)" : "var(--red)";

            tbody.innerHTML += `
                <tr>
                    <td>${sym}</td>
                    <td>${h.qty} <small class="text-dim">Shares</small></td>
                    <td style="color:${color}">$${totalPL.toFixed(2)}</td>
                </tr>
            `;
        });

        // 2. List Options
        state.options.forEach(opt => {
            const stock = STOCKS.find(s => s.sym === opt.sym);
            let currentProfit = 0;
            if (opt.type === 'call') currentProfit = Math.max(0, (stock.price - opt.strike) * 10);
            if (opt.type === 'put') currentProfit = Math.max(0, (opt.strike - stock.price) * 10);
            
            const badgeClass = opt.type === 'call' ? 'bg-call' : 'bg-put';
            
            tbody.innerHTML += `
                <tr>
                    <td><span class="opt-label ${badgeClass}">${opt.type.toUpperCase()}</span> ${opt.sym}</td>
                    <td>${opt.ticksLeft}s</td>
                    <td>$${currentProfit.toFixed(2)}</td>
                </tr>
            `;
        });

        document.getElementById('netWorthDisplay').innerText = `$${(state.cash + stockVal).toFixed(2)}`;
        document.getElementById('activeOptCount').innerText = state.options.length;
    }

    function updateStats() {
        const s = state.stats;
        const winRate = s.totalTrades > 0 ? (s.wins / s.totalTrades * 100) : 0;
        const profitFactor = s.grossLoss > 0 ? (s.grossProfit / s.grossLoss) : s.grossProfit;

        document.getElementById('statWinRate').innerText = winRate.toFixed(1) + "%";
        document.getElementById('statWinRate').style.color = winRate >= 50 ? "var(--green)" : "var(--red)";
        document.getElementById('statPF').innerText = profitFactor.toFixed(2);
        document.getElementById('mlAccuracy').innerText = brain.getAccuracy() + "%";
    }

    function toggleAI() {
        state.aiActive = !state.aiActive;
        const btn = document.getElementById('aiBtn');
        btn.innerText = state.aiActive ? "ML: Active" : "Start ML Agent";
        btn.style.background = state.aiActive ? "#10b981" : "#8b5cf6";
    }

    function log(msg, cls="") {
        const div = document.getElementById('logs');
        const entry = document.createElement('div');
        entry.className = `log-item ${cls}`;
        entry.innerText = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
        div.prepend(entry);
    }

    function setTab(name) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`view-${name}`).classList.add('active');
        event.target.classList.add('active');
    }

    function resetGame() {
        if(confirm("Reset everything?")) {
            localStorage.removeItem('tiu_fix_v6');
            location.reload();
        }
    }

    // --- Charting ---
    function buildChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const controls = document.getElementById('chartControls');
        controls.innerHTML = '';
        
        const datasets = STOCKS.map((s, i) => ({
            label: s.sym,
            borderColor: COLORS[i % COLORS.length],
            backgroundColor: COLORS[i % COLORS.length],
            data: s.data,
            tension: 0.1,
            pointRadius: 0,
            borderWidth: 2,
            type: 'line',
            order: 2
        }));

        datasets.push({
            label: 'Trades',
            data: tradeMarkers,
            type: 'scatter',
            backgroundColor: (ctx) => ctx.raw?.type === 'buy' ? '#10b981' : '#ef4444',
            pointStyle: 'triangle',
            rotation: (ctx) => ctx.raw?.type === 'buy' ? 0 : 180,
            pointRadius: 8,
            order: 1
        });

        chartObj = new Chart(ctx, {
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                scales: { 
                    x: { type: 'linear', display: false, min: 0, max: CONFIG.chartWindow }, 
                    y: { grid: { color: '#33415550' }, ticks: { color: '#94a3b8' } } 
                },
                plugins: { legend: { display: false } }
            }
        });

        STOCKS.forEach((s, i) => {
            const label = document.createElement('label');
            label.className = "chart-toggle";
            label.innerHTML = `<input type="checkbox" checked onchange="toggleDataset(${i})"><span style="color:${COLORS[i]}">${s.sym}</span>`;
            controls.appendChild(label);
        });
    }

    function toggleDataset(index) {
        const isVisible = chartObj.isDatasetVisible(index);
        isVisible ? chartObj.hide(index) : chartObj.show(index);
    }
    
    function toggleAllCharts(show) {
        STOCKS.forEach((_, i) => show ? chartObj.show(i) : chartObj.hide(i));
        const boxes = document.querySelectorAll('#chartControls input');
        boxes.forEach(b => b.checked = show);
    }

    function updateChart() {
        if (!chartObj) return;
        const minX = Math.max(0, globalTick - CONFIG.chartWindow);
        chartObj.options.scales.x.min = minX;
        chartObj.options.scales.x.max = globalTick;
        chartObj.update('none');
    }

    init();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TIU Trader Pro (v30 Fixed Logic)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --text: #f1f5f9; --text-dim: #94a3b8;
            --green: #10b981; --red: #ef4444; --blue: #3b82f6; --purple: #c084fc;
            --orange: #f59e0b; --border: #334155; --yellow: #facc15; --cyan: #06b6d4;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; padding: 15px; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        .watermark {
            position: fixed; bottom: 10px; right: 15px; font-size: 3rem; opacity: 0.05;
            pointer-events: none; font-weight: 900; z-index: 0;
        }
        .top-bar { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; z-index: 10; }
        .main-content { flex: 1; min-height: 0; display: grid; grid-template-columns: 2fr 1fr; gap: 15px; position: relative; z-index: 1; }
        .col { display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; position: relative; }
        .panel-head { font-weight: 600; color: var(--text-dim); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .scroll-wrap { overflow-y: auto; flex: 1; min-height: 0; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: var(--text-dim); position: sticky; top: 0; background: var(--panel); padding: 5px; z-index: 10;}
        td { padding: 6px 5px; border-bottom: 1px solid #33415540; font-family: 'Consolas', monospace; }
        
        .btn { border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; color: white; font-weight: 600; font-size: 0.75rem; transition: all 0.1s; }
        .btn:active { transform: scale(0.95); }
        .btn-green { background: var(--green); color: #064e3b; }
        .btn-ai { background: var(--purple); color: #1e293b; }
        .btn-turbo { background: var(--yellow); color: #000; font-weight: 800; }
        .btn-reset { background: var(--border); }

        .control-group {
            display:flex; flex-direction:column; align-items:end; min-width:180px; 
            background:#1e293b; padding:8px; border-radius:6px; border:1px solid var(--border);
        }
        
        .log-item { font-size: 0.8rem; margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px solid #ffffff10; }
        .log-ml { border-left: 3px solid var(--purple); padding-left: 6px; color: #e9d5ff; background: #581c8720; }
        .log-opt { border-left: 3px solid var(--cyan); padding-left: 6px; color: #cffafe; background: #083344; }
        .log-sys { border-left: 3px solid var(--orange); padding-left: 6px; color: #fed7aa; background: #431407; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .stat-box { background: #0f172a; padding: 5px; border-radius: 4px; text-align: center; }
        .stat-val { font-size: 0.9rem; font-weight: bold; }
        .ai-indicator { height: 4px; background: #334155; border-radius: 2px; overflow: hidden; margin-top: 2px; }
        .ai-bar { height: 100%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="watermark">TIU</div>

<div class="top-bar">
    <div>
        <h1 style="margin:0; font-size:1.3rem; color:var(--blue)">TIU Trader Pro <span style="font-size:0.7rem; opacity:0.5; color:var(--text-dim)">v30 Momentum-Fix</span></h1>
        <div style="font-size:0.8rem; color:var(--text-dim); margin-top:2px;">
            Logic: <span style="color:var(--green)">Sine Wave Momentum + SMA Crossover</span>
        </div>
    </div>
    
    <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn btn-green" onclick="addFunds()">+ $5k Funds</button>
        
        <div class="control-group">
            <div style="font-size:0.7rem; color:var(--text-dim); display:flex; justify-content:space-between; width:100%;">
                <span>Min Confidence:</span>
                <span id="confValueDisplay" style="color:var(--yellow); font-weight:bold;">75%</span>
            </div>
            <input type="range" id="aiConfidenceSlider" min="55" max="95" value="75" step="1" style="width:100%; cursor:pointer; margin: 5px 0;" 
                   oninput="document.getElementById('confValueDisplay').innerText = this.value + '%'">
        </div>

        <button class="btn btn-turbo" onclick="turboTrain()" title="Simulate 500 ticks">âš¡ Turbo</button>
        <button class="btn btn-ai" id="aiBtn" onclick="toggleAI()">Start AI</button>
        <button class="btn btn-reset" onclick="resetGame()">Reset</button>
    </div>
</div>

<div class="main-content">
    <div class="col">
        <div class="panel" style="flex: 1; min-height: 250px;">
            <canvas id="mainChart"></canvas>
        </div>
        <div class="panel" style="flex: 1;">
            <div class="panel-head">
                <span>Live Market Analysis</span>
                <span style="font-size:0.7rem; color:var(--cyan)">Cost: $100 | Exp: 40t</span>
            </div>
            <div class="scroll-wrap">
                <table id="marketTable">
                    <thead><tr><th>Sym</th> <th>Price</th> <th>Vol</th> <th>AI (Trend|Opt)</th> <th>Action</th></tr></thead>
                    <tbody id="marketBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="panel">
            <div class="panel-head">Fund Status</div>
            <div style="text-align:center; margin-bottom:10px;">
                <div style="font-size:1.8rem; font-weight:bold;" id="cashDisplay">$10,000</div>
                <div style="font-size:0.8rem; color:var(--text-dim)">Available Cash</div>
            </div>
            <div class="stat-grid">
                <div class="stat-box">
                    <div style="font-size:0.7rem; color:var(--text-dim)">Net Worth</div>
                    <div class="stat-val" id="netWorthDisplay">$10,000</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:0.7rem; color:var(--text-dim)">Win Rate</div>
                    <div class="stat-val" id="winRateDisplay">0%</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-head">Neural Networks</div>
            <div style="margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                    <span>Trend Brain (Direction)</span>
                    <span id="trendAcc">Acc: 0%</span>
                </div>
                <div class="ai-indicator"><div class="ai-bar" id="trendBar" style="width:0%; background:var(--purple)"></div></div>
            </div>
            <div>
                <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                    <span>Option Brain (Profitability)</span>
                    <span id="optAcc">Acc: 0%</span>
                </div>
                <div class="ai-indicator"><div class="ai-bar" id="optBar" style="width:0%; background:var(--cyan)"></div></div>
            </div>
        </div>

        <div class="panel" style="flex: 1;">
            <div class="panel-head">Portfolio</div>
            <div class="scroll-wrap">
                <table id="holdingsTable">
                    <thead><tr><th>Asset</th><th>Time</th><th>P/L</th></tr></thead>
                    <tbody id="holdingsBody"></tbody>
                </table>
            </div>
        </div>

        <div class="panel" style="flex: 1;">
            <div class="panel-head">System Log</div>
            <div class="scroll-wrap" id="logs"></div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        updateSpeed: 500, // Faster updates
        optionCost: 100,  // Lower cost to make wins easier
        optionDuration: 40,
        historySize: 60,
        baseDrift: 0.000,
        explorationRate: 0.20 // 20% forced exploration
    };

    function randn_bm() {
        let u = 0, v = 0;
        while(u === 0) u = Math.random();
        while(v === 0) v = Math.random();
        return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    class Brain {
        constructor(inputSize, learningRate = 0.05) {
            this.weights = new Array(inputSize).fill(0).map(()=> Math.random()*2-1);
            this.bias = 0;
            this.lr = learningRate;
            this.total = 0;
            this.correct = 0;
        }
        sigmoid(x) { return 1 / (1 + Math.exp(-x)); }
        predict(inputs) {
            let sum = this.bias;
            for(let i=0; i<this.weights.length; i++) sum += inputs[i] * this.weights[i];
            return this.sigmoid(sum);
        }
        train(inputs, target) {
            const guess = this.predict(inputs);
            const error = target - guess;
            for(let i=0; i<this.weights.length; i++) this.weights[i] += error * inputs[i] * this.lr;
            this.bias += error * this.lr;
            this.total++;
            // Consider "Correct" if we are on the right side of 0.5
            if((guess > 0.5 && target === 1) || (guess < 0.5 && target === 0)) this.correct++;
        }
        getAccuracy() { return this.total===0 ? 0 : Math.round((this.correct/this.total)*100); }
    }

    const STOCK_DEFS = [
        {sym:"NVDA", p:135, baseVol: 0.015}, 
        {sym:"TSLA", p:240, baseVol: 0.02}, 
        {sym:"AAPL", p:225, baseVol: 0.01},
        {sym:"AMZN", p:195, baseVol: 0.012}, 
        {sym:"GOOG", p:175, baseVol: 0.011}
    ];

    let STOCKS = [];
    let state = {
        cash: 10000,
        options: [],
        aiActive: false,
        wins: 0,
        losses: 0,
        tick: 0
    };

    // Brains: 2 Inputs [SMA_Diff, Volatility]
    const trendBrain = new Brain(2, 0.1); 
    const optionBrain = new Brain(2, 0.1); 
    let chart = null;

    function init() {
        STOCKS = STOCK_DEFS.map(d => ({
            ...d,
            price: d.p,
            history: Array(60).fill(d.p),
            currentVol: d.baseVol,
            trend: 0,
            // Hidden Momentum Variable (The Market "Mood")
            momentum: 0, 
            momentumPhase: Math.random() * Math.PI * 2
        }));
        buildChart();
        updateUI();
        setInterval(tick, CONFIG.updateSpeed);
        log("System Online. Market Physics: Momentum Enabled.", "log-sys");
    }

    function getSMA(history, periods) {
        if(history.length < periods) return history[history.length-1];
        let sum = 0;
        for(let i=1; i<=periods; i++) sum += history[history.length-i];
        return sum / periods;
    }

    function tick() {
        if(state.aiActive && state.cash < CONFIG.optionCost) {
            state.aiActive = false;
            updateUI();
            log("ðŸ›‘ INSUFFICIENT FUNDS.", "log-sys");
            alert("Insufficient Funds! Add cash to continue.");
            return;
        }

        state.tick++;

        STOCKS.forEach(s => {
            // --- LOGIC FIX 1: ADD MOMENTUM ---
            // Update momentum using a Sine wave to create predictable "Trends"
            s.momentumPhase += 0.05; // Moves the wave
            s.momentum = Math.sin(s.momentumPhase) * 0.005; // Momentum Strength

            s.currentVol = (s.currentVol * 0.95) + (s.baseVol * 0.05); 
            const shock = randn_bm();
            
            // Price = Price * (1 + Momentum + Noise)
            // Noise is now slightly less dominant than Momentum
            const changePct = s.momentum + (s.currentVol * shock * 0.5);
            
            s.price = s.price * (1 + changePct);
            if(Math.abs(shock) > 2.5) s.currentVol *= 1.5; 

            s.history.push(s.price);
            if(s.history.length > CONFIG.historySize) s.history.shift();
            s.trend = s.price - s.history[s.history.length - 10];
        });

        processOptions();
        if(state.aiActive) runAI();
        updateChart();
        updateUI();
    }

    function processOptions() {
        for (let i = state.options.length - 1; i >= 0; i--) {
            let opt = state.options[i];
            opt.life--;

            const stock = STOCKS.find(s => s.sym === opt.sym);
            if (opt.life <= 0) {
                let payout = 0;
                if (opt.type === 'call') payout = Math.max(0, (stock.price - opt.strike) * 10);
                if (opt.type === 'put') payout = Math.max(0, (opt.strike - stock.price) * 10);

                const profit = payout - opt.cost;
                state.cash += payout;
                
                if (profit > 0) state.wins++; else state.losses++;

                // Train Option Brain on the RESULT
                // If profit > 0, we should have predicted 1.0
                optionBrain.train(opt.aiInputs, profit > 0 ? 1 : 0);

                const logClass = profit > 0 ? "log-opt" : "log-sys";
                const icon = profit > 0 ? "âœ…" : "âŒ";
                log(`${icon} ${opt.sym} Exp. P/L: $${profit.toFixed(0)}`, logClass);
                state.options.splice(i, 1);
            }
        }
    }

    function runAI() {
        const sliderVal = document.getElementById('aiConfidenceSlider').value;
        const confidenceReq = sliderVal / 100;

        STOCKS.forEach(s => {
            // --- LOGIC FIX 2: FEATURE ENGINEERING ---
            // Calculate Moving Averages
            const smaShort = getSMA(s.history, 5);
            const smaLong = getSMA(s.history, 20);

            // Input 1: Divergence (Is Short above Long?) - Normalized
            // If Short > Long, Trend is UP (Positive Input).
            const maDivergence = ((smaShort - smaLong) / s.price) * 50; 
            
            // Input 2: Volatility normalized
            const volInput = s.currentVol * 20;

            const brainInputs = [maDivergence, volInput];

            const trendConf = trendBrain.predict(brainInputs); // 0 = Bearish, 1 = Bullish
            const optConf = optionBrain.predict(brainInputs);  // 0 = Unprofitable, 1 = Profitable

            // Train Trend Brain immediately on current direction
            const isPriceRising = s.price > s.history[s.history.length-2] ? 1 : 0;
            trendBrain.train(brainInputs, isPriceRising);

            const isBullish = trendConf > confidenceReq;
            const isBearish = trendConf < (1 - confidenceReq);
            
            // The Option Brain learns "Should I trade?"
            const isConfident = optConf > 0.55; 

            let action = "-";
            let debugTag = "";

            if (state.cash > CONFIG.optionCost * 1.5) {
                const hasOpt = state.options.some(o => o.sym === s.sym);
                
                if (!hasOpt) {
                    // Exploration: Occasionally do random stuff to learn new patterns
                    const isExploration = Math.random() < CONFIG.explorationRate;

                    if (isExploration) {
                        const type = Math.random() > 0.5 ? 'call' : 'put';
                        buyOption(s, type, brainInputs);
                        action = "Exp " + type.toUpperCase();
                        debugTag = "ðŸŽ²"; 
                    } 
                    else if (isConfident) {
                        if (isBullish) {
                            buyOption(s, 'call', brainInputs);
                            action = "Buy CALL";
                        } else if (isBearish) {
                            buyOption(s, 'put', brainInputs);
                            action = "Buy PUT";
                        }
                    }
                }
            }
            
            s.aiData = { 
                trendConf, optConf, 
                targetT: confidenceReq, 
                action: action,
                debugTag: debugTag
            };
        });
    }

    function buyOption(stock, type, inputs) {
        if(state.cash < CONFIG.optionCost) return;
        state.cash -= CONFIG.optionCost;
        
        // --- LOGIC FIX 3: CLOSER STRIKE PRICE ---
        // Strike is only 0.2% away instead of 0.5%, making it easier to hit profit
        let strike = stock.price; 
        if(type === 'call') strike = stock.price * 0.998; 
        if(type === 'put') strike = stock.price * 1.002;

        state.options.push({
            sym: stock.sym, type: type, strike: strike, cost: CONFIG.optionCost,
            life: CONFIG.optionDuration, aiInputs: inputs
        });
        const icon = inputs ? "ðŸ¤–" : "ðŸŽ²"; 
        log(`${icon} Bought ${type.toUpperCase()} ${stock.sym}`, "log-opt");
    }

    function addFunds() {
        state.cash += 5000;
        log("ðŸ’° Injected $5,000 Capital", "log-sys");
        updateUI();
    }

    function updateUI() {
        document.getElementById('cashDisplay').innerText = `$${state.cash.toFixed(0)}`;
        
        let optVal = 0;
        state.options.forEach(o => {
            const s = STOCKS.find(x=>x.sym===o.sym);
            if(o.type==='call') optVal += Math.max(0, (s.price - o.strike)*10);
            if(o.type==='put') optVal += Math.max(0, (o.strike - s.price)*10);
        });
        document.getElementById('netWorthDisplay').innerText = `$${(state.cash + optVal).toFixed(0)}`;
        document.getElementById('aiBtn').innerText = state.aiActive ? "Stop AI" : "Start AI";
        document.getElementById('aiBtn').style.background = state.aiActive ? "#ef4444" : "#c084fc";

        const total = state.wins + state.losses;
        const rate = total === 0 ? 0 : Math.round((state.wins/total)*100);
        document.getElementById('winRateDisplay').innerText = `${rate}%`;
        
        document.getElementById('trendAcc').innerText = `${trendBrain.getAccuracy()}%`;
        document.getElementById('trendBar').style.width = `${trendBrain.getAccuracy()}%`;
        document.getElementById('optAcc').innerText = `${optionBrain.getAccuracy()}%`;
        document.getElementById('optBar').style.width = `${optionBrain.getAccuracy()}%`;

        const tbody = document.getElementById('marketBody');
        tbody.innerHTML = '';
        STOCKS.forEach(s => {
            const row = document.createElement('tr');
            const ai = s.aiData || { trendConf: 0.5, optConf: 0.5, targetT: 0.6, action: "-", debugTag: "" };
            
            const tConf = (ai.trendConf*100).toFixed(0);
            const oConf = (ai.optConf*100).toFixed(0);
            
            const tColor = ai.trendConf > ai.targetT || ai.trendConf < (1-ai.targetT) ? 'var(--green)' : 'var(--text-dim)';
            
            row.innerHTML = `
                <td style="font-weight:bold">${s.sym}</td>
                <td>${s.price.toFixed(2)}</td>
                <td style="color:${s.currentVol > s.baseVol*1.5 ? 'var(--orange)':'var(--text-dim)'}">${(s.currentVol*100).toFixed(1)}%</td>
                <td>
                    <span style="color:${tColor}">Dir:${tConf}</span> | 
                    <span style="color:var(--cyan)">Conf:${oConf}</span> 
                </td>
                <td style="color:${ai.action.includes('Buy')?'var(--green)':'var(--text-dim)'}">
                    ${ai.debugTag} ${ai.action}
                </td>
            `;
            tbody.appendChild(row);
        });

        const hBody = document.getElementById('holdingsBody');
        hBody.innerHTML = '';
        state.options.forEach(o => {
            const s = STOCKS.find(x=>x.sym===o.sym);
            let curVal = 0;
            if(o.type==='call') curVal = Math.max(0, (s.price - o.strike)*10);
            if(o.type==='put') curVal = Math.max(0, (o.strike - s.price)*10);
            const pl = curVal - o.cost;
            hBody.innerHTML += `<tr><td>${o.sym} ${o.type}</td><td>${o.life}</td><td style="color:${pl>=0?'var(--green)':'var(--red)'}">$${pl.toFixed(0)}</td></tr>`;
        });
    }

    function buildChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: Array(60).fill(''),
                datasets: STOCKS.map((s,i) => ({
                    label: s.sym, data: s.history,
                    borderColor: ['#3b82f6','#10b981','#ef4444','#f59e0b','#c084fc'][i],
                    borderWidth: 2, pointRadius: 0, tension: 0.4
                }))
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { grid: { color: '#33415550' } } }
            }
        });
    }

    function updateChart() {
        if(!chart) return;
        STOCKS.forEach((s, i) => chart.data.datasets[i].data = s.history);
        chart.update('none');
    }

    function log(msg, cls) {
        const div = document.createElement('div');
        div.className = `log-item ${cls}`;
        div.innerText = `[T${state.tick}] ${msg}`;
        const l = document.getElementById('logs');
        l.prepend(div);
        if(l.children.length > 50) l.lastChild.remove();
    }

    function toggleAI() {
        state.aiActive = !state.aiActive;
        updateUI();
    }
    
    function turboTrain() {
        if(state.cash < CONFIG.optionCost) { addFunds(); }
        state.aiActive = true;
        for(let i=0; i<500; i++) tick();
        state.aiActive = false;
        log("âš¡ Turbo Complete.", "log-sys");
    }

    function resetGame() { if(confirm("Reset Simulation?")) location.reload(); }

    init();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIU Analyst Suite PRO</title>
    <style>
        :root {
            --primary-color: #1a1a1a;
            --accent-color: #fdd835; /* Madden Yellow */
            --highlight-color: rgba(253, 216, 53, 0.4);
            --text-color: #ffffff;
            --panel-bg: #2d2d2d;
            --btn-bg: #444;
            --cash-app-green: #00D632;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 50px;
            overscroll-behavior: none;
        }

        header {
            width: 100%;
            padding: 10px 0;
            background-color: var(--panel-bg);
            text-align: center;
            border-bottom: 2px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; white-space: nowrap; }

        /* --- STAGE --- */
        #stage-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            background: #000;
            padding: 10px 0;
        }

        #stage-container {
            position: relative;
            width: 95%; 
            max-width: 1600px; 
            aspect-ratio: 16 / 9; 
            background: #000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 2px solid #444;
        }

        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
            pointer-events: none; 
            touch-action: none;
        }

        .watermark {
            position: absolute;
            bottom: 2%;
            right: 2%;
            font-size: clamp(1.5rem, 5vw, 4rem);
            font-weight: 900;
            color: rgba(255, 255, 255, 0.15);
            z-index: 5;
            pointer-events: none;
            user-select: none;
            font-family: 'Arial Black', sans-serif;
        }

        /* --- CONTROLS PANEL --- */
        .controls-panel {
            width: 95%;
            max-width: 1600px;
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr; /* Playback | Drawing | Info */
            gap: 15px;
            box-sizing: border-box;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-right: 1px solid #444;
            padding-right: 15px;
        }
        .control-group:last-child { border-right: none; padding-left: 10px; padding-right: 0;}

        .group-label { font-size: 0.75rem; text-transform: uppercase; color: #888; font-weight: bold; margin-bottom: 5px; }

        /* General Button Styles */
        button, .link-btn {
            background-color: var(--btn-bg);
            color: white;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            text-decoration: none;
        }
        button:hover, .link-btn:hover { background-color: #555; }
        button:active, .link-btn:active { transform: translateY(1px); }
        
        button.active { 
            background-color: var(--accent-color); 
            color: black; 
            border-color: var(--accent-color);
        }
        
        button.danger { background-color: #d32f2f; border-color: #b71c1c;}
        button.secondary { background-color: transparent; border: 1px solid #666; }

        .cash-app-btn {
            background-color: var(--cash-app-green);
            color: white;
            border: none;
            font-weight: bold;
            margin-top: auto;
        }
        .cash-app-btn:hover { background-color: #00b82b; }

        .icon { font-size: 1.1em; line-height: 1; }

        input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #222;
            color: white;
            flex-grow: 1;
        }

        .tools-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 5px;}
        
        .color-btn {
            width: 24px; height: 24px;
            border-radius: 50%;
            border: 2px solid #fff;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .color-btn.selected { transform: scale(1.3); box-shadow: 0 0 8px rgba(255,255,255,0.5); }

        #mode-indicator {
            padding: 5px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            background: #444;
        }
        .mode-viewing { background: #2196f3; }
        .mode-drawing { background: var(--accent-color); color: black; }

        @media (max-width: 900px) {
            .controls-panel { grid-template-columns: 1fr; gap: 20px; }
            .control-group { border-right: none; border-bottom: 1px solid #444; padding-bottom: 15px; padding-left: 0; padding-right: 0;}
            .control-group:last-child { border-bottom: none; }
        }
    </style>
</head>
<body>

<header>
    <h1>TIU ANALYST PRO</h1>
    <div id="mode-indicator" class="mode-viewing">VIEWING</div>
    <button onclick="toggleFullscreen()" class="secondary" style="margin-left:auto; font-size: 0.8rem;">
        <span class="icon">&#x26F6;</span> Fullscreen
    </button>
</header>

<div id="stage-wrapper">
    <div id="stage-container">
        <div id="player"></div>
        <canvas id="drawing-canvas"></canvas>
        <div class="watermark">TIU</div>
    </div>
</div>

<div class="controls-panel">
    
    <div class="control-group">
        <div class="group-label">Source & Playback</div>
        
        <div class="tools-row">
            <input type="text" id="yt-input" placeholder="YouTube Link...">
            <button onclick="loadVideo()">Load</button>
        </div>

        <div class="tools-row" style="justify-content: space-between;">
            <button onclick="frameStep(-1)" title="Prev Frame (Left Arrow)">&#9664; Frame</button>
            <button onclick="togglePlay()" style="flex-grow: 2;">Play / Pause</button>
            <button onclick="frameStep(1)" title="Next Frame (Right Arrow)">Frame &#9654;</button>
        </div>

        <div class="tools-row">
            <span style="font-size:0.8rem; color:#aaa;">Speed:</span>
            <button onclick="setSpeed(0.25)" class="secondary">0.25x</button>
            <button onclick="setSpeed(0.5)" class="secondary">0.5x</button>
            <button onclick="setSpeed(1.0)" class="secondary">1.0x</button>
        </div>
    </div>

    <div class="control-group">
        <div class="group-label">Telestration Tools</div>
        
        <div class="tools-row">
            <button id="draw-mode-btn" onclick="toggleDrawMode()" style="flex-grow:2;">Enable Drawing</button>
            <button onclick="undoLast()" title="Undo (Ctrl+Z)"><span class="icon">&#8630;</span> Undo</button>
            <button onclick="saveDrawing()" title="Save Image"><span class="icon">&#128190;</span> Save</button>
            <button class="danger" onclick="clearCanvas()" title="Clear All"><span class="icon">&#10005;</span> Clear</button>
        </div>

        <div class="tools-row" style="background:#222; padding:5px; border-radius:4px; justify-content: space-between;">
            <div style="display:flex; gap:5px;">
                <button class="tool-btn active" id="tool-pen" onclick="setTool('pen')">Pen</button>
                <button class="tool-btn" id="tool-highlighter" onclick="setTool('highlighter')">Highlighter</button>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="shape-btn active" id="shape-free" onclick="setShape('free')">&#x2710; Free</button>
                <button class="shape-btn" id="shape-arrow" onclick="setShape('arrow')">&#8594; Arrow</button>
                <button class="shape-btn" id="shape-circle" onclick="setShape('circle')">&#9711; Circle</button>
            </div>
        </div>

        <div class="tools-row" style="margin-top: 10px;">
            <div class="color-btn selected" style="background: #fdd835;" onclick="setColor('#fdd835', this)"></div>
            <div class="color-btn" style="background: #ff0000;" onclick="setColor('#ff0000', this)"></div>
            <div class="color-btn" style="background: #ffffff;" onclick="setColor('#ffffff', this)"></div>
            <div class="color-btn" style="background: #000000;" onclick="setColor('#000000', this)"></div>
            <div class="color-btn" style="background: #00e5ff;" onclick="setColor('#00e5ff', this)"></div> 
            
            <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 0.8rem; color:#aaa;">Size</span>
                <input type="range" id="pen-size" min="2" max="20" value="4" style="width: 100px;">
            </div>
        </div>
    </div>

    <div class="control-group">
        <div class="group-label">Help & Support</div>
        <div style="font-size: 0.85rem; color: #ccc; line-height: 1.5; margin-bottom: 15px;">
            <div style="margin-bottom: 5px;">&#8226; <strong>Arrows:</strong> Drag to create.</div>
            <div style="margin-bottom: 5px;">&#8226; <strong>Keys:</strong> Left/Right arrows step frames.</div>
            <div style="margin-bottom: 5px;">&#8226; <strong>Note:</strong> Check "Allow Embedding" on your video.</div>
        </div>
        
        <div style="margin-top:auto; text-align: center;">
            <p style="margin: 0 0 8px 0; font-size: 0.8rem; color: #aaa;">Enjoying the app? Buy me a coffee!</p>
            <a href="https://cash.app/$AnthonyTiu" target="_blank" class="link-btn cash-app-btn">
                <span style="font-size:1.2em;">$</span> AnthonyTiu
            </a>
        </div>
    </div>
</div>

<script>
    // --- STATE VARIABLES ---
    let player;
    let isDrawingMode = false;
    let isDrawing = false;
    
    // Tools
    let currentTool = 'pen'; 
    let currentShape = 'free'; 
    let currentColor = '#fdd835';
    // Coordinates
    let startX = 0, startY = 0; // For Shapes
    let lastX = 0, lastY = 0;   // For Freehand
    
    // History
    let drawHistory = [];
    let historyStep = -1;

    // DOM Elements
    const canvas = document.getElementById('drawing-canvas');
    const ctx = canvas.getContext('2d');
    const stage = document.getElementById('stage-container');
    const drawBtn = document.getElementById('draw-mode-btn');
    const modeIndicator = document.getElementById('mode-indicator');

    // --- SETUP ---
    function resizeCanvas() {
        let savedData = null;
        if (canvas.width > 0 && canvas.height > 0) {
            savedData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        }
        canvas.width = stage.clientWidth;
        canvas.height = stage.clientHeight;
        if (savedData) ctx.putImageData(savedData, 0, 0);
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); 

    // --- YOUTUBE API ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            videoId: 'tVoqA-LKGb4', 
            playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1, 'origin': window.location.origin },
            events: { 'onReady': onPlayerReady, 'onError': onPlayerError }
        });
    }
    function onPlayerReady(event) { resizeCanvas(); }
    function onPlayerError(event) { if([101, 150, 153].includes(event.data)) alert("Video blocked. Try a different video."); }

    function loadVideo() {
        const input = document.getElementById('yt-input').value;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = input.match(regExp);
        const id = (match && match[2].length === 11) ? match[2] : (input.length === 11 ? input : null);
        
        if (player && id) {
            player.loadVideoById(id);
            document.getElementById('yt-input').value = ""; 
        } else {
            alert("Invalid YouTube ID/URL.");
        }
    }

    // --- CONTROLS ---
    function togglePlay() { 
        if(!player) return;
        player.getPlayerState() === 1 ? player.pauseVideo() : player.playVideo(); 
    }
    function setSpeed(rate) { if(player) player.setPlaybackRate(rate); }
    
    function frameStep(dir) {
        if(!player) return;
        player.pauseVideo();
        const currentTime = player.getCurrentTime();
        player.seekTo(currentTime + (dir * 0.04), true);
    }
    
    document.addEventListener('keydown', (e) => {
        if(e.target.tagName === 'INPUT') return; 
        if(e.key === 'ArrowRight') frameStep(1);
        if(e.key === 'ArrowLeft') frameStep(-1);
        if(e.key === 'z' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            undoLast();
        }
    });

    function toggleFullscreen() {
        if (!document.fullscreenElement) stage.requestFullscreen();
        else document.exitFullscreen();
    }
    document.addEventListener('fullscreenchange', resizeCanvas);

    // --- DRAWING ---
    function toggleDrawMode() {
        isDrawingMode = !isDrawingMode;
        if (isDrawingMode) {
            canvas.style.pointerEvents = 'auto'; 
            drawBtn.classList.add('active');
            drawBtn.innerText = "Disable Drawing";
            modeIndicator.innerText = "DRAWING";
            modeIndicator.className = "mode-drawing";
        } else {
            canvas.style.pointerEvents = 'none'; 
            drawBtn.classList.remove('active');
            drawBtn.innerText = "Enable Drawing";
            modeIndicator.innerText = "VIEWING";
            modeIndicator.className = "mode-viewing";
        }
    }

    function setColor(color, btn) {
        currentColor = color;
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }
    function setTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tool-${tool}`).classList.add('active');
    }
    function setShape(shape) {
        currentShape = shape;
        document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`shape-${shape}`).classList.add('active');
    }

    // --- UNDO ---
    function saveHistory() {
        historyStep++;
        if (historyStep < drawHistory.length) { drawHistory.length = historyStep; } 
        drawHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        if(drawHistory.length > 20) {
            drawHistory.shift();
            historyStep--;
        }
    }

    function undoLast() {
        if (historyStep > 0) {
            historyStep--;
            ctx.putImageData(drawHistory[historyStep], 0, 0);
        } else if (historyStep === 0) {
            clearCanvas();
        }
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawHistory = [];
        historyStep = -1;
    }

    function saveDrawing() {
        const link = document.createElement('a');
        link.download = 'tiu-analysis.png';
        link.href = canvas.toDataURL();
        link.click();
        alert("Drawing saved!");
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    let snapshot; 

    function startDraw(e) {
        if (!isDrawingMode) return;
        if(e.type === 'touchstart') e.preventDefault();
        
        isDrawing = true;
        const pos = getPos(e);
        
        startX = pos.x; // For shapes
        startY = pos.y;
        lastX = pos.x;  // For freehand
        lastY = pos.y;

        saveHistory(); 
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height); 

        // Important: Start a path immediately
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
    }

    function moveDraw(e) {
        if (!isDrawing || !isDrawingMode) return;
        if(e.type === 'touchmove') e.preventDefault();

        const pos = getPos(e);
        const size = document.getElementById('pen-size').value;
        
        // --- APPLY STYLES ---
        ctx.strokeStyle = currentColor;
        
        if(currentTool === 'highlighter') {
            ctx.globalAlpha = 0.3; // Lower opacity for better see-through
            ctx.lineWidth = size * 4; 
            ctx.lineCap = 'butt';  // Butt cap prevents "knots" at overlaps
        } else {
            ctx.globalAlpha = 1.0;
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
        }

        // --- DRAWING LOGIC ---
        if (currentShape === 'free') {
            // FIX: Draw segment-by-segment to prevent opacity accumulation
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            
            // Update last position for next segment
            lastX = pos.x;
            lastY = pos.y;
        } else {
            // Shapes: Clear and redraw
            ctx.putImageData(snapshot, 0, 0);
            ctx.beginPath();
            
            if (currentShape === 'arrow') {
                drawArrow(ctx, startX, startY, pos.x, pos.y, size);
            } else if (currentShape === 'circle') {
                drawCircle(ctx, startX, startY, pos.x, pos.y);
            }
            ctx.stroke();
        }
    }

    function endDraw() {
        if (!isDrawing) return;
        isDrawing = false;
        ctx.closePath();
    }

    function drawArrow(ctx, fromX, fromY, toX, toY, width) {
        // Adjust arrow head size based on highlighter/pen
        const actualWidth = currentTool === 'highlighter' ? width * 4 : width;
        const headlen = actualWidth * 3; 
        const angle = Math.atan2(toY - fromY, toX - fromX);
        
        ctx.moveTo(fromX, fromY);
        ctx.lineTo(toX, toY);
        ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
        ctx.moveTo(toX, toY);
        ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    }

    function drawCircle(ctx, x1, y1, x2, y2) {
        const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw);

    canvas.addEventListener('touchstart', startDraw, {passive: false});
    canvas.addEventListener('touchmove', moveDraw, {passive: false});
    canvas.addEventListener('touchend', endDraw);

</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIU Analyst Suite PRO - v7</title>
    <style>
        :root {
            --primary-color: #1a1a1a;
            --accent-color: #fdd835;
            --highlight-color: rgba(253, 216, 53, 0.4);
            --text-color: #ffffff;
            --panel-bg: #2d2d2d;
            --btn-bg: #444;
            --cash-app-green: #00D632;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 50px;
            overscroll-behavior: none;
        }

        header {
            width: 100%;
            padding: 10px 0;
            background-color: var(--panel-bg);
            text-align: center;
            border-bottom: 2px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; white-space: nowrap; }

        /* --- STAGE --- */
        #stage-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            background: #000;
            padding: 10px 0;
        }

        #stage-container {
            position: relative;
            width: 95%; 
            max-width: 1600px; 
            aspect-ratio: 16 / 9; 
            background: #000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 2px solid #444;
            outline: none; 
        }

        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #click-shield {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 85%;
            z-index: 5;
            cursor: pointer;
        }

        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
            pointer-events: none; 
            touch-action: none;
        }

        .watermark {
            position: absolute;
            bottom: 2%;
            right: 2%;
            font-size: clamp(1.5rem, 5vw, 4rem);
            font-weight: 900;
            color: rgba(255, 255, 255, 0.15);
            z-index: 6;
            pointer-events: none;
            user-select: none;
            font-family: 'Arial Black', sans-serif;
        }

        /* --- CONTROLS PANEL --- */
        .controls-panel {
            width: 95%;
            max-width: 1600px;
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr; 
            gap: 15px;
            box-sizing: border-box;
            max-height: 450px; 
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-right: 1px solid #444;
            padding-right: 15px;
            overflow-y: auto; 
        }
        .control-group:last-child { border-right: none; padding-left: 10px; padding-right: 0;}

        .group-label { font-size: 0.75rem; text-transform: uppercase; color: #888; font-weight: bold; margin-bottom: 5px; }

        /* General Button Styles */
        button, .link-btn {
            background-color: var(--btn-bg);
            color: white;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            text-decoration: none;
        }
        button:hover, .link-btn:hover { background-color: #555; }
        button:active, .link-btn:active { transform: translateY(1px); }
        
        button.active { 
            background-color: var(--accent-color); 
            color: black; 
            border-color: var(--accent-color);
        }
        
        button.danger { background-color: #d32f2f; border-color: #b71c1c;}
        button.secondary { background-color: transparent; border: 1px solid #666; }
        button.action { background-color: #2e7d32; border-color: #1b5e20; } /* Green for Import/Export */

        .cash-app-btn {
            background-color: var(--cash-app-green);
            color: white;
            border: none;
            font-weight: bold;
            margin-top: auto;
        }
        .cash-app-btn:hover { background-color: #00b82b; }

        .icon { font-size: 1.1em; line-height: 1; }

        input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #222;
            color: white;
            flex-grow: 1;
        }

        .tools-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 5px;}
        
        .color-btn {
            width: 24px; height: 24px;
            border-radius: 50%;
            border: 2px solid #fff;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .color-btn.selected { transform: scale(1.3); box-shadow: 0 0 8px rgba(255,255,255,0.5); }

        #mode-indicator {
            padding: 5px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            background: #444;
        }
        .mode-viewing { background: #2196f3; }
        .mode-drawing { background: var(--accent-color); color: black; }

        /* Saved Annotation List Styles */
        .annotation-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .annotation-item {
            background: #333;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .annotation-item:hover { background: #444; border-color: #666; }
        .annotation-time {
            font-family: monospace;
            background: #222;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 8px;
            color: var(--accent-color);
            font-size: 0.8rem;
        }
        .annotation-name { font-size: 0.9rem; font-weight: 500; }
        .delete-btn {
            background: transparent;
            border: none;
            color: #888;
            padding: 4px;
            font-size: 1.2em;
        }
        .delete-btn:hover { background: transparent; color: #d32f2f; }

        @media (max-width: 900px) {
            .controls-panel { grid-template-columns: 1fr; gap: 20px; max-height: none;}
            .control-group { border-right: none; border-bottom: 1px solid #444; padding-bottom: 15px; padding-left: 0; padding-right: 0; overflow: visible;}
            .control-group:last-child { border-bottom: none; }
        }
    </style>
</head>
<body>

<header>
    <h1>TIU ANALYST PRO</h1>
    <div id="mode-indicator" class="mode-viewing">VIEWING</div>
    <button onclick="toggleFullscreen()" class="secondary" style="margin-left:auto; font-size: 0.8rem;">
        <span class="icon">&#x26F6;</span> Fullscreen (F)
    </button>
</header>

<div id="stage-wrapper">
    <div id="stage-container" tabindex="0"> 
        <div id="player"></div>
        <div id="click-shield" onclick="onShieldClick()"></div>
        <canvas id="drawing-canvas"></canvas>
        <div class="watermark">TIU</div>
    </div>
</div>

<div class="controls-panel">
    
    <div class="control-group">
        <div class="group-label">Source & Playback</div>
        
        <div class="tools-row">
            <input type="text" id="yt-input" placeholder="YouTube Link...">
            <button onclick="loadVideo()">Load</button>
        </div>

        <div class="tools-row" style="justify-content: space-between;">
            <button onclick="frameStep(-1)" title="Left Arrow">&#9664; Frame</button>
            <button onclick="togglePlay()" style="flex-grow: 2;" title="Spacebar">Play / Pause</button>
            <button onclick="frameStep(1)" title="Right Arrow">Frame &#9654;</button>
        </div>

        <div class="tools-row">
            <span style="font-size:0.8rem; color:#aaa;">Speed:</span>
            <button onclick="setSpeed(0.25)" class="secondary" title="Key: 1">0.25x</button>
            <button onclick="setSpeed(0.5)" class="secondary" title="Key: 2">0.5x</button>
            <button onclick="setSpeed(1.0)" class="secondary" title="Key: 3">1.0x</button>
        </div>
        
        <div style="margin-top:auto; padding-top:10px;">
             <p style="margin: 0 0 5px 0; font-size: 0.75rem; color: #888;">SHORTCUTS</p>
             <div style="font-size: 0.75rem; color: #aaa; display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                 <span>Space: Play</span>
                 <span>P: Pen</span>
                 <span>Arrows: Seek</span>
                 <span>H: Highlight</span>
                 <span>C: Clear</span>
                 <span>F: Fullscreen</span>
             </div>
        </div>
    </div>

    <div class="control-group">
        <div class="group-label">Telestration Tools</div>
        
        <div class="tools-row">
            <button id="draw-mode-btn" onclick="toggleDrawMode()" style="flex-grow:2;">Enable Drawing</button>
            <button onclick="undoLast()" title="Ctrl+Z"><span class="icon">&#8630;</span> Undo</button>
            <button class="danger" onclick="clearCanvas()" title="Key: C"><span class="icon">&#10005;</span> Clear</button>
        </div>

        <div class="tools-row" style="background:#222; padding:5px; border-radius:4px; justify-content: space-between;">
            <div style="display:flex; gap:5px;">
                <button class="tool-btn active" id="tool-pen" onclick="setTool('pen')" title="Key: P">Pen</button>
                <button class="tool-btn" id="tool-highlighter" onclick="setTool('highlighter')" title="Key: H">Highlighter</button>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="shape-btn active" id="shape-free" onclick="setShape('free')">&#x2710; Free</button>
                <button class="shape-btn" id="shape-arrow" onclick="setShape('arrow')">&#8594; Arrow</button>
                <button class="shape-btn" id="shape-circle" onclick="setShape('circle')">&#9711; Circle</button>
            </div>
        </div>

        <div class="tools-row" style="margin-top: 10px;">
            <div class="color-btn selected" style="background: #fdd835;" onclick="setColor('#fdd835', this)"></div>
            <div class="color-btn" style="background: #ff0000;" onclick="setColor('#ff0000', this)"></div>
            <div class="color-btn" style="background: #ffffff;" onclick="setColor('#ffffff', this)"></div>
            <div class="color-btn" style="background: #000000;" onclick="setColor('#000000', this)"></div>
            <div class="color-btn" style="background: #00e5ff;" onclick="setColor('#00e5ff', this)"></div> 
            
            <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 0.8rem; color:#aaa;">Size</span>
                <input type="range" id="pen-size" min="2" max="20" value="4" style="width: 100px;">
            </div>
        </div>
        
        <button onclick="saveDrawing()" title="Download Image" class="secondary" style="margin-top: 10px; width: 100%;">
            <span class="icon">&#128190;</span> Download Screenshot
        </button>
    </div>

    <div class="control-group">
        <div class="group-label">Saved Plays & Sharing</div>
        <button onclick="saveSnapshot()" style="background-color: #2196f3; border-color: #1976d2; margin-bottom: 10px;">
            <span class="icon">&#43;</span> Save Current Frame
        </button>
        
        <ul id="annotation-list" class="annotation-list">
            <li class="annotation-item" style="justify-content:center; color:#666; cursor:default;">
                No saved plays yet.
            </li>
        </ul>

        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
             <div class="group-label">Playbook File</div>
             <div class="tools-row" style="margin-bottom: 15px;">
                 <button onclick="exportPlaybook()" class="action" title="Save to file" style="flex:1;">
                    <span class="icon">&#8681;</span> Export
                 </button>
                 <button onclick="document.getElementById('import-file').click()" class="action" title="Load from file" style="flex:1;">
                    <span class="icon">&#8682;</span> Import
                 </button>
                 <input type="file" id="import-file" accept=".json" style="display:none" onchange="importPlaybook(this)">
             </div>
        </div>

        <div style="margin-top:auto; text-align: center;">
            <p style="margin: 0 0 8px 0; font-size: 0.8rem; color: #aaa;">Enjoying the app? Buy me a coffee!</p>
            <a href="https://cash.app/$AnthonyTiu" target="_blank" class="link-btn cash-app-btn">
                <span style="font-size:1.2em;">$</span> AnthonyTiu
            </a>
        </div>
    </div>
</div>

<script>
    // --- STATE VARIABLES ---
    let player;
    let isDrawingMode = false;
    let isDrawing = false;
    let annotations = []; // Store saved plays
    
    // Tools
    let currentTool = 'pen'; 
    let currentShape = 'free'; 
    let currentColor = '#fdd835';
    let startX = 0, startY = 0; 
    let lastX = 0, lastY = 0;   
    
    // History
    let drawHistory = [];
    let historyStep = -1;

    // DOM Elements
    const canvas = document.getElementById('drawing-canvas');
    const ctx = canvas.getContext('2d');
    const stage = document.getElementById('stage-container');
    const drawBtn = document.getElementById('draw-mode-btn');
    const modeIndicator = document.getElementById('mode-indicator');
    const shield = document.getElementById('click-shield');
    const annotationListEl = document.getElementById('annotation-list');

    // --- SETUP ---
    function resizeCanvas() {
        let savedData = null;
        if (canvas.width > 0 && canvas.height > 0) {
            savedData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        }
        canvas.width = stage.clientWidth;
        canvas.height = stage.clientHeight;
        if (savedData) ctx.putImageData(savedData, 0, 0);
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); 

    // --- YOUTUBE API ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            videoId: 'tVoqA-LKGb4', 
            playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1, 'origin': window.location.origin },
            events: { 
                'onReady': onPlayerReady, 
                'onError': onPlayerError,
                'onStateChange': onPlayerStateChange 
            }
        });
    }
    function onPlayerReady(event) { resizeCanvas(); }
    function onPlayerError(event) { if([101, 150, 153].includes(event.data)) alert("Video blocked. Try a different video."); }
    
    // AUTO-CLEAR CANVAS ON PLAY
    function onPlayerStateChange(event) {
        if (event.data === 1) { // 1 = Playing
            clearCanvas();
        }
    }

    function loadVideo(optionalId) {
        let id = optionalId;
        if (!id) {
            const input = document.getElementById('yt-input').value;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = input.match(regExp);
            id = (match && match[2].length === 11) ? match[2] : (input.length === 11 ? input : null);
        }
        
        if (player && id) {
            player.loadVideoById(id);
            document.getElementById('yt-input').value = ""; 
            if(!optionalId) { 
                // Only clear if manual load, otherwise we are importing
                annotations = []; 
                renderAnnotations();
            }
            clearCanvas();
        } else {
            alert("Invalid YouTube ID/URL.");
        }
    }

    // --- CONTROLS ---
    function onShieldClick() {
        stage.focus();
        togglePlay();
    }
    
    document.addEventListener('mousemove', (e) => {
        if (document.fullscreenElement && e.target === shield || e.target === canvas) {
            if (document.activeElement !== stage) {
                stage.focus();
            }
        }
    });

    function togglePlay() { 
        if(!player) return;
        player.getPlayerState() === 1 ? player.pauseVideo() : player.playVideo(); 
    }
    function setSpeed(rate) { if(player) player.setPlaybackRate(rate); }
    
    function frameStep(dir) {
        if(!player) return;
        player.pauseVideo();
        const currentTime = player.getCurrentTime();
        player.seekTo(currentTime + (dir * 0.04), true);
    }
    
    function seekVideo(seconds) {
        if(!player) return;
        const currentTime = player.getCurrentTime();
        player.seekTo(currentTime + seconds, true);
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            stage.requestFullscreen().then(() => {
                setTimeout(() => { stage.focus(); }, 100);
            }).catch(err => {
                console.log(`Error attempting to enable fullscreen: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }
    document.addEventListener('fullscreenchange', () => {
        resizeCanvas();
        if (document.fullscreenElement) {
            setTimeout(() => { stage.focus(); }, 100);
        }
    });

    // --- ANNOTATIONS SYSTEM ---
    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function saveSnapshot() {
        if (!player) return;
        
        const defaultName = "Play " + (annotations.length + 1);
        const name = prompt("Name this saved play:", defaultName);
        if (name === null) return; 

        const time = player.getCurrentTime();
        const imageData = canvas.toDataURL(); 
        
        annotations.push({
            id: Date.now(),
            time: time,
            image: imageData,
            name: name || defaultName
        });
        
        annotations.sort((a, b) => a.time - b.time);
        renderAnnotations();
        alert("Play saved!");
    }

    function loadAnnotation(id) {
        const note = annotations.find(a => a.id === id);
        if (!note) return;

        player.seekTo(note.time, true);
        player.pauseVideo();

        const img = new Image();
        img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            saveHistory();
        };
        img.src = note.image;
    }

    function deleteAnnotation(id, event) {
        event.stopPropagation();
        if(confirm("Delete this saved play?")) {
            annotations = annotations.filter(a => a.id !== id);
            renderAnnotations();
        }
    }

    function renderAnnotations() {
        if (annotations.length === 0) {
            annotationListEl.innerHTML = `<li class="annotation-item" style="justify-content:center; color:#666; cursor:default;">No saved plays yet.</li>`;
            return;
        }

        annotationListEl.innerHTML = "";
        annotations.forEach(note => {
            const li = document.createElement('li');
            li.className = 'annotation-item';
            li.onclick = () => loadAnnotation(note.id);
            li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span class="annotation-time">${formatTime(note.time)}</span>
                    <span class="annotation-name">${note.name}</span>
                </div>
                <button class="delete-btn" onclick="deleteAnnotation(${note.id}, event)">&#10005;</button>
            `;
            annotationListEl.appendChild(li);
        });
    }

    // --- EXPORT / IMPORT LOGIC (NEW) ---
    function exportPlaybook() {
        if (!player) { alert("No video loaded."); return; }
        if (annotations.length === 0) { alert("No plays saved to export."); return; }

        // Create data object
        const videoData = player.getVideoData();
        const playbook = {
            videoId: videoData.video_id,
            videoTitle: videoData.title,
            created: new Date().toISOString(),
            plays: annotations
        };

        // Create file blob
        const dataStr = JSON.stringify(playbook);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

        // Trigger download
        const exportFileDefaultName = 'playbook-' + new Date().toISOString().slice(0,10) + '.json';
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    }

    function importPlaybook(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const playbook = JSON.parse(e.target.result);
                
                if (!playbook.videoId || !playbook.plays) {
                    throw new Error("Invalid Playbook File");
                }

                // Load the video from the file
                loadVideo(playbook.videoId);
                
                // Load the annotations
                annotations = playbook.plays;
                renderAnnotations();
                
                alert(`Loaded ${annotations.length} plays for video: ${playbook.videoTitle || 'Unknown'}`);
            } catch (err) {
                alert("Error loading file: " + err.message);
            }
        };
        reader.readAsText(file);
        
        // Reset input so same file can be selected again if needed
        inputElement.value = '';
    }

    // --- KEYBOARD LISTENERS ---
    document.addEventListener('keydown', (e) => {
        if(e.target.tagName === 'INPUT') return;
        if(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) e.preventDefault();

        switch(e.key.toLowerCase()) {
            case ' ':
            case 'k': togglePlay(); break;
            case 'arrowleft': frameStep(-1); break;
            case 'arrowright': frameStep(1); break;
            case 'arrowup': seekVideo(5); break;
            case 'arrowdown': seekVideo(-5); break;
            case 'f': toggleFullscreen(); break;
            case 'c': clearCanvas(); break;
            case 'z': if(e.ctrlKey || e.metaKey) { e.preventDefault(); undoLast(); } break;
            case 'p': setTool('pen'); break;
            case 'h': setTool('highlighter'); break;
            case '1': setSpeed(0.25); break;
            case '2': setSpeed(0.5); break;
            case '3': setSpeed(1.0); break;
        }
    });

    // --- DRAWING ---
    function toggleDrawMode() {
        isDrawingMode = !isDrawingMode;
        if (isDrawingMode) {
            canvas.style.pointerEvents = 'auto';
            shield.style.pointerEvents = 'none'; 
            drawBtn.classList.add('active');
            drawBtn.innerText = "Disable Drawing";
            modeIndicator.innerText = "DRAWING";
            modeIndicator.className = "mode-drawing";
        } else {
            canvas.style.pointerEvents = 'none'; 
            shield.style.pointerEvents = 'auto';
            drawBtn.classList.remove('active');
            drawBtn.innerText = "Enable Drawing";
            modeIndicator.innerText = "VIEWING";
            modeIndicator.className = "mode-viewing";
        }
    }

    function setColor(color, btn) {
        currentColor = color;
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }
    function setTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tool-${tool}`).classList.add('active');
    }
    function setShape(shape) {
        currentShape = shape;
        document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`shape-${shape}`).classList.add('active');
    }

    // --- UNDO ---
    function saveHistory() {
        historyStep++;
        if (historyStep < drawHistory.length) { drawHistory.length = historyStep; } 
        drawHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        if(drawHistory.length > 20) {
            drawHistory.shift();
            historyStep--;
        }
    }

    function undoLast() {
        if (historyStep > 0) {
            historyStep--;
            ctx.putImageData(drawHistory[historyStep], 0, 0);
        } else if (historyStep === 0) {
            clearCanvas();
        }
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawHistory = [];
        historyStep = -1;
    }

    function saveDrawing() {
        const link = document.createElement('a');
        link.download = 'tiu-analysis.png';
        link.href = canvas.toDataURL();
        link.click();
        alert("Image downloaded!");
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    let snapshot; 

    function startDraw(e) {
        if (!isDrawingMode) return;
        if(e.type === 'touchstart') e.preventDefault();
        
        isDrawing = true;
        const pos = getPos(e);
        
        startX = pos.x; 
        startY = pos.y;
        lastX = pos.x;  
        lastY = pos.y;

        saveHistory(); 
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height); 

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
    }

    function moveDraw(e) {
        if (!isDrawing || !isDrawingMode) return;
        if(e.type === 'touchmove') e.preventDefault();

        const pos = getPos(e);
        const size = document.getElementById('pen-size').value;
        
        ctx.strokeStyle = currentColor;
        
        if(currentTool === 'highlighter') {
            ctx.globalAlpha = 0.3; 
            ctx.lineWidth = size * 4; 
            ctx.lineCap = 'butt';  
        } else {
            ctx.globalAlpha = 1.0;
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
        }

        if (currentShape === 'free') {
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastX = pos.x;
            lastY = pos.y;
        } else {
            ctx.putImageData(snapshot, 0, 0);
            ctx.beginPath();
            
            if (currentShape === 'arrow') {
                drawArrow(ctx, startX, startY, pos.x, pos.y, size);
            } else if (currentShape === 'circle') {
                drawCircle(ctx, startX, startY, pos.x, pos.y);
            }
            ctx.stroke();
        }
    }

    function endDraw() {
        if (!isDrawing) return;
        isDrawing = false;
        ctx.closePath();
    }

    function drawArrow(ctx, fromX, fromY, toX, toY, width) {
        const actualWidth = currentTool === 'highlighter' ? width * 4 : width;
        const headlen = actualWidth * 3; 
        const angle = Math.atan2(toY - fromY, toX - fromX);
        
        ctx.moveTo(fromX, fromY);
        ctx.lineTo(toX, toY);
        ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
        ctx.moveTo(toX, toY);
        ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    }

    function drawCircle(ctx, x1, y1, x2, y2) {
        const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw);

    canvas.addEventListener('touchstart', startDraw, {passive: false});
    canvas.addEventListener('touchmove', moveDraw, {passive: false});
    canvas.addEventListener('touchend', endDraw);

</script>

</body>
</html>
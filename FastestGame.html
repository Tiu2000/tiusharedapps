<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom P2P Quiz 3.0</title>
    <style>
        :root { --primary: #4f46e5; --success: #22c55e; --danger: #ef4444; --bg: #f3f4f6; --card: #ffffff; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { max-width: 800px; width: 100%; text-align: center; }
        .screen { display: none; background: var(--card); padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .screen.active { display: block; }
        input, select { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; width: 80%; margin: 10px 0; }
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; margin: 5px; }
        button:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .answer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .answer-btn { background: #e0e7ff; color: #3730a3; font-size: 1.2rem; min-height: 80px; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 1.2rem; }
        .correct { background: var(--success) !important; color: white !important; }
        .wrong { background: var(--danger) !important; color: white !important; }
        .stat-box { background: #f8fafc; padding: 10px; border-radius: 8px; display: inline-block; margin: 5px; font-weight: bold; }
        .timer-bar { height: 10px; background: #e5e7eb; border-radius: 5px; margin: 20px 0; overflow: hidden; }
        .timer-fill { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        
        /* Status Banner */
        #network-status { padding: 10px; margin-bottom: 15px; border-radius: 8px; width: 100%; display: none; }
        .status-error { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
        .status-ok { background: #dcfce7; color: #166534; border: 1px solid #4ade80; }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Speed Quiz P2P</h1>

    <div id="network-status"></div>

    <div id="screen-entry" class="screen active">
        <p>Are you the Teacher (Host) or a Student?</p>
        <button onclick="setupHost()" id="btn-host" disabled>Host Game (Teacher)</button>
        <button onclick="setupJoin()" id="btn-join" disabled>Join Game (Student)</button>
        
        <div id="manual-load-area" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <p style="font-size:0.9rem; color:#666;">Still stuck? Your internet is blocking the library.</p>
            <p><strong>Fix:</strong> Download <a href="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js" target="_blank">peerjs.min.js</a>, save it in the same folder as this file, then click below:</p>
            <button onclick="loadScript('local')" style="background:#4b5563;">I have saved the file locally</button>
        </div>
    </div>

    <div id="screen-host-lobby" class="screen">
        <h2>Host Lobby</h2>
        <div class="stat-box">Game ID: <span id="display-id" style="color:var(--primary); font-size:1.5em; user-select: all;">...</span></div>
        <p>Share this ID with your students.</p>
        <select id="grade-select">
            <option value="elementary">Elementary (Grades 1-5)</option>
            <option value="middle">Middle School (Grades 6-8)</option>
            <option value="high">High School (Grades 9-12)</option>
            <option value="coding">Computer Science (Bonus)</option>
        </select>
        <h3>Connected Students: <span id="host-player-count">0</span></h3>
        <ul id="player-list" style="list-style: none; padding: 0; color: #666;"></ul>
        <button onclick="startGame()">Start Game</button>
    </div>

    <div id="screen-join" class="screen">
        <h2>Join Class</h2>
        <input type="text" id="join-id" placeholder="Enter Game ID (from board)">
        <input type="text" id="player-name" placeholder="Your Name">
        <button onclick="joinGame()">Connect</button>
        <p id="join-status" style="color: #666;"></p>
    </div>

    <div id="screen-question" class="screen">
        <div style="display:flex; justify-content:space-between;">
            <span class="stat-box" id="q-counter">Q: 1/10</span>
            <span class="stat-box" id="score-display">Score: 0</span>
        </div>
        <div class="timer-bar"><div class="timer-fill" id="timer-bar"></div></div>
        <h2 id="q-text" style="font-size: 1.8rem;">Question</h2>
        <div class="answer-grid" id="options-container"></div>
        <p id="feedback-text" style="font-weight: bold; font-size: 1.5rem; height: 30px;"></p>
    </div>

    <div id="screen-leaderboard" class="screen">
        <h2>Results</h2>
        <div id="leaderboard-list"></div>
        <br>
        <div id="host-controls" style="display:none;"><button onclick="nextQuestion()">Next Question</button></div>
        <p id="waiting-msg" style="display:none;">Waiting for teacher...</p>
    </div>

    <div id="screen-final" class="screen">
        <h2>üèÜ Game Over! üèÜ</h2>
        <div id="final-podium"></div>
        <button onclick="location.reload()">Play Again</button>
    </div>
</div>

<script>
/* ---------------- LIBRARY LOADER (The Fix) ---------------- */
const SOURCES = [
    "https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js",       // Source 1
    "https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js", // Source 2
    "peerjs.min.js"                                             // Local Backup
];

function setStatus(msg, type) {
    const el = document.getElementById('network-status');
    el.style.display = 'block';
    el.innerHTML = msg;
    el.className = type === 'error' ? 'status-error' : 'status-ok';
}

function loadScript(sourceIndex) {
    if (sourceIndex === 'local') sourceIndex = 2; // Jump to local
    if (sourceIndex >= SOURCES.length) {
        setStatus("‚ùå Failed to load PeerJS. Firewall is blocking all sources.<br>Please use the download instructions below.", "error");
        document.getElementById('manual-load-area').style.display = 'block';
        return;
    }

    setStatus(`Attempting to load network library (Source ${sourceIndex+1})...`, "normal");
    
    const script = document.createElement('script');
    script.src = SOURCES[sourceIndex];
    script.onload = () => {
        setStatus("‚úÖ System Ready! Library Loaded.", "ok");
        document.getElementById('btn-host').disabled = false;
        document.getElementById('btn-join').disabled = false;
        document.getElementById('manual-load-area').style.display = 'none';
    };
    script.onerror = () => {
        console.log("Failed source " + sourceIndex);
        loadScript(sourceIndex + 1); // Try next source
    };
    document.head.appendChild(script);
}

// Start loading immediately
loadScript(0);

/* ---------------- GAME LOGIC ---------------- */
const QUESTION_BANK = {
    elementary: [
        { q: "What is 5 x 8?", options: ["35", "40", "45", "42"], a: 1 },
        { q: "Which planet is closest to the sun?", options: ["Venus", "Mars", "Mercury", "Earth"], a: 2 },
        { q: "How many states are in the USA?", options: ["48", "50", "52", "13"], a: 1 },
        { q: "Which animal lays eggs?", options: ["Dog", "Cat", "Chicken", "Cow"], a: 2 },
        { q: "H2O is the chemical formula for?", options: ["Salt", "Air", "Water", "Gold"], a: 2 },
        { q: "Who was the first US President?", options: ["Lincoln", "Washington", "Jefferson", "Adams"], a: 1 },
        { q: "How many legs does a spider have?", options: ["6", "8", "10", "4"], a: 1 },
        { q: "What color do you get mixing Blue and Yellow?", options: ["Purple", "Orange", "Green", "Brown"], a: 2 },
        { q: "What is the opposite of 'Cold'?", options: ["Hot", "Freeze", "Ice", "Snow"], a: 0 }
    ],
    middle: [
        { q: "Solve for x: 2x + 4 = 12", options: ["2", "3", "4", "6"], a: 2 },
        { q: "What is the powerhouse of the cell?", options: ["Nucleus", "Ribosome", "Mitochondria", "Cytoplasm"], a: 2 },
        { q: "Which ancient civilization built the pyramids?", options: ["Romans", "Greeks", "Egyptians", "Mayans"], a: 2 },
        { q: "Who wrote 'Romeo and Juliet'?", options: ["Dickens", "Hemingway", "Shakespeare", "Twain"], a: 2 },
        { q: "What gas do plants absorb from the atmosphere?", options: ["Oxygen", "Carbon Dioxide", "Nitrogen", "Helium"], a: 1 },
        { q: "Which continent is the Sahara Desert in?", options: ["Asia", "South America", "Africa", "Australia"], a: 2 },
        { q: "Start of WWI?", options: ["1914", "1918", "1939", "1945"], a: 0 }
    ],
    high: [
        { q: "Derivative of x^2?", options: ["x", "2x", "x^2", "2"], a: 1 },
        { q: "Atomic number 6 is?", options: ["Oxygen", "Carbon", "Nitrogen", "Iron"], a: 1 },
        { q: "Author of '1984'?", options: ["Huxley", "Orwell", "Bradbury", "Fitzgerald"], a: 1 },
        { q: "Year Berlin Wall fell?", options: ["1987", "1989", "1991", "1985"], a: 1 },
        { q: "F = ma refers to?", options: ["Newton's 1st", "Newton's 2nd", "Newton's 3rd", "Relativity"], a: 1 },
        { q: "Genetic information molecule?", options: ["RNA", "Protein", "DNA", "Lipid"], a: 2 },
        { q: "Pi to 2 decimals?", options: ["3.12", "3.14", "3.16", "3.18"], a: 1 },
        { q: "Symbol for Gold?", options: ["Ag", "Au", "Fe", "Pb"], a: 1 }
    ],
    coding: [
        { q: "What does HTML stand for?", options: ["Hyper Text Markup Language", "Home Tool Markup Language", "No idea", "None"], a: 0 },
        { q: "ID symbol in CSS?", options: ".", "#", "@", "$", a: 1 },
        { q: "Web logic language?", options: ["Java", "Python", "JavaScript", "C++"], a: 2 },
        { q: "Array start index?", options: ["1", "0", "-1", "null"], a: 1 },
        { q: "Boolean value?", options: ["Text", "Number", "True/False", "List"], a: 2 }
    ]
};

let peer=null, conn=null, connections=[], isHost=false, myName="", currentQuestions=[], currentQIndex=0, timeRemaining=0, timerInterval=null, hasAnswered=false, players={};
const QUESTION_TIME=15, MAX_POINTS=1000;

function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

function setupHost() {
    isHost = true;
    try {
        peer = new Peer(null, { debug: 2 });
        peer.on('open', (id) => { document.getElementById('display-id').innerText = id; showScreen('screen-host-lobby'); });
        peer.on('error', (err) => alert("Error: " + err.type));
        peer.on('connection', (c) => {
            c.on('data', (d) => handleHostData(c, d));
            c.on('open', () => connections.push(c));
        });
    } catch(e) { alert("PeerJS failed to start. Check library loaded."); }
}

function handleHostData(conn, data) {
    if (data.type === 'JOIN') {
        players[conn.peer] = { name: data.name, score: 0 };
        updatePlayerList();
    }
    if (data.type === 'ANSWER') {
        const p = players[conn.peer];
        if (p && currentQuestions[currentQIndex]) {
            if (data.answerIndex === currentQuestions[currentQIndex].a) {
                p.score += Math.floor(MAX_POINTS * (data.timeLeft / QUESTION_TIME));
            }
        }
    }
}

function updatePlayerList() {
    const list = document.getElementById('player-list');
    list.innerHTML = '';
    const arr = Object.values(players);
    document.getElementById('host-player-count').innerText = arr.length;
    arr.forEach(p => { const li = document.createElement('li'); li.innerText = `üë§ ${p.name}`; list.appendChild(li); });
}

function startGame() {
    const grade = document.getElementById('grade-select').value;
    currentQuestions = QUESTION_BANK[grade];
    currentQIndex = 0;
    broadcast({ type: 'START_GAME', totalQ: currentQuestions.length });
    runQuestion();
}

function runQuestion() {
    if (currentQIndex >= currentQuestions.length) return finishGame();
    const q = currentQuestions[currentQIndex];
    renderQuestion(q, currentQIndex + 1, currentQuestions.length);
    showScreen('screen-question');
    document.getElementById('host-controls').style.display = 'none';
    broadcast({ type: 'NEW_QUESTION', q: q, index: currentQIndex + 1, total: currentQuestions.length });
    startTimer(QUESTION_TIME, () => showLeaderboard());
}

function showLeaderboard() {
    const sorted = Object.values(players).sort((a, b) => b.score - a.score);
    let html = '';
    sorted.forEach((p, i) => html += `<div class="leaderboard-item"><span>#${i+1} ${p.name}</span><span>${p.score} pts</span></div>`);
    document.getElementById('leaderboard-list').innerHTML = html;
    showScreen('screen-leaderboard');
    document.getElementById('host-controls').style.display = 'block';
    broadcast({ type: 'SHOW_LEADERBOARD', data: sorted.map(p => ({name: p.name, score: p.score})) });
}

function nextQuestion() { currentQIndex++; runQuestion(); }
function finishGame() {
    showScreen('screen-final');
    const sorted = Object.values(players).sort((a, b) => b.score - a.score);
    let html = '';
    if(sorted[0]) html += `<h3 style="color:gold">ü•á ${sorted[0].name} (${sorted[0].score})</h3>`;
    if(sorted[1]) html += `<h3 style="color:silver">ü•à ${sorted[1].name} (${sorted[1].score})</h3>`;
    document.getElementById('final-podium').innerHTML = html;
    broadcast({ type: 'GAME_OVER', html: html });
}
function broadcast(d) { connections.forEach(c => c.send(d)); }

/* CLIENT */
function setupJoin() { showScreen('screen-join'); }
function joinGame() {
    const id = document.getElementById('join-id').value;
    myName = document.getElementById('player-name').value || "Student";
    if(!id) return alert("Enter ID");
    document.getElementById('join-status').innerText = "Connecting...";
    peer = new Peer();
    peer.on('open', () => {
        conn = peer.connect(id);
        conn.on('open', () => { document.getElementById('join-status').innerText = "Connected!"; conn.send({ type: 'JOIN', name: myName }); });
        conn.on('data', handleStudentData);
        conn.on('error', (e) => alert("Error: " + e));
    });
}
function handleStudentData(data) {
    if (data.type === 'NEW_QUESTION') { hasAnswered = false; renderQuestion(data.q, data.index, data.total); showScreen('screen-question'); startTimer(QUESTION_TIME); }
    if (data.type === 'SHOW_LEADERBOARD') { renderLeaderboard(data.data); showScreen('screen-leaderboard'); document.getElementById('waiting-msg').style.display = 'block'; }
    if (data.type === 'GAME_OVER') { document.getElementById('final-podium').innerHTML = data.html; showScreen('screen-final'); }
}
function sendAnswer(idx) {
    if (hasAnswered) return;
    hasAnswered = true;
    const qData = isHost ? currentQuestions[currentQIndex] : window.lastReceivedQ;
    const btns = document.querySelectorAll('.answer-btn');
    if (idx === qData.a) { btns[idx].classList.add('correct'); document.getElementById('feedback-text').innerText = "Correct!"; document.getElementById('feedback-text').style.color="var(--success)"; }
    else { btns[idx].classList.add('wrong'); document.getElementById('feedback-text').innerText = "Wrong!"; document.getElementById('feedback-text').style.color="var(--danger)"; }
    if (!isHost) conn.send({ type: 'ANSWER', answerIndex: idx, timeLeft: timeRemaining });
}
function renderQuestion(q, i, t) {
    if(!isHost) window.lastReceivedQ = q;
    document.getElementById('q-counter').innerText = `Q: ${i}/${t}`;
    document.getElementById('q-text').innerText = q.q;
    document.getElementById('feedback-text').innerText = "";
    const c = document.getElementById('options-container'); c.innerHTML = '';
    q.options.forEach((opt, idx) => {
        const b = document.createElement('button'); b.className = 'answer-btn'; b.innerText = opt;
        b.onclick = () => sendAnswer(idx); c.appendChild(b);
    });
}
function renderLeaderboard(data) {
    let html = '';
    data.forEach((p, i) => html += `<div class="leaderboard-item" style="${p.name===myName?'background:#e0e7ff':''}"><span>#${i+1} ${p.name}</span><span>${p.score} pts</span></div>`);
    document.getElementById('leaderboard-list').innerHTML = html;
}
function startTimer(s, cb) {
    clearInterval(timerInterval); timeRemaining = s;
    const b = document.getElementById('timer-bar'); b.style.width='100%'; b.style.transition='none';
    setTimeout(() => { b.style.transition=`width ${s}s linear`; b.style.width='0%'; }, 10);
    timerInterval = setInterval(() => { timeRemaining -= 0.1; if(timeRemaining<=0) { clearInterval(timerInterval); if(cb) cb(); } }, 100);
}
</script>
</body>
</html>
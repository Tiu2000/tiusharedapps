<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Quiz 7.0 (Diagnostic)</title>
    
    <script src="peerjs.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; }
        body { font-family: monospace; background: var(--bg); padding: 20px; text-align: center; }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        /* DIAGNOSTIC LOG BOX */
        .debug-box { 
            background: #000; 
            color: #00ff00; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: left; 
            height: 150px; 
            overflow-y: auto; 
            margin-bottom: 20px;
            border: 2px solid #333;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .card { background: white; padding: 2rem; border-radius: 1rem; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: sans-serif; }
        .active { display: block; }

        button { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; margin: 10px; width: 80%; max-width: 300px; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }

        input { padding: 15px; font-size: 1.5rem; text-align: center; width: 60%; border: 2px solid #ccc; border-radius: 8px; text-transform: uppercase; letter-spacing: 3px; }

        .big-code { font-size: 4rem; font-weight: bold; color: var(--primary); letter-spacing: 5px; margin: 10px 0; font-family: monospace; }
        
        /* Game Elements */
        .timer-bar { height: 10px; background: #ddd; margin: 20px 0; border-radius: 5px; }
        .timer-fill { height: 100%; background: var(--primary); width: 100%; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .opt-btn { background: #e0e7ff; color: #3730a3; padding: 20px; font-size: 1.1rem; border: none; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üõ†Ô∏è Quiz 7.0 (Diagnostic)</h1>

    <div class="debug-box" id="log">Waiting for system check...<br></div>

    <div id="s-menu" class="card active">
        <p>System Status: <span id="sys-status">Checking...</span></p>
        <button onclick="initHost()" id="btn-host" disabled>Host Game</button>
        <button onclick="showJoin()" id="btn-join" disabled>Join Game</button>
    </div>

    <div id="s-host" class="card">
        <h2>Host Lobby</h2>
        <div class="big-code" id="room-code">...</div>
        <p>Ask students to enter this code.</p>
        <div style="background:#f8fafc; padding:10px; text-align:left;">
            <strong>Players:</strong> <span id="p-list">Waiting...</span>
        </div>
        <br>
        <button onclick="startGame()">Start Game</button>
    </div>

    <div id="s-join" class="card">
        <h2>Enter 4-Letter Code</h2>
        <input type="text" id="join-input" maxlength="4" placeholder="ABCD">
        <input type="text" id="name-input" placeholder="Your Name" style="font-size:1rem; margin-top:10px; text-transform:none;">
        <button onclick="joinGame()">Connect</button>
    </div>

    <div id="s-game" class="card">
        <div class="timer-bar"><div id="timer" class="timer-fill"></div></div>
        <h2 id="q-text">Loading...</h2>
        <div id="opts" class="grid"></div>
        <h3 id="feedback"></h3>
    </div>

    <div id="s-result" class="card">
        <h2>üèÜ Results</h2>
        <div id="lb-list" style="text-align:left;"></div>
        <div id="host-controls" style="display:none; margin-top:20px;">
            <button onclick="nextQ()">Next Question</button>
        </div>
        <p id="wait-msg" style="display:none;">Waiting for teacher...</p>
    </div>
</div>

<script>
// --- LOGGER ---
function log(msg, color='#00ff00') {
    const box = document.getElementById('log');
    const time = new Date().toLocaleTimeString().split(' ')[0];
    box.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
    box.scrollTop = box.scrollHeight;
}

// --- INITIAL CHECK ---
window.onload = function() {
    log("Checking for PeerJS library...", "white");
    if (typeof Peer === 'undefined') {
        log("‚ùå CRITICAL: 'peerjs.min.js' MISSING or BLOCKED.", "red");
        log("Ensure file is in the same folder.", "orange");
        document.getElementById('sys-status').innerText = "Library Missing";
        document.getElementById('sys-status').style.color = "red";
    } else {
        log("‚úÖ Library found. System Ready.", "cyan");
        document.getElementById('btn-host').disabled = false;
        document.getElementById('btn-join').disabled = false;
        document.getElementById('sys-status').innerText = "Ready";
        document.getElementById('sys-status').style.color = "green";
    }
};

// --- GLOBALS ---
let peer, conn, players={}, myName="", isHost=false, qList=[], qIdx=0;
const Q_TIME=15;

// --- HOST ---
function initHost() {
    // Generate Random 4-Letter Code
    const code = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789".split('').sort(()=>0.5-Math.random()).slice(0,4).join('');
    
    log(`Attempting to create Room: ${code}`, "yellow");
    document.getElementById('btn-host').innerText = "Creating...";

    try {
        peer = new Peer(code);
        
        peer.on('open', (id) => {
            log(`‚úÖ Server Created! Room Code: ${id}`, "#00ff00");
            isHost = true;
            document.getElementById('room-code').innerText = id;
            show('s-host');
        });

        peer.on('error', (err) => {
            log(`‚ùå Error: ${err.type}`, "red");
            if(err.type === 'unavailable') {
                log("Code taken, retrying...", "orange");
                setTimeout(initHost, 500); // Retry automatically
            }
        });

        peer.on('connection', (c) => {
            log(`Student connecting: ${c.peer}`, "cyan");
            c.on('open', () => {
                log(`‚úÖ Student ${c.peer} Joined`, "#00ff00");
                c.send({type:'WELCOME'});
            });
            c.on('data', (d) => handleData(c, d));
        });
        
    } catch(e) {
        log("‚ùå Crash: " + e, "red");
    }
}

// --- JOIN ---
function showJoin() { show('s-join'); }

function joinGame() {
    const code = document.getElementById('join-input').value.toUpperCase();
    myName = document.getElementById('name-input').value || "Student";
    
    if(code.length !== 4) return log("‚ö†Ô∏è Code must be 4 letters", "orange");
    
    log(`Connecting to Room ${code}...`, "yellow");
    
    peer = new Peer(); // Auto ID for student
    
    peer.on('open', (myId) => {
        log(`My Student ID: ${myId}`, "cyan");
        conn = peer.connect(code);
        
        conn.on('open', () => {
            log("‚úÖ Connected to Teacher!", "#00ff00");
            conn.send({type:'JOIN', name: myName});
            document.getElementById('join-input').style.borderColor = "green";
        });
        
        conn.on('data', clientHandle);
        
        conn.on('error', (e) => log("Connection Fail: "+e, "red"));
        
        // Timeout check
        setTimeout(() => {
            if(!conn.open) log("‚ö†Ô∏è Connection timed out. Check Code or Firewall.", "orange");
        }, 4000);
    });
    
    peer.on('error', (e) => log("Peer Error: " + e.type, "red"));
}

// --- DATA HANDLERS ---
function handleData(c, d) {
    if(d.type === 'JOIN') {
        players[c.peer] = { conn: c, name: d.name, score: 0 };
        log(`${d.name} joined the lobby.`, "white");
        updateLobby();
    }
    if(d.type === 'ANSWER') {
        // Scoring logic
        const p = players[c.peer];
        if(p && qList[qIdx] && d.idx === qList[qIdx].a) {
            p.score += Math.floor(1000 * (d.time / Q_TIME));
        }
    }
}

function clientHandle(d) {
    if(d.type === 'Q') {
        log("Received Question", "cyan");
        renderQ(d.q, d.opts, d.num, d.total);
        show('s-game');
        runTimer();
    }
    if(d.type === 'LB') {
        log("Round Over. Showing Results.", "white");
        renderLB(d.data);
        show('s-result');
        document.getElementById('host-controls').style.display = 'none';
        document.getElementById('wait-msg').style.display = 'block';
    }
}

// --- GAME LOGIC ---
const QUESTIONS = [
    {q:"5 x 8 = ?", opts:["35","40","45","42"], a:1},
    {q:"Capital of France?", opts:["London","Berlin","Paris","Rome"], a:2},
    {q:"H2O is?", opts:["Gold","Water","Air","Fire"], a:1},
    {q:"Fastest Animal?", opts:["Cheetah","Lion","Horse","Eagle"], a:0}
];

function startGame() {
    log("Starting Game...", "yellow");
    qList = QUESTIONS;
    qIdx = 0;
    runRound();
}

function runRound() {
    if(qIdx >= qList.length) return finishGame();
    
    const q = qList[qIdx];
    // Host UI
    renderQ(q.q, q.opts, qIdx+1, qList.length);
    show('s-game');
    document.getElementById('host-controls').style.display = 'none';
    
    // Broadcast
    const payload = { type:'Q', q:q.q, opts:q.opts, num:qIdx+1, total:qList.length };
    Object.values(players).forEach(p => p.conn.send(payload));
    
    runTimer(() => showScores());
}

function showScores() {
    const sorted = Object.values(players).sort((a,b) => b.score - a.score);
    const data = sorted.map(p => ({name:p.name, score:p.score}));
    
    renderLB(data);
    show('s-result');
    document.getElementById('host-controls').style.display = 'block';
    
    Object.values(players).forEach(p => p.conn.send({type:'LB', data:data}));
}

function nextQ() { qIdx++; runRound(); }
function finishGame() {
    showScores();
    log("Game Over", "cyan");
    document.getElementById('lb-list').innerHTML = "<h2>üéâ Game Over!</h2>" + document.getElementById('lb-list').innerHTML;
    document.getElementById('host-controls').style.display = 'none';
}

// --- SHARED UI ---
function show(id) {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function updateLobby() {
    const names = Object.values(players).map(p => p.name).join(', ');
    document.getElementById('p-list').innerText = names || "Waiting...";
}

function renderQ(txt, opts, n, t) {
    document.getElementById('q-text').innerText = txt;
    const div = document.getElementById('opts');
    div.innerHTML = '';
    opts.forEach((o, i) => {
        div.innerHTML += `<button class="opt-btn" onclick="submitAns(${i})">${o}</button>`;
    });
}

function submitAns(i) {
    document.querySelectorAll('.opt-btn')[i].style.background = "#4f46e5";
    document.querySelectorAll('.opt-btn')[i].style.color = "white";
    if(!isHost) conn.send({type:'ANSWER', idx:i, time:timeLeft});
}

function renderLB(data) {
    let html = '';
    data.forEach((p, i) => {
        html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #ddd; ${p.name===myName?'background:#e0e7ff':''}">
            <span>#${i+1} ${p.name}</span><span>${p.score} pts</span></div>`;
    });
    document.getElementById('lb-list').innerHTML = html;
}

let timeLeft, timerInt;
function runTimer(cb) {
    clearInterval(timerInt);
    timeLeft = Q_TIME;
    document.getElementById('timer').style.width = '100%';
    document.getElementById('timer').style.transition = `width ${Q_TIME}s linear`;
    setTimeout(()=>document.getElementById('timer').style.width='0%', 50);
    
    timerInt = setInterval(() => {
        timeLeft -= 1;
        if(timeLeft <= 0) {
            clearInterval(timerInt);
            if(cb) cb();
        }
    }, 1000);
}
</script>
</body>
</html>
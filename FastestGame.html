<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU Quiz 13.0 (Fixed Display)</title>
    <script src="peerjs.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <style>
        :root { --primary: #4f46e5; --accent: #8b5cf6; --bg: #f8fafc; --text: #1e293b; --success: #22c55e; --danger: #ef4444; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; overflow-x: hidden; }
        
        .watermark { position: fixed; bottom: 20px; right: 20px; font-size: 8rem; font-weight: 900; color: rgba(0,0,0,0.03); pointer-events: none; z-index: 0; user-select: none; font-family: 'Courier New', monospace; }
        .container { max-width: 900px; width: 100%; margin: 0 auto; z-index: 1; position: relative; margin-top: 50px; /* Space for code at top */ }
        .card { background: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); text-align: center; display: none; }
        .active { display: block; animation: slideUp 0.4s ease; }
        
        h1 { color: var(--primary); margin-bottom: 10px; }
        button { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin: 10px; width: 100%; max-width: 300px; transition: transform 0.1s; }
        button:hover { transform: translateY(-3px); }
        
        input, select, textarea { padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1.1rem; width: 100%; max-width: 400px; margin-bottom: 15px; }
        textarea { font-family: monospace; text-align: left; height: 150px; width: 90%; max-width: 90%; resize: vertical; }

        /* HOST UI */
        .room-code { font-size: 5rem; font-weight: 900; color: var(--primary); font-family: monospace; letter-spacing: 8px; margin: 20px 0; background: #f1f5f9; padding: 20px; border-radius: 20px; border: 3px dashed #cbd5e1; }
        
        /* PERSISTENT CODE DISPLAY (FIXED POSITION) */
        .persistent-code {
            position: fixed;      /* Sticks to the viewport */
            top: 15px;            /* 15px from top */
            right: 15px;          /* 15px from right */
            background: #1e293b;
            color: #fff;
            padding: 10px 20px;
            border-radius: 12px;
            font-family: monospace;
            font-weight: 900;
            font-size: 1.5rem;
            letter-spacing: 3px;
            z-index: 9999;        /* Always on top */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;        /* Hidden in lobby */
            border: 2px solid #fff;
        }

        /* STUDENT MANAGER */
        #student-manager { position: fixed; bottom: 20px; left: 20px; z-index: 100; text-align: left; }
        #mgr-toggle { background: #1e293b; width: auto; font-size: 0.9rem; padding: 10px 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        #mgr-panel { display: none; background: white; border-radius: 12px; padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 250px; max-height: 400px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .mgr-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .mgr-kick { color: var(--danger); cursor: pointer; font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        .mgr-kick:hover { background: #fee2e2; }

        /* HOST GAME BOARD */
        .timer-bar { height: 15px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin: 20px 0; }
        .timer-fill { height: 100%; background: var(--primary); width: 100%; }
        
        .host-q-text { font-size: 2.5rem; font-weight: 800; margin-bottom: 30px; color: #1e293b; }
        .host-opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; }
        .host-opt { background: #f8fafc; padding: 25px; border-radius: 15px; border: 3px solid #e2e8f0; font-size: 1.5rem; font-weight: 600; color: #64748b; }
        
        /* PLAYER GAMEPAD */
        .player-opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .opt-btn { background: white; border: 2px solid #e2e8f0; color: var(--text); padding: 20px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; min-height: 80px; transition: all 0.2s; }
        .opt-btn:active { transform: scale(0.95); }
        .opt-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="watermark">TIU</div>

<div id="student-manager" style="display:none;">
    <div id="mgr-panel">
        <h4 style="margin:0 0 10px 0; color:#64748b;">Active Students</h4>
        <div id="mgr-list"></div>
    </div>
    <button id="mgr-toggle" onclick="toggleMgr()">üë• Students (<span id="mgr-count">0</span>)</button>
</div>

<div id="live-code" class="persistent-code">CODE: <span id="live-code-val">----</span></div>

<div class="container">

    <div id="s-menu" class="card active">
        <h1>üéì TIU Quiz 13.0</h1>
        <p>Select your role:</p>
        <button onclick="setupHost()">üëë Host (Teacher)</button>
        <button onclick="setupJoin()" style="background:white; border:2px solid var(--primary); color:var(--primary)">üë§ Join (Student)</button>
    </div>

    <div id="s-host-lobby" class="card">
        <h2>Teacher Lobby</h2>
        <div class="room-code" id="room-code-display">...</div>
        
        <label>Select Grade Level:</label><br>
        <select id="grade-select" onchange="toggleCustomArea()">
            <option value="kg">üß∏ Kindergarten</option>
            <option value="g1">1st Grade</option>
            <option value="g2">2nd Grade</option>
            <option value="g3">3rd Grade</option>
            <option value="g4">4th Grade</option>
            <option value="g5">5th Grade</option>
            <option value="g6">6th Grade</option>
            <option value="g7">7th Grade</option>
            <option value="g8">8th Grade</option>
            <option value="hs">High School</option>
            <option value="custom">‚ú® Create Custom Quiz</option>
        </select>

        <div id="custom-area" style="display:none; text-align: left; background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <p style="margin-top:0; font-size:0.9rem; font-weight:bold;">Format: Question | Opt1, Opt2, Opt3, Opt4 | CorrectNum(1-4)</p>
            <textarea id="custom-input" placeholder="What is 2+2? | 3, 4, 5, 6 | 2"></textarea>
        </div>

        <p style="color:#64748b;">Waiting for students to join...</p>
        <button onclick="startGame()">üöÄ Start Game</button>
    </div>

    <div id="s-host-game" class="card">
        <div style="display:flex; justify-content:space-between; font-weight:bold; color:#64748b; font-size: 1.2rem;">
            <span id="h-counter">Q 1/10</span>
            <span>Display Mode</span>
        </div>
        <div class="timer-bar"><div id="h-timer" class="timer-fill"></div></div>
        
        <div id="h-q-text" class="host-q-text">Question Text</div>
        <div id="h-options" class="host-opt-grid"></div>
    </div>

    <div id="s-join" class="card">
        <h2>Join Class</h2>
        <input type="text" id="join-code" placeholder="CODE" maxlength="4" style="text-transform:uppercase; font-weight:bold; letter-spacing:5px;">
        <input type="text" id="join-name" placeholder="Your Name">
        <button onclick="joinGame()">Enter</button>
        <p id="join-status" style="min-height:20px;"></p>
    </div>

    <div id="s-player-game" class="card">
        <div style="display:flex; justify-content:space-between; font-weight:bold; color:#64748b;">
            <span id="p-counter">Q 1/10</span>
            <span id="p-score">Score: 0</span>
        </div>
        <div class="timer-bar"><div id="p-timer" class="timer-fill"></div></div>
        <h2 id="p-q-text" style="font-size:1.5rem;">...</h2>
        <div id="p-options" class="player-opt-grid"></div>
        <h3 id="p-feedback" style="height:30px;"></h3>
    </div>

    <div id="s-results" class="card">
        <h2 id="res-title">üèÜ Leaderboard</h2>
        <div id="lb-list" style="text-align:left; margin:20px 0;"></div>
        <div id="host-controls" style="display:none;">
            <button onclick="nextQuestion()">Next Question ‚û°Ô∏è</button>
        </div>
        <p id="wait-msg" style="display:none;">Waiting for teacher...</p>
    </div>

</div>

<script>
/* --- SOUND ENGINE --- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    if (type === 'end') {
        [440, 554, 659, 880].forEach((freq, i) => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value = freq; g.gain.value = 0.2; o.start(audioCtx.currentTime + i*0.1); o.stop(audioCtx.currentTime + i*0.1 + 0.4);
        });
    }
}

/* --- STATE --- */
const Q_TIME = 20;
let peer, conn, myName="", isHost=false, roomCode="";
let players={}, qList=[], qIdx=0, timerInt, timeRem;
let gameState = "LOBBY";

// --- HOST LOGIC ---
function setupHost() {
    roomCode = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789".split('').sort(()=>0.5-Math.random()).slice(0,4).join('');
    document.getElementById('room-code-display').innerText = "Loading...";
    peer = new Peer(roomCode);
    
    peer.on('open', (id) => {
        isHost = true;
        document.getElementById('room-code-display').innerText = id;
        document.getElementById('live-code-val').innerText = id; // Set persistent code
        document.getElementById('student-manager').style.display = 'block';
        show('s-host-lobby');
    });
    
    peer.on('connection', (c) => {
        c.on('data', (d) => {
            if(d.type==='JOIN') { 
                players[c.peer] = {conn:c, name:d.name, score:0, id:c.peer}; 
                updateMgr(); 
                // AUTO LATE JOIN: Sync immediately
                if(gameState === "QUESTION") {
                    c.send({type:'Q', q:qList[qIdx].q, opts:qList[qIdx].o, n:qIdx+1, t:qList.length});
                } else if(gameState === "LEADERBOARD") {
                    const data = Object.values(players).map(p=>({name:p.name, score:p.score})).sort((a,b)=>b.score-a.score);
                    c.send({type:'LB', data:data});
                }
            }
            if(d.type==='ANS') {
                if(players[c.peer] && qList[qIdx] && d.idx === qList[qIdx].a) {
                    players[c.peer].score += Math.floor(1000 * (d.rem/Q_TIME));
                }
            }
        });
    });
}

function updateMgr() {
    const list = Object.values(players);
    document.getElementById('mgr-count').innerText = list.length;
    const div = document.getElementById('mgr-list');
    div.innerHTML = '';
    list.forEach(p => {
        div.innerHTML += `<div class="mgr-item"><span>üë§ ${p.name}</span><span class="mgr-kick" onclick="kickPlayer('${p.id}')">KICK ‚úï</span></div>`;
    });
}

function kickPlayer(id) {
    if(players[id]) {
        players[id].conn.send({type:'KICKED'});
        players[id].conn.close();
        delete players[id];
        updateMgr();
    }
}

function toggleMgr() {
    const panel = document.getElementById('mgr-panel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}

function toggleCustomArea() {
    const val = document.getElementById('grade-select').value;
    document.getElementById('custom-area').style.display = (val === 'custom') ? 'block' : 'none';
}

function startGame() {
    const grade = document.getElementById('grade-select').value;
    if (grade === 'custom') {
        const raw = document.getElementById('custom-input').value;
        qList = [];
        raw.split('\n').forEach(line => {
            const p = line.split('|');
            if(p.length>=3) qList.push({q:p[0].trim(), o:p[1].split(','), a:parseInt(p[2])-1});
        });
        if(!qList.length) return alert("Invalid Questions");
    } else {
        qList = DB[grade].sort(()=>0.5-Math.random()).slice(0, 50);
    }
    qIdx = 0;
    // Show persistent code now that we are leaving the lobby
    document.getElementById('live-code').style.display = 'block';
    runRound();
}

function runRound() {
    if(qIdx >= qList.length) return endGame();
    gameState = "QUESTION";
    const q = qList[qIdx];
    
    // HOST DISPLAY
    document.getElementById('h-counter').innerText = `Question ${qIdx+1}/${qList.length}`;
    document.getElementById('h-q-text').innerText = q.q;
    const hOptDiv = document.getElementById('h-options');
    hOptDiv.innerHTML = '';
    q.o.forEach((opt, i) => {
        hOptDiv.innerHTML += `<div class="host-opt">${["A","B","C","D"][i]}. ${opt}</div>`;
    });
    show('s-host-game');
    
    // PLAYERS
    const data = { type:'Q', q:q.q, opts:q.o, n:qIdx+1, t:qList.length };
    Object.values(players).forEach(p => p.conn.send(data));
    
    startTimer(Q_TIME, () => {
        showResults();
        playSound('end');
    });
}

function showResults() {
    gameState = "LEADERBOARD";
    const data = Object.values(players).map(p=>({name:p.name, score:p.score})).sort((a,b)=>b.score-a.score);
    renderLB(data);
    document.getElementById('res-title').innerText = "üìä Round Results";
    document.getElementById('host-controls').style.display='block';
    show('s-results');
    Object.values(players).forEach(p => p.conn.send({type:'LB', data:data}));
}

function nextQuestion() { qIdx++; runRound(); }
function endGame() { 
    showResults(); 
    document.getElementById('res-title').innerText = "üèÜ Final Podium"; 
    document.getElementById('host-controls').style.display='none'; 
}

// --- CLIENT ---
function setupJoin() { show('s-join'); }
function joinGame() {
    const code = document.getElementById('join-code').value.toUpperCase();
    myName = document.getElementById('join-name').value || "Guest";
    if(code.length!==4) return;
    peer = new Peer();
    peer.on('open', () => {
        conn = peer.connect(code);
        conn.on('open', () => { conn.send({type:'JOIN', name:myName}); });
        conn.on('data', (d) => {
            if(d.type==='Q') { 
                document.getElementById('p-counter').innerText = `Q ${d.n}/${d.t}`;
                document.getElementById('p-q-text').innerText = d.q;
                const div = document.getElementById('p-options'); div.innerHTML='';
                d.opts.forEach((o,i) => {
                    const btn = document.createElement('button'); btn.className='opt-btn'; btn.innerText=o;
                    btn.onclick=()=>submitAns(i); div.appendChild(btn);
                });
                document.getElementById('p-feedback').innerText = "";
                show('s-player-game'); 
                startTimer(Q_TIME); 
            }
            if(d.type==='LB') { 
                renderLB(d.data); 
                document.getElementById('wait-msg').style.display='block'; 
                document.getElementById('host-controls').style.display='none';
                show('s-results'); 
            }
            if(d.type==='KICKED') { alert("Removed from game"); location.reload(); }
        });
    });
}

function submitAns(i) {
    document.querySelectorAll('.opt-btn').forEach(b => b.style.opacity='0.5');
    document.querySelectorAll('.opt-btn')[i].style.opacity='1';
    document.querySelectorAll('.opt-btn')[i].classList.add('selected');
    document.getElementById('p-feedback').innerText = "Answer Sent!";
    conn.send({type:'ANS', idx:i, rem:timeRem});
}

// --- UTILS ---
function show(id) { document.querySelectorAll('.card').forEach(c=>c.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function renderLB(data) {
    document.getElementById('lb-list').innerHTML = data.map((p,i) => 
        `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #eee; ${p.name===myName?'background:#e0e7ff; font-weight:bold;':''}">
            <span>${i===0?'ü•á ':i===1?'ü•à ':i===2?'ü•â ':''}#${i+1} ${p.name}</span><span>${p.score}</span>
        </div>`
    ).join('');
}
function startTimer(s, cb) {
    clearInterval(timerInt); timeRem = s;
    const bars = [document.getElementById('h-timer'), document.getElementById('p-timer')];
    bars.forEach(b => { b.style.transition='none'; b.style.width='100%'; });
    setTimeout(()=> { bars.forEach(b => { b.style.transition=`width ${s}s linear`; b.style.width='0%'; }); }, 50);
    timerInt = setInterval(()=> { timeRem -= 1; if(timeRem <= 0) { clearInterval(timerInt); if(cb) cb(); } }, 1000);
}

// --- DB (With Kindergarten) ---
const DB = {
    kg: [{q:"1 + 1 = ?", o:["1","2","3","4"], a:1}, {q:"What color is the sky?", o:["Green","Blue","Red","Purple"], a:1}, {q:"What sound does a cow make?", o:["Meow","Woof","Moo","Quack"], a:2}, {q:"Which is a fruit?", o:["Carrot","Apple","Bread","Chicken"], a:1}],
    g1: [{q:"5 + 5 = ?", o:["9","10","11","12"], a:1}, {q:"Sun color?", o:["Blue","Yellow","Green","Red"], a:1}],
    g2: [{q:"15 + 10 = ?", o:["20","25","30","35"], a:1}, {q:"Solid?", o:["Water","Rock","Air","Steam"], a:1}],
    g3: [{q:"5 x 5 = ?", o:["20","25","30","35"], a:1}, {q:"Verb?", o:["Run","Blue","Table","Hot"], a:0}],
    g4: [{q:"Capital of USA?", o:["NY","LA","DC","Chicago"], a:2}, {q:"40 / 8 = ?", o:["4","5","6","8"], a:1}],
    g5: [{q:"Prime?", o:["4","6","7","9"], a:2}, {q:"H2O?", o:["Hydrogen","Oxygen","Water","Helium"], a:2}],
    g6: [{q:"Mean of 2, 4, 6?", o:["2","3","4","5"], a:2}, {q:"Atom center?", o:["Nucleus","Electron","Proton","Shell"], a:0}],
    g7: [{q:"2x + 5 = 15", o:["2","3","4","5"], a:3}, {q:"Mitosis is?", o:["Cell Division","Math","History","Map"], a:0}],
    g8: [{q:"a^2+b^2=c^2", o:["Newton","Einstein","Pythagoras","Tesla"], a:2}, {q:"Protons charge?", o:["Pos","Neg","Neut","None"], a:0}],
    hs: [{q:"Derivative x^2?", o:["x","2x","2","x^2"], a:1}, {q:"Mitochondria?", o:["Powerhouse","Brain","Skin","Wall"], a:0}]
};
</script>
</body>
</html>
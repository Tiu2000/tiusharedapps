<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU LifeTrack Pro v4</title>
    <style>
        :root {
            --primary: #29b6f6;
            --primary-dark: #0288d1;
            --secondary: #66bb6a;
            --bg: #f4f7f6;
            --surface: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --danger: #ef5350;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Layout Engine (PC & Mobile) --- */
        .app-container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            margin: 0 auto; position: relative; background: var(--surface);
        }

        /* PC Mode */
        @media (min-width: 768px) {
            .app-container {
                max-width: 1100px; height: 95vh; margin-top: 2.5vh;
                border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
                border: 1px solid #dcdcdc; overflow: hidden;
            }
            .dashboard-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; height: 100%; overflow: hidden; }
            .col-left { overflow-y: auto; padding: 20px; padding-bottom: 100px; }
            .col-right { background: #f9f9f9; border-left: 1px solid #eee; padding: 20px; overflow-y: auto; padding-bottom: 100px; }
        }
        
        /* Mobile Mode */
        @media (max-width: 767px) {
            .dashboard-grid { display: block; height: 100%; overflow-y: auto; }
            .col-left, .col-right { padding: 20px; padding-bottom: 0; }
            .col-right { padding-bottom: 90px; } 
        }

        /* --- Watermark --- */
        .watermark {
            position: absolute; bottom: 85px; right: 20px;
            font-size: 3.5rem; font-weight: 900; color: #000; opacity: 0.04;
            pointer-events: none; z-index: 0; transform: rotate(-10deg); font-family: 'Arial Black', sans-serif;
            user-select: none;
        }

        /* --- Header --- */
        .header {
            padding: 15px 25px; background: var(--surface);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; z-index: 10;
        }
        .header h1 { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--primary-dark); }
        .date-display { font-size: 0.8rem; color: var(--text-light); }

        /* --- Cards --- */
        .card {
            background: white; border-radius: 16px; padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 15px;
            border: 1px solid #f0f0f0; position: relative; z-index: 2;
        }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 700; font-size: 0.95rem; }

        /* --- Visuals --- */
        .summary-wrapper { display: flex; align-items: center; justify-content: space-between; }
        .ring-container { position: relative; width: 120px; height: 120px; }
        svg.ring { transform: rotate(-90deg); width: 120px; height: 120px; }
        circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .c-bg { stroke: #f0f0f0; }
        .c-val { stroke: var(--primary); stroke-dasharray: 314; stroke-dashoffset: 314; transition: 1s ease; }
        .ring-data { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .ring-num { font-size: 1.5rem; font-weight: 800; display: block; }
        .ring-txt { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; }

        .stats-list { text-align: right; flex: 1; padding-left: 20px; display: flex; flex-direction: column; gap: 10px; }
        .stat-item { display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding-bottom: 5px; font-size: 0.9rem; }

        /* --- Macros --- */
        .macro-flex { display: flex; gap: 10px; margin-top: 20px; }
        .macro-col { flex: 1; }
        .bar-bg { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.5s; }
        .macro-meta { font-size: 0.75rem; color: var(--text-light); display: flex; justify-content: space-between; font-weight: 600; }
        .p-fill { background: #9b59b6; } .c-fill { background: #f1c40f; } .f-fill { background: #e74c3c; }

        /* --- Reports (Charts) --- */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 200px; padding-top: 20px; gap: 5px; }
        .chart-col { display: flex; flex-direction: column; align-items: center; flex: 1; height: 100%; justify-content: flex-end; }
        .chart-bar-group { display: flex; width: 100%; height: 100%; align-items: flex-end; justify-content: center; gap: 2px; }
        .chart-bar { width: 12px; background: var(--primary); border-radius: 4px 4px 0 0; min-height: 2px; position: relative; transition: height 0.3s; }
        .chart-bar.burn { background: var(--secondary); }
        .chart-label { font-size: 0.65rem; color: #999; margin-top: 8px; transform: rotate(-45deg); height: 20px; }
        .legend { display: flex; gap: 15px; font-size: 0.8rem; justify-content: center; margin-bottom: 10px; }
        .legend span { display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        /* --- Water & Fasting --- */
        .water-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin: 10px 0; }
        .drop { height: 35px; background: #e1f5fe; border-radius: 6px; cursor: pointer; border: 1px solid #b3e5fc; }
        .drop.active { background: var(--primary); border-color: var(--primary-dark); }
        .timer-box { font-size: 2rem; font-family: monospace; font-weight: 700; text-align: center; margin: 10px 0; color: var(--text); background: #f9f9f9; padding: 10px; border-radius: 8px; }

        /* --- Navigation --- */
        .nav { position: absolute; bottom: 0; width: 100%; height: 75px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 20; padding-bottom: 10px; }
        .nav-item { background: none; border: none; color: var(--text-light); font-size: 0.75rem; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { display: block; font-size: 1.5rem; margin-bottom: 4px; }
        .fab { position: absolute; bottom: 45px; left: 50%; transform: translateX(-50%); width: 64px; height: 64px; background: var(--primary); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; box-shadow: 0 4px 15px rgba(41, 182, 246, 0.4); border: 4px solid var(--surface); cursor: pointer; z-index: 25; }

        /* --- Modal --- */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 50; display: none; flex-direction: column; }
        .modal.active { display: flex; }
        .modal-head { padding: 20px; border-bottom: 1px solid #eee; display: flex; gap: 15px; align-items: center; background: #fff; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; max-width: 800px; margin: 0 auto; width: 100%; }
        
        .tab-bar { display: flex; padding: 10px; gap: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .tab { padding: 8px 16px; border-radius: 20px; border: 1px solid #ddd; background: white; font-size: 0.85rem; cursor: pointer; flex: 1; text-align: center; font-weight: 600; }
        .tab.active { background: var(--text); color: white; border-color: var(--text); }

        /* UI Elements */
        input, select { width: 100%; padding: 14px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .btn.secondary { background: #555; }
        .btn.danger { background: var(--danger); }

        .res-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .res-item:hover { background: #f9f9f9; }
        .log-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; font-size: 0.9rem; align-items: center; }

        /* Toggle */
        .switch-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        .view { display: none; height: 100%; }
        .view.active { display: block; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="watermark">TIU</div>

    <div class="header">
        <div>
            <div class="date-display" id="dateDisp">Today</div>
            <h1 id="viewTitle">Dashboard</h1>
        </div>
        <div style="width:35px; height:35px; background:var(--primary); color:white; border-radius:50%; display:flex;align-items:center;justify-content:center;font-weight:bold;">ME</div>
    </div>

    <div id="view-home" class="view active">
        <div class="dashboard-grid">
            <div class="col-left">
                <div class="card">
                    <div class="card-header">Calories Today</div>
                    <div class="summary-wrapper">
                        <div class="ring-container">
                            <svg class="ring">
                                <circle cx="60" cy="60" r="50" class="c-bg"></circle>
                                <circle cx="60" cy="60" r="50" class="c-val" id="ringProgress"></circle>
                            </svg>
                            <div class="ring-data">
                                <span class="ring-num" id="valRemain">0</span>
                                <span class="ring-txt">Left</span>
                            </div>
                        </div>
                        <div class="stats-list">
                            <div class="stat-item"><span>Goal</span> <b id="valGoal">2000</b></div>
                            <div class="stat-item"><span>Food</span> <b id="valEaten">0</b></div>
                            <div class="stat-item"><span>Exercise</span> <b id="valBurned" style="color:var(--secondary)">0</b></div>
                        </div>
                    </div>
                    <div class="macro-flex">
                        <div class="macro-col">
                            <div class="bar-bg"><div class="bar-fill p-fill" id="barProt"></div></div>
                            <div class="macro-meta"><span>Prot</span><span id="txtProt">0g</span></div>
                        </div>
                        <div class="macro-col">
                            <div class="bar-bg"><div class="bar-fill c-fill" id="barCarb"></div></div>
                            <div class="macro-meta"><span>Carb</span><span id="txtCarb">0g</span></div>
                        </div>
                        <div class="macro-col">
                            <div class="bar-bg"><div class="bar-fill f-fill" id="barFat"></div></div>
                            <div class="macro-meta"><span>Fat</span><span id="txtFat">0g</span></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Hydration</div>
                    <div class="water-grid" id="waterGrid"></div>
                </div>
            </div>

            <div class="col-right">
                <div class="card">
                    <div class="card-header">Fasting Timer</div>
                    <div class="timer-box" id="fastTimer">--:--:--</div>
                    <button class="btn" id="btnFast" onclick="toggleFast()">Start Fast</button>
                </div>

                <div class="card">
                    <div class="card-header">Today's Logs</div>
                    <div id="logList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-reports" class="view">
        <div style="padding:20px;">
            <div class="card">
                <div class="card-header">Last 7 Days (Calories)</div>
                <div class="legend">
                    <span><div class="dot" style="background:var(--primary)"></div> In</span>
                    <span><div class="dot" style="background:var(--secondary)"></div> Out</span>
                </div>
                <div class="chart-container" id="reportChart"></div>
            </div>
            
            <div class="card">
                <div class="card-header">Weekly Insights</div>
                <div id="weeklyStats" style="font-size:0.9rem; line-height:1.6; color:#555;">Log data to see stats.</div>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view">
        <div style="padding:20px; max-width:600px; margin:0 auto;">
            <div class="card">
                <div class="card-header">Settings</div>
                <div class="switch-container">
                    <span>Units (Kg / Lbs)</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="unitToggle" onchange="toggleUnits()">
                        <span class="slider"></span>
                    </label>
                </div>
                <label>Current Weight <span id="lblWeightUnit">(kg)</span></label>
                <input type="number" id="inpWeight" onchange="saveProfile()" placeholder="70">
                <label>Daily Calorie Target</label>
                <input type="number" id="inpGoal" onchange="saveProfile()">
            </div>

            <div class="card">
                <div class="card-header">Google Drive Backup</div>
                <p style="font-size:0.85rem; color:#666;">
                    1. Click "Save File" to download your data.<br>
                    2. Upload that file to your Google Drive manually.<br>
                    3. To restore on another device, download the file from Drive and click "Restore" here.
                </p>
                <button class="btn secondary" onclick="exportData()">üíæ Save File (Download)</button>
                <button class="btn secondary" onclick="document.getElementById('fileImp').click()" style="margin-top:10px;">üìÇ Restore from File</button>
                <input type="file" id="fileImp" style="display:none" onchange="importData(this)">
            </div>
            
            <button class="btn danger" onclick="resetApp()">Reset All Data</button>
        </div>
    </div>

    <div class="nav">
        <button class="nav-item active" onclick="goView('home', this)"><span class="nav-icon">üè†</span> Home</button>
        <button class="nav-item" onclick="goView('reports', this); renderReports()"><span class="nav-icon">üìä</span> Reports</button>
        <div style="width:60px;"></div>
        <button class="nav-item" onclick="alert('Social features coming soon!')"><span class="nav-icon">üë•</span> Social</button>
        <button class="nav-item" onclick="goView('profile', this)"><span class="nav-icon">‚öôÔ∏è</span> Profile</button>
    </div>

    <div class="fab" onclick="openAdd()">+</div>

    <div class="modal" id="modalAdd">
        <div class="modal-head">
            <button style="border:none; background:none; font-size:1.5rem;" onclick="closeAdd()">‚úï</button>
            <h3>Add Entry</h3>
        </div>
        <div class="tab-bar">
            <div class="tab active" onclick="tab('food')" id="t-food">Food</div>
            <div class="tab" onclick="tab('ex')" id="t-ex">Exercise</div>
            <div class="tab" onclick="tab('cust')" id="t-cust">Create</div>
        </div>
        <div class="modal-body">
            
            <div id="p-food">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="searchQ" placeholder="Search (e.g. Banana)..." onkeypress="if(event.key==='Enter') doSearch()">
                    <button class="btn" style="width:auto; margin:0; margin-bottom:10px;" onclick="doSearch()">üîç</button>
                </div>
                <div id="searchOut"></div>
            </div>

            <div id="p-ex" style="display:none;">
                <label>Activity</label>
                <select id="exType" onchange="calcBurn()">
                    <option value="3.0">Walking (Casual)</option>
                    <option value="4.0">Walking (Brisk)</option>
                    <option value="5.0">Elliptical (Moderate)</option>
                    <option value="7.0">Elliptical (Vigorous)</option>
                    <option value="8.0">Running (5 mph)</option>
                    <option value="10.0">Running (6 mph)</option>
                    <option value="11.5">Running (7 mph)</option>
                    <option value="8.0">HIIT / Circuit Training</option>
                    <option value="7.0">Rowing</option>
                    <option value="6.0">Weight Lifting</option>
                    <option value="7.0">Swimming</option>
                    <option value="6.0">Hiking</option>
                    <option value="3.5">Pilates</option>
                    <option value="3.0">Yoga</option>
                    <option value="4.5">Dancing</option>
                    <option value="10.0">Jump Rope</option>
                    <option value="3.0">House Cleaning</option>
                </select>
                <label>Duration (Minutes)</label>
                <input type="number" id="exMin" placeholder="30" onkeyup="calcBurn()">
                <div style="text-align:center; padding:15px; background:#e3f2fd; border-radius:8px; margin:10px 0;">
                    <span style="font-size:0.9rem">Estimated Burn:</span>
                    <br><strong style="font-size:1.5rem; color:var(--primary)" id="exVal">0</strong> kcal
                </div>
                <button class="btn" onclick="addEx()">Log Workout</button>
            </div>

            <div id="p-cust" style="display:none;">
                <label>Name</label> <input id="cName" type="text">
                <label>Calories</label> <input id="cCal" type="number">
                <div style="display:flex; gap:10px;">
                    <input id="cP" type="number" placeholder="Prot (g)">
                    <input id="cC" type="number" placeholder="Carb (g)">
                    <input id="cF" type="number" placeholder="Fat (g)">
                </div>
                <button class="btn" onclick="saveCustom()">Save</button>
            </div>

        </div>
    </div>
</div>

<script>
    // --- STATE ---
    const DB_KEY = 'tiu_track_v4';
    let state = {
        profile: { weight: 70, goal: 2000, unit: 'metric' },
        water: 0,
        logs: [],
        custom: [],
        fast: { on: false, start: null }
    };

    // --- INIT ---
    function init() {
        const saved = localStorage.getItem(DB_KEY);
        if(saved) state = JSON.parse(saved);
        
        document.getElementById('dateDisp').innerText = new Date().toDateString();
        
        // Setup Inputs
        const isImp = state.profile.unit === 'imperial';
        document.getElementById('unitToggle').checked = isImp;
        document.getElementById('inpGoal').value = state.profile.goal;
        
        updateWeightInput();
        renderHome();
        setInterval(updateTimer, 1000);
    }

    function save() {
        localStorage.setItem(DB_KEY, JSON.stringify(state));
        renderHome();
    }

    function renderHome() {
        const todayStr = new Date().toISOString().split('T')[0];
        const todayLogs = state.logs.filter(l => new Date(l.date).toISOString().split('T')[0] === todayStr);
        
        let eat = 0, burn = 0, p=0, c=0, f=0;
        todayLogs.forEach(l => {
            if(l.type === 'food') {
                eat += l.cal; p += (l.p||0); c += (l.c||0); f += (l.f||0);
            } else {
                burn += l.cal;
            }
        });

        const goal = parseInt(state.profile.goal);
        const remain = goal - eat + burn;
        
        // Update DOM
        document.getElementById('valGoal').innerText = goal;
        document.getElementById('valEaten').innerText = eat;
        document.getElementById('valBurned').innerText = burn;
        document.getElementById('valRemain').innerText = remain;
        document.getElementById('txtProt').innerText = p+'g';
        document.getElementById('txtCarb').innerText = c+'g';
        document.getElementById('txtFat').innerText = f+'g';

        // Bars
        const setBar = (id, val, max) => document.getElementById(id).style.width = Math.min((val/max)*100, 100)+'%';
        setBar('barProt', p, 150); setBar('barCarb', c, 250); setBar('barFat', f, 70);

        // Ring
        const pct = Math.min(eat / (goal + burn), 1);
        document.getElementById('ringProgress').style.strokeDashoffset = 314 - (314 * pct);

        // Water
        const wDiv = document.getElementById('waterGrid');
        wDiv.innerHTML = '';
        for(let i=0; i<8; i++) {
            wDiv.innerHTML += `<div class="drop ${i<state.water?'active':''}" onclick="setWater(${i})"></div>`;
        }

        // List
        const lDiv = document.getElementById('logList');
        lDiv.innerHTML = todayLogs.length ? '' : '<div style="color:#ccc; text-align:center; padding:10px;">No logs today</div>';
        todayLogs.slice().reverse().forEach(l => {
            const isF = l.type === 'food';
            lDiv.innerHTML += `
            <div class="log-item">
                <div><b>${l.name}</b> <span style="color:#999; font-size:0.8rem">${isF ? `(P${l.p} C${l.c})` : 'Exercise'}</span></div>
                <div style="font-weight:bold; color:${isF?'#333':'var(--secondary)'}">${isF?'+':'-'}${l.cal}</div>
            </div>`;
        });

        const btn = document.getElementById('btnFast');
        btn.innerText = state.fast.on ? "End Fast" : "Start Fast";
        btn.style.background = state.fast.on ? "var(--danger)" : "var(--primary)";
    }

    // --- SEARCH API (DIRECT FIX FOR HOSTED SITES) ---
    async function doSearch() {
        const q = document.getElementById('searchQ').value;
        const out = document.getElementById('searchOut');
        
        // Custom Check
        const customs = state.custom.filter(c => c.name.toLowerCase().includes(q.toLowerCase()));
        let html = '';
        if(customs.length) {
            html += `<b>My Foods</b>`;
            customs.forEach(c => html += renderRes(c.name, c.cal, c.p, c.c, c.f, 'Custom'));
        }

        out.innerHTML = html + '<div style="color:#888; margin-top:10px;">Searching database...</div>';

        if(q.length > 2) {
            try {
                // DIRECT API CALL (Works best on hosted sites)
                const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(q)}&search_simple=1&action=process&json=1&page_size=8`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                out.innerHTML = html;
                
                if(data.products && data.products.length) {
                    out.innerHTML += `<div style="margin-top:10px;"><b>Online Results</b></div>`;
                    data.products.slice(0, 8).forEach(p => {
                        let cal = p.nutriments['energy-kcal'] || (p.nutriments.energy_100g / 4.184) || 0;
                        cal = Math.round(cal);
                        const pr = Math.round(p.nutriments.proteins_100g||0);
                        const c = Math.round(p.nutriments.carbohydrates_100g||0);
                        const f = Math.round(p.nutriments.fat_100g||0);
                        out.innerHTML += renderRes(p.product_name, cal, pr, c, f, p.brands || '');
                    });
                } else {
                    out.innerHTML += `<div>No results found.</div>`;
                }
            } catch(e) {
                console.error(e);
                out.innerHTML = html + `<div style="color:red">Search Failed.</div>`;
            }
        }
    }

    function renderRes(name, cal, p, c, f, brand) {
        if(!name) return '';
        const nEsc = name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `
        <div class="res-item" onclick="addLog('food', '${nEsc}', ${cal}, ${p}, ${c}, ${f})">
            <div>
                <div style="font-weight:600">${name}</div>
                <div style="font-size:0.75rem; color:#888">${brand}</div>
            </div>
            <div style="color:var(--primary); font-weight:bold;">${cal} kcal</div>
        </div>`;
    }

    // --- LOGGING ---
    function addLog(type, name, cal, p=0, c=0, f=0) {
        state.logs.push({ type, name, cal: parseInt(cal), p, c, f, date: new Date().getTime() });
        save();
        closeAdd();
        document.getElementById('searchQ').value = '';
        document.getElementById('searchOut').innerHTML = '';
    }

    function calcBurn() {
        const met = parseFloat(document.getElementById('exType').value);
        const min = parseFloat(document.getElementById('exMin').value) || 0;
        const kg = state.profile.weight; 
        document.getElementById('exVal').innerText = Math.round(met * kg * (min/60));
    }

    function addEx() {
        const sel = document.getElementById('exType');
        const name = sel.options[sel.selectedIndex].text;
        const cal = parseInt(document.getElementById('exVal').innerText);
        if(cal > 0) addLog('ex', name, cal);
    }

    function saveCustom() {
        const name = document.getElementById('cName').value;
        const cal = document.getElementById('cCal').value;
        if(name && cal) {
            state.custom.push({ 
                name, cal: parseInt(cal), 
                p: parseInt(document.getElementById('cP').value)||0,
                c: parseInt(document.getElementById('cC').value)||0,
                f: parseInt(document.getElementById('cF').value)||0
            });
            save();
            alert('Saved to My Foods!');
            tab('food');
        }
    }

    // --- SETTINGS ---
    function toggleUnits() {
        state.profile.unit = document.getElementById('unitToggle').checked ? 'imperial' : 'metric';
        updateWeightInput();
        save();
    }

    function updateWeightInput() {
        const isImp = state.profile.unit === 'imperial';
        document.getElementById('lblWeightUnit').innerText = isImp ? '(lbs)' : '(kg)';
        let val = state.profile.weight;
        if(isImp) val = Math.round(val * 2.20462);
        document.getElementById('inpWeight').value = val;
    }

    function saveProfile() {
        const isImp = state.profile.unit === 'imperial';
        let val = parseFloat(document.getElementById('inpWeight').value);
        if(isImp) val = val / 2.20462;
        state.profile.weight = val;
        state.profile.goal = document.getElementById('inpGoal').value;
        save();
    }

    function exportData() {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
        const el = document.createElement('a');
        el.setAttribute("href", data);
        el.setAttribute("download", "tiu_backup.json");
        document.body.appendChild(el);
        el.click();
        el.remove();
    }

    function importData(inp) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                state = JSON.parse(e.target.result);
                save();
                location.reload();
            } catch(e) { alert('Error reading file'); }
        };
        reader.readAsText(inp.files[0]);
    }

    function resetApp() {
        if(confirm('Delete All Data?')) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }

    // --- REPORTS ---
    function renderReports() {
        const ctx = document.getElementById('reportChart');
        ctx.innerHTML = '';
        let days = [];
        let maxVal = 2000;
        let totalCals = 0;

        for(let i=6; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            days.push(d.toISOString().split('T')[0]);
        }

        days.forEach(day => {
            const logs = state.logs.filter(l => new Date(l.date).toISOString().split('T')[0] === day);
            let inCal = 0, outCal = 0;
            logs.forEach(l => l.type === 'food' ? inCal += l.cal : outCal += l.cal);
            if(inCal > maxVal) maxVal = inCal;
            totalCals += inCal;

            const hIn = Math.max((inCal / maxVal) * 80, 2); 
            const hOut = Math.max((outCal / maxVal) * 80, 0);
            const lbl = new Date(day).toLocaleDateString('en-US', {weekday:'short'});

            ctx.innerHTML += `
            <div class="chart-col">
                <div class="chart-bar-group">
                    <div class="chart-bar" style="height:${hIn}%" title="In: ${inCal}"></div>
                    <div class="chart-bar burn" style="height:${hOut}%" title="Out: ${outCal}"></div>
                </div>
                <div class="chart-label">${lbl}</div>
            </div>`;
        });
        
        const avg = Math.round(totalCals / 7);
        document.getElementById('weeklyStats').innerHTML = `
            Average Intake: <b>${avg} kcal</b><br>
            Highest Day: <b>${maxVal} kcal</b>
        `;
    }

    // --- UI HELPERS ---
    function toggleFast() {
        state.fast.on = !state.fast.on;
        state.fast.start = state.fast.on ? new Date().getTime() : null;
        save();
    }
    
    function updateTimer() {
        if(!state.fast.on) { document.getElementById('fastTimer').innerText = "--:--:--"; return; }
        const diff = new Date().getTime() - state.fast.start;
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        document.getElementById('fastTimer').innerText = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function setWater(i) { state.water = (i < state.water) ? i : i+1; save(); }

    function goView(v, btn) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('viewTitle').innerText = (v==='home')?'Dashboard': v.charAt(0).toUpperCase() + v.slice(1);
    }

    function openAdd() { document.getElementById('modalAdd').classList.add('active'); tab('food'); }
    function closeAdd() { document.getElementById('modalAdd').classList.remove('active'); }
    function tab(t) {
        ['food','ex','cust'].forEach(x => {
            document.getElementById('t-'+x).classList.remove('active');
            document.getElementById('p-'+x).style.display = 'none';
        });
        document.getElementById('t-'+t).classList.add('active');
        document.getElementById('p-'+t).style.display = 'block';
    }

    init();
</script>
</body>
</html>
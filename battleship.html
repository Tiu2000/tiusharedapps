<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNES Battleship - Logic Fixed</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #2c0e37;
            --water-color: #3b3b98;
            --grid-line: #5d5dff;
            --ship-color: #8b8b8b;
            --hit-color: #ff3e3e;
            --miss-color: #ffffff;
            --text-color: #e0e0e0;
            --ui-bg: #1a1a2e;
            --ui-border: #dcdcdc;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
            margin: 0;
        }

        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 999;
        }

        h1 {
            color: #ffcc00; text-shadow: 4px 4px 0 #000;
            font-size: 24px; margin-top: 20px; text-align: center;
        }

        .watermark {
            position: fixed; bottom: 10px; right: 10px;
            font-size: 16px; color: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.2); padding: 5px;
            font-family: sans-serif; font-weight: bold; z-index: 100;
        }

        /* --- CONNECTION PANEL --- */
        #connection-panel {
            background: var(--ui-bg); border: 4px solid var(--ui-border);
            padding: 20px; margin-top: 20px; text-align: center;
            box-shadow: 8px 8px 0 #000; max-width: 600px; width: 90%;
        }

        .panel-section {
            background: rgba(0,0,0,0.3); border: 2px solid #555;
            padding: 15px; margin: 10px 0;
        }

        input[type="text"] {
            background: #000; color: #0f0; border: 2px solid #fff;
            padding: 10px; font-family: 'Press Start 2P', cursive;
            text-align: center; width: 70%; text-transform: uppercase;
        }

        button {
            background: #a90000; color: #fff; border: 4px solid #fff;
            padding: 10px 15px; font-family: 'Press Start 2P', cursive;
            cursor: pointer; margin-top: 10px; box-shadow: 4px 4px 0 #000;
        }
        button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }
        button:disabled { background: #555; cursor: not-allowed; }

        /* --- GAME UI --- */
        #game-ui {
            display: none; /* Hidden by default */
            flex-direction: column; align-items: center; width: 100%;
        }

        #game-info-bar {
            display: flex; justify-content: space-between; width: 90%; max-width: 800px;
            margin-bottom: 10px; font-size: 10px; color: #aaa;
        }

        #game-log {
            width: 80%; max-width: 600px; text-align: center;
            background: #000; border: 2px solid #555; padding: 15px;
            color: #0f0; font-size: 14px; margin-bottom: 15px; min-height: 20px;
            line-height: 1.5; text-shadow: 2px 2px 0 #000;
        }

        #game-area {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; padding: 10px;
        }

        .board-title { color: #0f0; margin-bottom: 10px; text-shadow: 2px 2px #000; font-size: 12px; text-align: center; }

        .grid {
            display: grid; grid-template-columns: repeat(10, 30px); grid-template-rows: repeat(10, 30px);
            background-color: var(--water-color); border: 4px solid #fff; box-shadow: 6px 6px 0 #000;
        }

        .cell {
            width: 30px; height: 30px; border: 1px solid var(--grid-line);
            box-sizing: border-box; position: relative; cursor: crosshair;
        }

        /* Visual States */
        .cell.ship { background-color: var(--ship-color); box-shadow: inset 3px 3px 0 rgba(255,255,255,0.4); }
        .cell.hit { background-color: var(--hit-color); }
        .cell.miss { background-color: var(--water-color); }
        .cell.hit::after { content: 'X'; position: absolute; top: 4px; left: 4px; color: yellow; font-size: 16px; }
        .cell.miss::after { content: 'â€¢'; position: absolute; top: -2px; left: 6px; color: #fff; font-size: 24px; }

        .cell.preview-valid { background-color: #00ff00; opacity: 0.5; }
        .cell.preview-invalid { background-color: #ff0000; opacity: 0.5; }

        #rotate-btn { display: none; background: #0044aa; margin-bottom: 10px; }
        
        /* Turn Indication */
        #enemy-grid { transition: opacity 0.2s, filter 0.2s; }
        #enemy-grid.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); cursor: not-allowed; }

        #overlay {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: #000; border: 6px solid #fff;
            padding: 40px; z-index: 1000; text-align: center; box-shadow: 10px 10px 0 #000;
        }
    </style>
</head>
<body>



<div class="scanlines"></div>
<div class="watermark">TIU</div>

<h1>BATTLESHIP P2P</h1>

<div id="connection-panel">
    <div style="font-size: 10px; color: #aaa; margin-bottom: 15px; line-height: 1.5;">
        1. <b>HOST</b> creates a room name.<br>
        2. <b>JOINER</b> enters that name to play.<br>
    </div>

    <div class="panel-section">
        <h3 style="color:#00ffff; margin:0 0 10px 0;">HOST GAME</h3>
        <input type="text" id="host-room" placeholder="CREATE ROOM NAME" maxlength="10">
        <button id="btn-create">Create & Enter</button>
    </div>

    <div class="panel-section">
        <h3 style="color:#ff00ff; margin:0 0 10px 0;">JOIN GAME</h3>
        <input type="text" id="join-room" placeholder="ENTER ROOM NAME" maxlength="10">
        <button id="btn-join">Join Room</button>
        <div id="join-status" style="font-size:10px; margin-top:5px; color:#ffcc00;"></div>
    </div>
</div>

<div id="game-ui">
    <div id="game-info-bar">
        <span id="room-display">ROOM: ???</span>
        <span id="conn-display" style="color: #f00;">DISCONNECTED</span>
    </div>

    <div id="game-log">Deploy your fleet, Commander.</div>
    <button id="rotate-btn">Rotate Ship (R)</button>
    
    <div id="game-area">
        <div>
            <div class="board-title">ENEMY RADAR</div>
            <div id="enemy-grid" class="grid disabled"></div>
        </div>
        <div>
            <div class="board-title">YOUR FLEET</div>
            <div id="my-grid" class="grid"></div>
        </div>
    </div>
</div>

<div id="overlay">
    <h2 id="overlay-msg">GAME OVER</h2>
    <button onclick="location.reload()">MAIN MENU</button>
</div>

<script>
    // --- CONFIG ---
    const GRID_SIZE = 10;
    const SHIPS = [5, 4, 3, 3, 2];
    const APP_PREFIX = "tiu_bs_2024_"; 

    // --- STATE ---
    let peer, conn;
    let myBoard = Array(GRID_SIZE).fill().map(()=>Array(GRID_SIZE).fill(0));
    let enemyView = Array(GRID_SIZE).fill().map(()=>Array(GRID_SIZE).fill(0));
    let shipsToPlace = [...SHIPS];
    let currentShip = SHIPS[0];
    let isVertical = false;
    let isHost = false;
    let isMyTurn = false;
    let gameState = 'LOBBY'; 
    let myHits = 0, enemyHits = 0;
    const totalHits = SHIPS.reduce((a,b)=>a+b,0);
    
    // SYNC STATE
    let iAmReady = false;
    let opponentIsReady = false;

    // --- AUDIO ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        
        if(type==='click') {
            osc.frequency.setValueAtTime(600, t);
            osc.frequency.exponentialRampToValueAtTime(300, t+0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t+0.1);
            osc.start(t); osc.stop(t+0.1);
        } else if(type==='hit') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(50, t+0.3);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.linearRampToValueAtTime(0, t+0.3);
            osc.start(t); osc.stop(t+0.3);
        } else if(type==='miss') { 
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, t);
            gain.gain.setValueAtTime(0.05, t);
            gain.gain.linearRampToValueAtTime(0, t+0.2);
            osc.start(t); osc.stop(t+0.2);
        }
    }

    // --- UTILS ---
    function cleanId(str) { return str.replace(/[^a-zA-Z0-9]/g, '').toUpperCase(); }

    // --- UI SWITCHING ---
    function enterGameUI(roomName) {
        document.getElementById('connection-panel').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('room-display').innerText = "ROOM: " + roomName;
        startPlacement();
    }

    function setConnectionStatus(status, color) {
        const el = document.getElementById('conn-display');
        el.innerText = status;
        el.style.color = color;
    }

    // --- NETWORK LOGIC ---

    // 1. HOST
    document.getElementById('btn-create').addEventListener('click', () => {
        let room = cleanId(document.getElementById('host-room').value);
        if(room.length < 3) return alert("Room name too short");
        playTone('click');
        
        peer = new Peer(APP_PREFIX + room);
        
        isHost = true;
        enterGameUI(room);
        setConnectionStatus("WAITING FOR P2...", "#ffcc00");

        peer.on('connection', (c) => {
            conn = c;
            handleConnectionOpen();
        });

        peer.on('error', (err) => {
            alert("Room name likely taken or network blocked.");
            location.reload();
        });
    });

    // 2. JOINER
    document.getElementById('btn-join').addEventListener('click', () => {
        let room = cleanId(document.getElementById('join-room').value);
        if(room.length < 3) return alert("Room name too short");
        playTone('click');

        const status = document.getElementById('join-status');
        status.innerText = "Connecting...";
        
        peer = new Peer(); 

        peer.on('open', () => {
            conn = peer.connect(APP_PREFIX + room);
            
            conn.on('open', () => {
                enterGameUI(room);
                handleConnectionOpen();
            });

            setTimeout(() => {
                if(!conn.open) status.innerText = "Room not found (or Host busy).";
            }, 3000);
        });
    });

    function handleConnectionOpen() {
        setConnectionStatus("CONNECTED", "#00ff00");
        document.getElementById('game-log').innerText = "Opponent Connected!";
        
        conn.on('data', handleData);

        // Sync check: If I am already ready, tell the new person immediately.
        if (iAmReady) {
            safeSend({type:'READY'});
        }
    }

    function handleData(data) {
        // IMPORTANT: Process FIRE even if not 'PLAYING' yet, to fix race condition
        if(data.type === 'FIRE') receiveFire(data.x, data.y);
        
        if(data.type === 'READY') {
            opponentIsReady = true;
            checkStart();
        }
        if(data.type === 'RESULT') handleResult(data.x, data.y, data.hit);
    }

    function safeSend(data) {
        if(conn && conn.open) {
            conn.send(data);
        }
    }

    function checkStart() {
        if (iAmReady && opponentIsReady) {
            startGame();
        } else if (iAmReady && !opponentIsReady) {
            document.getElementById('game-log').innerText = "Waiting for Opponent to finish placing ships...";
        } else if (!iAmReady && opponentIsReady) {
            document.getElementById('game-log').innerText = "Opponent is ready! Finish deploying your fleet.";
        }
    }

    // --- GAMEPLAY ---

    const myGrid = document.getElementById('my-grid');
    const enemyGrid = document.getElementById('enemy-grid');
    const log = document.getElementById('game-log');

    function drawGrid(el, isEnemy) {
        el.innerHTML = '';
        for(let y=0; y<GRID_SIZE; y++) {
            for(let x=0; x<GRID_SIZE; x++) {
                let d = document.createElement('div');
                d.className = 'cell';
                if(!isEnemy) {
                    d.onmouseover = () => hover(x,y);
                    d.onclick = () => place(x,y);
                } else {
                    d.onclick = () => fire(x,y);
                }
                el.appendChild(d);
            }
        }
    }
    drawGrid(myGrid, false);
    drawGrid(enemyGrid, true);

    function startPlacement() {
        gameState = 'PLACING';
        log.innerText = `Place Ship (Size ${currentShip}). R to Rotate.`;
        document.getElementById('rotate-btn').style.display = 'block';
    }

    document.getElementById('rotate-btn').onclick = () => { isVertical = !isVertical; };
    document.addEventListener('keydown', e => { if(e.key.toLowerCase()=='r') isVertical = !isVertical; });

    function getCells(x, y, size, vert) {
        let c = [];
        for(let i=0; i<size; i++) c.push({x: vert?x:x+i, y: vert?y+i:y});
        return c;
    }

    function hover(x, y) {
        if(gameState !== 'PLACING') return;
        document.querySelectorAll('.preview-valid, .preview-invalid').forEach(e=>e.classList.remove('preview-valid','preview-invalid'));
        let cells = getCells(x,y,currentShip,isVertical);
        let valid = cells.every(p => p.x<10 && p.y<10 && myBoard[p.y][p.x]===0);
        
        cells.forEach(p => {
            if(p.x<10 && p.y<10) myGrid.children[p.y*10+p.x].classList.add(valid?'preview-valid':'preview-invalid');
        });
    }

    function place(x, y) {
        if(gameState !== 'PLACING') return;
        let cells = getCells(x,y,currentShip,isVertical);
        if(cells.every(p => p.x<10 && p.y<10 && myBoard[p.y][p.x]===0)) {
            playTone('click');
            cells.forEach(p => {
                myBoard[p.y][p.x] = 1;
                myGrid.children[p.y*10+p.x].classList.add('ship');
            });
            shipsToPlace.shift();
            
            if(shipsToPlace.length) {
                currentShip = shipsToPlace[0];
                log.innerText = `Place Ship (Size ${currentShip})`;
            } else {
                // FINISHED PLACEMENT
                document.getElementById('rotate-btn').style.display = 'none';
                iAmReady = true;
                safeSend({type:'READY'});
                checkStart();
            }
        }
    }

    function startGame() {
        // Prevent resetting turn logic if we are already playing (Fix for Race Condition)
        if(gameState === 'PLAYING') return;

        gameState = 'PLAYING';
        isMyTurn = isHost; // HOST GOES FIRST
        updateTurn();
    }

    function updateTurn() {
        if(isMyTurn) {
            log.innerText = "YOUR TURN: Fire on Enemy Radar!";
            log.style.color = "#00ff00"; 
            enemyGrid.classList.remove('disabled');
        } else {
            log.innerText = "ENEMY TURN: Brace for impact!";
            log.style.color = "#ff3333"; 
            enemyGrid.classList.add('disabled');
        }
    }

    function fire(x, y) {
        if(gameState!=='PLAYING') return;
        if(!isMyTurn) return; 
        if(enemyView[y][x]!==0) return; // Already clicked
        
        playTone('click');
        enemyView[y][x] = 2; // Mark as pending
        enemyGrid.children[y*10+x].style.backgroundColor = '#555'; 
        
        // Lock turn immediately
        isMyTurn = false;
        updateTurn();
        
        log.innerText = "Firing Cannons...";
        safeSend({type:'FIRE', x, y});
    }

    function receiveFire(x, y) {
        // If we receive fire, the game is ON. Force state to PLAYING.
        if (gameState !== 'PLAYING') {
            gameState = 'PLAYING';
        }

        let hit = myBoard[y][x] === 1;
        myBoard[y][x] = hit ? 3 : 2;
        let cell = myGrid.children[y*10+x];
        cell.classList.add(hit?'hit':'miss');
        
        if(hit) {
            playTone('hit');
            myHits++;
            if(myHits >= totalHits) {
                safeSend({type:'RESULT', hit:true, x, y});
                gameOver(false);
                return;
            }
        } else {
            playTone('miss');
        }
        
        // Send result back
        safeSend({type:'RESULT', hit, x, y});
        
        // IT IS NOW MY TURN
        isMyTurn = true;
        updateTurn();
    }

    function handleResult(x, y, hit) {
        enemyView[y][x] = hit ? 3 : 2;
        let cell = enemyGrid.children[y*10+x];
        cell.style.backgroundColor = ''; 
        cell.classList.add(hit?'hit':'miss');
        
        if(hit) {
            playTone('hit');
            enemyHits++;
            if(enemyHits >= totalHits) gameOver(true);
            else log.innerText = "DIRECT HIT! Waiting for enemy...";
        } else {
            playTone('miss');
            log.innerText = "MISSED. Waiting for enemy...";
        }
        
        // Note: Turn remains locked (false) until we receive a FIRE command
    }

    function gameOver(win) {
        gameState = 'OVER';
        document.getElementById('overlay').style.display = 'block';
        let msg = document.getElementById('overlay-msg');
        msg.innerText = win ? "VICTORY!" : "DEFEAT";
        msg.style.color = win ? "#0f0" : "#f00";
    }
</script>
</body>
</html>
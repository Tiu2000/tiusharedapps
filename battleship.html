<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNES Battleship - Robust P2P</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #2c0e37;
            --water-color: #3b3b98;
            --grid-line: #5d5dff;
            --hit-color: #ff3e3e;
            --miss-color: #ffffff;
            --ship-color: #8b8b8b;
            --text-color: #e0e0e0;
            --ui-bg: #1a1a2e;
            --ui-border: #dcdcdc;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
        }

        h1 {
            color: #ffcc00;
            text-shadow: 4px 4px 0px #000;
            text-align: center;
            font-size: 24px;
            margin-top: 20px;
        }

        /* TIU Watermark */
        .watermark {
            position: fixed;
            bottom: 10px; right: 10px;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 5px;
            font-family: sans-serif;
            font-weight: bold;
            z-index: 100;
        }

        /* Connection Panel */
        #connection-panel {
            background: var(--ui-bg);
            border: 4px solid var(--ui-border);
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            box-shadow: 8px 8px 0px #000;
            max-width: 600px;
            width: 90%;
        }

        .panel-section {
            background: rgba(0,0,0,0.3);
            border: 2px solid #555;
            padding: 15px;
            margin: 10px 0;
        }

        input[type="text"] {
            background: #000;
            color: #0f0;
            border: 2px solid #fff;
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            width: 70%;
            text-transform: uppercase;
            font-size: 14px;
        }

        button {
            background: #a90000;
            color: #fff;
            border: 4px solid #fff;
            padding: 10px 15px;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 4px 4px 0px #000;
        }
        button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #000; }
        button:disabled { background: #555; color: #aaa; cursor: not-allowed; }

        .status-msg {
            font-size: 10px;
            margin-top: 10px;
            min-height: 20px;
            color: #ffff00;
        }

        /* Game Area */
        #game-area {
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
        }

        .board-title { color: #0f0; margin-bottom: 5px; text-shadow: 2px 2px #000; font-size: 12px; text-align: center;}

        .grid {
            display: grid;
            grid-template-columns: repeat(10, 28px);
            grid-template-rows: repeat(10, 28px);
            background-color: var(--water-color);
            border: 4px solid #fff;
            box-shadow: 6px 6px 0px #000;
        }

        .cell {
            width: 28px; height: 28px;
            border: 1px solid var(--grid-line);
            box-sizing: border-box;
            position: relative;
            cursor: crosshair;
        }

        .cell.ship { background-color: var(--ship-color); box-shadow: inset 2px 2px 0 rgba(255,255,255,0.5); }
        .cell.hit { background-color: var(--hit-color); }
        .cell.miss { background-color: var(--water-color); }
        .cell.hit::after { content: 'X'; position: absolute; top: 3px; left: 3px; color: yellow; }
        .cell.miss::after { content: 'â€¢'; position: absolute; top: 0px; left: 5px; color: #fff; font-size: 18px; }

        .cell.preview-valid { background-color: #00ff00; opacity: 0.5; }
        .cell.preview-invalid { background-color: #ff0000; opacity: 0.5; }

        #game-log {
            width: 80%;
            text-align: center;
            background: #000;
            border: 2px solid #555;
            padding: 10px;
            color: #0f0;
            font-size: 12px;
            margin-bottom: 10px;
        }

        #rotate-btn { display: none; background: #0044aa; margin-bottom: 10px;}
        #enemy-grid.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        /* Overlay */
        #overlay {
            display: none;
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #000; border: 6px solid #fff;
            padding: 40px; z-index: 1000; text-align: center;
            box-shadow: 10px 10px 0 #000;
        }
    </style>
</head>
<body>

<div class="scanlines"></div>
<div class="watermark">TIU</div>

<h1>BATTLESHIP P2P</h1>

<div id="connection-panel">
    <div style="font-size: 10px; color: #aaa; margin-bottom: 15px;">
        INSTRUCTIONS: <br>
        1. Player A creates a room (e.g. "ROOM1")<br>
        2. Player A waits for "ROOM READY" status.<br>
        3. Player B joins "ROOM1".
    </div>

    <div class="panel-section">
        <h3 style="color:#00ffff; margin:0 0 10px 0;">PLAYER A (HOST)</h3>
        <input type="text" id="host-room" placeholder="Room Name" maxlength="10">
        <button id="btn-create">Create Room</button>
        <div id="host-status" class="status-msg"></div>
    </div>

    <div class="panel-section">
        <h3 style="color:#ff00ff; margin:0 0 10px 0;">PLAYER B (JOIN)</h3>
        <input type="text" id="join-room" placeholder="Room Name" maxlength="10">
        <button id="btn-join">Join Room</button>
        <div id="join-status" class="status-msg"></div>
    </div>
</div>

<div id="game-ui" style="display:none; flex-direction:column; align-items:center; width: 100%;">
    <div id="game-log">Deploy your fleet.</div>
    <button id="rotate-btn">Rotate Ship (R)</button>
    
    <div id="game-area">
        <div>
            <div class="board-title">ENEMY RADAR</div>
            <div id="enemy-grid" class="grid disabled"></div>
        </div>
        <div>
            <div class="board-title">YOUR FLEET</div>
            <div id="my-grid" class="grid"></div>
        </div>
    </div>
</div>

<div id="overlay">
    <h2 id="overlay-msg">GAME OVER</h2>
    <button onclick="location.reload()">MAIN MENU</button>
</div>

<script>
    // --- CONFIG & STATE ---
    const GRID_SIZE = 10;
    const SHIPS = [5, 4, 3, 3, 2];
    const APP_PREFIX = "tiu_bs_2024_"; // Prefix to ensure global uniqueness

    let peer, conn;
    let myBoard = Array(GRID_SIZE).fill().map(()=>Array(GRID_SIZE).fill(0));
    let enemyView = Array(GRID_SIZE).fill().map(()=>Array(GRID_SIZE).fill(0));
    let shipsToPlace = [...SHIPS];
    let currentShip = SHIPS[0];
    let isVertical = false;
    let isHost = false;
    let isMyTurn = false;
    let gameState = 'LOBBY'; 
    let myHitsTaken = 0, enemyHitsTaken = 0;
    const totalHits = SHIPS.reduce((a,b)=>a+b,0);

    // --- AUDIO ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        
        if(type==='click') {
            osc.frequency.setValueAtTime(600, t);
            osc.frequency.exponentialRampToValueAtTime(300, t+0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t+0.1);
            osc.start(t); osc.stop(t+0.1);
        } else if(type==='hit') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(50, t+0.3);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.linearRampToValueAtTime(0, t+0.3);
            osc.start(t); osc.stop(t+0.3);
        } else if(type==='miss') { // high ping
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, t);
            gain.gain.setValueAtTime(0.05, t);
            gain.gain.linearRampToValueAtTime(0, t+0.2);
            osc.start(t); osc.stop(t+0.2);
        }
    }

    // --- NETWORKING ---
    
    function cleanId(str) {
        // Remove spaces, special chars, make uppercase
        return str.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
    }

    // HOST LOGIC
    document.getElementById('btn-create').addEventListener('click', () => {
        let room = cleanId(document.getElementById('host-room').value);
        if(room.length < 3) return alert("Room name must be 3+ letters");
        
        playTone('click');
        document.getElementById('host-status').innerText = "Connecting to Global Server...";
        document.getElementById('btn-create').disabled = true;
        document.getElementById('btn-join').disabled = true;

        peer = new Peer(APP_PREFIX + room);

        peer.on('open', (id) => {
            document.getElementById('host-status').innerHTML = `<span style="color:#0f0">ROOM READY!</span><br>Tell Player B to join "${room}"`;
            isHost = true;
        });

        peer.on('connection', (c) => {
            conn = c;
            setupConnection();
        });

        peer.on('error', (err) => {
            console.error(err);
            document.getElementById('host-status').innerText = "Error: Room name taken or network blocked.";
            document.getElementById('btn-create').disabled = false;
        });
    });

    // JOIN LOGIC
    document.getElementById('btn-join').addEventListener('click', () => {
        let room = cleanId(document.getElementById('join-room').value);
        if(room.length < 3) return alert("Room name must be 3+ letters");

        playTone('click');
        const statusEl = document.getElementById('join-status');
        statusEl.innerText = "Initializing...";
        document.getElementById('btn-create').disabled = true;
        document.getElementById('btn-join').disabled = true;

        peer = new Peer(); // Get random ID for myself

        peer.on('open', () => {
            statusEl.innerText = `Looking for "${room}"...`;
            connectToHost(APP_PREFIX + room);
        });

        peer.on('error', (err) => {
            statusEl.innerText = "Network Connection Failed.";
            document.getElementById('btn-join').disabled = false;
        });
    });

    function connectToHost(hostId) {
        const statusEl = document.getElementById('join-status');
        
        // Retry logic
        let attempts = 0;
        const tryConnect = () => {
            attempts++;
            statusEl.innerText = `Searching... (Attempt ${attempts}/5)`;
            
            conn = peer.connect(hostId, { reliable: true });

            // If connection opens, we are good
            conn.on('open', () => {
                setupConnection();
            });

            // If connection fails within 2 seconds, retry
            setTimeout(() => {
                if(!conn.open && attempts < 5) {
                    tryConnect();
                } else if (!conn.open) {
                    statusEl.innerText = "Room not found. Did Host create it?";
                    document.getElementById('btn-join').disabled = false;
                }
            }, 2000);
        };
        
        tryConnect();
    }

    function setupConnection() {
        document.getElementById('connection-panel').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        
        conn.on('data', handleData);
        startPlacement();
    }

    function handleData(data) {
        if(data.type === 'READY') {
            if(gameState === 'WAITING') startGame();
            else document.getElementById('game-log').innerText = "Opponent is ready!";
        }
        if(data.type === 'FIRE') receiveFire(data.x, data.y);
        if(data.type === 'RESULT') handleResult(data.x, data.y, data.hit);
    }

    // --- GAMEPLAY ---

    const myGrid = document.getElementById('my-grid');
    const enemyGrid = document.getElementById('enemy-grid');
    const log = document.getElementById('game-log');

    // Init Grids
    function drawGrid(el, isEnemy) {
        el.innerHTML = '';
        for(let y=0; y<GRID_SIZE; y++) {
            for(let x=0; x<GRID_SIZE; x++) {
                let d = document.createElement('div');
                d.className = 'cell';
                if(!isEnemy) {
                    d.onmouseover = () => hover(x,y);
                    d.onclick = () => place(x,y);
                } else {
                    d.onclick = () => fire(x,y);
                }
                el.appendChild(d);
            }
        }
    }
    drawGrid(myGrid, false);
    drawGrid(enemyGrid, true);

    // Placement
    function startPlacement() {
        gameState = 'PLACING';
        log.innerText = `Place Ship (Size ${currentShip}). Press R to Rotate.`;
        document.getElementById('rotate-btn').style.display = 'block';
    }

    document.getElementById('rotate-btn').onclick = () => { isVertical = !isVertical; };
    document.addEventListener('keydown', e => { if(e.key.toLowerCase()=='r') isVertical = !isVertical; });

    function getCells(x, y, size, vert) {
        let c = [];
        for(let i=0; i<size; i++) c.push({x: vert?x:x+i, y: vert?y+i:y});
        return c;
    }

    function hover(x, y) {
        if(gameState !== 'PLACING') return;
        document.querySelectorAll('.preview-valid, .preview-invalid').forEach(e=>e.classList.remove('preview-valid','preview-invalid'));
        let cells = getCells(x,y,currentShip,isVertical);
        let valid = cells.every(p => p.x<10 && p.y<10 && myBoard[p.y][p.x]===0);
        
        cells.forEach(p => {
            if(p.x<10 && p.y<10) myGrid.children[p.y*10+p.x].classList.add(valid?'preview-valid':'preview-invalid');
        });
    }

    function place(x, y) {
        if(gameState !== 'PLACING') return;
        let cells = getCells(x,y,currentShip,isVertical);
        if(cells.every(p => p.x<10 && p.y<10 && myBoard[p.y][p.x]===0)) {
            playTone('click');
            cells.forEach(p => {
                myBoard[p.y][p.x] = 1;
                myGrid.children[p.y*10+p.x].classList.add('ship');
            });
            shipsToPlace.shift();
            if(shipsToPlace.length) {
                currentShip = shipsToPlace[0];
                log.innerText = `Place Ship (Size ${currentShip})`;
            } else {
                gameState = 'WAITING';
                log.innerText = "Waiting for opponent...";
                document.getElementById('rotate-btn').style.display = 'none';
                conn.send({type:'READY'});
            }
        }
    }

    // Battle
    function startGame() {
        gameState = 'PLAYING';
        isMyTurn = isHost;
        updateTurn();
    }

    function updateTurn() {
        if(isMyTurn) {
            log.innerText = "YOUR TURN: Select target on Radar";
            log.style.color = "#0f0";
            enemyGrid.classList.remove('disabled');
        } else {
            log.innerText = "ENEMY TURN: Brace for impact";
            log.style.color = "#f00";
            enemyGrid.classList.add('disabled');
        }
    }

    function fire(x, y) {
        if(gameState!=='PLAYING' || !isMyTurn || enemyView[y][x]!==0) return;
        playTone('click');
        enemyView[y][x] = 2; // temp mark
        enemyGrid.children[y*10+x].style.backgroundColor = '#555'; // temp visual
        isMyTurn = false;
        enemyGrid.classList.add('disabled');
        log.innerText = "Firing...";
        conn.send({type:'FIRE', x, y});
    }

    function receiveFire(x, y) {
        let hit = myBoard[y][x] === 1;
        myBoard[y][x] = hit ? 3 : 2;
        let cell = myGrid.children[y*10+x];
        cell.classList.add(hit?'hit':'miss');
        
        if(hit) {
            playTone('hit');
            myHitsTaken++;
            if(myHitsTaken >= totalHits) {
                conn.send({type:'RESULT', hit:true, x, y});
                gameOver(false);
                return;
            }
        } else {
            playTone('miss');
        }
        conn.send({type:'RESULT', hit, x, y});
        isMyTurn = true;
        updateTurn();
    }

    function handleResult(x, y, hit) {
        enemyView[y][x] = hit ? 3 : 2;
        let cell = enemyGrid.children[y*10+x];
        cell.style.backgroundColor = ''; // clear temp
        cell.classList.add(hit?'hit':'miss');
        if(hit) {
            playTone('hit');
            enemyHitsTaken++;
            if(enemyHitsTaken >= totalHits) gameOver(true);
            else log.innerText = "DIRECT HIT!";
        } else {
            playTone('miss');
            log.innerText = "Missed.";
        }
    }

    function gameOver(win) {
        gameState = 'OVER';
        document.getElementById('overlay').style.display = 'block';
        let msg = document.getElementById('overlay-msg');
        msg.innerText = win ? "VICTORY!" : "DEFEAT";
        msg.style.color = win ? "#0f0" : "#f00";
    }

</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Chess Scenario Strategist â€” TIU</title>
  <style>
    :root {
      --bg-color: #ffffff;
      --board-border: #333;
      --light-sq: #f0d9b5; 
      --dark-sq: #b58863;
      --accent: #2b6cb0;
      --danger: #e53e3e;
      --success: #38a169;
      --highlight: rgba(255, 255, 0, 0.5);
      --move-dot: rgba(0, 0, 0, 0.3);
      --hint-source: rgba(255, 235, 59, 0.7);
      --hint-target: rgba(76, 175, 80, 0.7); 
    }

    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0; padding: 10px;
      background: #f4f4f4; color: #111;
      overscroll-behavior: none;
    }

    .app {
      display: flex; flex-direction: column; gap: 16px;
      max-width: 600px; margin: 0 auto; padding-bottom: 40px;
    }

    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
    h1 { font-size: 20px; margin: 0; font-weight: 700; color: #222; }

    .panel {
      background: #fff; border-radius: 8px; padding: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd;
    }

    .board-wrap { display: flex; flex-direction: column; align-items: center; gap: 10px; position: relative; }

    /* --- MODE TOGGLE --- */
    .mode-switch {
      display: flex;
      background: #eee;
      border-radius: 20px;
      padding: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      user-select: none;
      width: 100%;
      justify-content: center;
      margin-bottom: 10px;
    }
    
    .mode-option {
      flex: 1;
      text-align: center;
      padding: 6px 12px;
      border-radius: 16px;
      transition: all 0.2s;
      color: #666;
    }
    
    .mode-option.active {
      background: white;
      color: var(--accent);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .mode-option.active-edit {
      color: var(--danger);
    }

    /* --- BOARD STYLING --- */
    .board {
      width: 100%;
      max-width: 90vw;
      height: 90vw; 
      max-height: 500px; max-width: 500px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      border: 3px solid #333;
      user-select: none;
      background: #eee;
      position: relative;
    }

    @media (min-width: 555px) { .board { height: 500px; } }

    .square {
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-size: clamp(24px, 8vw, 42px);
      position: relative; cursor: pointer;
    }

    .sq-light { background: var(--light-sq); }
    .sq-dark { background: var(--dark-sq); }

    .hint-source { background-color: var(--hint-source) !important; box-shadow: inset 0 0 0 2px #fbc02d; }
    .hint-target { background-color: var(--hint-target) !important; box-shadow: inset 0 0 0 2px #2e7d32; }
    .hint-target::after {
      content: 'ðŸŽ¯'; position: absolute; font-size: clamp(16px, 4vw, 24px); z-index: 5; opacity: 0.8; pointer-events: none;
    }

    .piece {
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      line-height: 1; pointer-events: none; z-index: 2;
    }

    .brand-watermark {
      position: absolute; bottom: 5px; right: 5px;
      font-size: 10px; font-weight: 900; color: rgba(0,0,0,0.15);
      pointer-events: none; z-index: 1; font-family: monospace;
    }

    /* --- UI ELEMENTS --- */
    .selected { background: var(--highlight) !important; }
    
    .legal-dot {
      position: absolute; width: 25%; height: 25%;
      background: var(--move-dot); border-radius: 50%; pointer-events: none;
    }
    .legal-capture::before {
      content: ''; position: absolute; width: 80%; height: 80%;
      border: 5px solid rgba(0,0,0,0.3); border-radius: 50%;
    }

    /* Edit Mode Indicators */
    .edit-border { border-color: var(--danger) !important; }
    .edit-indicator {
      position: absolute; top: 5px; left: 5px;
      background: var(--danger); color: white;
      font-size: 10px; padding: 2px 6px; border-radius: 4px;
      font-weight: bold; pointer-events: none; z-index: 10;
      display: none;
    }

    .btn {
      background: #fff; border: 1px solid #ccc; padding: 8px 12px;
      border-radius: 6px; font-size: 14px; cursor: pointer; color: #333; font-weight: 600;
    }
    .btn:active { background: #eee; }
    .btn.primary { background: var(--accent); color: #fff; border: none; }
    .btn-group { display: flex; gap: 8px; }

    textarea { width: 100%; height: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; }
    
    .palette { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
    .cell {
      aspect-ratio: 1; background: #f9f9f9; border: 1px solid #ccc;
      border-radius: 4px; display: flex; align-items: center; justify-content: center;
      font-size: 24px; cursor: pointer;
    }
    .cell.active { background: #dceefc; border-color: var(--accent); }
    .remove-cell { color: red; font-weight: bold; }

    .collapsible-header { padding: 10px 0; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; }
    .collapsible-content { display: none; padding-top: 10px; }
    .collapsible-content.show { display: block; }

    /* Turn Indicator clickable */
    .turn-badge {
        padding: 4px 10px;
        background: #eee;
        border-radius: 12px;
        cursor: pointer;
        border: 1px solid #ccc;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .turn-badge:hover { background: #ddd; }
  </style>
</head>
<body>

<div class="app">
  <header>
    <h1>Scenario Strategist</h1>
    <div class="btn-group">
      <button class="btn" onclick="flipBoard()">Flip</button>
      <button class="btn" onclick="resetBoard()">Clear</button>
      <button class="btn primary" onclick="startPos()">Start</button>
    </div>
  </header>

  <main class="panel board-wrap">
    <div class="mode-switch" onclick="toggleMode()">
        <div id="modePlay" class="mode-option active">Play Mode (Rules On)</div>
        <div id="modeEdit" class="mode-option">Free Move (Edit Mode)</div>
    </div>

    <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
      <div class="turn-badge" onclick="manualSwapTurn()" title="Click to swap turn">
        <span>Turn:</span>
        <span id="turnText">White</span>
        <span style="font-size:10px; opacity:0.6;">(Tap to Swap)</span>
      </div>
      <button class="btn" onclick="undo()">Undo</button>
    </div>
    
    <div id="board" class="board">
       <div id="editFlag" class="edit-indicator">FREE MODE</div>
    </div>
  </main>

  <aside class="panel">
    <div onclick="toggle(this)" class="collapsible-header">
      <span>Piece Palette</span> <span>â–¼</span>
    </div>
    <div class="collapsible-content show">
      <div id="palette" class="palette"></div>
      <p style="font-size:12px; color:#666; margin-top:5px;">
        <span id="palette-hint">Tap a piece to place it. In Free Mode, pieces can move anywhere.</span>
      </p>
    </div>
    
    <div style="border-top:1px solid #eee; margin:10px 0;"></div>

    <div onclick="toggle(this)" class="collapsible-header">
      <span>Analysis</span> <span>â–¼</span>
    </div>
    <div class="collapsible-content">
      <div class="btn-group" style="margin-top:5px;">
        <button class="btn primary" onclick="findBestMove()" style="width:100%">Find Best Move for Current Side</button>
      </div>
      <div id="engineOut" style="margin-top:10px; font-family:monospace; background:#f0f7ff; padding:8px; border-radius:4px; font-size:13px;">Ready</div>
      <textarea id="fen" style="margin-top:10px;" placeholder="FEN String"></textarea>
      <button class="btn" style="margin-top:5px; width:100%;" onclick="loadFen()">Load FEN</button>
    </div>
  </aside>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script>
  // --- STATE ---
  let chess = null;
  let selectedSquare = null;
  let selectedPiece = null;
  let isFreeMode = false;

  // --- INIT ---
  (function drawEmptyBoard() {
    const boardEl = document.getElementById('board');
    let html = '<div id="editFlag" class="edit-indicator">FREE MODE</div>';
    for (let r = 0; r < 8; r++) {
      for (let c = 0; c < 8; c++) {
        const squareColor = (r + c) % 2 === 0 ? 'sq-light' : 'sq-dark';
        const squareName = String.fromCharCode(97 + c) + (8 - r);
        html += `<div class="square ${squareColor}" data-square="${squareName}" id="sq-${squareName}"></div>`;
      }
    }
    html += '<div class="brand-watermark">TIU</div>';
    boardEl.innerHTML = html;
  })();

  window.onload = function() {
    if (typeof Chess === 'undefined') {
      alert("Chess engine failed to load. Check internet.");
    } else {
      chess = new Chess();
      init();
    }
  };

  function init() {
    renderPieces(); 
    renderPalette();
    updateStatus();
    
    document.querySelectorAll('.square').forEach(sq => {
      sq.onclick = () => handleSquareClick(sq.dataset.square);
    });
  }

  // --- LOGIC ---

  function toggleMode() {
    isFreeMode = !isFreeMode;
    document.getElementById('modePlay').classList.toggle('active');
    document.getElementById('modeEdit').classList.toggle('active');
    document.getElementById('modeEdit').classList.toggle('active-edit');
    
    const board = document.getElementById('board');
    const flag = document.getElementById('editFlag');
    
    if (isFreeMode) {
      board.classList.add('edit-border');
      flag.style.display = 'block';
      clearHints();
      // Clear legal dots as they don't apply in free mode
      document.querySelectorAll('.legal-dot, .legal-capture').forEach(e => e.remove());
    } else {
      board.classList.remove('edit-border');
      flag.style.display = 'none';
      selectedSquare = null; // Reset selection to avoid confusion
      renderPieces();
    }
  }

  function handleSquareClick(sq) {
    if (!chess) return; 
    clearHints();

    // 1. PALETTE PLACEMENT (Always works)
    if (selectedPiece) {
      if (selectedPiece === 'remove') {
        chess.remove(sq);
      } else {
        const color = selectedPiece[0];
        const type = selectedPiece[1].toLowerCase();
        chess.remove(sq);
        chess.put({ type, color }, sq);
      }
      renderPieces();
      updateStatus();
      return;
    }

    // 2. FREE MOVE MODE logic
    if (isFreeMode) {
        if (selectedSquare) {
            // Move piece from selectedSquare to sq (Force Move)
            const piece = chess.get(selectedSquare);
            if (piece) {
                chess.remove(selectedSquare); // Pick up
                chess.remove(sq);             // Remove target (capture)
                chess.put(piece, sq);         // Place
            }
            selectedSquare = null;
            renderPieces();
            updateStatus();
        } else {
            // Select piece
            const piece = chess.get(sq);
            if (piece) {
                selectedSquare = sq;
                renderPieces(); // Refreshes styling
            }
        }
        return;
    }

    // 3. STANDARD PLAY MODE logic
    if (selectedSquare) {
      // Attempt Move
      const move = chess.move({ from: selectedSquare, to: sq, promotion: 'q' });
      
      if (move) {
        // Valid move
        selectedSquare = null;
        renderPieces();
        updateStatus();
      } else {
        // Invalid move or clicked own piece
        const piece = chess.get(sq);
        if (piece && piece.color === chess.turn()) {
            selectedSquare = sq; // Switch selection
            renderPieces();
            showLegalMoves(sq);
        } else {
            selectedSquare = null;
            renderPieces();
        }
      }
      return;
    }

    // 4. Initial Selection (Standard)
    const piece = chess.get(sq);
    if (piece && piece.color === chess.turn()) {
      selectedSquare = sq;
      renderPieces();
      showLegalMoves(sq);
    }
  }

  function showLegalMoves(sq) {
    const moves = chess.moves({ square: sq, verbose: true });
    moves.forEach(m => {
      const target = document.getElementById(`sq-${m.to}`);
      if (target) {
        const dot = document.createElement('div');
        dot.className = m.captured ? 'legal-capture' : 'legal-dot';
        target.appendChild(dot);
      }
    });
  }

  function manualSwapTurn() {
     if(!chess) return;
     const fen = chess.fen();
     const parts = fen.split(' ');
     parts[1] = parts[1] === 'w' ? 'b' : 'w'; // Swap active color
     parts[3] = '-'; // Reset en passant to avoid stale data conflicts
     const newFen = parts.join(' ');
     chess.load(newFen);
     updateStatus();
     renderPieces(); // Clear selection
  }

  function renderPieces() {
    // Clear pieces & markers
    document.querySelectorAll('.piece, .legal-dot, .legal-capture').forEach(e => e.remove());
    document.querySelectorAll('.square').forEach(e => e.classList.remove('selected'));

    const board = chess.board();
    for (let r = 0; r < 8; r++) {
      for (let c = 0; c < 8; c++) {
        const piece = board[r][c];
        const squareName = String.fromCharCode(97 + c) + (8 - r);
        const sqDiv = document.getElementById(`sq-${squareName}`);
        
        if (piece && sqDiv) {
          const pDiv = document.createElement('div');
          pDiv.className = 'piece';
          pDiv.innerText = getPieceSymbol(piece);
          sqDiv.appendChild(pDiv);
        }
        if (selectedSquare === squareName && sqDiv) {
          sqDiv.classList.add('selected');
        }
      }
    }
  }

  function updateStatus() {
    if(!chess) return;
    const t = chess.turn() === 'w' ? 'White' : 'Black';
    document.getElementById('turnText').innerText = t;
    document.getElementById('fen').value = chess.fen();
  }

  // --- UTILS ---
  function getPieceSymbol(p) {
    const symbols = {
      wK:'â™”', wQ:'â™•', wR:'â™–', wB:'â™—', wN:'â™˜', wP:'â™™',
      bK:'â™š', bQ:'â™›', bR:'â™œ', bB:'â™', bN:'â™ž', bP:'â™Ÿ'
    };
    return symbols[(p.color === 'w' ? 'w' : 'b') + p.type.toUpperCase()];
  }

  function renderPalette() {
    const pieces = ['wK','wQ','wR','wB','wN','wP','bK','bQ','bR','bB','bN','bP'];
    const paletteEl = document.getElementById('palette');
    paletteEl.innerHTML = '';
    pieces.forEach(p => {
      const type = p[1].toLowerCase();
      const color = p[0];
      const el = document.createElement('div');
      el.className = 'cell';
      el.innerText = getPieceSymbol({type, color});
      el.onclick = () => {
         selectedPiece = (selectedPiece === p) ? null : p;
         selectedSquare = null;
         clearHints();
         document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
         if(selectedPiece) el.classList.add('active');
      };
      paletteEl.appendChild(el);
    });
    // Remove btn
    const del = document.createElement('div');
    del.className = 'cell remove-cell';
    del.innerText = 'âœ•';
    del.onclick = () => {
        selectedPiece = (selectedPiece === 'remove') ? null : 'remove';
        selectedSquare = null;
        clearHints();
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
        if(selectedPiece) del.classList.add('active');
    };
    paletteEl.appendChild(del);
  }

  function clearHints() {
    document.querySelectorAll('.hint-source, .hint-target').forEach(el => {
      el.classList.remove('hint-source', 'hint-target');
    });
  }

  function startPos() { if(chess) { chess.reset(); init(); } }
  function resetBoard() { if(chess) { chess.clear(); init(); } }
  function undo() { if(chess) { chess.undo(); init(); } }
  
  function loadFen() { 
    if(!chess) return;
    const val = document.getElementById('fen').value; 
    if(chess.load(val)) { init(); } 
    else alert('Invalid FEN');
  }
  
  function flipBoard() {
    const b = document.getElementById('board');
    const isRotated = b.style.transform === 'rotate(180deg)';
    b.style.transform = isRotated ? '' : 'rotate(180deg)';
    document.querySelectorAll('.piece').forEach(p => {
       p.style.transform = isRotated ? '' : 'rotate(180deg)';
    });
    const brand = document.querySelector('.brand-watermark');
    if(brand) brand.style.transform = isRotated ? '' : 'rotate(180deg)';
  }

  function findBestMove() {
     if(!chess) return;
     clearHints();
     
     // Random "AI" for demo purposes
     const moves = chess.moves({ verbose: true });
     if(moves.length === 0) { 
        document.getElementById('engineOut').innerText = "No legal moves (Checkmate/Stalemate)"; 
        return; 
     }
     
     const move = moves[Math.floor(Math.random() * moves.length)];
     
     const sourceSq = document.getElementById('sq-' + move.from);
     const targetSq = document.getElementById('sq-' + move.to);
     if (sourceSq) sourceSq.classList.add('hint-source');
     if (targetSq) targetSq.classList.add('hint-target');

     document.getElementById('engineOut').innerText = `Suggestion: ${move.san} (${move.from} â†’ ${move.to})`;
  }
  
  function toggle(el) { el.nextElementSibling.classList.toggle('show'); }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIU Mixer Pro v33 - System Repair</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --deck-bg: #181818;
            --accent: #00ff9d; 
            --accent-dim: #008f58;
            --text-color: #e0e0e0;
            --bar-color: #00ccff;
            --automix-on: #ff00ff;
            --record-on: #ff3333;
            --vote-color: #ffaa00;
        }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Roboto', 'Arial', sans-serif; 
            overflow: hidden; touch-action: none;
            height: 100vh; width: 100vw;
        }

        /* --- LAYOUT WRAPPER --- */
        #app-container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            background: transparent;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* LANDSCAPE MODE */
        @media (orientation: landscape) {
            body { display: flex; justify-content: center; align-items: center; }
            #app-container {
                width: 1024px; height: 768px;
                border: 1px solid #333; padding: 15px;
                background: #181818;
            }
        }

        /* PORTRAIT MODE */
        @media (orientation: portrait) {
            body { display: block; overflow-y: auto; }
            #app-container {
                width: 100%; height: auto; min-height: 100vh;
                padding: 10px; overflow-y: scroll;
                background: #181818;
            }
            .console { flex-direction: column; height: auto !important; margin-bottom: 20px; }
            .deck { margin-bottom: 20px; } 
            .mixer { width: 100% !important; height: 100px !important; flex-direction: row !important; margin-bottom: 10px; }
            .mixer > div { width: 45% !important; height: 100% !important; }
            input[type=range].vertical-fader#master-vol { writing-mode: horizontal-tb; -webkit-appearance: slider-horizontal; width: 100%; }
            .crate-section { height: 400px; }
        }

        header { 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px; height: 40px; flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; color: #fff; }
        
        .top-btn-group { display: flex; gap: 10px; }
        .top-btn {
            background: #333; color: #fff; border: 1px solid #555; padding: 5px 15px;
            font-weight: bold; font-size: 0.8rem; border-radius: 4px; cursor: pointer;
            transition: all 0.2s;
        }
        .top-btn:hover { background: #444; }
        .top-btn.active-mode { background: var(--accent); color:#000; box-shadow: 0 0 10px var(--accent); }
        
        .sync-on { background: var(--bar-color); color: #000; border: 1px solid #fff; box-shadow: 0 0 8px var(--bar-color); }
        .automix-on { background: var(--automix-on); color: white; border: 1px solid white; box-shadow: 0 0 10px var(--automix-on); animation: pulseSlow 2s infinite; }
        .rec-btn.recording { background: var(--record-on); color: white; box-shadow: 0 0 10px red; animation: pulseFast 1s infinite; }

        @keyframes pulseSlow { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @keyframes pulseFast { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- CONSOLE & DECKS --- */
        .console { display: flex; gap: 10px; flex: 1; width: 100%; min-height: 0; margin-bottom: 10px; overflow: hidden; }
        .deck {
            background: var(--deck-bg); flex: 1; padding: 10px; border-radius: 8px;
            display: flex; flex-direction: column; gap: 6px; border: 1px solid #444; position: relative;
            justify-content: space-between; /* Helps distribute space */
        }
        
        /* Compact deck top to save space for pitch slider */
        .deck-top { display: flex; gap: 10px; height: 120px; flex-shrink: 0; justify-content: space-between; align-items: center; }
        .vinyl-wrapper { width: 110px; height: 110px; position: relative; }
        .vinyl {
            width: 100%; height: 100%; background: #111; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 2px solid #333;
        }
        .vinyl-grooves { width: 90%; height: 90%; border-radius: 50%; position: absolute; background: repeating-radial-gradient(#151515, #151515 2px, #252525 3px, #252525 4px); }
        .vinyl-label { width: 35%; height: 35%; background: #d32f2f; border-radius: 50%; z-index: 2; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; color: white; }
        .deck-b .vinyl-label { background: #1976d2; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinning { animation: spin 1.8s linear infinite; }
        .paused { animation-play-state: paused; }

        .controls-group { display: flex; gap: 10px; height: 100%; align-items: center; }
        .knob-container { width: 40px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .gain-container { display: flex; flex-direction: column; align-items: center; width: 30px; height: 100%; background: #111; border-radius: 4px; padding: 5px 0; border: 1px solid #333; }
        input[type=range].vertical-fader { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 100%; height: 100%; background: transparent; }

        .deck-info { background: #0f0f0f; border: 1px solid #333; padding: 5px; border-radius: 4px; font-family: 'Courier New', monospace; color: var(--accent); font-size: 0.8rem; display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; }
        .progress-container { width: 100%; height: 12px; background: #222; border-radius: 3px; overflow: hidden; border: 1px solid #444; position: relative; cursor: pointer; }
        .progress-fill { height: 100%; width: 0%; background: var(--bar-color); transition: width 0.1s linear; }

        .pad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; height: 50px; flex-shrink: 0; }
        .pad { background: #333; border: none; color: #aaa; font-size: 0.7rem; font-weight: bold; border-radius: 4px; cursor: pointer; border-bottom: 2px solid #222; }
        .pad:active { transform: translateY(2px); border-bottom: none; }
        .pad.has-cue { background: var(--accent-dim); color: #fff; border-bottom: 2px solid var(--accent); }
        .pad.set-mode { background: #500; color: #fff; animation: pulseSlow 1s infinite; }

        .transport { display: flex; gap: 8px; height: 40px; flex-shrink: 0; }
        .btn-transport { flex: 1; background: #333; color: #fff; border: none; border-radius: 4px; font-weight: 900; font-size: 0.8rem; cursor: pointer; border-bottom: 3px solid #111; }
        .btn-play.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); color: #000;}

        /* FIXED PITCH CONTAINER - ENFORCED VISIBILITY */
        .pitch-container { 
            background: #111; 
            padding: 8px;
            border-radius: 4px; 
            border: 1px solid #333; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 40px; /* Specific height */
            gap: 5px; 
            flex-shrink: 0;
            z-index: 50; /* Ensure it floats above accidental overlaps */
            margin-top: auto; /* Push to bottom of deck */
        }
        .pitch-slider { flex: 1; -webkit-appearance: none; background: transparent; }
        .pitch-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 25px; width: 40px; background: #555; margin-top: -10px; border-radius: 2px; border: 1px solid #888; cursor: ns-resize; }
        .pitch-reset-btn { width: 35px; height: 35px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; font-size: 0.8rem; font-weight: bold; cursor: pointer; }

        .mixer { width: 100px; background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: space-between; flex-shrink: 0; }

        .crate-section { 
            width: 100%; 
            flex: 1; 
            min-height: 160px;
            background: #111; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 10px; 
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; 
            z-index: 10;
        }
        .crate-header { display: flex; gap: 10px; margin-bottom: 10px; }
        .crate-input { background: #000; border: 1px solid #444; color: #fff; padding: 5px; flex: 1; }
        .crate-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; background: #000; padding: 5px; border: 1px solid #333; }
        .crate-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 6px 10px; border-radius: 4px; border: 1px solid #333; transition: all 0.2s; }
        .item-name { color: #fff; font-size: 0.8rem; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 10px; }
        
        .vote-badge { background: var(--vote-color); color: #000; font-size: 0.7rem; font-weight: bold; padding: 2px 5px; border-radius: 3px; margin-right: 5px; display: none; }
        .vote-badge.visible { display: inline-block; }

        .load-btn { background: #333; color: #fff; border: 1px solid #555; font-size: 0.65rem; padding: 4px 8px; border-radius: 3px; cursor: pointer; }

        /* --- MODALS --- */
        .modal { position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.95); z-index: 99999; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { width: 90%; max-width: 500px; background: #181818; border: 1px solid #444; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .key-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 8px 0; color: #bbb; font-size: 0.85rem; }
        .key-badge { background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: bold; border: 1px solid #555; }
        #bulk-textarea { width: 100%; height: 150px; background: #000; color: #fff; border: 1px solid #444; font-family: monospace; padding: 10px; box-sizing: border-box; }
        #diag-textarea { width: 100%; height: 200px; background: #111; color: #00ff9d; border: 1px solid #333; font-family: monospace; padding: 10px; font-size:0.7rem; white-space: pre; overflow: auto; }

        /* Session List Styles */
        .session-item { display:flex; justify-content:space-between; align-items:center; background:#222; padding:8px; margin-bottom:4px; border:1px solid #333; }
        
        /* VOTER INTERFACE (When accessed as Guest) */
        #voter-app { display: none; width: 100%; height: 100%; background: #000; color: #fff; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .vote-btn { background: var(--vote-color); color: black; font-weight: bold; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
        
        #video-layer { position: absolute; top: -9999px; }

    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <h1>TIU MIXER <span style="font-size:0.7rem; border:1px solid var(--accent); padding:2px 5px; border-radius:4px; color:var(--accent);">v33 REPAIR</span></h1>
            
            <div class="top-btn-group">
                <button class="top-btn" onclick="openDiag()">‚ùì HELP</button>
                <button id="rec-btn" class="top-btn rec-btn" onclick="toggleRecord()">üî¥ REC</button>
                <button id="automix-btn" class="top-btn automix-btn" onclick="toggleAutoMix()">ü§ñ AUTOMIX</button>
                <button class="top-btn" onclick="document.getElementById('keys-modal').style.display='flex'">‚å®Ô∏è KEYS</button>
                <button id="sync-mode-btn" class="top-btn sync-on" onclick="toggleSyncMode()">SYNC: ON</button>
                <button class="top-btn" onclick="openMemory()">üíæ MEMORY</button>
            </div>
        </header>

        <div class="console">
            <div class="deck" id="deck-a">
                <div class="deck-top">
                    <div class="vinyl-wrapper"><div class="vinyl" id="vinyl-a"><div class="vinyl-grooves"></div><div class="vinyl-label">A</div></div></div>
                    <div class="controls-group">
                        <div class="knob-container"><input type="range" class="vertical-fader" id="eq-a" min="0" max="100" value="100" oninput="updateVol()"><span class="knob-label">LOW</span></div>
                        <div class="gain-container"><input type="range" class="vertical-fader" id="gain-a" min="0" max="100" value="80" oninput="updateVol()"></div>
                    </div>
                </div>
                <div class="deck-info">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="time-a">00:00</span>
                        <div>BPM: <span id="bpm-a" style="color:var(--accent); font-weight:bold;">--</span> <span style="cursor:pointer;" onclick="tap('A')">TAP</span></div>
                    </div>
                    <div class="progress-container" onclick="seek('A', event)"><div class="progress-fill" id="prog-a"></div></div>
                </div>
                <div class="pad-grid">
                    <button class="pad" id="cue-a-1" onclick="hotCue('A',1)">1</button>
                    <button class="pad" id="cue-a-2" onclick="hotCue('A',2)">2</button>
                    <button class="pad" id="cue-a-3" onclick="hotCue('A',3)">3</button>
                    <button class="pad" id="set-a" onclick="toggleSet('A')" style="color:#d32f2f;">SET</button>
                    <button class="pad" onclick="loopIn('A')">IN</button>
                    <button class="pad" onclick="loopOut('A')">OUT</button>
                    <button class="pad" id="loop-exit-a" onclick="loopExit('A')">EXIT</button>
                    <button class="pad" onclick="sync('A')" style="color:#00ccff;">SYNC</button>
                </div>
                <div class="transport">
                    <button class="btn-transport" onclick="cue('A')">CUE</button>
                    <button class="btn-transport btn-play" id="play-a" onclick="playToggle('A')">PLAY</button>
                </div>
                <div class="pitch-container">
                    <button class="pitch-reset-btn" onclick="resetPitch('A')">R</button>
                    <input type="range" class="pitch-slider" id="pitch-a" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('A')">
                </div>
                <div class="track-title" id="title-a">No Track Loaded</div>
            </div>

            <div class="mixer">
                <div style="text-align:center; height:60%; display:flex; flex-direction:column; justify-content:center;">
                    <div style="font-size:0.6rem; color:#666; margin-bottom:5px;">MASTER</div>
                    <input type="range" class="vertical-fader" id="master-vol" min="0" max="100" value="100" oninput="updateVol()">
                </div>
                <div style="width:100%; display:flex; flex-direction:column; justify-content:center;">
                    <div style="text-align:center; font-size:0.6rem; color:#666; margin-bottom:5px;">X-FADER</div>
                    <input type="range" id="crossfader" min="0" max="100" value="50" style="width:100%;" oninput="updateVol()">
                    <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#444; margin-top:5px;"><span>A</span><span>B</span></div>
                </div>
            </div>

            <div class="deck deck-b" id="deck-b">
                <div class="deck-top">
                    <div class="controls-group">
                        <div class="gain-container"><input type="range" class="vertical-fader" id="gain-b" min="0" max="100" value="80" oninput="updateVol()"></div>
                        <div class="knob-container"><input type="range" class="vertical-fader" id="eq-b" min="0" max="100" value="100" oninput="updateVol()"><span class="knob-label">LOW</span></div>
                    </div>
                    <div class="vinyl-wrapper"><div class="vinyl" id="vinyl-b"><div class="vinyl-grooves"></div><div class="vinyl-label">B</div></div></div>
                </div>
                <div class="deck-info">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="time-b">00:00</span>
                        <div>BPM: <span id="bpm-b" style="color:var(--accent); font-weight:bold;">--</span> <span style="cursor:pointer;" onclick="tap('B')">TAP</span></div>
                    </div>
                    <div class="progress-container" onclick="seek('B', event)"><div class="progress-fill" id="prog-b"></div></div>
                </div>
                <div class="pad-grid">
                    <button class="pad" id="cue-b-1" onclick="hotCue('B',1)">1</button>
                    <button class="pad" id="cue-b-2" onclick="hotCue('B',2)">2</button>
                    <button class="pad" id="cue-b-3" onclick="hotCue('B',3)">3</button>
                    <button class="pad" id="set-b" onclick="toggleSet('B')" style="color:#d32f2f;">SET</button>
                    <button class="pad" onclick="loopIn('B')">IN</button>
                    <button class="pad" onclick="loopOut('B')">OUT</button>
                    <button class="pad" id="loop-exit-b" onclick="loopExit('B')">EXIT</button>
                    <button class="pad" onclick="sync('B')" style="color:#00ccff;">SYNC</button>
                </div>
                <div class="transport">
                    <button class="btn-transport" onclick="cue('B')">CUE</button>
                    <button class="btn-transport btn-play" id="play-b" onclick="playToggle('B')">PLAY</button>
                </div>
                <div class="pitch-container">
                    <button class="pitch-reset-btn" onclick="resetPitch('B')">R</button>
                    <input type="range" class="pitch-slider" id="pitch-b" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('B')">
                </div>
                <div class="track-title" id="title-b">No Track Loaded</div>
            </div>
        </div>

        <div class="crate-section">
            <div class="crate-header">
                <button class="load-btn" onclick="document.getElementById('bulk-modal').style.display='flex'" style="background:#333; margin-right:10px;">üìÇ BULK ADD</button>
                <button class="load-btn" onclick="shuffleCrate()" style="background:#444; margin-right:10px;">üîÄ SHUFFLE</button>
                <input type="text" id="crate-url" class="crate-input" placeholder="Paste Single URL...">
                <button class="load-btn" onclick="addSingle()">ADD</button>
            </div>
            <div class="crate-list" id="crate-list">
                <div style="padding:10px; color:#444; text-align:center;">Crate Empty.</div>
            </div>
        </div>
    </div>

    <div id="voter-app">
        <h1 style="color:var(--vote-color)">VOTE FOR NEXT TRACK</h1>
        <button class="suggest-toggle" onclick="toggleSuggestBox()">‚ûï Suggest a Song</button>
        <div id="suggest-box" style="display:none; margin-bottom:10px;">
            <input type="text" id="guest-url" class="crate-input" style="width:100%; margin-bottom:10px;" placeholder="Paste YouTube Link...">
            <button class="vote-btn" style="width:100%;" onclick="sendGuestSuggestion()">SEND REQUEST</button>
        </div>
        <div id="voter-list" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <div id="diag-modal" class="modal">
        <div class="modal-box">
            <h2>üîß SYSTEM DIAGNOSTICS</h2>
            <textarea id="diag-textarea" readonly></textarea>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="top-btn" onclick="generateDiag()">REFRESH</button>
                <button class="top-btn" onclick="document.getElementById('diag-modal').style.display='none'">CLOSE</button>
            </div>
        </div>
    </div>

    <div id="memory-modal" class="modal">
        <div class="modal-box">
            <h2>üíæ SESSIONS</h2>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="save-name" class="crate-input" placeholder="Session Name">
                <button class="top-btn accent" onclick="saveToSlot()">SAVE</button>
            </div>
            <div id="session-list" style="max-height:150px; overflow-y:auto; background:#000; border:1px solid #333; margin-bottom:10px;"></div>
            <div style="display:flex; justify-content:space-between;">
                <button class="top-btn" onclick="document.getElementById('import-file').click()">üìÇ IMPORT FILE</button>
                <input type="file" id="import-file" style="display:none;" onchange="importSession(this)">
                <button class="top-btn" onclick="exportSession()">EXPORT JSON</button>
            </div>
            <button class="top-btn" style="margin-top:10px; float:right;" onclick="document.getElementById('memory-modal').style.display='none'">CLOSE</button>
        </div>
    </div>

    <div id="keys-modal" class="modal">
        <div class="modal-box">
            <h2>‚å®Ô∏è SHORTCUTS</h2>
            <div style="display:flex; gap:20px;">
                <div style="flex:1;"><div class="key-row"><span>Play A</span> <span class="key-badge">S</span></div></div>
                <div style="flex:1;"><div class="key-row"><span>Play B</span> <span class="key-badge">K</span></div></div>
            </div>
            <button class="top-btn" style="margin-top:20px; float:right;" onclick="document.getElementById('keys-modal').style.display='none'">CLOSE</button>
        </div>
    </div>

    <div id="bulk-modal" class="modal">
        <div class="modal-box">
            <h2>üìÇ BULK IMPORT</h2>
            <textarea id="bulk-textarea" placeholder="Paste YouTube Links (one per line)"></textarea>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="top-btn" onclick="document.getElementById('bulk-modal').style.display='none'">CANCEL</button>
                <button class="top-btn accent" onclick="processBulk()">PROCESS</button>
            </div>
        </div>
    </div>

    <div id="video-layer"><div id="player-a"></div><div id="player-b"></div></div>

    <script>
        const AUTO_SAVE_KEY = 'tiu_v33';
        var players = { A: null, B: null }, ready = { A: false, B: false };
        var loops = { A: {active:false, in:null, out:null}, B: {active:false, in:null, out:null} };
        var cues = { A: {1:null,2:null,3:null,set:false}, B: {1:null,2:null,3:null,set:false} };
        var tapData = { A: {last:0,count:0,bpm:0}, B: {last:0,count:0,bpm:0} };
        var loadedIDs = { A: null, B: null };
        var crate = [];
        var smartSyncEnabled = true, autoMixEnabled = false, isMixing = false;
        var mediaRecorder, audioChunks = [], isRecording = false;
        var lastError = "None";

        window.addEventListener('resize', resizeApp);
        window.addEventListener('load', () => { resizeApp(); loadAutoSave(); renderSessionList(); });
        window.onerror = function(msg, url, line) { lastError = `${msg} line ${line}`; };

        // --- DIAGNOSTICS ---
        function openDiag() { document.getElementById('diag-modal').style.display='flex'; generateDiag(); }
        function generateDiag() {
            const txt = `TIU SYSTEM REPORT v33\n---------------------\n` +
            `UserAgent: ${navigator.userAgent}\n` +
            `Screen: ${window.innerWidth}x${window.innerHeight}\n` +
            `Player A: ${ready.A ? 'READY' : 'NOT READY'} (ID: ${loadedIDs.A || 'None'})\n` +
            `Player B: ${ready.B ? 'READY' : 'NOT READY'} (ID: ${loadedIDs.B || 'None'})\n` +
            `Crate Size: ${crate.length}\n` +
            `LocalStorage Keys: ${Object.keys(localStorage).length}\n` +
            `Last Error: ${lastError}\n` +
            `---------------------\n` +
            `Dump: ${JSON.stringify(crate).substring(0, 100)}...`;
            document.getElementById('diag-textarea').value = txt;
        }

        // --- YOUTUBE API ---
        var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
        window.onYouTubeIframeAPIReady = function() { 
            createP('A'); 
            // Delay B slightly to prevent race condition
            setTimeout(() => createP('B'), 500); 
            setInterval(loopCheck, 100); 
        };
        function createP(d) {
            try {
                players[d] = new YT.Player('player-'+d.toLowerCase(), {
                    height:'100%', width:'100%', playerVars:{'playsinline':1,'controls':0},
                    events: {
                        'onReady':()=>{ ready[d]=true; updateVol(); console.log(`Deck ${d} Ready`); },
                        'onStateChange':(e)=>{
                             const v = document.getElementById(`vinyl-${d.toLowerCase()}`);
                             e.data===1 ? v.classList.add('spinning','active') : v.classList.remove('spinning','active');
                             e.data===1 ? v.classList.remove('paused') : v.classList.add('paused');
                        },
                        'onError': (e)=> { lastError = `YT Error Deck ${d}: ${e.data}`; }
                    }
                });
            } catch(e) { lastError = e.message; }
        }

        // --- DJ LOGIC ---
        function playToggle(d) { if(ready[d]) players[d].getPlayerState()===1 ? players[d].pauseVideo() : players[d].playVideo(); }
        function cue(d) { if(ready[d]) { players[d].pauseVideo(); players[d].seekTo(0); } }
        function seek(d,e) { if(ready[d]){ const r=e.currentTarget.getBoundingClientRect(); players[d].seekTo(players[d].getDuration()*((e.clientX-r.left)/r.width), true); } }
        function updateVol() {
            const m=document.getElementById('master-vol').value/100, x=document.getElementById('crossfader').value;
            const ga=document.getElementById('gain-a').value/100, gb=document.getElementById('gain-b').value/100;
            const eqa=document.getElementById('eq-a').value/100, eqb=document.getElementById('eq-b').value/100;
            let xa=1, xb=1; if(x<50) xb=x/50; else xa=1-((x-50)/50);
            if(ready.A) players.A.setVolume(ga*eqa*xa*m*100);
            if(ready.B) players.B.setVolume(gb*eqb*xb*m*100);
        }
        function updatePitch(d) { if(ready[d]) players[d].setPlaybackRate(parseFloat(document.getElementById('pitch-'+d.toLowerCase()).value)); }
        function resetPitch(d) { document.getElementById('pitch-'+d.toLowerCase()).value = 1; updatePitch(d); }
        function normalizePitch(d) {
            const slider = document.getElementById('pitch-'+d.toLowerCase());
            let current = parseFloat(slider.value);
            const step = (1.0 - current) / 100; 
            let count = 0;
            const intv = setInterval(() => { current += step; slider.value = current; updatePitch(d); count++; if(count >= 100) clearInterval(intv); }, 100);
        }

        function toggleAutoMix() { autoMixEnabled = !autoMixEnabled; document.getElementById('automix-btn').classList.toggle('automix-on'); }
        function loopCheck() {
            ['A','B'].forEach(d => {
                if(ready[d] && players[d].getCurrentTime) {
                    const t = players[d].getCurrentTime(), dur = players[d].getDuration();
                    if(dur>0) {
                        document.getElementById(`prog-${d.toLowerCase()}`).style.width = ((t/dur)*100)+'%';
                        const m=Math.floor(t/60).toString().padStart(2,'0'), s=Math.floor(t%60).toString().padStart(2,'0');
                        document.getElementById(`time-${d.toLowerCase()}`).innerText = `${m}:${s}`;
                        
                        // AUTOMIX LOGIC
                        if(autoMixEnabled && !isMixing && players[d].getPlayerState()===1) {
                            const cf = parseInt(document.getElementById('crossfader').value);
                            const active = (d==='A' && cf<50) || (d==='B' && cf>50);
                            if(active && (dur-t)<15) triggerAutoMix(d);
                        }
                    }
                    if(loops[d].active && t>=loops[d].out) players[d].seekTo(loops[d].in, true);
                }
            });
        }
        function triggerAutoMix(currD) {
            isMixing = true;
            const nextD = currD==='A'?'B':'A';
            const currID = loadedIDs[currD];
            const currIdx = crate.findIndex(t => t.id === currID);
            let nextIdx = (currIdx >= 0 && currIdx < crate.length-1) ? currIdx + 1 : 0;
            
            // Auto Load next
            load(nextD, nextIdx);
            
            // Force play after short delay to ensure load
            setTimeout(() => { 
                if(ready[nextD]) {
                    players[nextD].playVideo();
                    sync(nextD);
                    doCrossfade(currD, nextD); 
                } else {
                    console.log("Automix aborted: Player not ready");
                    isMixing = false;
                }
            }, 2000);
        }
        function doCrossfade(fromD, toD) {
            let cf = document.getElementById('crossfader');
            let target = fromD==='A' ? 100 : 0, step = fromD==='A' ? 1 : -1;
            let intv = setInterval(() => {
                let val = parseInt(cf.value) + step;
                cf.value = val; updateVol();
                if(val === target) { clearInterval(intv); isMixing = false; normalizePitch(toD); }
            }, 100);
        }

        function generateAutoBpm(id) { let h=0; for(let i=0;i<id.length;i++) h=id.charCodeAt(i)+((h<<5)-h); return Math.abs(h%65)+75; }
        
        // --- CRATE & LOAD ---
        function processBulk() {
            document.getElementById('bulk-textarea').value.split('\n').forEach(l => {
                const m = l.match(/(?:v=|youtu\.be\/|\/)([a-zA-Z0-9_-]{11})/);
                if(m && !crate.some(t=>t.id===m[1])) {
                    const id=m[1]; crate.push({id:id, name:`Track ${id}`, bpm:generateAutoBpm(id), votes:0});
                    fetchTitle(id, id);
                }
            });
            renderCrate(); document.getElementById('bulk-modal').style.display='none';
        }
        function addSingle() {
            const url = document.getElementById('crate-url').value;
            const m = url.match(/(?:v=|youtu\.be\/|\/)([a-zA-Z0-9_-]{11})/);
            if(m) {
                const id = m[1];
                if(crate.some(t=>t.id===id)) return alert("Already in crate");
                crate.push({id:id, name:`Track ${id}`, bpm:generateAutoBpm(id), votes:0});
                fetchTitle(id, id);
                renderCrate(); document.getElementById('crate-url').value = '';
            }
        }
        function fetchTitle(id, lookupId) {
            fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`)
            .then(r=>r.json()).then(d=>{ if(d.title){ const t=crate.find(x=>x.id===lookupId); if(t){t.name=d.title; renderCrate();} } });
        }
        function renderCrate() {
            const l = document.getElementById('crate-list'); l.innerHTML='';
            crate.forEach((t,i) => {
                const d=document.createElement('div'); d.className='crate-item';
                d.innerHTML=`<span class="item-name">${t.name}</span>
                <div style="font-size:0.7rem; display:flex; gap:5px;">
                <button class="load-btn" onclick="load('A',${i})">A</button><button class="load-btn" onclick="load('B',${i})">B</button>
                <button class="load-btn" style="color:#d32f2f;" onclick="remove(${i})">X</button></div>`;
                l.appendChild(d);
            });
            saveAuto();
        }
        function load(d,i) {
            const t=crate[i]; if(!t) return;
            loadedIDs[d]=t.id;
            if(ready[d]) {
                players[d].loadVideoById(t.id);
                document.getElementById('title-'+d.toLowerCase()).innerText=t.name;
                tapData[d].bpm = t.bpm;
                document.getElementById('bpm-'+d.toLowerCase()).innerText=t.bpm;
                resetPitch(d);
            } else {
                alert(`Player ${d} not ready! Check Diagnostics.`);
            }
        }
        function remove(i){ crate.splice(i,1); renderCrate(); }
        function shuffleCrate(){ for(let i=crate.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[crate[i],crate[j]]=[crate[j],crate[i]];} renderCrate(); }

        // --- SESSION MANAGEMENT (FIXED) ---
        function saveToSlot(){
            const name = document.getElementById('save-name').value;
            if(!name) return alert("Please enter a name");
            localStorage.setItem('tiu_s_'+name, JSON.stringify(crate));
            renderSessionList();
            alert("Session Saved!");
        }
        function renderSessionList() {
            const l = document.getElementById('session-list'); l.innerHTML = '';
            for(let i=0; i<localStorage.length; i++) {
                const k = localStorage.key(i);
                if(k.startsWith('tiu_s_')) {
                    const n = k.replace('tiu_s_', '');
                    const d = document.createElement('div'); d.className='session-item';
                    d.innerHTML = `<span style="color:#fff;">${n}</span><div><button class="load-btn" onclick="loadSess('${n}')">LOAD</button>
                    <button class="load-btn" style="color:red;" onclick="delSess('${n}')">X</button></div>`;
                    l.appendChild(d);
                }
            }
        }
        function loadSess(n) { crate = JSON.parse(localStorage.getItem('tiu_s_'+n)); renderCrate(); document.getElementById('memory-modal').style.display='none'; }
        function delSess(n) { localStorage.removeItem('tiu_s_'+n); renderSessionList(); }
        function openMemory(){ document.getElementById('memory-modal').style.display='flex'; renderSessionList(); }
        
        function saveAuto(){ localStorage.setItem(AUTO_SAVE_KEY,JSON.stringify(crate)); }
        function loadAutoSave(){ const d=localStorage.getItem(AUTO_SAVE_KEY); if(d) {crate=JSON.parse(d); renderCrate();} }
        function importSession(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = function(e) { try { crate = JSON.parse(e.target.result); renderCrate(); saveAuto(); document.getElementById('memory-modal').style.display='none'; } catch(err){ alert("Invalid file"); } };
            r.readAsText(f);
        }
        function exportSession() {
            const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(crate));
            a.download = "tiu_mix.json"; document.body.appendChild(a); a.click(); a.remove();
        }

        // --- UTILS ---
        function resizeApp() {
            const c=document.getElementById('app-container');
            if(window.innerWidth>window.innerHeight){
                const s=Math.min(window.innerWidth/1024, window.innerHeight/768)*0.98;
                c.style.transform=`scale(${s})`; c.style.transformOrigin='center top';
                c.style.width='1024px'; c.style.height='768px'; c.style.marginTop='10px'; document.body.style.overflow='hidden';
            } else {
                c.style.transform='none'; c.style.width='100%'; c.style.height='auto'; c.style.marginTop='0'; document.body.style.overflowY='auto';
            }
        }
        function tap(d) {
            const n=Date.now(); if(n-tapData[d].last>2000)tapData[d].count=0;
            tapData[d].last=n; tapData[d].count++;
            if(tapData[d].count>3) { tapData[d].bpm=Math.floor(60000/((n-(n-1000))/4)); document.getElementById('bpm-'+d.toLowerCase()).innerText=tapData[d].bpm; }
        }
        function hotCue(d,n){ if(cues[d].set){cues[d][n]=players[d].getCurrentTime(); toggleSet(d);} else if(cues[d][n]){players[d].seekTo(cues[d][n],true); players[d].playVideo();} }
        function toggleSet(d){cues[d].set=!cues[d].set; document.getElementById('set-'+d.toLowerCase()).classList.toggle('set-mode');}
        function loopIn(d){loops[d].in=players[d].getCurrentTime();}
        function loopOut(d){loops[d].out=players[d].getCurrentTime(); loops[d].active=true; document.getElementById('loop-exit-'+d.toLowerCase()).classList.add('loop-active');}
        function loopExit(d){loops[d].active=false; document.getElementById('loop-exit-'+d.toLowerCase()).classList.remove('loop-active');}
        function toggleSyncMode() { smartSyncEnabled=!smartSyncEnabled; document.getElementById('sync-mode-btn').classList.toggle('sync-on'); }
        function sync(t) {
            const s=t==='A'?'B':'A'; 
            const bpmS=tapData[s].bpm, bpmT=tapData[t].bpm, pS=parseFloat(document.getElementById('pitch-'+s.toLowerCase()).value);
            if(smartSyncEnabled && bpmS && bpmT) {
                let r = (bpmS*pS)/bpmT; if(r<0.5)r=0.5; if(r>1.5)r=1.5;
                document.getElementById('pitch-'+t.toLowerCase()).value=r; updatePitch(t);
            }
        }
        async function toggleRecord() {
            if(!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({audio:true, video:true});
                    mediaRecorder = new MediaRecorder(new MediaStream(stream.getAudioTracks()), {mimeType:'audio/webm'});
                    audioChunks=[];
                    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data)};
                    mediaRecorder.onstop=()=>{
                        const b=new Blob(audioChunks,{type:'audio/webm'});
                        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='mix.webm'; a.click();
                        stream.getTracks().forEach(t=>t.stop());
                        isRecording=false; document.getElementById('rec-btn').classList.remove('recording');
                    };
                    mediaRecorder.start(); isRecording=true; document.getElementById('rec-btn').classList.add('recording');
                } catch(e){ alert("Recording failed/cancelled"); }
            } else { mediaRecorder.stop(); }
        }
        
        document.addEventListener('keydown',e=>{
            if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
            const k=e.key.toLowerCase();
            if(k==='s') playToggle('A'); if(k==='a') cue('A');
            if(k==='k') playToggle('B'); if(k==='l') cue('B');
            if(k==='arrowleft') { const c=document.getElementById('crossfader'); c.value=parseInt(c.value)-5; updateVol(); }
            if(k==='arrowright') { const c=document.getElementById('crossfader'); c.value=parseInt(c.value)+5; updateVol(); }
        });
    </script>
</body>
</html>
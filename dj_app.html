<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIU Mixer Pro v25 - Smart Toggle</title>
    <style>
        :root {
            --bg-color: #000;
            --deck-bg: #1e1e1e;
            --accent: #00ff9d; 
            --accent-dim: #008f58;
            --cue-active: #ff0055;
            --loop-active: #ffee00;
            --text-color: #e0e0e0;
            --bar-color: #00ccff;
        }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Roboto', 'Arial', sans-serif; 
            overflow: hidden; touch-action: none;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; width: 100vw;
        }

        /* --- AUTO SCALER --- */
        #scaler {
            transform-origin: center center;
            display: flex; flex-direction: column; align-items: center;
            width: 1024px; height: 768px; background: #111;
        }

        .app-layer {
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            background: #181818; padding: 15px; box-sizing: border-box; border: 1px solid #333;
        }

        header { 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px; height: 40px;
        }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; color: #fff; }
        
        .top-btn-group { display: flex; gap: 10px; }
        .top-btn {
            background: #333; color: #fff; border: 1px solid #555; padding: 5px 15px;
            font-weight: bold; font-size: 0.8rem; border-radius: 4px; cursor: pointer;
        }
        .top-btn.accent { background: var(--accent-dim); border-color: var(--accent); }
        
        /* SYNC TOGGLE STYLES */
        .sync-toggle-btn {
            display: flex; align-items: center; gap: 5px; width: 130px; justify-content: center;
            transition: all 0.2s;
        }
        .sync-on { background: var(--bar-color); color: #000; border: 1px solid #fff; box-shadow: 0 0 8px var(--bar-color); }
        .sync-off { background: #333; color: #777; border: 1px solid #444; }

        /* --- CONSOLE --- */
        .console { display: flex; gap: 10px; height: 380px; width: 100%; }

        .deck {
            background: var(--deck-bg); flex: 1; padding: 10px; border-radius: 8px;
            display: flex; flex-direction: column; gap: 8px; border: 1px solid #444; position: relative;
        }

        .track-title {
            font-size: 0.8rem; color: #fff; text-align: center; padding: 4px;
            background: #111; border: 1px solid #333; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: 20px;
        }

        .deck-top { display: flex; gap: 10px; height: 130px; }
        
        .vinyl-wrapper { width: 130px; height: 130px; position: relative; }
        .vinyl {
            width: 100%; height: 100%; background: #111; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 2px solid #333;
        }
        .vinyl-grooves {
            width: 90%; height: 90%; border-radius: 50%; position: absolute;
            background: repeating-radial-gradient(#151515, #151515 2px, #252525 3px, #252525 4px);
        }
        .vinyl-label {
            width: 35%; height: 35%; background: #d32f2f; border-radius: 50%; z-index: 2;
            border: 2px solid #fff; display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: bold; color: white;
        }
        .deck-b .vinyl-label { background: #1976d2; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinning { animation: spin 1.8s linear infinite; }
        .paused { animation-play-state: paused; }

        .gain-container {
            display: flex; flex-direction: column; align-items: center; width: 30px;
            background: #111; border-radius: 4px; padding: 5px 0; border: 1px solid #333;
        }
        input[type=range].vertical-fader {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 100%; height: 100%; background: transparent;
        }

        .deck-info {
            background: #0f0f0f; border: 1px solid #333; padding: 5px; border-radius: 4px;
            font-family: 'Courier New', monospace; color: var(--accent); font-size: 0.8rem;
            display: flex; flex-direction: column; gap: 2px;
        }
        .beat-gauge-container {
            width: 100%; height: 6px; background: #000; border-radius: 2px; overflow: hidden;
            border: 1px solid #333; position: relative;
        }
        .beat-piston {
            width: 20%; height: 100%; background: var(--bar-color);
            position: absolute; left: 0; opacity: 0.5;
        }
        @keyframes bounce { 0% { left: 0; } 50% { left: 80%; } 100% { left: 0; } }
        .beating { animation: bounce linear infinite; opacity: 1; }

        .pad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; height: 60px; }
        .pad {
            background: #333; border: none; color: #aaa; font-size: 0.7rem; font-weight: bold;
            border-radius: 4px; cursor: pointer; border-bottom: 2px solid #222;
        }
        .pad:active { transform: translateY(2px); border-bottom: none; }
        .pad.set-mode { background: #500; color: #fff; animation: pulse 1s infinite; }
        .pad.has-cue { background: var(--accent-dim); color: #fff; border-bottom: 2px solid var(--accent); }
        .pad.loop-active { background: var(--loop-active); color: #000; }

        .transport { display: flex; gap: 8px; height: 45px; }
        .btn-transport {
            flex: 1; background: #333; color: #fff; border: none;
            border-radius: 4px; font-weight: 900; font-size: 0.8rem; cursor: pointer;
            border-bottom: 3px solid #111;
        }
        .btn-play.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); color: #000;}

        .pitch-container {
            background: #111; padding: 5px; border-radius: 4px; border: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 40px;
        }
        .pitch-slider { width: 100%; -webkit-appearance: none; background: transparent; }
        .pitch-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 20px; width: 40px; background: #555; 
            margin-top: -8px; border-radius: 2px; border: 1px solid #888;
        }

        .mixer {
            width: 100px; background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #444;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
        }

        .crate-section {
            width: 100%; flex: 1; margin-top: 10px; background: #111; border: 1px solid #333;
            border-radius: 8px; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden;
        }
        
        .crate-header { display: flex; gap: 10px; margin-bottom: 10px; }
        .crate-input { background: #000; border: 1px solid #444; color: #fff; padding: 5px; flex: 1; }
        
        .crate-list {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;
            background: #000; padding: 5px; border: 1px solid #333;
        }
        .crate-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #1a1a1a; padding: 6px 10px; border-radius: 4px; border: 1px solid #333;
        }
        .item-name { color: #fff; font-size: 0.8rem; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 10px; }
        .item-bpm { font-size: 0.7rem; color: var(--accent); margin-right: 10px; font-weight: bold; }
        .load-btn { background: #333; color: #fff; border: 1px solid #555; font-size: 0.65rem; padding: 4px 8px; border-radius: 3px; cursor: pointer; }

        .bpm-btn {
            background: #222; border: 1px solid #444; color: #aaa; font-size: 0.6rem;
            border-radius: 3px; cursor: pointer; padding: 2px 5px; margin-left: 5px;
        }
        .bpm-btn:active { background: var(--accent); color: #000; }

        /* --- MODALS --- */
        .modal {
            position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.95);
            z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box { 
            width: 500px; background: #181818; border: 1px solid #444; padding: 20px; 
            border-radius: 8px; display: flex; flex-direction: column; gap: 10px; 
        }
        .modal h2 { color: #fff; margin-top: 0; }
        
        #bulk-textarea { width: 100%; height: 150px; background: #000; color: #fff; border: 1px solid #444; font-family: monospace; padding: 10px; box-sizing: border-box; }
        
        .mem-row { display: flex; justify-content: space-between; padding: 10px; background: #111; margin-bottom: 5px; border: 1px solid #333; align-items: center; }
        .mem-btn { background: var(--accent-dim); color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        #portrait-warning {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000;
            z-index: 10000; display: none; color: white; align-items: center; justify-content: center;
            text-align: center; font-size: 1.5rem; flex-direction: column; gap: 20px;
        }
        @media (orientation: portrait) { #portrait-warning { display: flex; } }

        #video-layer { position: absolute; top: -9999px; }

    </style>
</head>
<body>

    <div id="portrait-warning">
        <div style="font-size:3rem;">üîÑ</div>
        <div>PLEASE ROTATE PHONE<br>TO LANDSCAPE</div>
    </div>

    <div id="bulk-modal" class="modal">
        <div class="modal-box">
            <h2>BULK IMPORT</h2>
            <div style="color:#aaa;">Paste TubePilot Links or IDs (one per line):</div>
            <textarea id="bulk-textarea"></textarea>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="top-btn" onclick="document.getElementById('bulk-modal').style.display='none'">CANCEL</button>
                <button class="top-btn accent" onclick="processBulk()">PROCESS</button>
            </div>
        </div>
    </div>

    <div id="memory-modal" class="modal">
        <div class="modal-box">
            <h2>üíæ MEMORY & SESSIONS</h2>
            
            <div style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">
                <div style="color:#aaa; font-size:0.8rem; margin-bottom:5px;">QUICK ACTIONS</div>
                <div style="display:flex; gap:10px;">
                    <button class="top-btn" onclick="exportSession()">EXPORT TO FILE</button>
                    <button class="top-btn" onclick="document.getElementById('import-file').click()">IMPORT FILE</button>
                    <input type="file" id="import-file" style="display:none;" onchange="importSession(this)">
                </div>
            </div>

            <div style="color:#aaa; font-size:0.8rem; margin-bottom:5px;">SAVED SESSIONS</div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="save-name" class="crate-input" placeholder="Session Name (e.g. House Mix)">
                <button class="top-btn accent" onclick="saveToSlot()">SAVE</button>
            </div>

            <div id="session-list" style="max-height:150px; overflow-y:auto; background:#000; border:1px solid #333;">
                </div>

            <div style="margin-top:10px; text-align:right;">
                <button class="top-btn" onclick="closeMemory()">CLOSE</button>
            </div>
        </div>
    </div>

    <div id="video-layer">
        <div id="player-a"></div>
        <div id="player-b"></div>
    </div>

    <div id="scaler">
        <div class="app-layer">
            <header>
                <h1>TIU MIXER <span style="font-size:0.7rem; border:1px solid var(--accent); padding:2px 5px; border-radius:4px; color:var(--accent);">PRO v25</span></h1>
                
                <div class="top-btn-group">
                    <button id="sync-mode-btn" class="top-btn sync-toggle-btn sync-on" onclick="toggleSyncMode()">
                        SMART SYNC: ON
                    </button>
                    <button class="top-btn" onclick="openMemory()">üíæ MEMORY</button>
                </div>
            </header>

            <div class="console">
                <div class="deck" id="deck-a">
                    <div class="track-title" id="title-a">No Track Loaded</div>
                    <div class="deck-top">
                        <div class="vinyl-wrapper">
                            <div class="vinyl" id="vinyl-a">
                                <div class="vinyl-grooves"></div>
                                <div class="vinyl-label">A</div>
                            </div>
                        </div>
                        <div class="gain-container">
                            <input type="range" class="vertical-fader" id="gain-a" min="0" max="100" value="80" oninput="updateVol()">
                        </div>
                    </div>
                    
                    <div class="deck-info">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span id="time-a">00:00</span>
                            <div style="display:flex; align-items:center;">
                                <span style="font-size:0.7rem; color:#666; margin-right:5px;">BPM:</span>
                                <span id="bpm-a" style="color:var(--accent); font-weight:bold;">--</span>
                                <button class="bpm-btn" onclick="saveBPM('A')" title="Save BPM">üíæ</button>
                                <span style="cursor:pointer; font-weight:bold; margin-left:8px;" onclick="tap('A')">TAP</span>
                            </div>
                        </div>
                        <div class="beat-gauge-container"><div class="beat-piston" id="piston-a"></div></div>
                    </div>

                    <div class="pad-grid">
                        <button class="pad" id="cue-a-1" onclick="hotCue('A',1)">1</button>
                        <button class="pad" id="cue-a-2" onclick="hotCue('A',2)">2</button>
                        <button class="pad" id="cue-a-3" onclick="hotCue('A',3)">3</button>
                        <button class="pad" id="set-a" onclick="toggleSet('A')" style="color:#d32f2f;">SET</button>
                        
                        <button class="pad" onclick="loopIn('A')">IN</button>
                        <button class="pad" onclick="loopOut('A')">OUT</button>
                        <button class="pad" id="loop-exit-a" onclick="loopExit('A')">EXIT</button>
                        <button class="pad" onclick="sync('A')" style="color:#00ccff;">SYNC</button>
                    </div>

                    <div class="transport">
                        <button class="btn-transport" onclick="cue('A')">CUE</button>
                        <button class="btn-transport btn-play" id="play-a" onclick="playToggle('A')">PLAY</button>
                    </div>

                    <div class="pitch-container">
                        <input type="range" class="pitch-slider" id="pitch-a" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('A')">
                    </div>
                </div>

                <div class="mixer">
                    <div style="text-align:center; height:60%;">
                        <div style="font-size:0.6rem; color:#666; margin-bottom:5px;">MASTER</div>
                        <input type="range" class="vertical-fader" id="master-vol" min="0" max="100" value="100" oninput="updateVol()">
                    </div>
                    <div style="width:100%;">
                        <div style="text-align:center; font-size:0.6rem; color:#666; margin-bottom:5px;">X-FADER</div>
                        <input type="range" id="crossfader" min="0" max="100" value="50" style="width:100%;" oninput="updateVol()">
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#444; margin-top:5px;"><span>A</span><span>B</span></div>
                    </div>
                </div>

                <div class="deck deck-b" id="deck-b">
                    <div class="track-title" id="title-b">No Track Loaded</div>
                    <div class="deck-top">
                        <div class="gain-container">
                            <input type="range" class="vertical-fader" id="gain-b" min="0" max="100" value="80" oninput="updateVol()">
                        </div>
                        <div class="vinyl-wrapper">
                            <div class="vinyl" id="vinyl-b">
                                <div class="vinyl-grooves"></div>
                                <div class="vinyl-label">B</div>
                            </div>
                        </div>
                    </div>

                    <div class="deck-info">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span id="time-b">00:00</span>
                            <div style="display:flex; align-items:center;">
                                <span style="font-size:0.7rem; color:#666; margin-right:5px;">BPM:</span>
                                <span id="bpm-b" style="color:var(--accent); font-weight:bold;">--</span>
                                <button class="bpm-btn" onclick="saveBPM('B')" title="Save BPM">üíæ</button>
                                <span style="cursor:pointer; font-weight:bold; margin-left:8px;" onclick="tap('B')">TAP</span>
                            </div>
                        </div>
                        <div class="beat-gauge-container"><div class="beat-piston" id="piston-b"></div></div>
                    </div>

                    <div class="pad-grid">
                        <button class="pad" id="cue-b-1" onclick="hotCue('B',1)">1</button>
                        <button class="pad" id="cue-b-2" onclick="hotCue('B',2)">2</button>
                        <button class="pad" id="cue-b-3" onclick="hotCue('B',3)">3</button>
                        <button class="pad" id="set-b" onclick="toggleSet('B')" style="color:#d32f2f;">SET</button>

                        <button class="pad" onclick="loopIn('B')">IN</button>
                        <button class="pad" onclick="loopOut('B')">OUT</button>
                        <button class="pad" id="loop-exit-b" onclick="loopExit('B')">EXIT</button>
                        <button class="pad" onclick="sync('B')" style="color:#00ccff;">SYNC</button>
                    </div>

                    <div class="transport">
                        <button class="btn-transport" onclick="cue('B')">CUE</button>
                        <button class="btn-transport btn-play" id="play-b" onclick="playToggle('B')">PLAY</button>
                    </div>

                    <div class="pitch-container">
                        <input type="range" class="pitch-slider" id="pitch-b" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('B')">
                    </div>
                </div>
            </div>

            <div class="crate-section">
                <div class="crate-header">
                    <button class="load-btn" onclick="document.getElementById('bulk-modal').style.display='flex'" style="background:#333; margin-right:10px;">üìù BULK ADD</button>
                    <input type="text" id="crate-url" class="crate-input" placeholder="Paste Single URL...">
                    <button class="load-btn" onclick="addSingle()">ADD</button>
                </div>
                <div class="crate-list" id="crate-list">
                    <div style="padding:10px; color:#444; text-align:center;">Crate Empty.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STORAGE CONSTANTS ---
        const AUTO_SAVE_KEY = 'tiu_autosave_v2';
        const SESSION_PREFIX = 'tiu_session_';

        // --- AUTO SCALER ---
        function resizeApp() {
            const scaler = document.getElementById('scaler');
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            const baseW = 1024; const baseH = 768;
            const scaleX = winW / baseW;
            const scaleY = winH / baseH;
            const scale = Math.min(scaleX, scaleY) * 0.98; 
            scaler.style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', resizeApp);
        window.addEventListener('load', () => {
            resizeApp();
            loadAutoSave(); 
        });

        // --- APP STATE ---
        var players = { A: null, B: null };
        var ready = { A: false, B: false };
        var loops = { A: {active:false, in:null, out:null}, B: {active:false, in:null, out:null} };
        var cues = { A: {1:null,2:null,3:null,set:false}, B: {1:null,2:null,3:null,set:false} };
        var tapData = { A: {last:0,count:0,bpm:0}, B: {last:0,count:0,bpm:0} };
        var loadedIndices = { A: -1, B: -1 };
        var crate = [];
        var smartSyncEnabled = true; // Default to ON

        // --- YOUTUBE SETUP ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = function() {
            createP('A', 'player-a');
            createP('B', 'player-b');
            setInterval(loopCheck, 50);
        };

        function createP(d, id) {
            players[d] = new YT.Player(id, {
                height: '100%', width: '100%',
                playerVars: { 'playsinline': 1, 'controls': 0, 'origin': window.location.origin },
                events: {
                    'onReady': (e) => { ready[d] = true; updateVol(); },
                    'onStateChange': (e) => {
                        const vinyl = document.getElementById(`vinyl-${d.toLowerCase()}`);
                        const btn = document.getElementById(`play-${d.toLowerCase()}`);
                        const piston = document.getElementById(`piston-${d.toLowerCase()}`);
                        if(e.data === 1) { 
                            vinyl.classList.add('spinning'); vinyl.classList.remove('paused');
                            btn.classList.add('active');
                            if(tapData[d].bpm > 0) piston.classList.add('beating');
                        } else {
                            vinyl.classList.add('paused');
                            btn.classList.remove('active');
                            piston.classList.remove('beating');
                        }
                    }
                }
            });
        }

        // --- DJ LOGIC ---
        function playToggle(d) {
            if(!ready[d]) return;
            players[d].getPlayerState() === 1 ? players[d].pauseVideo() : players[d].playVideo();
        }

        function cue(d) {
            if(!ready[d]) return;
            players[d].pauseVideo();
            players[d].seekTo(0);
        }

        function updateVol() {
            const m = document.getElementById('master-vol').value / 100;
            const x = document.getElementById('crossfader').value;
            const ga = document.getElementById('gain-a').value / 100;
            const gb = document.getElementById('gain-b').value / 100;
            let xa = 1, xb = 1;
            if (x < 50) xb = x/50; else if (x > 50) xa = 1 - ((x-50)/50);
            if(ready.A) players.A.setVolume(ga * xa * m * 100);
            if(ready.B) players.B.setVolume(gb * xb * m * 100);
        }

        function updatePitch(d) {
            if(!ready[d]) return;
            const val = parseFloat(document.getElementById(`pitch-${d.toLowerCase()}`).value);
            players[d].setPlaybackRate(val);
            updateGauge(d);
        }

        function toggleSet(d) {
            cues[d].set = !cues[d].set;
            document.getElementById(`set-${d.toLowerCase()}`).classList.toggle('set-mode');
        }
        function hotCue(d, n) {
            if(!ready[d]) return;
            const btn = document.getElementById(`cue-${d.toLowerCase()}-${n}`);
            if(cues[d].set) {
                cues[d][n] = players[d].getCurrentTime();
                btn.classList.add('has-cue');
                toggleSet(d);
            } else if(cues[d][n] !== null) {
                players[d].seekTo(cues[d][n], true);
                players[d].playVideo();
            }
        }

        function loopIn(d) { if(ready[d]) loops[d].in = players[d].getCurrentTime(); }
        function loopOut(d) {
            if(ready[d] && loops[d].in !== null) {
                loops[d].out = players[d].getCurrentTime();
                loops[d].active = true;
                document.getElementById(`loop-exit-${d.toLowerCase()}`).classList.add('loop-active');
            }
        }
        function loopExit(d) {
            loops[d].active = false;
            document.getElementById(`loop-exit-${d.toLowerCase()}`).classList.remove('loop-active');
        }
        function loopCheck() {
            ['A','B'].forEach(d => {
                if(ready[d]) {
                    const t = players[d].getCurrentTime();
                    const m = Math.floor(t/60).toString().padStart(2,'0');
                    const s = Math.floor(t%60).toString().padStart(2,'0');
                    document.getElementById(`time-${d.toLowerCase()}`).innerText = `${m}:${s}`;
                    if(loops[d].active && loops[d].out && t >= loops[d].out) {
                        players[d].seekTo(loops[d].in, true);
                    }
                }
            });
        }

        // --- BPM, SAVE & AUTO SYNC ---
        function tap(d) {
            const now = Date.now();
            if(now - tapData[d].last > 2000) { tapData[d].count=0; }
            tapData[d].last = now;
            tapData[d].count++;
            if(tapData[d].count > 3) { 
                tapData[d].bpm = 80 + Math.floor(Math.random()*60); 
                document.getElementById(`bpm-${d.toLowerCase()}`).innerText = tapData[d].bpm;
                updateGauge(d);
            }
        }

        function saveBPM(d) {
            const idx = loadedIndices[d];
            if(idx === -1) return alert("Load a track first!");
            const bpm = tapData[d].bpm;
            if(!bpm || bpm <= 0) return alert("Tap a BPM first!");
            crate[idx].bpm = bpm;
            saveAuto();
            renderCrate();
            alert(`Saved ${bpm} BPM for ${crate[idx].name}`);
        }

        function updateGauge(d) {
            const piston = document.getElementById(`piston-${d.toLowerCase()}`);
            if(tapData[d].bpm > 0) {
                const pitch = parseFloat(document.getElementById(`pitch-${d.toLowerCase()}`).value);
                const dur = 60 / (tapData[d].bpm * pitch);
                piston.style.animationDuration = `${dur}s`;
                if(players[d].getPlayerState() === 1) piston.classList.add('beating');
            }
        }

        // --- NEW SYNC TOGGLE LOGIC ---
        function toggleSyncMode() {
            smartSyncEnabled = !smartSyncEnabled;
            const btn = document.getElementById('sync-mode-btn');
            if(smartSyncEnabled) {
                btn.classList.add('sync-on');
                btn.classList.remove('sync-off');
                btn.innerText = "SMART SYNC: ON";
            } else {
                btn.classList.add('sync-off');
                btn.classList.remove('sync-on');
                btn.innerText = "SMART SYNC: OFF";
            }
        }

        function sync(target) {
            if(!ready.A || !ready.B) return;

            const sourceKey = (target === 'A') ? 'B' : 'A';
            const targetKey = target;

            // Get pitch of source deck
            const pitchSource = parseFloat(document.getElementById(`pitch-${sourceKey.toLowerCase()}`).value);
            
            const bpmSource = tapData[sourceKey].bpm;
            const bpmTarget = tapData[targetKey].bpm;

            let newPitch = 1;

            if (smartSyncEnabled && bpmSource > 0 && bpmTarget > 0) {
                // SMART MODE: Calculate exact math
                const effectiveSourceBpm = bpmSource * pitchSource;
                newPitch = effectiveSourceBpm / bpmTarget;
            } else {
                // MANUAL/DUMB MODE: Just copy the other fader's position
                newPitch = pitchSource;
            }

            // Safety Clamps (0.5x to 1.5x)
            if(newPitch < 0.5) newPitch = 0.5;
            if(newPitch > 1.5) newPitch = 1.5;

            // Apply
            document.getElementById(`pitch-${targetKey.toLowerCase()}`).value = newPitch;
            updatePitch(targetKey);
        }

        // --- CRATE & IMPORT ---
        function processBulk() {
            const txt = document.getElementById('bulk-textarea').value;
            const lines = txt.split('\n');
            let c = 0;
            lines.forEach(l => {
                let id = null;
                const m = l.match(/(?:v=|youtu\.be\/|\/)([a-zA-Z0-9_-]{11})/);
                if(m) id = m[1]; else if(l.trim().length === 11) id = l.trim();
                if(id && !crate.some(t=>t.id===id)) {
                    crate.push({id:id, name:`Track ${id}`, bpm:null});
                    fetchTitle(id, crate.length-1);
                    c++;
                }
            });
            renderCrate();
            saveAuto();
            document.getElementById('bulk-modal').style.display = 'none';
            document.getElementById('bulk-textarea').value = '';
        }

        function addSingle() {
            const url = document.getElementById('crate-url').value;
            const m = url.match(/(?:v=|youtu\.be\/|\/)([a-zA-Z0-9_-]{11})/);
            if(m) {
                crate.push({id:m[1], name:`Track ${m[1]}`, bpm:null});
                fetchTitle(m[1], crate.length-1);
                renderCrate();
                saveAuto();
                document.getElementById('crate-url').value = '';
            }
        }

        function fetchTitle(id, idx) {
            fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`)
            .then(r=>r.json()).then(d=>{ 
                if(d.title){ 
                    crate[idx].name=d.title; 
                    renderCrate(); 
                    saveAuto();
                }
            });
        }

        function renderCrate() {
            const l = document.getElementById('crate-list');
            l.innerHTML = '';
            crate.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = 'crate-item';
                const bpmDisplay = t.bpm ? `<span class="item-bpm">${t.bpm} BPM</span>` : '';
                div.innerHTML = `
                    <span class="item-name">${t.name}</span>
                    <div style="display:flex; gap:5px; align-items:center;">
                        ${bpmDisplay}
                        <button class="load-btn" onclick="load(0,${i})">A</button>
                        <button class="load-btn" onclick="load(1,${i})">B</button>
                        <button class="load-btn" style="color:red;" onclick="remove(${i})">X</button>
                    </div>
                `;
                l.appendChild(div);
            });
        }

        function load(dIdx, tIdx) {
            const d = dIdx===0?'A':'B';
            const t = crate[tIdx];
            loadedIndices[d] = tIdx;

            if(ready[d]) {
                players[d].loadVideoById(t.id);
                document.getElementById(`title-${d.toLowerCase()}`).innerText = t.name;
                loops[d]={active:false,in:null,out:null};
                cues[d]={1:null,2:null,3:null,set:false};
                document.getElementById(`loop-exit-${d.toLowerCase()}`).classList.remove('loop-active');
                [1,2,3].forEach(n=>document.getElementById(`cue-${d.toLowerCase()}-${n}`).classList.remove('has-cue'));

                if(t.bpm) {
                    tapData[d].bpm = t.bpm;
                    document.getElementById(`bpm-${d.toLowerCase()}`).innerText = t.bpm;
                    updateGauge(d);
                } else {
                    tapData[d].bpm = 0;
                    document.getElementById(`bpm-${d.toLowerCase()}`).innerText = "--";
                    document.getElementById(`piston-${d.toLowerCase()}`).classList.remove('beating');
                }
            }
        }
        function remove(i) { crate.splice(i,1); renderCrate(); saveAuto(); }

        // --- SAVING SYSTEM ---
        function openMemory() {
            renderSessionList();
            document.getElementById('memory-modal').style.display = 'flex';
        }
        function closeMemory() {
            document.getElementById('memory-modal').style.display = 'none';
        }

        function saveAuto() {
            localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(crate));
        }
        function loadAutoSave() {
            const data = localStorage.getItem(AUTO_SAVE_KEY);
            if(data) {
                try { crate = JSON.parse(data); renderCrate(); } catch(e){}
            }
        }

        function saveToSlot() {
            const name = document.getElementById('save-name').value.trim();
            if(!name) return alert("Enter a name!");
            localStorage.setItem(SESSION_PREFIX + name, JSON.stringify(crate));
            document.getElementById('save-name').value = '';
            renderSessionList();
        }

        function renderSessionList() {
            const list = document.getElementById('session-list');
            list.innerHTML = '';
            for(let i=0; i<localStorage.length; i++) {
                const k = localStorage.key(i);
                if(k.startsWith(SESSION_PREFIX)) {
                    const sessionName = k.replace(SESSION_PREFIX, '');
                    const div = document.createElement('div');
                    div.className = 'mem-row';
                    div.innerHTML = `
                        <span style="color:#fff;">${sessionName}</span>
                        <div>
                            <button class="mem-btn" onclick="loadSession('${sessionName}')">LOAD</button>
                            <button class="mem-btn" style="background:#d32f2f;" onclick="deleteSession('${sessionName}')">X</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            }
        }

        function loadSession(name) {
            const data = localStorage.getItem(SESSION_PREFIX + name);
            if(data && confirm("Load this session? Current crate will be replaced.")) {
                crate = JSON.parse(data);
                renderCrate();
                saveAuto();
                closeMemory();
            }
        }
        
        function deleteSession(name) {
            if(confirm("Delete this session permanently?")) {
                localStorage.removeItem(SESSION_PREFIX + name);
                renderSessionList();
            }
        }

        function exportSession() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(crate));
            const a = document.createElement('a');
            a.href = str; a.download = "tiu_mix.json";
            document.body.appendChild(a); a.click(); a.remove();
        }
        function importSession(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = function(e) {
                try { 
                    crate = JSON.parse(e.target.result); 
                    renderCrate(); 
                    saveAuto();
                    closeMemory();
                } catch(err){ alert("Invalid file"); }
            };
            r.readAsText(f);
        }
    </script>
</body>
</html>
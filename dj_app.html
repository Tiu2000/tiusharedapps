<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIU Mixer Pro v67 - Cash App & Tempo</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --panel-bg: #141414;
            --panel-border: #2a2a2a;
            --text-main: #e0e0e0;
            --accent-a: #ff4757; 
            --accent-b: #1e90ff; 
            --accent-main: #2ed573;
            --gold: #ffa502;
            --cash-green: #00d632;
        }

        * { box-sizing: border-box; user-select: none; }

        body { 
            margin: 0; padding: 0; 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            height: 100vh; width: 100vw; 
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* WATERMARK - HIGH VISIBILITY */
        .watermark { 
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%) rotate(-10deg); 
            font-size: 35vw; 
            font-weight: 900; 
            color: rgba(255, 255, 255, 0.08); 
            pointer-events: none; 
            z-index: 9999; 
            white-space: nowrap; 
            mix-blend-mode: overlay;
        }

        /* --- MAIN LAYOUT --- */
        #app-layout {
            display: flex; flex-direction: column;
            width: 1280px; height: 720px; 
            padding: 10px; gap: 10px;
            background: rgba(20,20,20,0.9); 
            backdrop-filter: blur(10px);
            border: 1px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            position: relative; z-index: 1;
        }

        /* --- HEADER --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--panel-bg); border: 1px solid var(--panel-border);
            padding: 5px 15px; border-radius: 8px; height: 45px; flex-shrink: 0;
        }
        .brand { font-weight: 900; letter-spacing: 1px; color: #fff; font-size: 1.1rem; }
        .version-badge { background: var(--accent-main); color: #000; font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }
        
        .toolbar { display: flex; gap: 8px; }
        .tool-btn { background: #222; color: #aaa; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; border: 1px solid #333; }
        .tool-btn:hover { background: #333; color: white; }
        
        /* CASH APP BUTTON STYLE */
        .btn-cash { color: var(--cash-green); border-color: var(--cash-green); font-weight: 900; }
        .btn-cash:hover { background: var(--cash-green); color: black; }

        .btn-record.active { background: #ff4757; color: white; animation: pulse 2s infinite; }
        .btn-auto.active { background: #d63031; color: white; }
        .btn-sync.active { background: var(--accent-main); color: #000; }

        /* --- CONSOLE GRID --- */
        .console-grid {
            display: grid;
            grid-template-columns: 1fr 340px 1fr; /* Wider middle for QR */
            gap: 10px;
            height: 480px; /* Fixed height for controls */
            flex-shrink: 0;
        }

        /* --- DECKS --- */
        .deck-panel {
            background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 8px;
            display: flex; flex-direction: column; padding: 10px; position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            min-width: 0; /* Prevents overflow */
        }
        .deck-a-accent { border-top: 3px solid var(--accent-a); }
        .deck-b-accent { border-top: 3px solid var(--accent-b); }

        .track-display {
            background: #000; border: 1px solid #333; color: var(--accent-main);
            font-family: 'Courier New', monospace; padding: 8px; border-radius: 4px;
            margin-bottom: 10px; display: flex; flex-direction: column; gap: 4px;
            min-width: 0;
        }
        .track-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85rem; color: #fff; text-align: center; width:100%; }
        .track-meta { display: flex; justify-content: space-between; font-size: 0.75rem; align-items: center; }
        .bpm-editor { display: flex; gap: 5px; align-items: center; }
        .bpm-btn { width: 15px; height: 15px; background: #333; color: #fff; font-size: 0.6rem; border-radius: 2px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .progress-bar-bg { height: 8px; background: #222; width: 100%; border-radius: 3px; overflow: hidden; margin-top: 2px; cursor: pointer; }
        .progress-fill { height: 100%; width: 0%; background: var(--accent-main); transition: width 0.1s linear; }

        /* --- DIGITAL KNOBS --- */
        .controls-row { display: flex; justify-content: space-between; align-items: center; flex: 1; gap: 10px; }
        .knob-column { display: flex; flex-direction: column; gap: 10px; align-items: center; width: 60px; }
        
        .digital-knob {
            width: 50px; height: 50px;
            background: #222; border-radius: 50%; border: 2px solid #444;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .knob-label { font-size: 0.5rem; color: #888; font-weight: bold; margin-bottom: -2px; pointer-events: none; }
        .knob-value { font-size: 0.9rem; font-weight: bold; color: var(--accent-main); z-index: 1; pointer-events: none; }
        .knob-range {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: ns-resize; margin: 0; padding: 0;
        }

        /* VINYL */
        .platter-area { flex: 1; display: flex; justify-content: center; align-items: center; }
        .vinyl-disc {
            width: 140px; height: 140px; background: #111; border-radius: 50%; border: 2px solid #333;
            position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        }
        .vinyl-grooves {
            width: 90%; height: 90%; border-radius: 50%; position: absolute;
            background: repeating-radial-gradient(#181818, #181818 2px, #282828 3px, #282828 4px);
        }
        .vinyl-label {
            width: 35%; height: 35%; border-radius: 50%; z-index: 2; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1rem; color: white; border: 2px solid rgba(255,255,255,0.2);
        }
        .deck-a-accent .vinyl-label { background: var(--accent-a); }
        .deck-b-accent .vinyl-label { background: var(--accent-b); }
        .spinning { animation: spin 1.8s linear infinite; }
        .paused { animation-play-state: paused; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* PADS & TRANSPORT */
        .pad-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; }
        .pad { background: #2a2a2a; color: #888; font-size: 0.65rem; font-weight: bold; padding: 8px 0; border-radius: 3px; border-bottom: 2px solid #1a1a1a; }
        .pad:active { transform: translateY(2px); border-bottom: 0; background: #333; }
        .pad.active-cue { color: #fff; background: #444; border-bottom-color: var(--accent-main); }
        .pad.set-active { background: #d63031; color: white; animation: pulse 1s infinite; }

        .transport-row { display: flex; gap: 10px; height: 45px; }
        .btn-cue { flex: 1; background: #333; color: #fff; border-radius: 4px; font-weight: bold; font-size: 0.9rem; border-bottom: 3px solid #111; }
        .btn-play { flex: 2; background: #222; color: #ccc; border-radius: 4px; font-weight: bold; font-size: 1.1rem; border-bottom: 3px solid #111; }
        .deck-a-accent .btn-play.active { background: var(--accent-a); color: white; box-shadow: 0 0 15px var(--accent-a); }
        .deck-b-accent .btn-play.active { background: var(--accent-b); color: white; box-shadow: 0 0 15px var(--accent-b); }
        .btn-cue:active, .btn-play:active { border-bottom: 0; transform: translateY(3px); }

        /* PITCH CONTROLS */
        .pitch-wrap { display: flex; align-items: center; gap: 5px; margin-top: 10px; background: #111; padding: 5px; border-radius: 4px; }
        .btn-reset { background: #333; color: #fff; font-size: 0.7rem; width: 30px; height: 20px; border-radius: 2px; }
        .pitch-nudge { background: #333; color: #fff; font-size: 0.7rem; width: 25px; height: 20px; border-radius: 2px; font-weight: bold; cursor: pointer; }
        input[type=range].h-slider { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range].h-slider::-webkit-slider-thumb { height: 16px; width: 12px; border-radius: 2px; background: #ccc; -webkit-appearance: none; margin-top: -6px; border: 1px solid #999; }
        input[type=range].h-slider::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }

        /* --- MIXER PANEL --- */
        .mixer-panel { background: #111; border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; padding: 10px; }
        
        .visualizer-stack { display: flex; height: 140px; gap: 5px; background: #000; margin-bottom: 10px; }
        .monitor { flex: 1; border: 1px solid #555; position: relative; overflow: hidden; cursor: pointer; }
        .click-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; }
        .yt-frame { width: 100%; height: 100%; pointer-events: none; opacity: 0.8; }
        .monitor.active .yt-frame { opacity: 1; }

        #mixer-qr-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1a1a1a; border-radius: 4px; border: 1px solid #444; margin-bottom: 10px; min-height: 120px; }
        #mixer-qr-img { width: 90px; height: 90px; border: 3px solid white; background: white; }

        .mixer-controls { height: 80px; display: flex; align-items: flex-end; gap: 10px; }
        
        /* Master Knob */
        .master-section { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 70px; }
        .master-knob { width: 60px; height: 60px; border-color: #666; }
        .master-knob .knob-value { color: #fff; font-size: 1.1rem; }

        .crossfader-area { background: #1a1a1a; padding: 10px; border-radius: 6px; border: 1px solid #333; flex: 1; text-align: center; }
        .xf-labels { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: bold; color: #555; margin-top: 5px; }
        #crossfader::-webkit-slider-thumb { height: 24px; width: 40px; background: #fff; border: 1px solid #aaa; margin-top: -10px; }

        /* --- CRATE --- */
        .crate-panel {
            background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 8px;
            flex: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden;
            z-index: 20; box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
        }
        .crate-header { display: flex; gap: 8px; padding: 8px; background: #1a1a1a; border-bottom: 1px solid #333; }
        .crate-input { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 0 10px; border-radius: 4px; font-family: inherit; }
        .crate-list { flex: 1; overflow-y: auto; background: #080808; }
        .crate-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 12px; border-bottom: 1px solid #1a1a1a; font-size: 0.85rem; }
        .crate-item:hover { background: #111; }
        .item-name { flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 10px; }
        .load-btn { font-size: 0.65rem; padding: 3px 8px; background: #333; color: #fff; border-radius: 3px; margin-left: 2px; }
        
        .top-btn-priority { background: var(--gold); color: #000; font-weight: 900; margin-right: 5px; }
        .top-btn-priority:hover { background: #ffbe42; }
        .vote-count { color: var(--gold); font-weight: bold; margin-right: 5px; text-shadow: 0 0 5px rgba(255, 165, 2, 0.5); }

        /* --- UTILS --- */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: #181818; border: 1px solid #333; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; text-align: center; }
        .hidden { display: none !important; }
        .start-btn { background: linear-gradient(45deg, var(--accent-a), var(--accent-b)); color: white; font-size: 1.5rem; font-weight: 900; padding: 15px 40px; border-radius: 50px; box-shadow: 0 0 20px rgba(0,100,255,0.4); animation: pulse 2s infinite; }
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--accent-main); color: #000; padding: 10px 20px; border-radius: 30px; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 10000; pointer-events: none; }
        #toast.visible { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        
        .cash-link { display: inline-block; background: var(--cash-green); color: white; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-weight: bold; margin-top: 15px; }

        @media (orientation: portrait) {
            #app-layout { width: 100%; height: auto; transform: none !important; overflow-y: auto; display: block; }
            .console-grid { display: flex; flex-direction: column; height: auto; }
            .mixer-panel { margin: 10px 0; }
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="start-overlay" class="overlay">
        <div style="text-align:center;">
            <h1 style="color:white; margin-bottom:10px; font-size:3rem; letter-spacing:-2px;">TIU MIXER PRO</h1>
            <p style="color:#666; margin-bottom:30px;">Professional Web DJ System</p>
            <button class="start-btn" onclick="startSystem()">INITIALIZE SYSTEM üöÄ</button>
        </div>
    </div>

    <div id="toast">Notification</div>
    <div class="watermark">TIU</div>

    <div id="app-layout">
        
        <div class="top-bar">
            <div class="brand">TIU MIXER <span class="version-badge">v67</span></div>
            <div id="automix-status" style="display:none; color:var(--accent-main); font-weight:bold; font-size:0.9rem;">ü§ñ AUTOMIX ACTIVE</div>
            <div class="toolbar">
                <button class="tool-btn btn-cash" onclick="openModal('support-modal')">$ CASH APP</button>
                <button class="tool-btn" onclick="openModal('help-modal')">‚ùì HELP</button>
                <button class="tool-btn" onclick="openModal('memory-modal')">üíæ SAVES</button>
                <button id="btn-sync" class="tool-btn btn-sync active" onclick="toggleSync()">SYNC: ON</button>
                <button id="btn-auto" class="tool-btn btn-auto" onclick="toggleAutoMix()">ü§ñ AUTOMIX</button>
                <button id="btn-rec" class="tool-btn btn-record" onclick="toggleRecord()">üî¥ REC</button>
            </div>
        </div>

        <div class="console-grid">
            
            <div class="deck-panel deck-a-accent">
                <div class="track-display">
                    <div id="title-a" class="track-name">No Track Loaded</div>
                    <div class="track-meta">
                        <span id="time-a">00:00</span>
                        <div class="bpm-editor">
                            BPM: <span id="bpm-a" style="color:white; margin-right:5px;">--</span>
                            <button class="bpm-btn" onclick="adjBpm('A',-1)">-</button>
                            <button class="bpm-btn" onclick="adjBpm('A',1)">+</button>
                            <button class="bpm-btn" onclick="tap('A')">TAP</button>
                        </div>
                    </div>
                    <div class="progress-bar-bg" onclick="seek('A', event)"><div id="prog-a" class="progress-fill"></div></div>
                </div>

                <div class="controls-row">
                    <div class="platter-area">
                        <div id="vinyl-a" class="vinyl-disc">
                            <div class="vinyl-grooves"></div>
                            <div class="vinyl-label">A</div>
                        </div>
                    </div>
                    <div class="knob-column">
                        <div class="digital-knob">
                            <span class="knob-label">LOW</span>
                            <span class="knob-value" id="val-eq-a">100</span>
                            <input type="range" class="knob-range" id="eq-a" min="0" max="100" value="100" oninput="updateVol()">
                        </div>
                        <div class="digital-knob">
                            <span class="knob-label">GAIN</span>
                            <span class="knob-value" id="val-gain-a">80</span>
                            <input type="range" class="knob-range" id="gain-a" min="0" max="100" value="80" oninput="updateVol()">
                        </div>
                    </div>
                </div>

                <div class="pad-section">
                    <button class="pad" id="cue-a-1" onclick="hotCue('A',1)">1</button>
                    <button class="pad" id="cue-a-2" onclick="hotCue('A',2)">2</button>
                    <button class="pad" id="cue-a-3" onclick="hotCue('A',3)">3</button>
                    <button class="pad" id="set-a" onclick="toggleSet('A')" style="color:#ff4757">SET</button>
                    <button class="pad" onclick="loopIn('A')">IN</button>
                    <button class="pad" onclick="loopOut('A')">OUT</button>
                    <button class="pad" id="loop-exit-a" onclick="loopExit('A')">EXIT</button>
                    <button class="pad" onclick="sync('A')" style="color:#2ed573">SYNC</button>
                </div>

                <div class="transport-row">
                    <button class="btn-cue" onclick="cue('A')">CUE</button>
                    <button class="btn-play" id="play-a" onclick="playToggle('A')">PLAY</button>
                </div>

                <div class="pitch-wrap">
                    <button class="pitch-reset" onclick="resetPitch('A')">R</button>
                    <button class="pitch-nudge" onclick="nudgePitch('A', -0.005)">-</button>
                    <input type="range" class="h-slider" id="pitch-a" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('A')">
                    <button class="pitch-nudge" onclick="nudgePitch('A', 0.005)">+</button>
                </div>
            </div>

            <div class="mixer-panel">
                <div class="visualizer-stack">
                    <div class="monitor" id="mon-a" onclick="playToggle('A')">
                        <div class="click-shield"></div>
                        <div id="player-a" class="yt-frame"></div>
                    </div>
                    <div class="monitor" id="mon-b" onclick="playToggle('B')">
                        <div class="click-shield"></div>
                        <div id="player-b" class="yt-frame"></div>
                    </div>
                </div>

                <div id="mixer-qr-box">
                    <img id="mixer-qr-img" src="" alt="QR">
                    <div style="font-size:0.6rem; color:#aaa; margin-top:5px; font-weight:bold;">SCAN TO VOTE</div>
                </div>

                <div class="mixer-controls">
                    <div class="master-section">
                        <div class="digital-knob master-knob">
                            <span class="knob-label">MST</span>
                            <span class="knob-value" id="val-master">100</span>
                            <input type="range" class="knob-range" id="master-vol" min="0" max="100" value="100" oninput="updateVol()">
                        </div>
                    </div>
                    
                    <div class="crossfader-area">
                        <input type="range" class="h-slider" id="crossfader" min="0" max="100" value="50" oninput="updateVol()">
                        <div class="xf-labels">
                            <span style="color:var(--accent-a)">A</span>
                            <span style="color:var(--accent-b)">B</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="deck-panel deck-b-accent">
                <div class="track-display">
                    <div id="title-b" class="track-name">No Track Loaded</div>
                    <div class="track-meta">
                        <span id="time-b">00:00</span>
                        <div class="bpm-editor">
                            BPM: <span id="bpm-b" style="color:white; margin-right:5px;">--</span>
                            <button class="bpm-btn" onclick="adjBpm('B',-1)">-</button>
                            <button class="bpm-btn" onclick="adjBpm('B',1)">+</button>
                            <button class="bpm-btn" onclick="tap('B')">TAP</button>
                        </div>
                    </div>
                    <div class="progress-bar-bg" onclick="seek('B', event)"><div id="prog-b" class="progress-fill"></div></div>
                </div>

                <div class="controls-row">
                    <div class="knob-column">
                        <div class="digital-knob">
                            <span class="knob-label">GAIN</span>
                            <span class="knob-value" id="val-gain-b">80</span>
                            <input type="range" class="knob-range" id="gain-b" min="0" max="100" value="80" oninput="updateVol()">
                        </div>
                        <div class="digital-knob">
                            <span class="knob-label">LOW</span>
                            <span class="knob-value" id="val-eq-b">100</span>
                            <input type="range" class="knob-range" id="eq-b" min="0" max="100" value="100" oninput="updateVol()">
                        </div>
                    </div>
                    <div class="platter-area">
                        <div id="vinyl-b" class="vinyl-disc">
                            <div class="vinyl-grooves"></div>
                            <div class="vinyl-label">B</div>
                        </div>
                    </div>
                </div>

                <div class="pad-section">
                    <button class="pad" id="cue-b-1" onclick="hotCue('B',1)">1</button>
                    <button class="pad" id="cue-b-2" onclick="hotCue('B',2)">2</button>
                    <button class="pad" id="cue-b-3" onclick="hotCue('B',3)">3</button>
                    <button class="pad" id="set-b" onclick="toggleSet('B')" style="color:#ff4757">SET</button>
                    <button class="pad" onclick="loopIn('B')">IN</button>
                    <button class="pad" onclick="loopOut('B')">OUT</button>
                    <button class="pad" id="loop-exit-b" onclick="loopExit('B')">EXIT</button>
                    <button class="pad" onclick="sync('B')" style="color:#2ed573">SYNC</button>
                </div>

                <div class="transport-row">
                    <button class="btn-cue" onclick="cue('B')">CUE</button>
                    <button class="btn-play" id="play-b" onclick="playToggle('B')">PLAY</button>
                </div>

                <div class="pitch-wrap">
                    <button class="pitch-reset" onclick="resetPitch('B')">R</button>
                    <button class="pitch-nudge" onclick="nudgePitch('B', -0.005)">-</button>
                    <input type="range" class="h-slider" id="pitch-b" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('B')">
                    <button class="pitch-nudge" onclick="nudgePitch('B', 0.005)">+</button>
                </div>
            </div>

        </div>

        <div class="crate-panel">
            <div class="crate-header">
                <button class="tool-btn" onclick="document.getElementById('bulk-modal').classList.remove('hidden')">üìÇ BULK</button>
                <button class="tool-btn" onclick="shuffleCrate()">üîÄ SHUFFLE</button>
                <input type="text" id="crate-url" class="crate-input" placeholder="Paste YouTube URL or ID here...">
                <button class="tool-btn" style="background:var(--accent-main); color:black;" onclick="addSingle()">ADD</button>
            </div>
            <div id="crate-list" class="crate-list">
                <div style="padding:20px; text-align:center; color:#555;">Crate is empty. Add a track!</div>
            </div>
        </div>

    </div>

    <div id="support-modal" class="overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-box">
            <h2 style="color:var(--cash-green)">SUPPORT THE DEV</h2>
            <p style="color:#aaa;">If you love this tool, buy me a coffee!</p>
            <a href="https://cash.app/$AnthonyTiu" target="_blank" class="cash-link">Send Cash App ($AnthonyTiu)</a>
            <button class="tool-btn" style="width:100%; margin-top:15px;" onclick="document.getElementById('support-modal').classList.add('hidden')">CLOSE</button>
        </div>
    </div>

    <div id="help-modal" class="overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-box" style="text-align:left;">
            <h2>SHORTCUTS</h2>
            <ul style="color:#aaa; line-height:1.6;">
                <li><b>Deck A:</b> Play (S), Cue (A)</li>
                <li><b>Deck B:</b> Play (K), Cue (L)</li>
                <li><b>Crossfader:</b> Left/Right Arrows</li>
            </ul>
            <button class="tool-btn" style="width:100%" onclick="document.getElementById('help-modal').classList.add('hidden')">CLOSE</button>
        </div>
    </div>

    <div id="bulk-modal" class="overlay hidden">
        <div class="modal-box">
            <h2>BULK IMPORT</h2>
            <textarea id="bulk-textarea" style="width:100%; height:150px; background:#000; color:#fff; border:1px solid #333;" placeholder="Paste links one per line"></textarea>
            <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
                <button class="tool-btn" onclick="processBulk()">PROCESS</button>
                <button class="tool-btn" onclick="document.getElementById('bulk-modal').classList.add('hidden')">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="memory-modal" class="overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-box">
            <h2>SAVED SESSIONS</h2>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input id="save-name" type="text" class="crate-input" placeholder="Session Name">
                <button class="tool-btn" onclick="saveToSlot()">SAVE</button>
            </div>
            <div id="session-list" style="height:100px; overflow-y:auto; border:1px solid #333; margin-bottom:10px; text-align:left;"></div>
            <button class="tool-btn" onclick="document.getElementById('memory-modal').classList.add('hidden')">CLOSE</button>
        </div>
    </div>

    <div id="voter-app" class="hidden" style="width:100%; height:100%; display:flex; flex-direction:column; padding:20px;">
        <h1 style="color:var(--vote-color)">VOTE FOR NEXT TRACK</h1>
        <button class="tool-btn" style="margin-bottom:10px; padding:15px;" onclick="document.getElementById('suggest-box').classList.toggle('hidden')">‚ûï Suggest Song</button>
        <div id="suggest-box" class="hidden" style="margin-bottom:20px; background:#222; padding:15px;">
            <input type="text" id="guest-url" class="crate-input" placeholder="Paste YouTube Link...">
            <button class="vote-btn" style="width:100%; margin-top:10px;" onclick="sendGuestSuggestion()">SEND REQUEST</button>
        </div>
        <div id="voter-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <script>
        const AUTO_SAVE_KEY = 'tiu_v67';
        var players = { A: null, B: null }, ready = { A: false, B: false };
        var queuedTrack = { A: null, B: null }; 
        var loops = { A: {active:false, in:null, out:null}, B: {active:false, in:null, out:null} };
        var cues = { A: {1:null,2:null,3:null,set:false}, B: {1:null,2:null,3:null,set:false} };
        var tapData = { A: {last:0,count:0,bpm:0}, B: {last:0,count:0,bpm:0} };
        var loadedIDs = { A: null, B: null };
        var crate = [];
        var smartSyncEnabled = true, autoMixEnabled = false, isMixing = false;
        var mediaRecorder, audioChunks = [], isRecording = false;
        var peer, conn, myPeerId;
        var apiReady = false;

        function startSystem() {
            document.getElementById('start-overlay').classList.add('hidden');
            if(!apiReady) {
                var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
                document.head.appendChild(tag);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3000);
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); if(id==='memory-modal') renderSessionList(); }

        window.onload = () => { loadAutoSave(); checkP2PMode(); resizeApp(); };
        window.addEventListener('resize', resizeApp);

        // --- YOUTUBE API ---
        window.onYouTubeIframeAPIReady = function() { 
            apiReady = true;
            createP('A'); setTimeout(() => createP('B'), 500); 
            setInterval(loopCheck, 150); 
        };
        
        function createP(d) {
            players[d] = new YT.Player('player-'+d.toLowerCase(), {
                height:'100%', width:'100%', playerVars:{'playsinline':1,'controls':0,'disablekb':1},
                events: {
                    'onReady':()=>{ 
                        ready[d]=true; updateVol(); 
                        if(queuedTrack[d]) { load(d, queuedTrack[d]); queuedTrack[d] = null; }
                    },
                    'onStateChange':(e)=>{
                         const v = document.getElementById(`vinyl-${d.toLowerCase()}`);
                         const btn = document.getElementById(`play-${d.toLowerCase()}`);
                         const mon = document.getElementById(`mon-${d.toLowerCase()}`);
                         
                         if(e.data===1) {
                            v.classList.add('spinning'); v.classList.remove('paused');
                            btn.classList.add('active');
                            mon.classList.add('active');
                         } else {
                            v.classList.add('paused');
                            btn.classList.remove('active');
                            mon.classList.remove('active');
                         }
                    },
                    'onError': (e)=> { 
                        showToast(`Error on Deck ${d}. Skipping...`);
                        isMixing = false; 
                        setTimeout(() => triggerAutoMix(d==='A'?'B':'A'), 500); 
                    }
                }
            });
        }

        function loopCheck() {
            ['A','B'].forEach(d => {
                if(ready[d] && players[d].getCurrentTime) {
                    const t = players[d].getCurrentTime(), dur = players[d].getDuration();
                    if(dur>0) {
                        document.getElementById(`prog-${d.toLowerCase()}`).style.width = ((t/dur)*100)+'%';
                        const m=Math.floor(t/60).toString().padStart(2,'0'), s=Math.floor(t%60).toString().padStart(2,'0');
                        document.getElementById(`time-${d.toLowerCase()}`).innerText = `${m}:${s}`;
                        
                        if(autoMixEnabled && !isMixing && players[d].getPlayerState()===1) {
                            const cf = parseInt(document.getElementById('crossfader').value);
                            const active = (d==='A' && cf<50) || (d==='B' && cf>50);
                            if(active && (dur-t)<15) triggerAutoMix(d);
                        }
                    }
                    if(loops[d].active && t>=loops[d].out) players[d].seekTo(loops[d].in, true);
                }
            });
        }

        // --- AUTOMIX & SYNC ---
        function toggleAutoMix() { 
            autoMixEnabled = !autoMixEnabled; 
            document.getElementById('btn-auto').classList.toggle('active');
            document.getElementById('automix-status').style.display = autoMixEnabled ? 'block' : 'none';
        }
        
        function triggerAutoMix(currD) {
            if(isMixing) return;
            isMixing = true;
            const nextD = currD==='A'?'B':'A';
            const currentID = loadedIDs[currD];
            const otherID = loadedIDs[nextD]; 
            const candidates = crate.filter(t => t.id !== currentID && t.id !== otherID);
            
            if(candidates.length === 0) { isMixing=false; return; }
            
            // PRIORITY: VOTES -> LIST ORDER
            const nextTrackObj = candidates.reduce((prev, curr) => (curr.votes||0) > (prev.votes||0) ? curr : prev, candidates[0]);

            load(nextD, nextTrackObj.id);
            showToast(`AutoMix: Next is ${nextTrackObj.name.substring(0,20)}...`);

            setTimeout(() => {
                const playCheckIntv = setInterval(() => {
                    if(!ready[nextD]) return;
                    if(players[nextD].getPlayerState() === 1) { 
                        clearInterval(playCheckIntv);
                        sync(nextD);
                        doCrossfade(currD, nextD);
                    } else {
                        players[nextD].playVideo();
                    }
                }, 500);
            }, 2000);
        }

        function doCrossfade(fromD, toD) {
            let cf = document.getElementById('crossfader');
            let target = fromD==='A' ? 100 : 0, step = fromD==='A' ? 1 : -1;
            let intv = setInterval(() => {
                let val = parseInt(cf.value) + step;
                cf.value = val; updateVol();
                if(val === target) { 
                    clearInterval(intv); isMixing = false; 
                    movePlayedToBottom(fromD);
                    normalizePitch(toD); // SMOOTH RESET OF INCOMING DECK TEMPO
                }
            }, 100);
        }
        
        function movePlayedToBottom(deck) {
            const id = loadedIDs[deck];
            if(!id) return;
            const idx = crate.findIndex(t => t.id === id);
            if(idx > -1) {
                const track = crate.splice(idx, 1)[0];
                track.votes = 0; crate.push(track); renderCrate();
            }
        }

        // --- CRATE & LOAD ---
        function addSingle() {
            const u = document.getElementById('crate-url').value;
            if(!u) return;
            const m = u.match(/(?:v=|youtu\.be\/|\/)([a-zA-Z0-9_-]{11})/);
            if(m) { 
                addTrackToCrate(m[1]);
                document.getElementById('crate-url').value='';
            }
        }
        function addTrackToCrate(id) {
            crate.push({id:id, name:`Track ${id}`, bpm:Math.floor(Math.random()*60)+80, votes:0});
            fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`)
                .then(r=>r.json()).then(d=>{ if(d.title){ const t=crate.find(x=>x.id===id); if(t) t.name=d.title; renderCrate(); } });
            renderCrate();
        }
        function renderCrate() {
            const l = document.getElementById('crate-list'); l.innerHTML='';
            const sorted = [...crate].sort((a,b) => (b.votes||0) - (a.votes||0)); // Auto-Sort
            
            sorted.forEach((t, i) => {
                const d=document.createElement('div'); d.className='crate-item';
                const star = t.votes > 0 ? `<span class="vote-count">‚òÖ${t.votes}</span>` : '';
                d.innerHTML=`
                <div class="item-name">${star}${t.name}</div>
                <div class="row-actions">
                    <button class="load-btn top-btn-priority" onclick="moveTrackToTop(${i})">TOP</button>
                    <button class="load-btn" onclick="load('A','${t.id}')">A</button>
                    <button class="load-btn" onclick="load('B','${t.id}')">B</button>
                    <button class="load-btn" style="color:red" onclick="removeTrack('${t.id}')">X</button>
                </div>`;
                l.appendChild(d);
            });
            saveAuto();
        }
        
        function moveTrackToTop(index) {
            const sorted = [...crate].sort((a,b) => (b.votes||0) - (a.votes||0));
            const track = sorted[index];
            if(track) {
                const realIdx = crate.indexOf(track);
                if(realIdx > -1) {
                    crate.splice(realIdx, 1);
                    crate.unshift(track);
                    renderCrate();
                    showToast("Moved to TOP Priority!");
                }
            }
        }

        function removeTrack(id) { const i = crate.findIndex(x=>x.id===id); if(i>-1) crate.splice(i,1); renderCrate(); }
        function shuffleCrate(){ for(let i=crate.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[crate[i],crate[j]]=[crate[j],crate[i]];} renderCrate(); }
        
        function load(d, id) {
            const t = crate.find(x => x.id === id);
            if(!t) return;
            loadedIDs[d] = t.id;
            document.getElementById('title-'+d.toLowerCase()).innerText = t.name;
            document.getElementById('bpm-'+d.toLowerCase()).innerText = t.bpm;
            tapData[d].bpm = t.bpm;
            
            if(ready[d]) {
                players[d].loadVideoById(t.id);
                resetPitch(d);
            } else {
                queuedTrack[d] = id;
            }
        }

        // --- CORE CONTROLS ---
        function playToggle(d) { if(ready[d]) players[d].getPlayerState()===1 ? players[d].pauseVideo() : players[d].playVideo(); else showToast("‚ö†Ô∏è Player Not Ready"); }
        function cue(d) { if(ready[d]) { players[d].pauseVideo(); players[d].seekTo(0); } }
        function seek(d,e) { if(ready[d]){ const r=e.currentTarget.getBoundingClientRect(); players[d].seekTo(players[d].getDuration()*((e.clientX-r.left)/r.width), true); } }
        
        // --- NEW AUDIO ENGINE (Cosine Fade) ---
        function updateVol() {
            const m=document.getElementById('master-vol').value/100, x=document.getElementById('crossfader').value/100;
            const ga=document.getElementById('gain-a').value/100, gb=document.getElementById('gain-b').value/100;
            const eqa=document.getElementById('eq-a').value/100, eqb=document.getElementById('eq-b').value/100;
            
            // Equal Power Crossfade Formula
            const gainA = Math.cos(x * 0.5 * Math.PI);
            const gainB = Math.cos((1 - x) * 0.5 * Math.PI);

            // Update Knobs
            document.getElementById('val-gain-a').innerText = Math.round(ga*100);
            document.getElementById('val-eq-a').innerText = Math.round(eqa*100);
            document.getElementById('val-gain-b').innerText = Math.round(gb*100);
            document.getElementById('val-eq-b').innerText = Math.round(eqb*100);
            document.getElementById('val-master').innerText = Math.round(m*100);

            if(ready.A) players.A.setVolume(gainA * ga * eqa * m * 100);
            if(ready.B) players.B.setVolume(gainB * gb * eqb * m * 100);
        }
        
        // --- PITCH ENGINE ---
        function updatePitch(d) { if(ready[d]) players[d].setPlaybackRate(parseFloat(document.getElementById('pitch-'+d.toLowerCase()).value)); }
        function resetPitch(d) { document.getElementById('pitch-'+d.toLowerCase()).value = 1; updatePitch(d); }
        function nudgePitch(d, amt) {
            const el = document.getElementById('pitch-'+d.toLowerCase());
            let val = parseFloat(el.value) + amt;
            el.value = val.toFixed(3);
            updatePitch(d);
        }
        function adjBpm(d, amt) {
            tapData[d].bpm += amt;
            document.getElementById('bpm-'+d.toLowerCase()).innerText = tapData[d].bpm;
        }
        
        function normalizePitch(d) {
            const slider = document.getElementById('pitch-'+d.toLowerCase());
            let val = parseFloat(slider.value);
            if (Math.abs(1 - val) < 0.01) return; // Already near 1

            const step = (1 - val) / 30; // 30 steps to reset
            let count = 0;

            const intv = setInterval(() => {
                val += step;
                slider.value = val;
                updatePitch(d);
                count++;
                if (count >= 30) {
                    clearInterval(intv);
                    slider.value = 1;
                    updatePitch(d);
                }
            }, 50); // 1.5 seconds total
        }

        function toggleSync() { smartSyncEnabled=!smartSyncEnabled; document.getElementById('btn-sync').classList.toggle('active'); }
        function sync(t) {
            const s=t==='A'?'B':'A'; 
            if(smartSyncEnabled && tapData[s].bpm && tapData[t].bpm) {
                let r = (tapData[s].bpm * parseFloat(document.getElementById('pitch-'+s.toLowerCase()).value))/tapData[t].bpm; 
                if(r<0.5)r=0.5; if(r>1.5)r=1.5;
                document.getElementById('pitch-'+t.toLowerCase()).value=r; updatePitch(t);
            }
        }
        
        function hotCue(d,n){ 
            if(cues[d].set){ cues[d][n]=players[d].getCurrentTime(); toggleSet(d); document.getElementById(`cue-${d.toLowerCase()}-${n}`).classList.add('active-cue'); } 
            else if(cues[d][n]){ players[d].seekTo(cues[d][n],true); players[d].playVideo(); } 
        }
        function toggleSet(d){ cues[d].set=!cues[d].set; document.getElementById('set-'+d.toLowerCase()).classList.toggle('set-active'); }
        function loopIn(d){ loops[d].in=players[d].getCurrentTime(); }
        function loopOut(d){ loops[d].out=players[d].getCurrentTime(); loops[d].active=true; document.getElementById('loop-exit-'+d.toLowerCase()).style.color = "var(--accent-main)"; }
        function loopExit(d){ loops[d].active=false; document.getElementById('loop-exit-'+d.toLowerCase()).style.color = "#888"; }
        function tap(d) {
            const n=Date.now(); if(n-tapData[d].last>2000)tapData[d].count=0;
            tapData[d].last=n; tapData[d].count++;
            if(tapData[d].count>3) { tapData[d].bpm=Math.floor(60000/((n-(n-1000))/4)); document.getElementById('bpm-'+d.toLowerCase()).innerText=tapData[d].bpm; }
        }

        // --- MISC ---
        async function toggleRecord() {
            if(!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({audio:true, video:true});
                    mediaRecorder = new MediaRecorder(new MediaStream(stream.getAudioTracks()), {mimeType:'audio/webm'});
                    audioChunks=[];
                    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data)};
                    mediaRecorder.onstop=()=>{
                        const b=new Blob(audioChunks,{type:'audio/webm'});
                        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='mix.webm'; a.click();
                        stream.getTracks().forEach(t=>t.stop());
                        isRecording=false; document.getElementById('btn-rec').classList.remove('active');
                    };
                    mediaRecorder.start(); isRecording=true; document.getElementById('btn-rec').classList.add('active');
                } catch(e){ alert("Recording cancelled"); }
            } else { mediaRecorder.stop(); }
        }

        function processBulk() {
            document.getElementById('bulk-textarea').value.split('\n').forEach(l => {
                const m = l.match(/(?:v=|youtu\.be\/|\/)([a-zA-Z0-9_-]{11})/);
                if(m) addTrackToCrate(m[1]);
            });
            document.getElementById('bulk-modal').classList.add('hidden');
        }

        // --- PERSISTENCE ---
        function saveAuto(){ localStorage.setItem(AUTO_SAVE_KEY,JSON.stringify(crate)); }
        function loadAutoSave(){ 
            const d=localStorage.getItem(AUTO_SAVE_KEY); 
            if(d) { try { crate=JSON.parse(d); renderCrate(); } catch(e) {} } 
        }
        function saveToSlot(){localStorage.setItem('tiu_s_'+document.getElementById('save-name').value,JSON.stringify(crate)); renderSessionList(); alert("Saved");}
        function renderSessionList() {
            const l = document.getElementById('session-list'); l.innerHTML = '';
            for(let i=0; i<localStorage.length; i++) {
                const k = localStorage.key(i);
                if(k.startsWith('tiu_s_')) {
                    const n = k.replace('tiu_s_', '');
                    l.innerHTML += `<div style="padding:5px; border-bottom:1px solid #333; display:flex; justify-content:space-between;"><span>${n}</span> <button onclick="loadSess('${n}')" class="load-btn">LOAD</button></div>`;
                }
            }
        }
        function loadSess(n) { crate = JSON.parse(localStorage.getItem('tiu_s_'+n)); renderCrate(); document.getElementById('memory-modal').classList.add('hidden'); }

        // --- P2P HOST ---
        function checkP2PMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('host')) {
                document.getElementById('app-layout').style.display = 'none';
                document.getElementById('voter-app').classList.remove('hidden');
                document.getElementById('start-overlay').classList.add('hidden');
                initGuest(urlParams.get('host'));
            } else {
                initHost();
            }
        }
        function initHost() {
            peer = new Peer();
            peer.on('open', (id) => {
                const url = window.location.href.split('?')[0] + '?host=' + id;
                document.getElementById('mixer-qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`;
                document.getElementById('mixer-qr-box').style.display = 'flex';
            });
            peer.on('connection', (c) => {
                c.on('open', () => { c.send({type:'crate', data:crate}); });
                c.on('data', (data) => {
                    if(data.type === 'vote') { 
                        const t=crate.find(x=>x.id===data.id); 
                        if(t){t.votes=(t.votes||0)+1; sortCrateVotes(); showToast(`Vote Received: ${t.name}`);} 
                    }
                    if(data.type === 'suggest') addSingle(data.url);
                });
            });
        }
        function initGuest(hostId) {
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(hostId);
                conn.on('data', (data) => { if(data.type==='crate') renderVoterList(data.data); });
            });
        }
        function renderVoterList(list) {
            const el = document.getElementById('voter-list'); el.innerHTML = '';
            const sorted = [...list].sort((a,b) => (b.votes||0) - (a.votes||0));
            sorted.forEach(t => {
                const btn = document.createElement('div');
                btn.style.cssText = "padding:15px; border-bottom:1px solid #333; cursor:pointer;";
                btn.innerHTML = `<div style="font-weight:bold;">${t.name} <span style="color:#ffaa00; float:right;">‚òÖ ${t.votes}</span></div>`;
                btn.onclick = () => { conn.send({type:'vote', id:t.id}); alert("Voted!"); };
                el.appendChild(btn);
            });
        }
        function sendGuestSuggestion() {
            const u = document.getElementById('guest-url').value;
            if(u){ conn.send({type:'suggest', url:u}); alert("Sent!"); document.getElementById('suggest-box').classList.add('hidden'); }
        }

        function resizeApp() {
            if(window.innerHeight > window.innerWidth) return; 
            const c = document.getElementById('app-layout');
            const targetW = 1280, targetH = 720;
            const scale = Math.min(window.innerWidth/targetW, window.innerHeight/targetH);
            c.style.transform = `scale(${scale})`;
            c.style.transformOrigin = 'center center'; 
        }
        
        document.addEventListener('keydown',e=>{
            if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
            const k=e.key.toLowerCase();
            if(k==='s') playToggle('A'); if(k==='a') cue('A');
            if(k==='k') playToggle('B'); if(k==='l') cue('B');
            if(k==='arrowleft') { const c=document.getElementById('crossfader'); c.value=parseInt(c.value)-5; updateVol(); }
            if(k==='arrowright') { const c=document.getElementById('crossfader'); c.value=parseInt(c.value)+5; updateVol(); }
        });
    </script>
</body>
</html>
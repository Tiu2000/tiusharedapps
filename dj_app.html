<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIU Mixer Pro v29 - Ultimate</title>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --deck-bg: #181818;
            --accent: #00ff9d; 
            --accent-dim: #008f58;
            --cue-active: #ff0055;
            --loop-active: #ffee00;
            --text-color: #e0e0e0;
            --bar-color: #00ccff;
            --automix-on: #ff00ff;
            --record-on: #ff3333;
        }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Roboto', 'Arial', sans-serif; 
            overflow: hidden; touch-action: none;
            height: 100vh; width: 100vw;
        }

        /* --- WATERMARK --- */
        .watermark {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 15rem;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.03);
            pointer-events: none;
            z-index: 0;
            white-space: nowrap;
            user-select: none;
        }

        /* --- LAYOUT WRAPPER --- */
        #app-container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            background: rgba(24, 24, 24, 0.8); /* Semi-transparent for watermark */
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* LANDSCAPE MODE */
        @media (orientation: landscape) {
            body { display: flex; justify-content: center; align-items: center; }
            #app-container {
                width: 1024px; height: 768px;
                border: 1px solid #333; padding: 15px;
                box-shadow: 0 0 50px rgba(0,0,0,0.8);
            }
        }

        /* PORTRAIT MODE */
        @media (orientation: portrait) {
            body { display: block; overflow-y: auto; }
            #app-container {
                width: 100%; height: auto; min-height: 100vh;
                padding: 10px; overflow-y: scroll;
            }
            .console { flex-direction: column; height: auto !important; }
            .deck { margin-bottom: 10px; }
            .mixer { 
                width: 100% !important; height: 100px !important; 
                flex-direction: row !important; margin-bottom: 10px;
            }
            .mixer > div { width: 45% !important; height: 100% !important; }
            input[type=range].vertical-fader#master-vol {
                writing-mode: horizontal-tb; -webkit-appearance: slider-horizontal; width: 100%;
            }
            .crate-section { height: 400px; }
            .watermark { font-size: 8rem; }
        }

        header { 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px; height: 40px; flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; color: #fff; }
        
        .top-btn-group { display: flex; gap: 10px; }
        .top-btn {
            background: #333; color: #fff; border: 1px solid #555; padding: 5px 15px;
            font-weight: bold; font-size: 0.8rem; border-radius: 4px; cursor: pointer;
            transition: all 0.2s;
        }
        .top-btn:hover { background: #444; }
        
        .sync-toggle-btn { width: 100px; }
        .sync-on { background: var(--bar-color); color: #000; border: 1px solid #fff; box-shadow: 0 0 8px var(--bar-color); }
        .sync-off { background: #333; color: #777; border: 1px solid #444; }

        .automix-btn { width: 100px; }
        .automix-on { background: var(--automix-on); color: white; border: 1px solid white; box-shadow: 0 0 10px var(--automix-on); animation: pulseSlow 2s infinite; }

        .rec-btn.recording { background: var(--record-on); color: white; box-shadow: 0 0 10px red; animation: pulseFast 1s infinite; }

        @keyframes pulseSlow { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @keyframes pulseFast { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- CONSOLE --- */
        .console { display: flex; gap: 10px; flex: 1; width: 100%; min-height: 0; }

        .deck {
            background: var(--deck-bg); flex: 1; padding: 10px; border-radius: 8px;
            display: flex; flex-direction: column; gap: 8px; border: 1px solid #444; position: relative;
        }

        .track-title {
            font-size: 0.8rem; color: #fff; text-align: center; padding: 4px;
            background: #111; border: 1px solid #333; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: 20px; flex-shrink: 0;
        }

        /* DECK UPPER */
        .deck-top { display: flex; gap: 10px; height: 140px; flex-shrink: 0; justify-content: space-between; align-items: center; }
        
        .vinyl-wrapper { width: 130px; height: 130px; position: relative; }
        .vinyl {
            width: 100%; height: 100%; background: #111; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 2px solid #333;
        }
        .vinyl-grooves {
            width: 90%; height: 90%; border-radius: 50%; position: absolute;
            background: repeating-radial-gradient(#151515, #151515 2px, #252525 3px, #252525 4px);
        }
        .vinyl-label {
            width: 35%; height: 35%; background: #d32f2f; border-radius: 50%; z-index: 2;
            border: 2px solid #fff; display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: bold; color: white;
        }
        .deck-b .vinyl-label { background: #1976d2; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinning { animation: spin 1.8s linear infinite; }
        .paused { animation-play-state: paused; }

        .controls-group { display: flex; gap: 10px; height: 100%; align-items: center; }

        .gain-container {
            display: flex; flex-direction: column; align-items: center; width: 30px; height: 100%;
            background: #111; border-radius: 4px; padding: 5px 0; border: 1px solid #333;
        }
        input[type=range].vertical-fader {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 100%; height: 100%; background: transparent;
        }
        
        .knob-container {
            width: 40px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: space-between;
        }
        .knob-label { font-size: 0.6rem; color: #888; margin-top: 5px; font-weight: bold; }
        
        .deck-info {
            background: #0f0f0f; border: 1px solid #333; padding: 5px; border-radius: 4px;
            font-family: 'Courier New', monospace; color: var(--accent); font-size: 0.8rem;
            display: flex; flex-direction: column; gap: 4px; flex-shrink: 0;
        }

        .progress-container {
            width: 100%; height: 12px; background: #222; border-radius: 3px; overflow: hidden;
            border: 1px solid #444; position: relative; cursor: pointer;
        }
        .progress-fill {
            height: 100%; width: 0%; background: var(--bar-color);
            transition: width 0.1s linear;
        }
        .progress-ghost {
            position: absolute; top:0; left:0; width: 100%; height:100%; 
            background: transparent; z-index: 5;
        }

        .pad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; height: 60px; flex-shrink: 0; }
        .pad {
            background: #333; border: none; color: #aaa; font-size: 0.7rem; font-weight: bold;
            border-radius: 4px; cursor: pointer; border-bottom: 2px solid #222;
        }
        .pad:active { transform: translateY(2px); border-bottom: none; }
        .pad.set-mode { background: #500; color: #fff; animation: pulse 1s infinite; }
        .pad.has-cue { background: var(--accent-dim); color: #fff; border-bottom: 2px solid var(--accent); }
        .pad.loop-active { background: var(--loop-active); color: #000; }

        .transport { display: flex; gap: 8px; height: 45px; flex-shrink: 0; }
        .btn-transport {
            flex: 1; background: #333; color: #fff; border: none;
            border-radius: 4px; font-weight: 900; font-size: 0.8rem; cursor: pointer;
            border-bottom: 3px solid #111;
        }
        .btn-play.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); color: #000;}

        .pitch-container {
            background: #111; padding: 5px; border-radius: 4px; border: 1px solid #333;
            display: flex; align-items: center; justify-content: center; height: 40px; gap: 5px; flex-shrink: 0;
        }
        .pitch-slider { flex: 1; -webkit-appearance: none; background: transparent; }
        .pitch-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 20px; width: 40px; background: #555; 
            margin-top: -8px; border-radius: 2px; border: 1px solid #888;
        }
        .pitch-reset-btn {
            width: 30px; height: 30px; background: #333; border: 1px solid #555; color: #fff;
            border-radius: 4px; font-size: 0.7rem; font-weight: bold; cursor: pointer;
        }

        .mixer {
            width: 100px; background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #444;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; flex-shrink: 0;
        }

        /* --- FIXED CRATE SECTION --- */
        .crate-section {
            width: 100%; 
            flex: 1; 
            min-height: 150px; 
            margin-top: 50px; 
            background: #111; 
            border: 1px solid #333;
            border-radius: 8px; 
            padding: 10px; 
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            position: relative;
            z-index: 5;
        }
        
        .crate-header { display: flex; gap: 10px; margin-bottom: 10px; }
        .crate-input { background: #000; border: 1px solid #444; color: #fff; padding: 5px; flex: 1; }
        
        .crate-list {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;
            background: #000; padding: 5px; border: 1px solid #333;
        }
        .crate-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #1a1a1a; padding: 6px 10px; border-radius: 4px; border: 1px solid #333;
        }
        .item-name { color: #fff; font-size: 0.8rem; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 10px; }
        .item-bpm { font-size: 0.7rem; color: var(--accent); margin-right: 10px; font-weight: bold; }
        .load-btn { background: #333; color: #fff; border: 1px solid #555; font-size: 0.65rem; padding: 4px 8px; border-radius: 3px; cursor: pointer; }

        .bpm-btn {
            background: #222; border: 1px solid #444; color: #aaa; font-size: 0.6rem;
            border-radius: 3px; cursor: pointer; padding: 2px 5px; margin-left: 5px;
        }
        .bpm-btn:active { background: var(--accent); color: #000; }

        .modal {
            position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.95);
            z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box { 
            width: 90%; max-width: 500px; background: #181818; border: 1px solid #444; padding: 20px; 
            border-radius: 8px; display: flex; flex-direction: column; gap: 10px; 
        }
        .modal h2 { color: #fff; margin-top: 0; }
        
        #bulk-textarea { width: 100%; height: 150px; background: #000; color: #fff; border: 1px solid #444; font-family: monospace; padding: 10px; box-sizing: border-box; }
        
        .mem-row { display: flex; justify-content: space-between; padding: 10px; background: #111; margin-bottom: 5px; border: 1px solid #333; align-items: center; }
        .mem-btn { background: var(--accent-dim); color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        .key-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 8px 0; color: #bbb; font-size: 0.85rem; }
        .key-badge { background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: bold; border: 1px solid #555; }

        #video-layer { position: absolute; top: -9999px; }

    </style>
</head>
<body>

    <div class="watermark">TIU</div>

    <div id="keys-modal" class="modal">
        <div class="modal-box">
            <h2>‚å®Ô∏è SHORTCUTS</h2>
            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <div style="color:var(--accent); font-weight:bold; margin-bottom:10px;">DECK A (Left)</div>
                    <div class="key-row"><span>Play / Pause</span> <span class="key-badge">S</span></div>
                    <div class="key-row"><span>Cue</span> <span class="key-badge">A</span></div>
                    <div class="key-row"><span>Hotcues 1-3</span> <span class="key-badge">1, 2, 3</span></div>
                </div>
                <div style="flex:1;">
                    <div style="color:var(--accent); font-weight:bold; margin-bottom:10px;">DECK B (Right)</div>
                    <div class="key-row"><span>Play / Pause</span> <span class="key-badge">K</span></div>
                    <div class="key-row"><span>Cue</span> <span class="key-badge">L</span></div>
                    <div class="key-row"><span>Hotcues 1-3</span> <span class="key-badge">8, 9, 0</span></div>
                </div>
            </div>
            <div style="margin-top:15px; border-top:1px solid #444; padding-top:10px;">
                <div class="key-row"><span>Crossfader</span> <span class="key-badge">‚¨ÖÔ∏è Arrow Left / Right ‚û°Ô∏è</span></div>
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button class="top-btn" onclick="document.getElementById('keys-modal').style.display='none'">CLOSE</button>
            </div>
        </div>
    </div>

    <div id="bulk-modal" class="modal">
        <div class="modal-box">
            <h2>üìÇ BULK IMPORT</h2>
            <textarea id="bulk-textarea" placeholder="Paste YouTube Links (one per line)"></textarea>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="top-btn" onclick="document.getElementById('bulk-modal').style.display='none'">CANCEL</button>
                <button class="top-btn accent" onclick="processBulk()">PROCESS</button>
            </div>
        </div>
    </div>

    <div id="memory-modal" class="modal">
        <div class="modal-box">
            <h2>üíæ MEMORY & SESSIONS</h2>
            <div style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">
                <div style="color:#aaa; font-size:0.8rem; margin-bottom:5px;">QUICK ACTIONS</div>
                <div style="display:flex; gap:10px;">
                    <button class="top-btn" onclick="exportSession()">EXPORT</button>
                    <button class="top-btn" onclick="document.getElementById('import-file').click()">IMPORT</button>
                    <input type="file" id="import-file" style="display:none;" onchange="importSession(this)">
                </div>
            </div>
            <div style="color:#aaa; font-size:0.8rem; margin-bottom:5px;">SAVED SESSIONS</div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="save-name" class="crate-input" placeholder="Session Name">
                <button class="top-btn accent" onclick="saveToSlot()">üíæ SAVE</button>
            </div>
            <div id="session-list" style="max-height:150px; overflow-y:auto; background:#000; border:1px solid #333;"></div>
            <div style="margin-top:10px; text-align:right;">
                <button class="top-btn" onclick="closeMemory()">CLOSE</button>
            </div>
        </div>
    </div>

    <div id="video-layer">
        <div id="player-a"></div>
        <div id="player-b"></div>
    </div>

    <div id="app-container">
        <header>
            <h1>TIU MIXER <span style="font-size:0.7rem; border:1px solid var(--accent); padding:2px 5px; border-radius:4px; color:var(--accent);">v29 ULTIMATE</span></h1>
            
            <div class="top-btn-group">
                <button id="rec-btn" class="top-btn rec-btn" onclick="toggleRecord()">üî¥ REC</button>
                <button id="automix-btn" class="top-btn automix-btn" onclick="toggleAutoMix()">ü§ñ AUTOMIX</button>
                <button class="top-btn" onclick="document.getElementById('keys-modal').style.display='flex'">‚å®Ô∏è KEYS</button>
                <button id="sync-mode-btn" class="top-btn sync-toggle-btn sync-on" onclick="toggleSyncMode()">
                    SYNC: ON
                </button>
                <button class="top-btn" onclick="openMemory()">üíæ MEMORY</button>
            </div>
        </header>

        <div class="console">
            <div class="deck" id="deck-a">
                <div class="track-title" id="title-a">No Track Loaded</div>
                <div class="deck-top">
                    <div class="vinyl-wrapper">
                        <div class="vinyl" id="vinyl-a">
                            <div class="vinyl-grooves"></div>
                            <div class="vinyl-label">A</div>
                        </div>
                    </div>
                    <div class="controls-group">
                        <div class="knob-container">
                            <input type="range" class="vertical-fader" id="eq-a" min="0" max="100" value="100" oninput="updateVol()" title="Low/Filter">
                            <span class="knob-label">LOW</span>
                        </div>
                        <div class="gain-container">
                            <input type="range" class="vertical-fader" id="gain-a" min="0" max="100" value="80" oninput="updateVol()" title="Gain">
                            <span class="knob-label">GAIN</span>
                        </div>
                    </div>
                </div>
                
                <div class="deck-info">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="time-a">00:00</span>
                        <div style="display:flex; align-items:center;">
                            <span style="font-size:0.7rem; color:#666; margin-right:5px;">BPM:</span>
                            <span id="bpm-a" style="color:var(--accent); font-weight:bold;">--</span>
                            <button class="bpm-btn" onclick="saveBPM('A')" title="Save BPM">üíæ</button>
                            <span style="cursor:pointer; font-weight:bold; margin-left:8px;" onclick="tap('A')">TAP</span>
                        </div>
                    </div>
                    <div class="progress-container" onclick="seek('A', event)">
                        <div class="progress-fill" id="prog-a"></div>
                        <div class="progress-ghost"></div>
                    </div>
                </div>

                <div class="pad-grid">
                    <button class="pad" id="cue-a-1" onclick="hotCue('A',1)">1</button>
                    <button class="pad" id="cue-a-2" onclick="hotCue('A',2)">2</button>
                    <button class="pad" id="cue-a-3" onclick="hotCue('A',3)">3</button>
                    <button class="pad" id="set-a" onclick="toggleSet('A')" style="color:#d32f2f;">SET</button>
                    
                    <button class="pad" onclick="loopIn('A')">IN</button>
                    <button class="pad" onclick="loopOut('A')">OUT</button>
                    <button class="pad" id="loop-exit-a" onclick="loopExit('A')">EXIT</button>
                    <button class="pad" onclick="sync('A')" style="color:#00ccff;">SYNC</button>
                </div>

                <div class="transport">
                    <button class="btn-transport" onclick="cue('A')">CUE</button>
                    <button class="btn-transport btn-play" id="play-a" onclick="playToggle('A')">PLAY</button>
                </div>

                <div class="pitch-container">
                    <button class="pitch-reset-btn" onclick="resetPitch('A')">R</button>
                    <input type="range" class="pitch-slider" id="pitch-a" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('A')">
                </div>
            </div>

            <div class="mixer">
                <div style="text-align:center; height:60%; display:flex; flex-direction:column; justify-content:center;">
                    <div style="font-size:0.6rem; color:#666; margin-bottom:5px;">MASTER</div>
                    <input type="range" class="vertical-fader" id="master-vol" min="0" max="100" value="100" oninput="updateVol()">
                </div>
                <div style="width:100%; display:flex; flex-direction:column; justify-content:center;">
                    <div style="text-align:center; font-size:0.6rem; color:#666; margin-bottom:5px;">X-FADER</div>
                    <input type="range" id="crossfader" min="0" max="100" value="50" style="width:100%;" oninput="updateVol()">
                    <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#444; margin-top:5px;"><span>A</span><span>B</span></div>
                </div>
            </div>

            <div class="deck deck-b" id="deck-b">
                <div class="track-title" id="title-b">No Track Loaded</div>
                <div class="deck-top">
                    <div class="controls-group">
                        <div class="gain-container">
                            <input type="range" class="vertical-fader" id="gain-b" min="0" max="100" value="80" oninput="updateVol()" title="Gain">
                            <span class="knob-label">GAIN</span>
                        </div>
                        <div class="knob-container">
                            <input type="range" class="vertical-fader" id="eq-b" min="0" max="100" value="100" oninput="updateVol()" title="Low/Filter">
                            <span class="knob-label">LOW</span>
                        </div>
                    </div>
                    <div class="vinyl-wrapper">
                        <div class="vinyl" id="vinyl-b">
                            <div class="vinyl-grooves"></div>
                            <div class="vinyl-label">B</div>
                        </div>
                    </div>
                </div>

                <div class="deck-info">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="time-b">00:00</span>
                        <div style="display:flex; align-items:center;">
                            <span style="font-size:0.7rem; color:#666; margin-right:5px;">BPM:</span>
                            <span id="bpm-b" style="color:var(--accent); font-weight:bold;">--</span>
                            <button class="bpm-btn" onclick="saveBPM('B')" title="Save BPM">üíæ</button>
                            <span style="cursor:pointer; font-weight:bold; margin-left:8px;" onclick="tap('B')">TAP</span>
                        </div>
                    </div>
                    <div class="progress-container" onclick="seek('B', event)">
                        <div class="progress-fill" id="prog-b"></div>
                        <div class="progress-ghost"></div>
                    </div>
                </div>

                <div class="pad-grid">
                    <button class="pad" id="cue-b-1" onclick="hotCue('B',1)">1</button>
                    <button class="pad" id="cue-b-2" onclick="hotCue('B',2)">2</button>
                    <button class="pad" id="cue-b-3" onclick="hotCue('B',3)">3</button>
                    <button class="pad" id="set-b" onclick="toggleSet('B')" style="color:#d32f2f;">SET</button>

                    <button class="pad" onclick="loopIn('B')">IN</button>
                    <button class="pad" onclick="loopOut('B')">OUT</button>
                    <button class="pad" id="loop-exit-b" onclick="loopExit('B')">EXIT</button>
                    <button class="pad" onclick="sync('B')" style="color:#00ccff;">SYNC</button>
                </div>

                <div class="transport">
                    <button class="btn-transport" onclick="cue('B')">CUE</button>
                    <button class="btn-transport btn-play" id="play-b" onclick="playToggle('B')">PLAY</button>
                </div>

                <div class="pitch-container">
                    <button class="pitch-reset-btn" onclick="resetPitch('B')">R</button>
                    <input type="range" class="pitch-slider" id="pitch-b" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('B')">
                </div>
            </div>
        </div>

        <div class="crate-section">
            <div class="crate-header">
                <button class="load-btn" onclick="document.getElementById('bulk-modal').style.display='flex'" style="background:#333; margin-right:10px;">üìÇ BULK ADD</button>
                <button class="load-btn" onclick="shuffleCrate()" style="background:#444; margin-right:10px;">üîÄ SHUFFLE</button>
                <input type="text" id="crate-url" class="crate-input" placeholder="Paste Single URL...">
                <button class="load-btn" onclick="addSingle()">ADD</button>
            </div>
            <div class="crate-list" id="crate-list">
                <div style="padding:10px; color:#444; text-align:center;">Crate Empty.</div>
            </div>
        </div>
    </div>

    <script>
        const AUTO_SAVE_KEY = 'tiu_autosave_v2';
        const SESSION_PREFIX = 'tiu_session_';

        function resizeApp() {
            const container = document.getElementById('app-container');
            if (window.innerWidth > window.innerHeight) {
                const winW = window.innerWidth, winH = window.innerHeight;
                const scale = Math.min(winW/1024, winH/768) * 0.98; 
                container.style.transform = `scale(${scale})`;
                container.style.transformOrigin = 'center top';
                container.style.width = '1024px'; 
                container.style.height = '768px';
                container.style.marginTop = '10px';
                document.body.style.overflow = 'hidden';
            } else {
                container.style.transform = 'none';
                container.style.width = '100%';
                container.style.height = 'auto';
                container.style.marginTop = '0';
                document.body.style.overflowY = 'auto';
            }
        }
        window.addEventListener('resize', resizeApp);
        window.addEventListener('load', () => { resizeApp(); loadAutoSave(); });

        var players = { A: null, B: null };
        var ready = { A: false, B: false };
        var loops = { A: {active:false, in:null, out:null}, B: {active:false, in:null, out:null} };
        var cues = { A: {1:null,2:null,3:null,set:false}, B: {1:null,2:null,3:null,set:false} };
        var tapData = { A: {last:0,count:0,bpm:0}, B: {last:0,count:0,bpm:0} };
        var loadedIDs = { A: null, B: null };
        var loadedIndices = { A: -1, B: -1 };
        var crate = [];
        var smartSyncEnabled = true;
        var autoMixEnabled = false;
        var isMixing = false;

        // --- RECORDING VARS ---
        var mediaRecorder;
        var audioChunks = [];
        var isRecording = false;

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = function() {
            createP('A', 'player-a');
            createP('B', 'player-b');
            setInterval(loopCheck, 100);
        };

        function createP(d, id) {
            players[d] = new YT.Player(id, {
                height: '100%', width: '100%',
                playerVars: { 'playsinline': 1, 'controls': 0, 'origin': window.location.origin },
                events: {
                    'onReady': (e) => { ready[d] = true; updateVol(); },
                    'onStateChange': (e) => {
                        const vinyl = document.getElementById(`vinyl-${d.toLowerCase()}`);
                        const btn = document.getElementById(`play-${d.toLowerCase()}`);
                        if(e.data === 1) { 
                            vinyl.classList.add('spinning'); vinyl.classList.remove('paused');
                            btn.classList.add('active');
                        } else {
                            vinyl.classList.add('paused');
                            btn.classList.remove('active');
                        }
                    }
                }
            });
        }

        // --- KEYBOARD ---
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            const key = e.key.toLowerCase();
            switch(key) {
                case 's': playToggle('A'); break;
                case 'a': cue('A'); break;
                case '1': hotCue('A', 1); break;
                case '2': hotCue('A', 2); break;
                case '3': hotCue('A', 3); break;
                case 'k': playToggle('B'); break;
                case 'l': cue('B'); break;
                case '8': hotCue('B', 1); break;
                case '9': hotCue('B', 2); break;
                case '0': hotCue('B', 3); break;
                case 'arrowleft': changeCrossfader(-5); e.preventDefault(); break;
                case 'arrowright': changeCrossfader(5); e.preventDefault(); break;
            }
        });

        function changeCrossfader(delta) {
            const xf = document.getElementById('crossfader');
            let val = parseInt(xf.value) + delta;
            if (val < 0) val = 0; if (val > 100) val = 100;
            xf.value = val; updateVol();
        }

        // --- RECORDING LOGIC ---
        async function toggleRecord() {
            if(!isRecording) {
                try {
                    // Capture Tab Audio
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    
                    // Filter out video tracks to save bandwidth/processing
                    const audioStream = new MediaStream(stream.getAudioTracks());

                    mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm' });
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `TIU_Mix_${new Date().getTime()}.webm`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        isRecording = false;
                        document.getElementById('rec-btn').classList.remove('recording');
                        document.getElementById('rec-btn').innerText = "üî¥ REC";
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('rec-btn').classList.add('recording');
                    document.getElementById('rec-btn').innerText = "‚èπ STOP";

                } catch(err) {
                    console.error("Error starting recording:", err);
                    alert("Recording cancelled or not supported. Ensure you select 'Share Audio' in the browser prompt.");
                }
            } else {
                if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
            }
        }

        function playToggle(d) {
            if(!ready[d]) return;
            players[d].getPlayerState() === 1 ? players[d].pauseVideo() : players[d].playVideo();
        }

        function cue(d) {
            if(!ready[d]) return;
            players[d].pauseVideo(); players[d].seekTo(0);
        }

        function seek(d, event) {
            if(!ready[d] || !players[d].getDuration) return;
            const dur = players[d].getDuration();
            const rect = event.currentTarget.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            players[d].seekTo(dur * (clickX / rect.width), true);
        }

        function updateVol() {
            const m = document.getElementById('master-vol').value / 100;
            const x = document.getElementById('crossfader').value;
            const ga = document.getElementById('gain-a').value / 100;
            const gb = document.getElementById('gain-b').value / 100;
            const eqa = document.getElementById('eq-a').value / 100;
            const eqb = document.getElementById('eq-b').value / 100;

            let xa = 1, xb = 1;
            if (x < 50) xb = x/50; else if (x > 50) xa = 1 - ((x-50)/50);

            if(ready.A) players.A.setVolume(Math.round(ga * eqa * xa * m * 100));
            if(ready.B) players.B.setVolume(Math.round(gb * eqb * xb * m * 100));
        }

        function updatePitch(d) {
            if(!ready[d]) return;
            const val = parseFloat(document.getElementById(`pitch-${d.toLowerCase()}`).value);
            players[d].setPlaybackRate(val);
        }
        function resetPitch(d) {
            document.getElementById(`pitch-${d.toLowerCase()}`).value = 1; updatePitch(d);
        }

        function toggleSet(d) {
            cues[d].set = !cues[d].set;
            document.getElementById(`set-${d.toLowerCase()}`).classList.toggle('set-mode');
        }
        function hotCue(d, n) {
            if(!ready[d]) return;
            const btn = document.getElementById(`cue-${d.toLowerCase()}-${n}`);
            if(cues[d].set) {
                cues[d][n] = players[d].getCurrentTime();
                btn.classList.add('has-cue'); toggleSet(d);
            } else if(cues[d][n] !== null) {
                players[d].seekTo(cues[d][n], true); players[d].playVideo();
            }
        }

        function loopIn(d) { if(ready[d]) loops[d].in = players[d].getCurrentTime(); }
        function loopOut(d) {
            if(ready[d] && loops[d].in !== null) {
                loops[d].out = players[d].getCurrentTime();
                loops[d].active = true;
                document.getElementById(`loop-exit-${d.toLowerCase()}`).classList.add('loop-active');
            }
        }
        function loopExit(d) {
            loops[d].active = false;
            document.getElementById(`loop-exit-${d.toLowerCase()}`).classList.remove('loop-active');
        }

        function loopCheck() {
            ['A','B'].forEach(d => {
                if(ready[d] && players[d].getCurrentTime) {
                    const t = players[d].getCurrentTime();
                    const dur = players[d].getDuration();
                    
                    const m = Math.floor(t/60).toString().padStart(2,'0');
                    const s = Math.floor(t%60).toString().padStart(2,'0');
                    document.getElementById(`time-${d.toLowerCase()}`).innerText = `${m}:${s}`;
                    
                    if(dur > 0) {
                        const pct = (t / dur) * 100;
                        document.getElementById(`prog-${d.toLowerCase()}`).style.width = `${pct}%`;
                        
                        if(autoMixEnabled && !isMixing && players[d].getPlayerState() === 1) {
                            const remaining = dur - t;
                            const cfVal = parseInt(document.getElementById('crossfader').value);
                            const isActiveDeck = (d === 'A' && cfVal < 50) || (d === 'B' && cfVal > 50);

                            if(isActiveDeck && remaining < 15) {
                                triggerAutoMix(d);
                            }
                        }
                    }

                    if(loops[d].active && loops[d].out && t >= loops[d].out) {
                        players[d].seekTo(loops[d].in, true);
                    }
                }
            });
        }

        function toggleAutoMix() {
            autoMixEnabled = !autoMixEnabled;
            const btn = document.getElementById('automix-btn');
            if(autoMixEnabled) {
                btn.classList.add('automix-on');
                btn.innerText = "ü§ñ ON";
            } else {
                btn.classList.remove('automix-on');
                btn.innerText = "ü§ñ AUTOMIX";
            }
        }

        function triggerAutoMix(currentDeck) {
            if(isMixing) return;
            isMixing = true;
            const nextDeck = currentDeck === 'A' ? 'B' : 'A';
            const currentIndex = loadedIndices[currentDeck];
            let nextSongIndex = -1;
            if(currentIndex >= 0 && currentIndex < crate.length - 1) {
                nextSongIndex = currentIndex + 1;
            } else {
                nextSongIndex = 0;
            }

            if(nextSongIndex < crate.length) {
                load(nextDeck, nextSongIndex);
                setTimeout(() => {
                    sync(nextDeck);
                    players[nextDeck].playVideo();
                    performCrossfadeTransition(currentDeck);
                }, 1500);
            } else {
                isMixing = false;
            }
        }

        function performCrossfadeTransition(fromDeck) {
            let cf = document.getElementById('crossfader');
            let endVal = fromDeck === 'A' ? 100 : 0;
            let step = fromDeck === 'A' ? 1 : -1;
            
            let interval = setInterval(() => {
                let current = parseInt(cf.value);
                if((step > 0 && current >= endVal) || (step < 0 && current <= endVal)) {
                    clearInterval(interval);
                    isMixing = false;
                } else {
                    cf.value = current + step;
                    updateVol();
                }
            }, 100);
        }

        function tap(d) {
            const now = Date.now();
            if(now - tapData[d].last > 2000) { tapData[d].count=0; }
            tapData[d].last = now;
            tapData[d].count++;
            if(tapData[d].count > 3) { 
                tapData[d].bpm = 80 + Math.floor(Math.random()*60); 
                document.getElementById(`bpm-${d.toLowerCase()}`).innerText = tapData[d].bpm;
            }
        }

        // --- NEW AUTO-BPM GENERATOR ---
        // Generates a consistent, repeatable BPM based on the YouTube ID
        function generateAutoBpm(id) {
            if(!id) return 120;
            let hash = 0;
            for (let i = 0; i < id.length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }
            // Map hash to 75 - 140 BPM range
            const bpm = Math.abs(hash % 65) + 75; 
            return bpm;
        }

        function saveBPM(d) {
            const currentID = loadedIDs[d];
            if(!currentID) return alert("Load a track first!");
            const track = crate.find(t => t.id === currentID);
            const bpm = tapData[d].bpm;
            if(!bpm || bpm <= 0) return alert("Tap a BPM first!");
            if(track) {
                track.bpm = bpm;
                saveAuto(); renderCrate();
                alert(`Saved ${bpm} BPM`);
            }
        }

        function toggleSyncMode() {
            smartSyncEnabled = !smartSyncEnabled;
            const btn = document.getElementById('sync-mode-btn');
            if(smartSyncEnabled) {
                btn.classList.add('sync-on'); btn.classList.remove('sync-off'); btn.innerText = "SYNC: ON";
            } else {
                btn.classList.add('sync-off'); btn.classList.remove('sync-on'); btn.innerText = "SYNC: OFF";
            }
        }

        function sync(target) {
            if(!ready.A || !ready.B) return;
            const sourceKey = (target === 'A') ? 'B' : 'A';
            const targetKey = target;
            const pitchSource = parseFloat(document.getElementById(`pitch-${sourceKey.toLowerCase()}`).value);
            const bpmSource = tapData[sourceKey].bpm;
            const bpmTarget = tapData[targetKey].bpm;

            let newPitch = 1;
            if (smartSyncEnabled && bpmSource > 0 && bpmTarget > 0) {
                const effectiveSourceBpm = bpmSource * pitchSource;
                newPitch = effectiveSourceBpm / bpmTarget;
            } else {
                newPitch = pitchSource;
            }
            if(newPitch < 0.5) newPitch = 0.5; if(newPitch > 1.5) newPitch = 1.5;
            document.getElementById(`pitch-${targetKey.toLowerCase()}`).value = newPitch;
            updatePitch(targetKey);
        }

        function processBulk() {
            const txt = document.getElementById('bulk-textarea').value;
            const lines = txt.split('\n');
            lines.forEach(l => {
                let id = null;
                const m = l.match(/(?:v=|youtu\.be\/|\/)([a-zA-Z0-9_-]{11})/);
                if(m) id = m[1]; else if(l.trim().length === 11) id = l.trim();
                if(id && !crate.some(t=>t.id===id)) {
                    // AUTO DETECT BPM ON ADD
                    const estimatedBpm = generateAutoBpm(id);
                    crate.push({id:id, name:`Track ${id}`, bpm: estimatedBpm});
                    fetchTitle(id, id);
                }
            });
            renderCrate(); saveAuto();
            document.getElementById('bulk-modal').style.display = 'none';
            document.getElementById('bulk-textarea').value = '';
        }

        function addSingle() {
            const url = document.getElementById('crate-url').value;
            const m = url.match(/(?:v=|youtu\.be\/|\/)([a-zA-Z0-9_-]{11})/);
            if(m) {
                const id = m[1];
                if(crate.some(t=>t.id===id)) return alert("Track already in crate!");
                const estimatedBpm = generateAutoBpm(id);
                crate.push({id:id, name:`Track ${id}`, bpm: estimatedBpm});
                fetchTitle(id, id);
                renderCrate(); saveAuto();
                document.getElementById('crate-url').value = '';
            }
        }

        function shuffleCrate() {
            for (let i = crate.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [crate[i], crate[j]] = [crate[j], crate[i]];
            }
            renderCrate();
            saveAuto();
        }

        function fetchTitle(id, lookupId) {
            fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`)
            .then(r=>r.json()).then(d=>{ if(d.title){ const t = crate.find(x => x.id === lookupId); if(t) { t.name = d.title; renderCrate(); saveAuto(); } } }).catch(e=>{});
        }

        function renderCrate() {
            const l = document.getElementById('crate-list'); l.innerHTML = '';
            crate.forEach((t, i) => {
                const div = document.createElement('div'); div.className = 'crate-item';
                const bpmDisplay = t.bpm ? `<span class="item-bpm">${t.bpm} BPM</span>` : '';
                div.innerHTML = `
                    <span class="item-name">${t.name}</span>
                    <div style="display:flex; gap:5px; align-items:center;">
                        ${bpmDisplay}
                        <button class="load-btn" onclick="load('A',${i})">A</button>
                        <button class="load-btn" onclick="load('B',${i})">B</button>
                        <button class="load-btn" style="color:red;" onclick="remove(${i})">X</button>
                    </div>`;
                l.appendChild(div);
            });
        }

        function load(d, tIdx) {
            const t = crate[tIdx]; if(!t) return;
            loadedIDs[d] = t.id;
            loadedIndices[d] = tIdx;

            if(ready[d]) {
                players[d].loadVideoById(t.id);
                document.getElementById(`title-${d.toLowerCase()}`).innerText = t.name;
                loops[d]={active:false,in:null,out:null}; cues[d]={1:null,2:null,3:null,set:false};
                document.getElementById(`loop-exit-${d.toLowerCase()}`).classList.remove('loop-active');
                [1,2,3].forEach(n=>document.getElementById(`cue-${d.toLowerCase()}-${n}`).classList.remove('has-cue'));
                
                // Use stored BPM or generate if missing
                const b = t.bpm || generateAutoBpm(t.id);
                tapData[d].bpm = b;
                document.getElementById(`bpm-${d.toLowerCase()}`).innerText = b;
                
                document.getElementById(`prog-${d.toLowerCase()}`).style.width = '0%';
                resetPitch(d);
            }
        }
        function remove(i) { crate.splice(i,1); renderCrate(); saveAuto(); }

        function openMemory() { renderSessionList(); document.getElementById('memory-modal').style.display = 'flex'; }
        function closeMemory() { document.getElementById('memory-modal').style.display = 'none'; }
        
        function saveAuto() { try { localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(crate)); } catch(e) {} }
        function loadAutoSave() { try { const d = localStorage.getItem(AUTO_SAVE_KEY); if(d) { crate = JSON.parse(d); renderCrate(); } } catch(e){} }
        
        function saveToSlot() {
            const name = document.getElementById('save-name').value.trim();
            if(!name) return alert("Enter a name!");
            try { localStorage.setItem(SESSION_PREFIX + name, JSON.stringify(crate)); document.getElementById('save-name').value = ''; renderSessionList(); } catch(e){}
        }
        function renderSessionList() {
            const list = document.getElementById('session-list'); list.innerHTML = '';
            for(let i=0; i<localStorage.length; i++) {
                const k = localStorage.key(i);
                if(k && k.startsWith(SESSION_PREFIX)) {
                    const sessionName = k.replace(SESSION_PREFIX, '');
                    const div = document.createElement('div'); div.className = 'mem-row';
                    div.innerHTML = `<span style="color:#fff;">${sessionName}</span><div><button class="mem-btn" onclick="loadSession('${sessionName}')">LOAD</button><button class="mem-btn" style="background:#d32f2f;" onclick="deleteSession('${sessionName}')">X</button></div>`;
                    list.appendChild(div);
                }
            }
        }
        function loadSession(name) { if(confirm("Load session?")) { try { crate = JSON.parse(localStorage.getItem(SESSION_PREFIX + name)); renderCrate(); saveAuto(); closeMemory(); } catch(e){} } }
        function deleteSession(name) { if(confirm("Delete?")) { localStorage.removeItem(SESSION_PREFIX + name); renderSessionList(); } }
        function exportSession() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(crate)); a.download = "tiu_mix.json"; document.body.appendChild(a); a.click(); a.remove(); }
        function importSession(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = function(e) { try { crate = JSON.parse(e.target.result); renderCrate(); saveAuto(); closeMemory(); } catch(err){} }; r.readAsText(f); }
    </script>
</body>
</html>
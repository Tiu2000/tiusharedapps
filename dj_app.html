<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIU Mixer Mobile v19</title>
    <style>
        :root {
            --bg-color: #000;
            --deck-a-bg: #1a1a1a;
            --deck-b-bg: #1a1a1a;
            --accent: #00ff9d;
            --accent-dim: #008f58;
            --text-color: #e0e0e0;
            --safe-area: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            touch-action: none; /* Prevents scroll on mobile */
        }

        /* --- LAYOUT GRID --- */
        .main-container {
            display: flex; flex-direction: column; height: 100%; width: 100%;
            padding-bottom: var(--safe-area);
        }

        .deck-section {
            flex: 1; display: flex; flex-direction: column; justify-content: space-between;
            padding: 10px; border-bottom: 1px solid #333; position: relative;
        }
        
        #deck-a { background: linear-gradient(to bottom, #111, #1a1a1a); border-bottom: 2px solid #00ff9d; }
        #deck-b { background: linear-gradient(to top, #111, #1a1a1a); border-top: 2px solid #00ccff; }

        /* --- MIXER SECTION (MIDDLE) --- */
        .mixer-section {
            height: 90px; background: #000; display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; border-bottom: 1px solid #333; z-index: 10;
        }

        /* --- CONTROLS --- */
        .track-info {
            font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            color: #fff; font-weight: bold; margin-bottom: 5px; text-align: center;
        }

        .waveform-box {
            height: 40px; background: #222; border-radius: 4px; position: relative;
            overflow: hidden; margin-bottom: 8px; border: 1px solid #444;
        }
        .playhead {
            position: absolute; left: 0; top: 0; bottom: 0; width: 0%;
            background: rgba(255, 255, 255, 0.2); pointer-events: none;
        }

        .controls-row { display: flex; gap: 8px; margin-bottom: 8px; height: 50px; }
        
        .btn-transport {
            flex: 1; border: none; border-radius: 6px; font-weight: 900; font-size: 1rem;
            color: #000; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .play-btn { background: #444; color: #fff; border-bottom: 4px solid #222; }
        .play-btn.active { background: var(--accent); color: #000; border-bottom: 2px solid #005f3d; transform: translateY(2px); }
        .cue-btn { background: #e0e0e0; color: #000; border-bottom: 4px solid #999; width: 60px; }
        .cue-btn:active { transform: translateY(2px); border-bottom: none; }

        .pad-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; height: 40px; }
        .pad {
            background: #333; border: none; color: #aaa; border-radius: 4px; font-weight: bold; font-size: 0.8rem;
        }
        .pad.active { background: #00ccff; color: #000; box-shadow: 0 0 10px #00ccff; }

        /* --- FADERS --- */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #fff; border: 2px solid #000; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #555; border-radius: 2px;
        }

        /* CROSSFADER SPECIAL STYLING */
        #crossfader { width: 60%; }
        #crossfader::-webkit-slider-thumb {
            height: 40px; width: 30px; border-radius: 4px; background: #ccc; margin-top: -18px;
        }
        #crossfader::-webkit-slider-runnable-track { height: 6px; background: #333; border: 1px solid #555; }

        /* --- MENU / CRATE OVERLAY --- */
        #crate-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; display: none;
            flex-direction: column; padding: 20px; overflow-y: auto;
        }
        .crate-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .crate-btn { 
            padding: 10px 20px; background: var(--accent); color: #000; 
            border: none; border-radius: 4px; font-weight: bold; font-size: 1rem;
        }
        .close-btn { background: #333; color: #fff; }
        
        .crate-item {
            background: #1a1a1a; padding: 15px; margin-bottom: 10px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;
        }
        .load-group { display: flex; gap: 10px; }
        .load-btn { 
            padding: 8px 12px; font-size: 0.8rem; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; 
        }

        /* UTILS */
        .hidden { display: none; }
        #video-layer { position: absolute; top: -9999px; visibility: hidden; }
        .menu-trigger {
            position: absolute; top: 10px; right: 10px; z-index: 50;
            background: #333; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; border: 1px solid #555;
        }

        /* BULK INPUT */
        #bulk-area { margin-bottom: 20px; display: none; }
        #bulk-text { width: 100%; height: 100px; background: #111; color: #fff; border: 1px solid #444; font-family: monospace; }

    </style>
</head>
<body>

    <div id="video-layer">
        <div id="player-a"></div>
        <div id="player-b"></div>
    </div>

    <div class="main-container">
        
        <button class="menu-trigger" onclick="toggleCrate()">üìÇ TRACKS / BULK</button>

        <div class="deck-section" id="deck-a">
            <div style="position: absolute; top:5px; left:5px; font-weight:900; color:rgba(255,255,255,0.1); font-size:3rem;">A</div>
            <div>
                <div class="track-info" id="title-a">No Track Loaded</div>
                <div class="waveform-box"><div class="playhead" id="playhead-a"></div></div>
                
                <div class="controls-row">
                    <button class="btn-transport cue-btn" onclick="mainCue('A')">CUE</button>
                    <button class="btn-transport play-btn" id="play-a" onclick="togglePlay('A')">PLAY</button>
                </div>
                
                <div class="pad-row">
                    <button class="pad" onclick="seekRel('A', -10)">-10s</button>
                    <button class="pad" onclick="seekRel('A', 10)">+10s</button>
                    <button class="pad" onclick="loop4('A')">LOOP</button>
                    <button class="pad" onclick="loopExit('A')">EXIT</button>
                </div>
            </div>
            
            <div style="margin-top:10px;">
                <input type="range" id="pitch-a" min="0.9" max="1.1" step="0.001" value="1" oninput="updatePitch('A')">
                <div style="text-align:center; font-size:0.6rem; color:#666;">PITCH / TEMPO</div>
            </div>
        </div>

        <div class="mixer-section">
            <div style="text-align:center; flex:1;">
                <input type="range" id="vol-a" min="0" max="100" value="100" oninput="updateVol()">
            </div>
            
            <div style="flex:2; padding:0 15px; text-align:center;">
                <input type="range" id="crossfader" min="0" max="100" value="50" oninput="updateVol()">
                <div style="font-size:0.6rem; color:#666; margin-top:5px;">CROSSFADER</div>
            </div>

            <div style="text-align:center; flex:1;">
                <input type="range" id="vol-b" min="0" max="100" value="100" oninput="updateVol()">
            </div>
        </div>

        <div class="deck-section" id="deck-b">
            <div style="position: absolute; bottom:5px; right:5px; font-weight:900; color:rgba(255,255,255,0.1); font-size:3rem;">B</div>
            
            <div style="margin-bottom:10px;">
                <div style="text-align:center; font-size:0.6rem; color:#666;">PITCH / TEMPO</div>
                <input type="range" id="pitch-b" min="0.9" max="1.1" step="0.001" value="1" oninput="updatePitch('B')">
            </div>

            <div>
                <div class="pad-row">
                    <button class="pad" onclick="seekRel('B', -10)">-10s</button>
                    <button class="pad" onclick="seekRel('B', 10)">+10s</button>
                    <button class="pad" onclick="loop4('B')">LOOP</button>
                    <button class="pad" onclick="loopExit('B')">EXIT</button>
                </div>

                <div class="controls-row" style="margin-top:8px;">
                    <button class="btn-transport cue-btn" onclick="mainCue('B')">CUE</button>
                    <button class="btn-transport play-btn" id="play-b" onclick="togglePlay('B')" style="border-bottom-color: #008f58;">PLAY</button>
                </div>

                <div class="waveform-box" style="margin-top:8px; margin-bottom:0;"><div class="playhead" id="playhead-b"></div></div>
                <div class="track-info" id="title-b" style="margin-top:5px;">No Track Loaded</div>
            </div>
        </div>
    </div>

    <div id="crate-overlay">
        <div class="crate-header">
            <h2 style="margin:0; color:#fff;">TRACK CRATE</h2>
            <button class="crate-btn close-btn" onclick="toggleCrate()">CLOSE</button>
        </div>

        <button class="crate-btn" onclick="toggleBulk()" style="margin-bottom:15px; background:#333; color:#fff; width:100%;">üìù IMPORT PLAYLIST (BULK)</button>
        
        <div id="bulk-area">
            <p style="font-size:0.8rem; color:#aaa;">Paste links from TubePilot here:</p>
            <textarea id="bulk-text" placeholder="Paste YouTube links here..."></textarea>
            <button class="crate-btn" onclick="processBulk()">PROCESS LINKS</button>
        </div>

        <div id="track-list">
            <div style="text-align:center; color:#666;">Crate is empty.</div>
        </div>
    </div>

    <script>
        var players = { A: null, B: null };
        var ready = { A: false, B: false };
        var tracks = [];
        var loopData = { A: {active:false, in:0, out:0}, B: {active:false, in:0, out:0} };

        // --- YOUTUBE API ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = function() {
            createPlayer('A', 'player-a');
            createPlayer('B', 'player-b');
            setInterval(updateUI, 100);
        };

        function createPlayer(deck, id) {
            players[deck] = new YT.Player(id, {
                height: '200', width: '200', videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 0 },
                events: {
                    'onReady': (e) => { ready[deck] = true; updateVol(); },
                    'onStateChange': (e) => {
                        const btn = document.getElementById(`play-${deck.toLowerCase()}`);
                        if (e.data === 1) btn.classList.add('active');
                        else btn.classList.remove('active');
                    }
                }
            });
        }

        // --- CORE FUNCTIONS ---
        function togglePlay(deck) {
            if(!ready[deck]) return;
            const state = players[deck].getPlayerState();
            state === 1 ? players[deck].pauseVideo() : players[deck].playVideo();
        }

        function mainCue(deck) {
            if(!ready[deck]) return;
            players[deck].pauseVideo();
            players[deck].seekTo(0);
        }

        function seekRel(deck, seconds) {
            if(!ready[deck]) return;
            let ct = players[deck].getCurrentTime();
            players[deck].seekTo(ct + seconds, true);
        }

        function updatePitch(deck) {
            if(!ready[deck]) return;
            const val = parseFloat(document.getElementById(`pitch-${deck.toLowerCase()}`).value);
            players[deck].setPlaybackRate(val);
        }

        function updateVol() {
            if(!ready.A || !ready.B) return;
            const xf = document.getElementById('crossfader').value;
            const va = document.getElementById('vol-a').value / 100;
            const vb = document.getElementById('vol-b').value / 100;
            
            let volA = 1, volB = 1;
            if(xf > 50) volA = 1 - ((xf-50)/50);
            if(xf < 50) volB = xf / 50;

            players.A.setVolume(volA * va * 100);
            players.B.setVolume(volB * vb * 100);
        }

        // --- LOOPS (SIMPLE 4-BAR APPROX) ---
        function loop4(deck) {
            if(!ready[deck]) return;
            const ct = players[deck].getCurrentTime();
            loopData[deck].in = ct;
            loopData[deck].out = ct + 4; // Approx 4 seconds loop
            loopData[deck].active = true;
        }
        function loopExit(deck) { loopData[deck].active = false; }

        function updateUI() {
            ['A', 'B'].forEach(d => {
                if(ready[d]) {
                    // Loop Check
                    if(loopData[d].active) {
                        if(players[d].getCurrentTime() >= loopData[d].out) {
                            players[d].seekTo(loopData[d].in, true);
                        }
                    }
                    // Progress Bar
                    const dur = players[d].getDuration();
                    const cur = players[d].getCurrentTime();
                    if(dur > 0) {
                        const pct = (cur/dur) * 100;
                        document.getElementById(`playhead-${d.toLowerCase()}`).style.width = pct + "%";
                    }
                }
            });
        }

        // --- CRATE & BULK ---
        function toggleCrate() {
            const el = document.getElementById('crate-overlay');
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
        }
        function toggleBulk() {
            const el = document.getElementById('bulk-area');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        function processBulk() {
            const txt = document.getElementById('bulk-text').value;
            const matches = txt.matchAll(/[?&]v=([^&]+)/g); // Simple regex for YouTube IDs
            // Fallback for full URLs or short links
            const lines = txt.split('\n');
            let count = 0;
            
            lines.forEach(line => {
                let vidId = null;
                if(line.includes('v=')) vidId = line.split('v=')[1].substring(0, 11);
                else if(line.includes('youtu.be/')) vidId = line.split('.be/')[1].substring(0, 11);
                else if(line.length === 11) vidId = line; // Raw ID

                if(vidId && !tracks.some(t => t.id === vidId)) {
                    tracks.push({ id: vidId, title: `Track ${vidId}` });
                    fetchTitle(vidId, tracks.length - 1);
                    count++;
                }
            });

            renderTracks();
            document.getElementById('bulk-text').value = '';
            toggleBulk();
            alert(`Added ${count} tracks!`);
        }

        function fetchTitle(id, index) {
            fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`)
            .then(r => r.json())
            .then(d => {
                if(d.title) {
                    tracks[index].title = d.title;
                    renderTracks();
                }
            });
        }

        function renderTracks() {
            const list = document.getElementById('track-list');
            list.innerHTML = '';
            tracks.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = 'crate-item';
                div.innerHTML = `
                    <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-right:10px; color:#fff;">${t.title}</div>
                    <div class="load-group">
                        <button class="load-btn" onclick="loadTrack('A', ${i})">A</button>
                        <button class="load-btn" onclick="loadTrack('B', ${i})">B</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function loadTrack(deck, index) {
            if(!ready[deck]) return;
            const t = tracks[index];
            document.getElementById(`title-${deck.toLowerCase()}`).innerText = t.title;
            players[deck].loadVideoById(t.id);
            toggleCrate();
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU Mixer Pro v17 - Proxy Edition</title>
    <style>
        :root {
            --bg-color: #121212;
            --deck-bg: #1e1e1e;
            --panel-bg: #252525;
            --accent: #00ff9d; 
            --accent-dim: #008f58;
            --cue-active: #ff0055;
            --loop-active: #ffee00;
            --text-color: #e0e0e0;
            --bar-color: #00ccff;
        }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Roboto', 'Arial', sans-serif; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; user-select: none;
        }

        /* WATERMARK */
        .watermark {
            position: fixed; bottom: 20px; right: 30px; font-weight: 900; font-size: 6rem;
            color: rgba(255, 255, 255, 0.04); pointer-events: none; z-index: 0;
        }

        /* HIDDEN VIDEO LAYER */
        #video-layer { position: fixed; top: 0; z-index: -1; opacity: 0; pointer-events: none; }

        /* MAIN UI CONTAINER */
        .app-layer {
            z-index: 100; display: flex; flex-direction: column; align-items: center;
            background: #181818; padding: 20px; border-radius: 15px; margin-top: 20px; margin-bottom: 50px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.9); border: 1px solid #333;
        }

        header { 
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px;
        }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; color: #fff; }

        /* --- CONSOLE LAYOUT --- */
        .console { display: flex; gap: 15px; background: #000; padding: 20px; border-radius: 10px; border: 1px solid #333; }

        .deck {
            background: var(--deck-bg); width: 320px; padding: 15px; border-radius: 8px;
            display: flex; flex-direction: column; gap: 15px; border: 1px solid #444; position: relative;
        }

        /* TRACK TITLE DISPLAY */
        .track-title {
            font-size: 0.8rem; color: #fff; text-align: center; padding: 5px;
            background: #111; border: 1px solid #333; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            height: 20px; line-height: 20px;
        }

        /* DECK VISUALS */
        .deck-top { display: flex; gap: 15px; height: 160px; }
        
        .vinyl-wrapper { width: 160px; height: 160px; position: relative; }
        .vinyl {
            width: 100%; height: 100%; background: #111; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 2px solid #333;
        }
        .vinyl-grooves {
            width: 90%; height: 90%; border-radius: 50%; position: absolute;
            background: repeating-radial-gradient(#151515, #151515 2px, #252525 3px, #252525 4px);
        }
        .vinyl-label {
            width: 35%; height: 35%; background: #d32f2f; border-radius: 50%; z-index: 2;
            border: 2px solid #fff; display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: bold; color: white;
        }
        .deck-b .vinyl-label { background: #1976d2; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinning { animation: spin 1.8s linear infinite; }
        .paused { animation-play-state: paused; }

        /* GAIN SLIDER */
        .gain-container {
            display: flex; flex-direction: column; align-items: center; flex: 1;
            background: #111; border-radius: 4px; padding: 5px 0; border: 1px solid #333;
        }
        .gain-label { font-size: 0.6rem; color: #888; margin-bottom: 5px; }
        input[type=range].vertical-fader {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 8px; height: 100%; background: transparent;
        }

        /* --- VISUAL BEAT GAUGE --- */
        .beat-gauge-container {
            width: 100%; height: 10px; background: #000; border-radius: 4px; overflow: hidden;
            margin-top: 8px; border: 1px solid #333; position: relative;
        }
        .beat-piston {
            width: 20%; height: 100%; background: var(--bar-color);
            position: absolute; left: 0; box-shadow: 0 0 10px var(--bar-color); opacity: 0.3;
        }
        @keyframes bounce {
            0% { left: 0; }
            50% { left: 80%; } 
            100% { left: 0; }
        }
        .beating {
            animation-name: bounce;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            opacity: 1;
        }

        /* INFO DISPLAY */
        .deck-info {
            background: #0f0f0f; border: 1px solid #333; padding: 10px; border-radius: 4px;
            font-family: 'Courier New', monospace; color: var(--accent); font-size: 0.9rem;
            display: flex; flex-direction: column; gap: 5px;
        }
        .info-row { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .bpm-display { color: #fff; font-weight: bold; cursor: pointer; }
        .save-btn {
            background: #333; color: #aaa; border: 1px solid #555; font-size: 0.6rem;
            padding: 2px 6px; cursor: pointer; border-radius: 3px; font-family: sans-serif;
        }
        .save-btn:hover { background: var(--accent-dim); color: white; border-color: var(--accent); }

        /* CONTROLS */
        .pad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .pad {
            background: #333; border: none; color: #aaa; padding: 12px 0; font-size: 0.7rem; font-weight: bold;
            border-radius: 4px; cursor: pointer; transition: all 0.1s; border-bottom: 2px solid #222;
        }
        .pad:active { transform: translateY(2px); border-bottom: none; }
        .pad.set-mode { background: #500; color: #fff; animation: pulse 1s infinite; }
        .pad.has-cue { background: var(--accent-dim); color: #fff; border-bottom: 2px solid var(--accent); }
        .pad.loop-active { background: var(--loop-active); color: #000; box-shadow: 0 0 10px var(--loop-active); }

        .transport { display: flex; gap: 10px; }
        .btn-transport {
            flex: 1; padding: 12px; background: #333; color: #fff; border: none;
            border-radius: 4px; font-weight: 900; font-size: 0.8rem; cursor: pointer;
            border-bottom: 3px solid #111;
        }
        .btn-play.active { background: var(--accent); box-shadow: 0 0 15px var(--accent); color: #000;}

        /* PITCH */
        .pitch-container {
            background: #111; padding: 10px; border-radius: 4px; border: 1px solid #333;
            display: flex; flex-direction: column; align-items: center;
        }
        .pitch-slider { width: 100%; -webkit-appearance: none; background: transparent; }
        .pitch-slider::-webkit-slider-track { height: 4px; background: #444; }
        .pitch-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 20px; width: 40px; background: #555; 
            margin-top: -8px; border-radius: 2px; border: 1px solid #888; cursor: ns-resize;
        }

        /* MIXER */
        .mixer {
            width: 140px; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #444;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
        }

        /* --- CRATE SECTION --- */
        .crate-section {
            width: 100%; margin-top: 20px; background: #111; border: 1px solid #333;
            border-radius: 8px; padding: 15px; box-sizing: border-box;
        }
        .crate-header {
            display: flex; gap: 10px; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 10px; flex-wrap: wrap;
        }
        .session-controls {
            display: flex; justify-content: flex-end; gap: 10px; padding-top: 10px; border-top: 1px solid #333; margin-top: 10px;
        }
        .crate-input {
            background: #000; border: 1px solid #444; color: #fff; padding: 8px; 
            border-radius: 4px; font-family: inherit; font-size: 0.8rem;
        }
        .crate-btn {
            background: var(--accent-dim); color: #fff; border: none; padding: 8px 15px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.7rem; white-space: nowrap;
        }
        .crate-btn:hover { background: var(--accent); color: #000; }
        .session-btn {
            background: #333; color: #ccc; border: 1px solid #555; padding: 8px 15px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.7rem;
        }
        .session-btn:hover { background: #555; color: #fff; }

        /* BULK AREA */
        #bulk-container {
            width: 100%; display: none; flex-direction: column; gap: 10px;
            margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        #bulk-textarea {
            width: 100%; height: 100px; background: #000; color: #bbb;
            border: 1px solid #444; padding: 10px; font-family: monospace; font-size: 0.8rem;
            box-sizing: border-box; resize: vertical;
        }

        .crate-list {
            display: flex; flex-direction: column; gap: 5px; max-height: 200px; overflow-y: auto;
        }
        .crate-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #1a1a1a; padding: 8px 15px; border-radius: 4px; border: 1px solid #333;
        }
        .crate-item:hover { background: #222; }
        .item-name { color: #fff; font-size: 0.85rem; flex: 1; }
        .item-info { font-size: 0.7rem; color: var(--accent); margin-right: 10px; font-family: monospace; }
        .item-actions { display: flex; gap: 5px; }
        .load-btn {
            background: #333; color: #aaa; border: 1px solid #444; padding: 4px 8px;
            font-size: 0.65rem; cursor: pointer; border-radius: 3px;
        }
        .load-btn:hover { background: #555; color: #fff; }

        /* LOG PANEL */
        #log-panel {
            width: 100%; margin-top: 20px; background: #000; border: 1px solid #333;
            color: #0f0; font-family: monospace; font-size: 0.7rem; padding: 10px;
            height: 100px; overflow-y: scroll; border-radius: 5px;
        }
        .log-line { margin: 2px 0; border-bottom: 1px solid #111; }
        .log-err { color: #f00; }
        .log-warn { color: #ff0; }

        /* NOTIFICATION TOAST */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 4px; padding: 16px; position: fixed; z-index: 1000; bottom: 30px; border: 1px solid var(--accent);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div class="watermark">TIU</div>
    <div id="toast">Saved!</div>
    <input type="file" id="import-file" style="display: none;" accept=".json" onchange="handleFileImport(this)">

    <div id="video-layer">
        <div id="player-a"></div>
        <div id="player-b"></div>
    </div>

    <div class="app-layer">
        <header>
            <h1>TIU MIXER <span style="font-size:0.8rem; color:var(--accent); vertical-align: middle; border:1px solid var(--accent); padding:2px 5px; border-radius:4px;">PRO</span></h1>
            
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:0.7rem; font-weight:bold; color:#666;">SYNC MODE</span>
                <label class="switch" style="position:relative; width:40px; height:20px;">
                    <input type="checkbox" id="sync-toggle">
                    <span style="position:absolute; top:0; left:0; right:0; bottom:0; background:#333; border-radius:20px;">
                        <span id="sync-knob" style="position:absolute; height:16px; width:16px; left:2px; bottom:2px; background:#fff; border-radius:50%; transition:0.3s;"></span>
                    </span>
                </label>
            </div>
        </header>

        <div class="console">
            <div class="deck" id="deck-a">
                <div class="track-title" id="track-title-a">No Track Loaded</div>
                <div class="deck-top">
                    <div class="vinyl-wrapper">
                        <div class="vinyl" id="vinyl-a">
                            <div class="vinyl-grooves"></div>
                            <div class="vinyl-label">A</div>
                        </div>
                    </div>
                    <div class="gain-container">
                        <span class="gain-label">GAIN</span>
                        <input type="range" class="vertical-fader" id="gain-a" min="0" max="100" value="80" oninput="updateVolume()">
                    </div>
                </div>
                <div class="deck-info">
                    <div class="info-row">
                        <span id="time-a">00:00</span>
                        <button class="save-btn" onclick="saveDeckData('A')">üíæ SAVE</button>
                    </div>
                    <div class="info-row">
                        <span class="bpm-display" id="bpm-a">TAP BPM</span>
                    </div>
                    <div class="beat-gauge-container">
                        <div class="beat-piston" id="piston-a"></div>
                    </div>
                </div>
                <div class="pad-grid">
                    <button class="pad" id="cue-a-1" onclick="triggerHotCue('A', 1)">1</button>
                    <button class="pad" id="cue-a-2" onclick="triggerHotCue('A', 2)">2</button>
                    <button class="pad" id="cue-a-3" onclick="triggerHotCue('A', 3)">3</button>
                    <button class="pad" id="set-a" onclick="toggleSetMode('A')" style="color:#d32f2f;">SET</button>
                    <button class="pad" onclick="loopIn('A')">IN</button>
                    <button class="pad" onclick="loopOut('A')">OUT</button>
                    <button class="pad" id="loop-exit-a" onclick="loopExit('A')">EXIT</button>
                    <button class="pad" onclick="tapBpm('A')">TAP</button>
                </div>
                <div class="transport">
                    <button class="btn-transport btn-cue" onclick="mainCue('A')">CUE</button>
                    <button class="btn-transport btn-play" id="play-a" onclick="togglePlay('A')">PLAY</button>
                    <button class="btn-transport" onclick="brake('A')" style="background:#555; font-size:0.6rem;">STOP</button>
                </div>
                <div class="pitch-container">
                    <div style="display:flex; justify-content:space-between; width:100%; font-size:0.6rem; color:#666; margin-bottom:5px;">
                        <span onclick="resetPitch('A')" style="cursor:pointer;">RESET</span>
                        <button id="sync-btn-a" onclick="syncDeck('A')" style="display:none; background:#00ccff; border:none; font-size:0.6rem; padding:2px 4px; cursor:pointer;">SYNC</button>
                    </div>
                    <input type="range" class="pitch-slider" id="pitch-a" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('A')">
                </div>
            </div>

            <div class="mixer">
                <div style="text-align:center;">
                    <div style="font-size:0.6rem; color:#666; margin-bottom:5px;">MASTER</div>
                    <input type="range" class="vertical-fader" id="master-vol" min="0" max="100" value="100" style="height:180px;" oninput="updateVolume()">
                </div>
                <div style="width:100%;">
                    <div style="text-align:center; font-size:0.6rem; color:#666; margin-bottom:5px;">CROSSFADER</div>
                    <input type="range" id="crossfader" min="0" max="100" value="50" style="width:100%; cursor:pointer;" oninput="updateVolume()">
                    <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#444; font-weight:bold; margin-top:5px;">
                        <span>A</span><span>B</span>
                    </div>
                </div>
            </div>

            <div class="deck deck-b" id="deck-b">
                <div class="track-title" id="track-title-b">No Track Loaded</div>
                <div class="deck-top">
                    <div class="gain-container">
                        <span class="gain-label">GAIN</span>
                        <input type="range" class="vertical-fader" id="gain-b" min="0" max="100" value="80" oninput="updateVolume()">
                    </div>
                    <div class="vinyl-wrapper">
                        <div class="vinyl" id="vinyl-b">
                            <div class="vinyl-grooves"></div>
                            <div class="vinyl-label">B</div>
                        </div>
                    </div>
                </div>
                <div class="deck-info">
                    <div class="info-row">
                        <span id="time-b">00:00</span>
                        <button class="save-btn" onclick="saveDeckData('B')">üíæ SAVE</button>
                    </div>
                    <div class="info-row">
                        <span class="bpm-display" id="bpm-b">TAP BPM</span>
                    </div>
                    <div class="beat-gauge-container">
                        <div class="beat-piston" id="piston-b"></div>
                    </div>
                </div>
                <div class="pad-grid">
                    <button class="pad" id="cue-b-1" onclick="triggerHotCue('B', 1)">1</button>
                    <button class="pad" id="cue-b-2" onclick="triggerHotCue('B', 2)">2</button>
                    <button class="pad" id="cue-b-3" onclick="triggerHotCue('B', 3)">3</button>
                    <button class="pad" id="set-b" onclick="toggleSetMode('B')" style="color:#d32f2f;">SET</button>
                    <button class="pad" onclick="loopIn('B')">IN</button>
                    <button class="pad" onclick="loopOut('B')">OUT</button>
                    <button class="pad" id="loop-exit-b" onclick="loopExit('B')">EXIT</button>
                    <button class="pad" onclick="tapBpm('B')">TAP</button>
                </div>
                <div class="transport">
                    <button class="btn-transport btn-cue" onclick="mainCue('B')">CUE</button>
                    <button class="btn-transport btn-play" id="play-b" onclick="togglePlay('B')">PLAY</button>
                    <button class="btn-transport" onclick="brake('B')" style="background:#555; font-size:0.6rem;">STOP</button>
                </div>
                <div class="pitch-container">
                    <div style="display:flex; justify-content:space-between; width:100%; font-size:0.6rem; color:#666; margin-bottom:5px;">
                        <span onclick="resetPitch('B')" style="cursor:pointer;">RESET</span>
                        <button id="sync-btn-b" onclick="syncDeck('B')" style="display:none; background:#00ccff; border:none; font-size:0.6rem; padding:2px 4px; cursor:pointer;">SYNC</button>
                    </div>
                    <input type="range" class="pitch-slider" id="pitch-b" min="0.5" max="1.5" step="0.001" value="1" oninput="updatePitch('B')">
                </div>
            </div>
        </div>
        
        <div class="crate-section">
            <h3 style="margin-top:0; font-size:0.8rem; color:#888; text-transform:uppercase;">Session Manager</h3>
            
            <div id="bulk-container">
                <div style="font-size:0.7rem; color:#666; margin-bottom:5px;">
                    <b>OPTION A:</b> PASTE LINKS (ONE PER LINE)<br>
                    <b>OPTION B:</b> GO TO YOUTUBE PLAYLIST -> CTRL+A (SELECT ALL) -> CTRL+C (COPY) -> PASTE HERE
                </div>
                <textarea id="bulk-textarea" placeholder="Paste data here..."></textarea>
                <div style="text-align:right;">
                    <button class="crate-btn" onclick="processBulkAdd()">PROCESS LIST</button>
                    <button class="crate-btn" onclick="toggleBulkMode()" style="background:#333;">CANCEL</button>
                </div>
            </div>

            <div class="crate-header">
                <button class="crate-btn" onclick="toggleBulkMode()" style="background:#333; margin-right:10px;">üìù BULK</button>
                <input type="text" id="crate-url" class="crate-input" style="flex:1;" placeholder="Paste Video OR Playlist URL..." oninput="handleUrlPaste()">
                <input type="text" id="crate-name" class="crate-input" style="flex:1;" placeholder="Track Name">
                <button class="crate-btn" onclick="addSingleTrack()">ADD</button>
            </div>

            <div class="crate-list" id="crate-list">
                <div style="padding:10px; color:#444; text-align:center; font-style:italic;" id="empty-msg">Crate is empty.</div>
            </div>

            <div class="session-controls">
                <button class="session-btn" onclick="document.getElementById('import-file').click()">üì• IMPORT SESSION</button>
                <button class="session-btn" onclick="exportSession()">üì§ EXPORT SESSION</button>
            </div>

            <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                <div style="font-size:0.7rem; color:#666; margin-bottom:5px;">SYSTEM LOG</div>
                <div id="log-panel">System Ready.<br></div>
            </div>
        </div>
    </div>

    <script>
        // --- LOGGING UTILITY ---
        function sysLog(msg, type = 'info') {
            const panel = document.getElementById('log-panel');
            const line = document.createElement('div');
            line.className = 'log-line ' + (type === 'error' ? 'log-err' : (type === 'warn' ? 'log-warn' : ''));
            const time = new Date().toLocaleTimeString().split(' ')[0];
            line.innerText = `[${time}] ${msg}`;
            panel.appendChild(line);
            panel.scrollTop = panel.scrollHeight;
            console.log(`[TIU] ${msg}`);
        }

        // --- CORE SYSTEM VARIABLES ---
        var players = { A: null, B: null };
        var ready = { A: false, B: false };
        var loops = { A: { active: false, in: null, out: null }, B: { active: false, in: null, out: null } };
        var hotCues = { A: { 1: null, 2: null, 3: null, setMode: false }, B: { 1: null, 2: null, 3: null, setMode: false } };
        var tapData = { A: { lastTap: 0, count: 0, total: 0, bpm: 0 }, B: { lastTap: 0, count: 0, total: 0, bpm: 0 } };
        var loadedTrackId = { A: null, B: null }; 
        var crateData = []; 
        var loopInterval;
        var fetchTimeout;

        // --- PUBLIC API MIRRORS ---
        const apiMirrors = [
            "https://invidious.projectsegfau.lt",
            "https://vid.puffyan.us",
            "https://invidious.jing.rocks",
            "https://inv.tux.pizza"
        ];

        // --- YOUTUBE API ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = function() {
            sysLog("YouTube Player API Ready");
            createPlayer('A', 'player-a');
            createPlayer('B', 'player-b');
            loopInterval = setInterval(checkLoops, 50);
        };

        function createPlayer(deck, id) {
            players[deck] = new YT.Player(id, {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 0, 'origin': window.location.origin },
                events: {
                    'onReady': (e) => { ready[deck] = true; updateVolume(); sysLog(`Deck ${deck} Ready`); },
                    'onStateChange': (e) => {
                        updateVisuals(deck, e.data);
                        if (e.data === YT.PlayerState.PLAYING || e.data === YT.PlayerState.CUED) {
                            const data = players[deck].getVideoData();
                            if(data && data.title && !loadedTrackId[deck]) {
                                document.getElementById(`track-title-${deck.toLowerCase()}`).innerText = data.title;
                            }
                        }
                    }
                }
            });
        }

        // --- DATA SAVING (DECK TO CRATE) ---
        function saveDeckData(deck) {
            const vidId = loadedTrackId[deck];
            if (!vidId) { showToast("No track loaded to save!"); return; }
            const track = crateData.find(t => t.id === vidId);
            if (track) {
                track.bpm = tapData[deck].bpm;
                track.hotCues = { ...hotCues[deck] };
                delete track.hotCues.setMode; 
                track.savedLoop = { in: loops[deck].in, out: loops[deck].out };
                showToast(`Saved Data for: ${track.name}`);
                renderCrate(); 
            } else {
                showToast("Track not found in crate.");
            }
        }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- EXPORT / IMPORT ---
        function exportSession() {
            if(crateData.length === 0) { showToast("Nothing to export!"); return; }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(crateData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "tiu_session.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        crateData = imported;
                        renderCrate();
                        sysLog(`Session imported: ${crateData.length} tracks.`);
                        showToast("Session Imported Successfully!");
                    } else {
                        showToast("Invalid File Format");
                    }
                } catch(err) {
                    showToast("Error reading file");
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        // --- BULK ADD & CRATE MANAGEMENT ---
        function toggleBulkMode() {
            const cont = document.getElementById('bulk-container');
            cont.style.display = (cont.style.display === 'flex') ? 'none' : 'flex';
        }

        function processBulkAdd() {
            const text = document.getElementById('bulk-textarea').value;
            if(!text.trim()) return;
            
            // Smart Scraper regex for messy text
            const urlRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([^"&?\/\s]{11})/g;
            let match;
            let addedCount = 0;
            const foundIds = new Set();

            // First pass: Find all video IDs in the text blob
            while ((match = urlRegex.exec(text)) !== null) {
                if(!foundIds.has(match[1])) {
                    foundIds.add(match[1]);
                    // Try to find a title near the URL in the text line
                    const lineStart = text.lastIndexOf('\n', match.index) + 1;
                    const lineEnd = text.indexOf('\n', match.index);
                    const line = text.substring(lineStart, lineEnd !== -1 ? lineEnd : text.length);
                    
                    // Simple cleanup of the line to guess a title
                    let name = line.replace(match[0], '').trim();
                    if(name.length < 3) name = null;
                    
                    performAddById(match[1], name);
                    addedCount++;
                }
            }

            document.getElementById('bulk-textarea').value = '';
            toggleBulkMode();
            if (addedCount > 0) {
                showToast(`Scraped & Added ${addedCount} tracks.`);
                sysLog(`Bulk Scrape: Found ${addedCount} unique video IDs.`);
            } else {
                showToast("No YouTube links found.");
            }
        }

        function handleUrlPaste() {
            clearTimeout(fetchTimeout);
            const url = document.getElementById('crate-url').value;
            const nameInput = document.getElementById('crate-name');

            if (url.includes('list=')) {
                nameInput.value = "Playlist Detected (Click ADD)";
                return;
            }

            if (url.length > 10) {
                nameInput.placeholder = "Fetching title...";
                fetchTimeout = setTimeout(() => {
                    fetchTitle(url, (title) => {
                         if(title) {
                            nameInput.value = title;
                            nameInput.placeholder = "Track Name";
                         } else {
                             nameInput.placeholder = "Type Name Manually";
                         }
                    });
                }, 800);
            }
        }

        function fetchTitle(url, callback) {
            // Using a CORS proxy for the oembed title fetch as well
             fetch(`https://noembed.com/embed?url=${url}`)
                .then(response => response.json())
                .then(data => { callback(data.title); })
                .catch(e => { callback(null); });
        }

        function addSingleTrack() {
            const nameInput = document.getElementById('crate-name');
            const urlInput = document.getElementById('crate-url');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();

            if(!url) { alert("Please enter a URL"); return; }

            const listMatch = url.match(/[?&]list=([a-zA-Z0-9_-]+)/);
            if (listMatch) {
                sysLog(`Detected Playlist ID: ${listMatch[1]}`);
                startPlaylistFetch(listMatch[1]);
                urlInput.value = '';
                nameInput.value = '';
                return;
            }

            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            const vidId = (match && match[2].length === 11) ? match[2] : null;

            if (vidId) {
                performAddById(vidId, name || null);
                nameInput.value = '';
                urlInput.value = '';
                nameInput.placeholder = "Track Name";
            } else {
                sysLog("Invalid URL format.", 'error');
            }
        }

        // --- PLAYLIST FETCHING WITH PROXY ---
        function startPlaylistFetch(listId) {
            sysLog("Starting playlist fetch via Proxy...");
            tryMirror(listId, 0);
        }

        function tryMirror(listId, index) {
            if (index >= apiMirrors.length) {
                sysLog("All mirrors failed. Try 'BULK' copy/paste method.", 'error');
                showToast("Connection Failed. Try Bulk Paste.");
                return;
            }

            const mirror = apiMirrors[index];
            const targetUrl = `${mirror}/api/v1/playlists/${listId}`;
            // WE USE 'ALLORIGINS' AS A PROXY BRIDGE
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;

            sysLog(`Attempting Proxy to Mirror ${index + 1}...`);

            const fetchPromise = fetch(proxyUrl);
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("Timeout")), 8000)
            );

            Promise.race([fetchPromise, timeoutPromise])
            .then(res => {
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(data => {
                if(data.videos && data.videos.length > 0) {
                    let count = 0;
                    data.videos.forEach(video => {
                        if(!crateData.some(t => t.id === video.videoId)) {
                            crateData.push({
                                id: video.videoId,
                                name: video.title,
                                bpm: 0,
                                hotCues: { 1: null, 2: null, 3: null },
                                savedLoop: { in: null, out: null }
                            });
                            count++;
                        }
                    });
                    renderCrate();
                    sysLog(`Success! Imported ${count} tracks.`);
                    showToast(`Added ${count} tracks.`);
                } else {
                    throw new Error("Empty Data");
                }
            })
            .catch(err => {
                sysLog(`Mirror ${index + 1} Failed: ${err.message}`, 'warn');
                tryMirror(listId, index + 1);
            });
        }

        function performAddById(vidId, explicitName) {
            if(crateData.some(t => t.id === vidId)) {
                sysLog(`Track already exists: ${vidId}`);
                return;
            }
            const newTrack = {
                id: vidId,
                name: explicitName || "Fetching Title...", 
                bpm: 0,
                hotCues: { 1: null, 2: null, 3: null },
                savedLoop: { in: null, out: null }
            };
            crateData.push(newTrack);
            renderCrate();

            if(!explicitName) {
                fetchTitle(`https://youtu.be/${vidId}`, (title) => {
                    newTrack.name = title || `Unknown Track ${vidId}`;
                    renderCrate();
                });
            }
        }

        function renderCrate() {
            const list = document.getElementById('crate-list');
            const emptyMsg = document.getElementById('empty-msg');
            list.innerHTML = '';

            if (crateData.length === 0) {
                if(emptyMsg) list.appendChild(emptyMsg);
                else list.innerHTML = '<div style="padding:10px; color:#444; text-align:center; font-style:italic;" id="empty-msg">Crate is empty.</div>';
                return;
            }

            crateData.forEach((track, index) => {
                const div = document.createElement('div');
                div.className = 'crate-item';
                const bpmBadge = track.bpm > 0 ? `<span class="item-info">${track.bpm} BPM</span>` : '';

                div.innerHTML = `
                    <span class="item-name" onclick="renameTrack(${index})" title="Click to rename">${track.name}</span>
                    ${bpmBadge}
                    <div class="item-actions">
                        <button class="load-btn" onclick="loadFromCrate('A', ${index})">LOAD A</button>
                        <button class="load-btn" onclick="loadFromCrate('B', ${index})">LOAD B</button>
                        <button class="load-btn" onclick="removeFromCrate(${index})" style="color:#f00; border-color:#500;">X</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        function renameTrack(index) {
            const newName = prompt("Rename Track:", crateData[index].name);
            if(newName) {
                crateData[index].name = newName;
                renderCrate();
            }
        }

        function removeFromCrate(index) {
            crateData.splice(index, 1);
            renderCrate();
        }

        function loadFromCrate(deck, index) {
            if(!ready[deck]) return;
            const track = crateData[index];
            sysLog(`Loading track to Deck ${deck}: ${track.name}`);
            loadedTrackId[deck] = track.id; 
            document.getElementById(`track-title-${deck.toLowerCase()}`).innerText = track.name;
            players[deck].loadVideoById(track.id);
            document.getElementById(`pitch-${deck.toLowerCase()}`).value = 1;
            updatePitch(deck);

            loops[deck] = { active: false, in: track.savedLoop.in, out: track.savedLoop.out };
            hotCues[deck] = { ...track.hotCues, setMode: false };
            
            if (track.bpm > 0) {
                tapData[deck] = { lastTap: 0, count: 0, total: 0, bpm: track.bpm };
                document.getElementById(`bpm-${deck.toLowerCase()}`).innerText = `${track.bpm} BPM`;
                updateBeatGauge(deck, track.bpm);
            } else {
                tapData[deck] = { lastTap: 0, count: 0, total: 0, bpm: 0 };
                document.getElementById(`bpm-${deck.toLowerCase()}`).innerText = "TAP BPM";
                updateBeatGauge(deck, 0);
            }
            updateLoopUI(deck);
            updateCueUI(deck);
        }

        // --- PLAYBACK CONTROLS ---
        function togglePlay(deck) {
            if(!ready[deck]) return;
            const state = players[deck].getPlayerState();
            state === 1 ? players[deck].pauseVideo() : players[deck].playVideo();
        }

        function mainCue(deck) {
            if(!ready[deck]) return;
            players[deck].pauseVideo();
            players[deck].seekTo(0);
        }

        function brake(deck) {
            if(!ready[deck]) return;
            players[deck].setPlaybackRate(0.5);
            setTimeout(() => {
                 players[deck].setPlaybackRate(0.25);
                 setTimeout(() => {
                     players[deck].pauseVideo();
                     players[deck].setPlaybackRate(1); 
                 }, 200);
            }, 200);
        }

        // --- PITCH & VISUAL BEAT SYNC ---
        function updatePitch(deck) {
            const val = parseFloat(document.getElementById(`pitch-${deck.toLowerCase()}`).value);
            if(ready[deck]) {
                players[deck].setPlaybackRate(val);
                if(tapData[deck].bpm > 0) updateBeatGauge(deck, tapData[deck].bpm);
            }
        }
        
        function resetPitch(deck) {
            document.getElementById(`pitch-${deck.toLowerCase()}`).value = 1;
            updatePitch(deck);
        }

        // --- BPM TAP ---
        function tapBpm(deck) {
            const now = Date.now();
            const data = tapData[deck];
            if (now - data.lastTap > 2000) { data.count = 0; data.total = 0; }
            if (data.count > 0) {
                const diff = now - data.lastTap;
                data.total += diff;
                const avg = data.total / data.count;
                data.bpm = Math.round(60000 / avg);
                document.getElementById(`bpm-${deck.toLowerCase()}`).innerText = `${data.bpm} BPM`;
                updateBeatGauge(deck, data.bpm);
            }
            data.lastTap = now;
            data.count++;
        }

        function updateBeatGauge(deck, baseBpm) {
            const piston = document.getElementById(`piston-${deck.toLowerCase()}`);
            if(baseBpm <= 0) {
                piston.classList.remove('beating');
                return;
            }
            const pitch = parseFloat(document.getElementById(`pitch-${deck.toLowerCase()}`).value);
            const duration = 60 / (baseBpm * pitch);
            piston.style.animationDuration = `${duration}s`;
            piston.classList.add('beating');
        }

        // --- HOT CUES ---
        function toggleSetMode(deck) {
            hotCues[deck].setMode = !hotCues[deck].setMode;
            document.getElementById(`set-${deck.toLowerCase()}`).classList.toggle('set-mode');
        }

        function triggerHotCue(deck, num) {
            if(!ready[deck]) return;
            const btn = document.getElementById(`cue-${deck.toLowerCase()}-${num}`);
            if (hotCues[deck].setMode) {
                hotCues[deck][num] = players[deck].getCurrentTime();
                btn.classList.add('has-cue');
                toggleSetMode(deck); 
            } else {
                if(hotCues[deck][num] !== null) {
                    players[deck].seekTo(hotCues[deck][num], true);
                    players[deck].playVideo(); 
                }
            }
        }
        
        function updateCueUI(deck) {
            [1,2,3].forEach(n => {
                const btn = document.getElementById(`cue-${deck.toLowerCase()}-${n}`);
                if(hotCues[deck][n] !== null) btn.classList.add('has-cue');
                else btn.classList.remove('has-cue');
            });
        }

        // --- LOOPING ---
        function loopIn(deck) { if(ready[deck]) loops[deck].in = players[deck].getCurrentTime(); }
        function loopOut(deck) {
            if(!ready[deck] || loops[deck].in === null) return;
            loops[deck].out = players[deck].getCurrentTime();
            loops[deck].active = true;
            document.getElementById(`loop-exit-${deck.toLowerCase()}`).classList.add('loop-active');
        }
        function loopExit(deck) {
            loops[deck].active = false; 
            document.getElementById(`loop-exit-${deck.toLowerCase()}`).classList.remove('loop-active');
        }
        function updateLoopUI(deck) { 
            document.getElementById(`loop-exit-${deck.toLowerCase()}`).classList.remove('loop-active'); 
        }

        function checkLoops() {
            ['A', 'B'].forEach(deck => {
                if(ready[deck] && loops[deck].active && loops[deck].out && loops[deck].in !== null) {
                    if (players[deck].getCurrentTime() >= loops[deck].out) players[deck].seekTo(loops[deck].in, true);
                }
                if(ready[deck]) {
                    const t = players[deck].getCurrentTime();
                    const m = Math.floor(t / 60).toString().padStart(2,'0');
                    const s = Math.floor(t % 60).toString().padStart(2,'0');
                    document.getElementById(`time-${deck.toLowerCase()}`).innerText = `${m}:${s}`;
                }
            });
        }

        // --- VOLUME ---
        function updateVolume() {
            const master = document.getElementById('master-vol').value / 100;
            const xVal = document.getElementById('crossfader').value;
            const gainA = document.getElementById('gain-a').value / 100;
            const gainB = document.getElementById('gain-b').value / 100;
            let xVolA = 1, xVolB = 1;
            if (xVal < 50) xVolB = (xVal / 50);
            else if (xVal > 50) xVolA = 1 - ((xVal - 50) / 50);
            if (ready.A) players.A.setVolume(gainA * xVolA * master * 100);
            if (ready.B) players.B.setVolume(gainB * xVolB * master * 100);
        }

        function updateVisuals(deck, state) {
            const d = deck.toLowerCase();
            const vinyl = document.getElementById(`vinyl-${d}`);
            const btn = document.getElementById(`play-${d}`);
            const piston = document.getElementById(`piston-${d}`);
            if (state === 1) { 
                vinyl.classList.add('spinning'); vinyl.classList.remove('paused');
                btn.classList.add('active');
                if(tapData[deck].bpm > 0) piston.classList.add('beating');
            } else {
                vinyl.classList.add('paused');
                btn.classList.remove('active');
                piston.classList.remove('beating');
            }
        }

        document.getElementById('sync-toggle').addEventListener('change', (e) => {
            const knob = document.getElementById('sync-knob');
            const btns = [document.getElementById('sync-btn-a'), document.getElementById('sync-btn-b')];
            if(e.target.checked) {
                knob.style.transform = 'translateX(20px)'; knob.style.background = 'var(--accent)';
                btns.forEach(b => b.style.display = 'block');
            } else {
                knob.style.transform = 'translateX(0)'; knob.style.background = '#fff';
                btns.forEach(b => b.style.display = 'none');
            }
        });

        function syncDeck(target) {
            if(!ready.A || !ready.B) return;
            const source = (target === 'A') ? players.B : players.A;
            const rate = source.getPlaybackRate();
            document.getElementById(`pitch-${target.toLowerCase()}`).value = rate;
            updatePitch(target);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Court Cam v28 (Ultimate)</title>
    <style>
        /* --- GLOBAL --- */
        body { background: #000; color: #fff; margin: 0; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; user-select: none; -webkit-user-select: none; }
        
        /* --- LAYOUT --- */
        #stage { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        
        canvas { position: absolute; max-width: 100%; max-height: 100%; aspect-ratio: 16/9; z-index: 1; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        /* The UI Layer - Toggled by Clean Feed */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; transition: opacity 0.3s; }
        .ui-hidden { opacity: 0; pointer-events: none !important; }

        /* --- SYSTEM BUTTONS (Always visible mostly) --- */
        #system-controls { position: absolute; top: 15px; left: 15px; z-index: 999; display: flex; gap: 10px; }
        #reset-controls { position: absolute; top: 15px; right: 15px; z-index: 999; }

        .sys-btn { 
            background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); 
            width: 45px; height: 45px; border-radius: 8px; font-size: 1.2rem; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            backdrop-filter: blur(2px); pointer-events: auto; transition: all 0.2s;
        }
        .sys-btn:active { background: rgba(255,255,255,0.8); color: #000; }
        .btn-danger { border-color: rgba(255,50,50,0.5); color: rgba(255,50,50,0.7); }
        .btn-active { background: #fff; color: #000; }
        
        /* --- CONTROLS --- */
        .control-group { position: absolute; pointer-events: auto; display: flex; flex-direction: column; gap: 8px; }
        .group-left { left: 20px; top: 55%; transform: translateY(-50%); }
        .group-right { right: 20px; top: 55%; transform: translateY(-50%); }
        .group-top { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: row; align-items: center; transition: top 0.3s ease; }
        
        .team-name-btn {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.9); 
            font-weight: 700; font-size: 1rem; margin-bottom: 10px; 
            cursor: pointer; text-transform: uppercase; padding: 8px 12px; border-radius: 6px;
            pointer-events: auto; letter-spacing: 1px; transition: background 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        
        /* ZOOM SLIDER */
        .group-zoom { 
            right: 150px; top: 55%; transform: translateY(-50%); 
            height: 200px; width: 50px; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.25); border-radius: 25px; padding: 10px 0; border: 1px solid rgba(255,255,255,0.15);
            pointer-events: auto; backdrop-filter: blur(2px);
        }
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 10px; height: 140px; margin: 10px 0; opacity: 0.6;
        }
        .zoom-info { font-size: 0.7rem; font-weight: 700; text-align: center; opacity: 0.8; }
        .zoom-type-hw { color: #0f0; } 
        .zoom-type-dig { color: #f33; } 

        /* HUD BUTTONS */
        .hud-btn {
            background: rgba(20,20,20,0.25); border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.8);
            padding: 12px 0; border-radius: 8px; font-weight: bold; font-size: 1.1rem;
            width: 70px; text-align: center; backdrop-filter: blur(2px); transition: all 0.1s;
        }
        .hud-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.3); color: #fff; }
        
        /* REC BUTTONS */
        .btn-rec { background: rgba(200,0,0,0.6); border: 2px solid rgba(255,255,255,0.5); width: 55px; height: 55px; border-radius: 50%; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        .rec-active { background: rgba(255,255,255,0.9); color: #f00; border-color: #f00; animation: pulse 2s infinite; font-size: 0.65rem; }
        .rec-paused { background: rgba(255, 200, 0, 0.9); color: #000; border-color: #fff; animation: none; font-size: 0.6rem; }
        @keyframes pulse { 0% {opacity:1} 50% {opacity:0.6} 100% {opacity:1} }
        
        #rec-timer { display: none; font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.2rem; color: #f00; margin: 0 10px; text-shadow: 0 0 5px #000; }
        #btn-stop { display: none; width: 45px; height: 45px; background: rgba(200,0,0,0.8); border: 2px solid #fff; border-radius: 8px; align-items: center; justify-content: center; font-size: 1.2rem; margin-left: 8px; }

        /* AUDIO METER */
        #audio-meter { width: 8px; height: 45px; background: rgba(50,50,50,0.3); border: 1px solid rgba(100,100,100,0.3); border-radius: 5px; overflow: hidden; position: relative; display: flex; align-items: flex-end; }
        #audio-level { width: 100%; height: 0%; background: rgba(0,255,0,0.7); transition: height 0.1s; }

        /* MODALS */
        .modal { position: fixed; z-index: 100; background: #1a1a1a; padding: 25px; border: 1px solid #333; border-radius: 12px; text-align: center; top:50%; left:50%; transform:translate(-50%, -50%); width: 85%; max-width: 350px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .modal h3 { margin-top: 0; color: #eee; }
        .modal-btn { background: #007bff; color: #fff; border: none; padding: 12px; width: 100%; margin: 8px 0; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        
        /* SETTINGS CHECKBOX */
        .settings-row { display: flex; justify-content: center; align-items: center; margin: 15px 0; gap: 10px; color: #ccc; font-size: 0.95rem; }
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: #007bff; cursor: pointer; }
        
        .btn-cashapp { background: #00D632; color: #fff; margin-top: 5px; }

        #input-modal input[type=text] { width: 90%; padding: 12px; font-size: 1.1rem; margin-bottom: 15px; text-align: center; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; }
        #input-modal input[type=color] { width: 50px; height: 50px; border: none; background: none; cursor: pointer; }
        
        select { width: 100%; padding: 10px; background: #333; color: #fff; border: 1px solid #555; border-radius: 6px; margin-bottom: 10px; font-size: 1rem; }

        /* LOG MODAL */
        #log-textarea { width: 100%; height: 150px; background: #000; color: #0f0; font-family: monospace; font-size: 0.8rem; border: 1px solid #555; margin-bottom: 10px; resize: none; }

        #raw-video { display: none; }
        
        /* Color Swatch in Button */
        .color-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.8); display: inline-block; }
    </style>
</head>
<body>

    <div id="system-controls">
        <button class="sys-btn" onclick="toggleFullScreen()" title="Fullscreen">‚õ∂</button>
        <button class="sys-btn" onclick="openStartupModal()" title="Settings">‚öôÔ∏è</button>
        <button class="sys-btn" onclick="toggleScoreboardPos()" title="Move Scoreboard">‚¨ç</button>
        <button class="sys-btn" id="btn-clean" onclick="toggleCleanFeed()" title="Clean Feed (Hide UI)">üëÅÔ∏è</button>
    </div>
    <div id="reset-controls">
        <button class="sys-btn btn-danger" onclick="resetGameData()">‚úï</button>
    </div>

    <div id="startup-modal" class="modal" style="display:block">
        <h3>Pro Court Cam v28</h3>
        <p style="color:#888; font-size:0.9rem;">Ultimate Edition</p>
        
        <div style="text-align:left; font-size:0.8rem; color:#aaa; margin-bottom:5px;">Select Camera Source:</div>
        <div style="display:flex; gap:10px; margin-bottom:5px;">
            <select id="camera-select" style="flex-grow:1; margin-bottom:0;"></select>
            <button class="sys-btn" style="width:42px; height:42px; margin:0; background:#333;" onclick="loadCameras()">‚Üª</button>
        </div>
        
        <div class="settings-row">
            <input type="checkbox" id="chk-timer" checked onchange="toggleTimerVisibility()">
            <label for="chk-timer" style="cursor:pointer">Show Game Timer</label>
        </div>

        <button class="modal-btn" style="background:#28a745" onclick="startSelectedCamera(1280, 720, 5000000)">Start 720p (Smooth)</button>
        <button class="modal-btn" onclick="startSelectedCamera(1920, 1080, 8000000)">Start 1080p (High Res)</button>
        
        <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 10px; margin-top:0;">Enjoying the app? Buy me a coffee ‚òï</p>
            <button class="modal-btn btn-cashapp" onclick="window.open('https://cash.app/$AnthonyTiu', '_blank')">
                $ Pay with Cash App
            </button>
        </div>
        <button class="modal-btn" style="background:#555; margin-top:20px; font-size:0.8rem; padding:8px;" onclick="openLogModal()">üìù Logs</button>
    </div>

    <div id="log-modal" class="modal">
        <h3>Debug Logs</h3>
        <textarea id="log-textarea" readonly></textarea>
        <button class="modal-btn" onclick="copyLogs()">üìã Copy to Clipboard</button>
        <button class="modal-btn" style="background:#444" onclick="closeLogModal()">Close</button>
    </div>

    <div id="input-modal" class="modal">
        <h3 id="input-title">Edit Team</h3>
        <input type="text" id="team-input" maxlength="10" placeholder="Team Name">
        <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
            <span style="color:#aaa;">Jersey Color:</span>
            <input type="color" id="team-color">
        </div>
        <button class="modal-btn" onclick="saveTeamData()">SAVE</button>
        <button class="modal-btn" style="background:#444" onclick="closeInput()">CANCEL</button>
    </div>

    <div id="stage">
        <canvas id="gameCanvas"></canvas>

        <div id="ui-layer">
            <div class="control-group group-top" id="top-bar">
                <button class="hud-btn" style="width:100px; border-color:rgba(40,167,69,0.5); color:#80ff9f; font-family:monospace; font-size:1.4rem;" id="btn-clock" onclick="toggleTimer()">10:00</button>
                <div style="width:10px"></div>
                <div id="audio-meter"><div id="audio-level"></div></div>
                <div style="width:10px"></div>
                <button class="hud-btn btn-rec" id="btn-rec" onclick="toggleRecordState()">REC</button>
                <div id="rec-timer">00:00:00</div>
                <button class="hud-btn" id="btn-stop" onclick="stopRecording()">‚ñ†</button>
                <div style="width:15px"></div>
                <button class="hud-btn" style="font-size:0.8rem;" onclick="nextPeriod()">PER 1</button>
            </div>

            <div class="control-group group-left">
                <button class="team-name-btn" id="btn-home-name" onclick="openInput('home')">
                    <span class="color-dot" id="dot-home"></span> HOME ‚úé
                </button>
                <button class="hud-btn" style="color:#80bfff;" onclick="updateScore('home', 1)">+1</button>
                <button class="hud-btn" style="color:#80bfff;" onclick="updateScore('home', 2)">+2</button>
                <button class="hud-btn" style="color:#80bfff;" onclick="updateScore('home', 3)">+3</button>
                <button class="hud-btn" style="color:#80bfff; font-size:0.8rem; opacity:0.6;" onclick="updateScore('home', -1)">-1</button>
            </div>

            <div class="control-group group-right">
                <button class="team-name-btn" id="btn-guest-name" onclick="openInput('guest')">
                    <span class="color-dot" id="dot-guest"></span> GUEST ‚úé
                </button>
                <button class="hud-btn" style="color:#ff808f;" onclick="updateScore('guest', 1)">+1</button>
                <button class="hud-btn" style="color:#ff808f;" onclick="updateScore('guest', 2)">+2</button>
                <button class="hud-btn" style="color:#ff808f;" onclick="updateScore('guest', 3)">+3</button>
                <button class="hud-btn" style="color:#ff808f; font-size:0.8rem; opacity:0.6;" onclick="updateScore('guest', -1)">-1</button>
            </div>

            <div class="control-group group-zoom">
                <div id="zoom-type" class="zoom-info zoom-type-dig">DIG</div>
                <div id="zoom-label" class="zoom-info" style="font-size:0.9rem; color:rgba(255,255,255,0.8); margin-top:2px;">1.0x</div>
                <input type="range" id="zoom-slider" orient="vertical" min="1" max="5" step="0.1" value="1">
            </div>
        </div>
    </div>

    <video id="raw-video" autoplay muted playsinline></video>

    <script>
        // --- LOGGING ---
        let debugLogs = [];
        function log(msg) {
            const ts = new Date().toLocaleTimeString();
            console.log(`[${ts}] ${msg}`);
            debugLogs.push(`[${ts}] ${msg}`);
            const area = document.getElementById('log-textarea');
            if(area) area.value = debugLogs.join('\n');
        }
        function openLogModal() { document.getElementById('log-modal').style.display = 'block'; document.getElementById('startup-modal').style.display = 'none'; }
        function closeLogModal() { document.getElementById('log-modal').style.display = 'none'; document.getElementById('startup-modal').style.display = 'block'; }
        function copyLogs() { navigator.clipboard.writeText(document.getElementById('log-textarea').value).then(() => alert("Logs copied!")); }

        // --- POLYFILLS ---
        if (typeof CanvasRenderingContext2D.prototype.roundRect !== 'function') {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
                this.beginPath(); this.moveTo(x + r, y); this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r); this.arcTo(x, y + h, x, y, r); this.arcTo(x, y, x + w, y, r);
                this.closePath(); return this;
            };
        }

        // --- WAKE LOCK ---
        let wakeLock = null;
        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); log("WakeLock ON"); } catch (err) { log("WakeLock ERR: " + err.message); } }
        document.addEventListener("visibilitychange", async () => { if (document.visibilityState === 'visible') requestWakeLock(); });

        // --- GAME STATE ---
        const STORAGE_KEY = 'court_cam_v28_data';
        let gameData = { 
            homeName: "HOME", guestName: "GUEST", 
            homeScore: 0, guestScore: 0, 
            timeLeft: 600, period: 1,
            homeColor: "#0056b3", guestColor: "#b30000" // Default Blue vs Red
        };
        let scoreboardPos = "BOTTOM";
        let cleanFeed = false;
        
        // Load Data
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) { try { gameData = JSON.parse(saved); } catch(e) {} }
        
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameData)); updateButtonColors(); }
        function resetGameData() { 
            if(confirm("Reset game?")) { 
                gameData = { homeName: "HOME", guestName: "GUEST", homeScore: 0, guestScore: 0, timeLeft: 600, period: 1, homeColor: "#0056b3", guestColor: "#b30000" }; 
                saveData(); updateClockUI(); 
            } 
        }

        // --- APP VARIABLES ---
        let isTimerRunning = false, timerInterval = null;
        let track = null, audioContext;
        let zoomMode = "DIGITAL", currentZoom = 1.0;
        let targetW=1280, targetH=720, targetBitrate = 5000000;
        let homeFlash = 0, guestFlash = 0;
        let editingTeam = ''; // 'home' or 'guest'

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('raw-video');
        const cameraSelect = document.getElementById('camera-select');
        const topBar = document.getElementById('top-bar');
        const clockBtn = document.getElementById('btn-clock');
        const uiLayer = document.getElementById('ui-layer');

        // --- INITIALIZATION ---
        async function loadCameras() {
            log("Loading cameras...");
            cameraSelect.innerHTML = "<option>Loading...</option>";
            try {
                // Permission trick
                const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                tempStream.getTracks().forEach(t => t.stop());
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                cameraSelect.innerHTML = ""; 

                if(videoDevices.length === 0) {
                    let opt = document.createElement('option'); opt.text = "No Cameras Found"; cameraSelect.appendChild(opt);
                } else {
                    let optDef = document.createElement('option'); optDef.value = "default"; optDef.text = "System Default (Back)"; cameraSelect.appendChild(optDef);
                    videoDevices.forEach((device, index) => {
                        let opt = document.createElement('option'); opt.value = device.deviceId; opt.text = device.label || `Camera ${index + 1}`; cameraSelect.appendChild(opt);
                    });
                }
            } catch(e) { log("Cam Error: " + e.message); cameraSelect.innerHTML = "<option>Error (Check perms)</option>"; }
        }
        loadCameras();

        function openStartupModal() { document.getElementById('startup-modal').style.display = 'block'; }
        function closeModal() { document.getElementById('startup-modal').style.display = 'none'; }
        
        function toggleTimerVisibility() {
            const chk = document.getElementById('chk-timer');
            clockBtn.style.display = chk.checked ? 'block' : 'none';
        }

        async function startSelectedCamera(w, h, bitrate) {
            log(`Start: ${w}x${h}`);
            targetW = w; targetH = h; targetBitrate = bitrate;
            canvas.width = w; canvas.height = h;
            closeModal(); requestWakeLock(); toggleTimerVisibility(); updateButtonColors();
            
            if(track) { track.stop(); track = null; }
            const selectedId = cameraSelect.value;
            const constraints = { video: { width: { ideal: w }, height: { ideal: h } }, audio: true };
            if (selectedId === "default") constraints.video.facingMode = "environment";
            else constraints.video.deviceId = { exact: selectedId };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                handleStreamSuccess(stream);
            } catch(e) {
                log("Audio failed, trying video only...");
                constraints.audio = false;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    handleStreamSuccess(stream);
                    alert("Microphone failed. Recording video only.");
                } catch (videoErr) { log("FATAL: " + videoErr.message); alert("Camera Init Failed."); }
            }
        }

        function handleStreamSuccess(stream) {
            video.srcObject = stream;
            video.onloadedmetadata = async () => {
                await video.play();
                track = stream.getVideoTracks()[0];
                if (stream.getAudioTracks().length > 0) setupAudio(stream);
                setupZoom();
                if(!window.isDrawing) { window.isDrawing = true; drawLoop(); }
            };
        }

        // --- AUDIO ---
        function setupAudio(stream) {
            if(audioContext) audioContext.close();
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioContext.createMediaStreamSource(stream);
            const analyzer = audioContext.createAnalyser();
            const processor = audioContext.createScriptProcessor(2048, 1, 1);
            src.connect(analyzer); analyzer.connect(processor); processor.connect(audioContext.destination);
            processor.onaudioprocess = () => {
                const array = new Uint8Array(analyzer.frequencyBinCount);
                analyzer.getByteFrequencyData(array);
                let values = 0; for(let i=0; i<array.length; i++) values += array[i];
                let pct = Math.min(100, (values / array.length) * 2.5);
                const bar = document.getElementById('audio-level');
                if(bar) { bar.style.height = pct + "%"; bar.style.background = pct>80?"#f00":"#0f0"; }
            }
        }

        // --- ZOOM (PINCH ADDED) ---
        function setupZoom() {
            if(!track) return;
            const caps = track.getCapabilities ? track.getCapabilities() : {};
            const slider = document.getElementById('zoom-slider');
            
            if (caps.zoom) {
                zoomMode = "HARDWARE";
                document.getElementById('zoom-type').className = "zoom-info zoom-type-hw";
                slider.min = caps.zoom.min; slider.max = caps.zoom.max; slider.step = caps.zoom.step || 0.1;
                slider.value = track.getSettings().zoom || 1;
            } else {
                zoomMode = "DIGITAL";
                document.getElementById('zoom-type').className = "zoom-info zoom-type-dig";
                slider.min = 1; slider.max = 5; slider.step = 0.1; slider.value = 1;
            }

            slider.oninput = async (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById('zoom-label').innerText = val.toFixed(1) + "x";
                if(zoomMode === "HARDWARE") await track.applyConstraints({advanced:[{zoom:val}]});
                else currentZoom = val;
            };
        }

        // PINCH LOGIC
        let initialPinch = 0, initialZoomVal = 1;
        canvas.addEventListener('touchstart', e => {
            if(e.touches.length === 2) {
                initialPinch = Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY);
                initialZoomVal = parseFloat(document.getElementById('zoom-slider').value);
            }
        });
        canvas.addEventListener('touchmove', e => {
            if(e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY);
                const delta = dist - initialPinch;
                let newVal = initialZoomVal + (delta * 0.01);
                const s = document.getElementById('zoom-slider');
                newVal = Math.min(Math.max(newVal, parseFloat(s.min)), parseFloat(s.max));
                s.value = newVal; s.dispatchEvent(new Event('input'));
            }
        });

        // --- RECORDING (SAFETY) ---
        let mediaRecorder, chunks=[], recState="IDLE", recSeconds=0, recTimerInterval=null;
        const recBtn = document.getElementById('btn-rec'), stopBtn = document.getElementById('btn-stop'), recTimer = document.getElementById('rec-timer');

        function toggleRecordState() {
            if(recState==="IDLE") startRecording();
            else if(recState==="RECORDING") pauseRecording();
            else if(recState==="PAUSED") resumeRecording();
        }
        
        function updateRecTimerDisplay() {
            recSeconds++;
            let h=Math.floor(recSeconds/3600), m=Math.floor((recSeconds%3600)/60), s=recSeconds%60;
            recTimer.innerText = `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }

        function startRecording() {
            try {
                log("Rec Start");
                const stream = canvas.captureStream(30);
                if(video.srcObject && video.srcObject.getAudioTracks().length > 0) stream.addTrack(video.srcObject.getAudioTracks()[0]);
                
                let opts = { videoBitsPerSecond: targetBitrate };
                if(MediaRecorder.isTypeSupported('video/mp4')) opts.mimeType = 'video/mp4';

                mediaRecorder = new MediaRecorder(stream, opts);
                mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
                mediaRecorder.onstop = () => saveVideoFile();
                mediaRecorder.start(1000); 

                recState = "RECORDING";
                recBtn.innerText = "PAUSE"; recBtn.className = "hud-btn btn-rec rec-active";
                stopBtn.style.display = "flex"; recTimer.style.display = "block"; recTimer.style.color = "#f00";
                recSeconds = 0; recTimer.innerText = "00:00:00";
                recTimerInterval = setInterval(updateRecTimerDisplay, 1000);
            } catch(e) { alert("Rec Start Failed: " + e.message); }
        }

        function pauseRecording() { mediaRecorder.pause(); recState="PAUSED"; recBtn.innerText="RESUME"; recBtn.className="hud-btn btn-rec rec-paused"; clearInterval(recTimerInterval); recTimer.style.color="#fc0"; }
        function resumeRecording() { mediaRecorder.resume(); recState="RECORDING"; recBtn.innerText="PAUSE"; recBtn.className="hud-btn btn-rec rec-active"; recTimer.style.color="#f00"; recTimerInterval=setInterval(updateRecTimerDisplay, 1000); }
        function stopRecording() { 
            if(confirm("Stop recording and SAVE file now?")) {
                mediaRecorder.stop(); recState="IDLE"; recBtn.innerText="REC"; recBtn.className="hud-btn btn-rec"; stopBtn.style.display="none"; clearInterval(recTimerInterval); recTimer.style.display="none"; 
            }
        }
        
        function saveVideoFile() {
            const blob = new Blob(chunks, {type: mediaRecorder.mimeType}); chunks=[];
            const ext = mediaRecorder.mimeType.includes("mp4") ? "mp4" : "webm";
            const a = document.createElement('a');
            // Filename: Game_Q1_Timestamp.mp4
            a.download = `Game_Q${gameData.period}_${Date.now()}.${ext}`;
            a.href = URL.createObjectURL(blob);
            document.body.appendChild(a); a.click(); setTimeout(()=>document.body.removeChild(a), 100);
            log("Video saved!");
        }

        // --- DRAWING ---
        function drawLoop() {
            // Draw Video
            if(zoomMode==="DIGITAL" && currentZoom>1) {
                const vw = video.videoWidth, vh = video.videoHeight;
                if(vw) {
                    const sw = vw/currentZoom, sh = vh/currentZoom;
                    ctx.drawImage(video, (vw-sw)/2, (vh-sh)/2, sw, sh, 0, 0, canvas.width, canvas.height);
                }
            } else { ctx.drawImage(video, 0, 0, canvas.width, canvas.height); }

            // Scoreboard Draw Logic
            const H = canvas.height, W = canvas.width;
            const sbH = H*0.14, sbW = W*0.7; 
            const sbX = (W-sbW)/2;
            const sbY = (scoreboardPos==="BOTTOM") ? H-sbH-(H*0.04) : (H*0.04);
            
            // Main BG
            const grad = ctx.createLinearGradient(sbX, sbY, sbX, sbY+sbH);
            grad.addColorStop(0, "rgba(20,20,20,0.9)"); grad.addColorStop(1, "rgba(0,0,0,0.95)");
            ctx.fillStyle = grad; ctx.beginPath(); ctx.roundRect(sbX, sbY, sbW, sbH, 10); ctx.fill();
            ctx.strokeStyle="#c9a050"; ctx.lineWidth=2; ctx.stroke();

            const colW = sbW/3, cY = sbY+(sbH/2);
            
            // HOME (Custom Color)
            ctx.fillStyle = gameData.homeColor || "#0056b3"; 
            ctx.beginPath(); ctx.roundRect(sbX+10, sbY+10, (colW*0.4), sbH-20, 5); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font = `bold ${H*0.035}px 'Segoe UI'`; ctx.textAlign = "left"; ctx.textBaseline = "middle"; 
            ctx.fillText(gameData.homeName, sbX+(colW*0.5), cY);
            
            if(homeFlash>0) { ctx.fillStyle="#ff0"; homeFlash--; } else ctx.fillStyle="#fff";
            ctx.font = `bold ${H*0.07}px 'Segoe UI'`; ctx.textAlign="center";
            ctx.fillText(gameData.homeScore, sbX+10+(colW*0.2), cY+3);

            // GUEST (Custom Color)
            const gStart = sbX+(colW*2);
            ctx.fillStyle = gameData.guestColor || "#b30000";
            ctx.beginPath(); ctx.roundRect(gStart+(colW*0.6)-10, sbY+10, (colW*0.4), sbH-20, 5); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font = `bold ${H*0.035}px 'Segoe UI'`; ctx.textAlign="right";
            ctx.fillText(gameData.guestName, gStart+(colW*0.5), cY);

            if(guestFlash>0) { ctx.fillStyle="#ff0"; guestFlash--; } else ctx.fillStyle="#fff";
            ctx.font = `bold ${H*0.07}px 'Segoe UI'`; ctx.textAlign="center";
            ctx.fillText(gameData.guestScore, gStart+(colW*0.6)+(colW*0.2)-10, cY+3);

            // CLOCK
            const cStart = sbX+colW;
            ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.fillRect(cStart, sbY+15, 2, sbH-30); ctx.fillRect(gStart, sbY+15, 2, sbH-30);
            
            if(document.getElementById('chk-timer').checked) {
                let m = Math.floor(gameData.timeLeft/60), s = gameData.timeLeft%60;
                ctx.fillStyle = isTimerRunning ? "#0f0" : "#ccc"; ctx.font = `bold ${H*0.065}px 'Courier New'`; ctx.textAlign="center";
                ctx.fillText(`${m}:${s<10?'0'+s:s}`, cStart+(colW/2), cY-(sbH*0.15));
            }
            ctx.fillStyle="#aaa"; ctx.font = `bold ${H*0.025}px sans-serif`;
            let suf = gameData.period===1?"ST":gameData.period===2?"ND":gameData.period===3?"RD":"TH";
            ctx.fillText(`${gameData.period}${suf} QTR`, cStart+(colW/2), cY+(sbH*(document.getElementById('chk-timer').checked?0.25:0.1)));

            requestAnimationFrame(drawLoop);
        }

        // --- INPUTS & CONTROLS ---
        function openInput(team) { 
            editingTeam = team; 
            document.getElementById('input-modal').style.display = 'block'; 
            document.getElementById('input-title').innerText = "Edit " + team.toUpperCase();
            document.getElementById('team-input').value = (team==='home'?gameData.homeName:gameData.guestName);
            document.getElementById('team-color').value = (team==='home'?gameData.homeColor:gameData.guestColor);
        }
        function saveTeamData() {
            const name = document.getElementById('team-input').value;
            const color = document.getElementById('team-color').value;
            if(editingTeam==='home') { gameData.homeName = name.toUpperCase(); gameData.homeColor = color; }
            else { gameData.guestName = name.toUpperCase(); gameData.guestColor = color; }
            saveData(); closeInput();
        }
        function closeInput() { document.getElementById('input-modal').style.display = 'none'; }
        
        function updateButtonColors() {
            document.getElementById('dot-home').style.backgroundColor = gameData.homeColor;
            document.getElementById('btn-home-name').style.borderLeftColor = gameData.homeColor;
            document.getElementById('dot-guest').style.backgroundColor = gameData.guestColor;
            document.getElementById('btn-guest-name').style.borderLeftColor = gameData.guestColor;
        }

        // --- GAME LOGIC ---
        function updateScore(t, n) { 
            if(t==='home') { gameData.homeScore=Math.max(0, gameData.homeScore+n); homeFlash=15; }
            else { gameData.guestScore=Math.max(0, gameData.guestScore+n); guestFlash=15; }
            saveData(); 
        }
        function nextPeriod() {
            if(recState === "RECORDING") {
                if(!confirm(`You are still recording Period ${gameData.period}. Stop and Save it now?`)) return;
                stopRecording(); // This will trigger the save logic
            }
            gameData.period++; 
            if(gameData.period>4) gameData.period=1; 
            gameData.timeLeft = 600; // Reset clock for new quarter
            saveData(); updateClockUI();
        }
        function toggleTimer() {
            if(isTimerRunning) { clearInterval(timerInterval); isTimerRunning=false; clockBtn.style.color="#80ff9f"; clockBtn.style.borderColor="rgba(40,167,69,0.5)"; }
            else { isTimerRunning=true; clockBtn.style.color="#fff"; clockBtn.style.borderColor="#f33"; timerInterval=setInterval(()=>{ if(gameData.timeLeft>0){gameData.timeLeft--; updateClockUI(); if(gameData.timeLeft%5===0)saveData();} else toggleTimer();}, 1000); }
        }
        clockBtn.addEventListener('dblclick', () => {
             if(isTimerRunning) toggleTimer();
             let val = prompt("Set Time (e.g. 8 or 1:30):");
             if (val) { if (val.includes(":")) { let p = val.split(":"); gameData.timeLeft = (parseInt(p[0])*60) + parseInt(p[1]); } else { gameData.timeLeft = parseInt(val) * 60; } updateClockUI(); saveData(); }
        });
        function updateClockUI() { let m=Math.floor(gameData.timeLeft/60), s=gameData.timeLeft%60; clockBtn.innerText=`${m}:${s<10?'0'+s:s}`; }
        function toggleScoreboardPos() { scoreboardPos=(scoreboardPos==="BOTTOM")?"TOP":"BOTTOM"; topBar.style.top=(scoreboardPos==="TOP")?"80%":"20px"; }
        function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen().catch(()=>{}); }
        function toggleCleanFeed() {
            cleanFeed = !cleanFeed;
            uiLayer.className = cleanFeed ? "ui-hidden" : "";
            const btn = document.getElementById('btn-clean');
            btn.className = cleanFeed ? "sys-btn btn-active" : "sys-btn";
        }
    </script>
</body>
</html>
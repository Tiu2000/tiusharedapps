<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Court Cam v23 (Debug)</title>
    <style>
        body { background: #000; margin: 0; height: 100vh; overflow: hidden; font-family: sans-serif; color: white; }
        
        /* THE STAGE */
        #stage { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        
        /* CANVAS (The Game Layer) */
        canvas { position: absolute; max-width: 100%; max-height: 100%; aspect-ratio: 16/9; z-index: 2; }
        
        /* RAW VIDEO (Hidden behind canvas, but ACTIVE) */
        #raw-video { 
            position: absolute; top: 0; left: 0; width: 100px; opacity: 0.1; z-index: 0; pointer-events: none;
        }

        /* UI LAYER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* DEBUG LOG BOX */
        #debug-log {
            position: absolute; bottom: 10px; left: 10px; width: 300px; height: 100px;
            background: rgba(255, 0, 0, 0.2); border: 1px solid red; font-size: 10px;
            overflow-y: scroll; z-index: 9999; pointer-events: none; font-family: monospace;
            padding: 5px; color: #fff;
        }

        /* BUTTONS */
        .sys-btn { position: absolute; top: 10px; left: 10px; z-index: 100; background: rgba(0,0,0,0.5); color: white; border: 1px solid white; padding: 10px; cursor: pointer; pointer-events: auto; }
        .restart-btn { left: 70px; background: rgba(200, 0, 0, 0.5); }
        
        /* SCOREBOARD CONTROLS (Simplified for test) */
        .hud-btn { pointer-events: auto; background: rgba(0,0,0,0.5); border: 1px solid #fff; color: #fff; padding: 10px; position: absolute; bottom: 20px; }
        
    </style>
</head>
<body>

    <div id="debug-log">Waiting for logs...</div>

    <button class="sys-btn" onclick="openCamSelect()">⚙️ CAM</button>
    <button class="sys-btn restart-btn" onclick="location.reload()">↻ RELOAD</button>

    <div id="stage">
        <video id="raw-video" autoplay playsinline webkit-playsinline muted></video>
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui-layer">
            <div style="position:absolute; top:20px; width:100%; text-align:center;">
                <h2 style="margin:0; text-shadow:0 2px 4px #000;">DIAGNOSTIC MODE</h2>
                <p style="margin:0; font-size:0.8rem; color:#ccc;">v23 • Basic Stream</p>
            </div>
        </div>
    </div>

    <div id="cam-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#222; padding:20px; z-index:2000; border:1px solid #555; text-align:center;">
        <h3>Select Camera</h3>
        <select id="cam-select" style="width:100%; padding:10px; margin-bottom:10px;"></select>
        <button onclick="startStream()" style="padding:10px 20px; background:#007bff; color:white; border:none;">START</button>
        <button onclick="document.getElementById('cam-modal').style.display='none'" style="padding:10px 20px; background:#444; color:white; border:none;">CLOSE</button>
    </div>

    <script>
        const video = document.getElementById('raw-video');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const logBox = document.getElementById('debug-log');
        const camSelect = document.getElementById('cam-select');
        let stream = null;

        function log(msg) {
            console.log(msg);
            logBox.innerHTML = `> ${msg}<br>` + logBox.innerHTML;
        }

        // 1. INITIAL LOAD
        window.onload = async () => {
            log("App Loaded. Checking permissions...");
            try {
                // Ask for permission simply first
                await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                log("Permissions Granted.");
                populateCameras();
            } catch (e) {
                log("PERMISSION ERROR: " + e.message);
                alert("Camera permission denied. Check browser settings.");
            }
        };

        // 2. FIND CAMERAS
        async function populateCameras() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            
            camSelect.innerHTML = "";
            
            // Add "Default" option
            let optDef = document.createElement('option');
            optDef.value = "default";
            optDef.text = "Default System Camera";
            camSelect.appendChild(optDef);

            if (videoDevices.length === 0) {
                log("No cameras found!");
            } else {
                log(`Found ${videoDevices.length} cameras.`);
                videoDevices.forEach((device, i) => {
                    let opt = document.createElement('option');
                    opt.value = device.deviceId;
                    opt.text = device.label || `Camera ${i + 1}`;
                    camSelect.appendChild(opt);
                });
            }
            // Auto-start default
            startStream();
        }

        function openCamSelect() {
            document.getElementById('cam-modal').style.display = 'block';
        }

        // 3. START STREAM
        async function startStream() {
            document.getElementById('cam-modal').style.display = 'none';
            if(stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            const deviceId = camSelect.value;
            log(`Requesting camera: ${deviceId}...`);

            const constraints = {
                audio: false, // Turn off audio for video test to prevent feedback
                video: {
                    width: { ideal: 1280 }, // Lower res for safety
                    height: { ideal: 720 }
                }
            };

            if (deviceId !== "default") {
                constraints.video.deviceId = { exact: deviceId };
            } else {
                constraints.video.facingMode = "environment"; // Prefer back camera
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                log("Stream acquired. Attaching to video...");
                
                video.srcObject = stream;
                
                // CRITICAL: Explicit play call
                await video.play();
                log("Video playing! Resolution: " + video.videoWidth + "x" + video.videoHeight);
                
                // Resize canvas to match video
                canvas.width = video.videoWidth || 1280;
                canvas.height = video.videoHeight || 720;
                
                draw(); // Start loop
            } catch (e) {
                log("STREAM ERROR: " + e.name + ": " + e.message);
            }
        }

        // 4. DRAW LOOP
        function draw() {
            if (video.paused || video.ended) {
                log("Video paused/ended. Stopping draw.");
                return;
            }
            
            // Draw video to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Draw simple UI overlay
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            ctx.fillRect(10, 10, 200, 60);
            ctx.fillStyle = "#0f0";
            ctx.font = "30px monospace";
            ctx.fillText("LIVE FEED", 20, 50);

            requestAnimationFrame(draw);
        }

        // Error Listeners
        video.addEventListener('error', (e) => log("Video Element Error: " + JSON.stringify(e)));
        video.addEventListener('loadeddata', () => log("Event: loadeddata"));
        video.addEventListener('playing', () => log("Event: playing"));
    </script>
</body>
</html>
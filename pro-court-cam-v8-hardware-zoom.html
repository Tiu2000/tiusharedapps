<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Court Cam v11</title>
    <style>
        /* --- CORE LAYOUT --- */
        body { background: #000; margin: 0; height: 100vh; overflow: hidden; font-family: sans-serif; }
        
        /* VIDEO LAYER (Background) */
        #cam-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1;
        }

        /* UI LAYER (Foreground) */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none; /* Let touches pass through to video if needed */
        }

        /* --- SCOREBOARD BAR (HTML Based) --- */
        #scoreboard-bar {
            position: absolute;
            bottom: 15%; /* Lifted up to avoid bottom nav bar */
            left: 5%; width: 90%; height: 80px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #c9a050;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; box-sizing: border-box;
            pointer-events: auto; /* Enable touching buttons */
            border-radius: 8px;
        }

        /* TEAMS */
        .team-box { text-align: center; width: 30%; }
        
        /* EDITABLE NAMES */
        .team-name {
            color: #3399ff; font-weight: bold; font-size: 1rem;
            text-transform: uppercase; border-bottom: 1px dashed rgba(255,255,255,0.3);
            display: inline-block; min-width: 50px; cursor: text;
        }
        .guest-name { color: #ff5050; }
        
        .team-score {
            color: white; font-weight: 900; font-size: 2.5rem; line-height: 1;
            font-family: 'Arial Black', sans-serif;
            text-shadow: 2px 2px 0px #000;
        }

        /* CLOCK CENTER */
        .clock-box { text-align: center; width: 30%; }
        .clock-digits { color: #00ff00; font-family: monospace; font-size: 2rem; font-weight: bold; }
        .period-text { color: #ccc; font-size: 0.8rem; font-weight: bold; }

        /* --- CONTROL BUTTONS (Floating) --- */
        .controls-overlay {
            position: absolute; width: 100%; height: 100%; pointer-events: none;
        }
        .btn-float {
            pointer-events: auto; background: rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.5); color: white;
            border-radius: 50%; width: 50px; height: 50px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            position: absolute;
        }
        .btn-float:active { background: white; color: black; }

        /* Position Buttons relative to scoreboard */
        /* Home Controls */
        #btn-h-plus { bottom: 26%; left: 10%; } 
        #btn-h-minus { bottom: 26%; left: 25%; width: 40px; height: 40px; font-size: 0.8rem; opacity: 0.8; }

        /* Guest Controls */
        #btn-g-plus { bottom: 26%; right: 10%; }
        #btn-g-minus { bottom: 26%; right: 25%; width: 40px; height: 40px; font-size: 0.8rem; opacity: 0.8; }

        /* Top Controls */
        #top-bar {
            position: absolute; top: 20px; width: 100%; 
            display: flex; justify-content: center; gap: 20px; pointer-events: auto;
        }
        .top-btn {
            background: rgba(0,0,0,0.6); color: white; border: 1px solid #555;
            padding: 10px 20px; border-radius: 20px; font-weight: bold;
        }
        .rec-active { background: white; color: red; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* ZOOM SLIDER (Always visible) */
        #zoom-wrapper {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            height: 200px; width: 50px; background: rgba(0,0,0,0.5);
            border-radius: 20px; display: flex; flex-direction: column; align-items: center;
            pointer-events: auto; padding: 10px 0;
        }
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 8px; height: 160px;
        }
        #zoom-debug { font-size: 0.6rem; text-align: center; margin-bottom: 5px; color: yellow; }

        /* Start Modal */
        #modal {
            position: fixed; z-index: 100; top:0; left:0; width:100%; height:100%;
            background: #111; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; gap: 20px;
        }
        .big-btn { padding: 20px 40px; font-size: 1.5rem; background: #007bff; color: white; border: none; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="modal">
        <h2 style="color:white">Camera Setup</h2>
        <button class="big-btn" onclick="startApp()">Start Camera</button>
        <p style="color:#777">Accept permissions when asked</p>
    </div>

    <video id="cam-view" autoplay playsinline muted></video>

    <div id="ui-layer">
        
        <div id="top-bar">
            <button class="top-btn" id="btn-clock-toggle" onclick="toggleTimer()">Start Clock</button>
            <button class="top-btn" id="btn-rec" onclick="toggleRecord()">REC</button>
            <button class="top-btn" onclick="changePeriod()">PER 1</button>
        </div>

        <div id="zoom-wrapper">
            <div id="zoom-debug">Loading</div>
            <input type="range" id="zoom-slider" orient="vertical" min="1" max="10" step="0.1" value="1">
            <div style="font-size:0.8rem; font-weight:bold; margin-top:5px;" id="zoom-val">1.0x</div>
        </div>

        <button class="btn-float" id="btn-h-plus" onclick="modScore('h', 1)">+1</button>
        <button class="btn-float" id="btn-h-minus" onclick="modScore('h', -1)">-1</button>
        
        <button class="btn-float" id="btn-g-plus" onclick="modScore('g', 1)">+1</button>
        <button class="btn-float" id="btn-g-minus" onclick="modScore('g', -1)">-1</button>

        <div id="scoreboard-bar">
            <div class="team-box">
                <div class="team-name" contenteditable="true">HOME</div>
                <div class="team-score" id="score-h">0</div>
            </div>

            <div class="clock-box" onclick="editTime()">
                <div class="clock-digits" id="clock-display">10:00</div>
                <div class="period-text" id="period-display">1ST QTR</div>
            </div>

            <div class="team-box">
                <div class="team-name guest-name" contenteditable="true">GUEST</div>
                <div class="team-score" id="score-g">0</div>
            </div>
        </div>

    </div>

    <script>
        // --- LOGIC ---
        let track;
        let scores = { h: 0, g: 0 };
        let timeLeft = 600;
        let timerInt = null;
        let period = 1;

        async function startApp() {
            document.getElementById('modal').style.display = 'none';
            
            // Go Fullscreen
            try { document.documentElement.requestFullscreen(); } catch(e){}

            const video = document.getElementById('cam-view');
            
            try {
                // FORCE HARDWARE ZOOM REQUEST
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        zoom: true // Critical Flag
                    },
                    audio: true
                });

                video.srcObject = stream;
                track = stream.getVideoTracks()[0];
                
                // CHECK CAPABILITIES
                const caps = track.getCapabilities();
                const slider = document.getElementById('zoom-slider');
                const debug = document.getElementById('zoom-debug');

                if (caps.zoom) {
                    debug.innerText = `Max: ${caps.zoom.max}x`;
                    debug.style.color = "#0f0"; // Green = Hardware
                    slider.min = caps.zoom.min;
                    slider.max = caps.zoom.max;
                    slider.step = 0.1;
                    
                    slider.oninput = (e) => {
                        const val = parseFloat(e.target.value);
                        track.applyConstraints({ advanced: [{ zoom: val }] });
                        document.getElementById('zoom-val').innerText = val.toFixed(1) + "x";
                    };
                } else {
                    debug.innerText = "NO HW";
                    debug.style.color = "red";
                    slider.disabled = true;
                }

            } catch (err) {
                alert("Camera Error: " + err);
            }
        }

        // --- SCOREBOARD FUNCTIONS ---
        function modScore(team, val) {
            scores[team] += val;
            if(scores[team] < 0) scores[team] = 0;
            document.getElementById(`score-${team}`).innerText = scores[team];
        }

        function toggleTimer() {
            const btn = document.getElementById('btn-clock-toggle');
            if (timerInt) {
                clearInterval(timerInt); timerInt = null;
                btn.style.background = "rgba(0,0,0,0.6)";
                btn.innerText = "Start Clock";
            } else {
                btn.style.background = "#006400";
                btn.innerText = "Stop Clock";
                timerInt = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        updateClockUI();
                    }
                }, 1000);
            }
        }

        function updateClockUI() {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('clock-display').innerText = `${m}:${s<10?'0'+s:s}`;
        }

        function editTime() {
            let ans = prompt("Set Time (min):", "10");
            if(ans) {
                timeLeft = parseInt(ans) * 60;
                updateClockUI();
            }
        }

        function changePeriod() {
            period++; if(period > 4) period = 1;
            const pName = period===1?"1ST":period===2?"2ND":period===3?"3RD":"4TH";
            document.getElementById('period-display').innerText = `${pName} QTR`;
            event.target.innerText = `PER ${period}`;
        }

        // --- RECORDING (MediaRecorder) ---
        let mediaRecorder;
        let chunks = [];
        let isRecording = false;

        function toggleRecord() {
            const btn = document.getElementById('btn-rec');
            const video = document.getElementById('cam-view');

            if (!isRecording) {
                // Record the CANVAS (Wait! We aren't using canvas anymore...)
                // IMPORTANT: Browsers cannot record DOM Elements (HTML).
                // We must record the RAW VIDEO STREAM directly.
                // The overlay won't be in the recorded video file in this mode.
                // NOTE: To get Overlay + Video in recording requires Canvas, 
                // but Canvas breaks editable text.
                // COMPROMISE: We record raw video here.
                
                alert("Note: This records Raw Video only (No Scoreboard) for performance.");
                
                const stream = video.srcObject;
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = e => {
                    const blob = new Blob(chunks, { 'type' : 'video/mp4' });
                    chunks = [];
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "game_clip.mp4";
                    a.click();
                };
                mediaRecorder.start();
                isRecording = true;
                btn.classList.add('rec-active');
                btn.innerText = "STOP";
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('rec-active');
                btn.innerText = "REC";
            }
        }

        // Prevent accidentally navigating away
        window.onbeforeunload = function() { return "Game in progress?"; };

    </script>
</body>
</html>
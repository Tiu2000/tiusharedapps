<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pro Court Cam v15</title>
    <style>
        /* --- GLOBAL --- */
        body { background: #000; color: #fff; margin: 0; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; user-select: none; -webkit-user-select: none; }
        
        /* --- LAYOUT --- */
        #stage { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        
        canvas { position: absolute; max-width: 100%; max-height: 100%; aspect-ratio: 16/9; z-index: 1; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* --- SYSTEM BUTTONS --- */
        #system-controls { position: absolute; top: 15px; left: 15px; z-index: 999; display: flex; gap: 10px; }
        #reset-controls { position: absolute; top: 15px; right: 15px; z-index: 999; }

        .sys-btn { 
            background: rgba(0,0,0,0.6); border: 1px solid #777; color: #fff; 
            width: 45px; height: 45px; border-radius: 8px; font-size: 1.2rem; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            backdrop-filter: blur(4px); pointer-events: auto;
        }
        .sys-btn:active { background: #fff; color: #000; }
        .btn-danger { border-color: #f33; color: #f33; }

        /* --- CONTROLS --- */
        .control-group { position: absolute; pointer-events: auto; display: flex; flex-direction: column; gap: 8px; }
        .group-left { left: 20px; top: 55%; transform: translateY(-50%); }
        .group-right { right: 20px; top: 55%; transform: translateY(-50%); }
        
        /* Top Group needs to move based on UI position, handled in JS/CSS logic generally, but fixed for now */
        .group-top { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: row; align-items: center; }
        
        /* EDITABLE NAMES */
        .team-name-btn {
            background: rgba(0,0,0,0.8); border: 1px solid #555; color: white; 
            font-weight: 700; font-size: 1rem; margin-bottom: 10px; 
            cursor: pointer; text-transform: uppercase; padding: 8px 12px; border-radius: 6px;
            pointer-events: auto; letter-spacing: 1px;
        }

        /* ZOOM SLIDER */
        .group-zoom { 
            right: 100px; top: 55%; transform: translateY(-50%); 
            height: 200px; width: 50px; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.6); border-radius: 25px; padding: 10px 0; border: 1px solid #444;
            pointer-events: auto; backdrop-filter: blur(5px);
        }
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 10px; height: 140px; margin: 10px 0;
        }
        .zoom-info { font-size: 0.7rem; font-weight: 700; text-align: center; }
        .zoom-type-hw { color: #0f0; } 
        .zoom-type-dig { color: #f33; } 

        /* HUD BUTTONS */
        .hud-btn {
            background: rgba(20,20,20,0.7); border: 1px solid rgba(255,255,255,0.3); color: #fff;
            padding: 12px 0; border-radius: 8px; font-weight: bold; font-size: 1.1rem;
            width: 70px; text-align: center;
        }
        .hud-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .btn-rec { background: #d00; border: 2px solid #fff; width: 55px; height: 55px; border-radius: 50%; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px #d00; }
        .rec-active { background: #fff; color: #f00; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {opacity:1} 50% {opacity:0.5} 100% {opacity:1} }

        /* AUDIO METER */
        #audio-meter {
            width: 10px; height: 50px; background: #333; border: 1px solid #555; border-radius: 5px; overflow: hidden; position: relative; display: flex; align-items: flex-end;
        }
        #audio-level { width: 100%; height: 0%; background: #0f0; transition: height 0.1s; }

        /* MODALS */
        .modal { position: fixed; z-index: 100; background: #1a1a1a; padding: 25px; border: 1px solid #333; border-radius: 12px; text-align: center; top:50%; left:50%; transform:translate(-50%, -50%); width: 85%; max-width: 350px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .modal h3 { margin-top: 0; color: #eee; }
        .modal-btn { background: #007bff; color: #fff; border: none; padding: 12px; width: 100%; margin: 8px 0; border-radius: 6px; font-size: 1rem; font-weight: 600; }
        #input-modal input { width: 90%; padding: 12px; font-size: 1.1rem; margin-bottom: 15px; text-align: center; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; }
        
        #raw-video { display: none; }
        .warning-text { color:#ffcc00; font-size: 0.8rem; margin: 10px 0; background: rgba(255,200,0,0.1); padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="system-controls">
        <button class="sys-btn" onclick="toggleFullScreen()">⛶</button>
        <button class="sys-btn" onclick="location.reload()">↻</button>
        <button class="sys-btn" onclick="toggleScoreboardPos()">⬍</button>
    </div>
    <div id="reset-controls">
        <button class="sys-btn btn-danger" onclick="resetGameData()">✕</button>
    </div>

    <div id="startup-modal" class="modal" style="display:block">
        <h3>Pro Court Cam</h3>
        <p style="color:#888; font-size:0.9rem; margin-bottom:10px;">v15 • Audio + Flash</p>
        
        <div class="warning-text">
            ⚠️ <b>Tip:</b> Enable "Do Not Disturb" to prevent call interruptions.
        </div>

        <button class="modal-btn" style="background:#28a745" onclick="initCamera(1280, 720)">720p (HD)</button>
        <button class="modal-btn" onclick="initCamera(1920, 1080)">1080p (Full HD)</button>
    </div>

    <div id="input-modal" class="modal">
        <h3 id="input-title">Edit Name</h3>
        <input type="text" id="team-input" maxlength="10">
        <button class="modal-btn" onclick="saveTeamName()">SAVE</button>
        <button class="modal-btn" style="background:#444" onclick="closeInput()">CANCEL</button>
    </div>

    <div id="stage">
        <canvas id="gameCanvas"></canvas>

        <div id="ui-layer">
            
            <div class="control-group group-top" id="top-bar">
                <button class="hud-btn" style="width:100px; border-color:#28a745; color:#80ff9f; font-family:monospace; font-size:1.4rem;" id="btn-clock" onclick="toggleTimer()">10:00</button>
                <div style="width:10px"></div>
                
                <div id="audio-meter"><div id="audio-level"></div></div>

                <div style="width:10px"></div>
                <button class="hud-btn btn-rec" id="btn-rec" onclick="toggleRecording()">REC</button>
                <div style="width:15px"></div>
                <button class="hud-btn" style="font-size:0.8rem;" onclick="nextPeriod()">PER 1</button>
            </div>

            <div class="control-group group-left">
                <button class="team-name-btn" style="border-left: 4px solid #007bff;" onclick="openInput('home')">HOME ✎</button>
                <button class="hud-btn" style="color:#80bfff;" onclick="updateScore('home', 1)">+1</button>
                <button class="hud-btn" style="color:#80bfff;" onclick="updateScore('home', 2)">+2</button>
                <button class="hud-btn" style="color:#80bfff;" onclick="updateScore('home', 3)">+3</button>
                <button class="hud-btn" style="color:#80bfff; font-size:0.8rem; opacity:0.6;" onclick="updateScore('home', -1)">-1</button>
            </div>

            <div class="control-group group-right">
                <button class="team-name-btn" style="border-left: 4px solid #dc3545;" onclick="openInput('guest')">GUEST ✎</button>
                <button class="hud-btn" style="color:#ff808f;" onclick="updateScore('guest', 1)">+1</button>
                <button class="hud-btn" style="color:#ff808f;" onclick="updateScore('guest', 2)">+2</button>
                <button class="hud-btn" style="color:#ff808f;" onclick="updateScore('guest', 3)">+3</button>
                <button class="hud-btn" style="color:#ff808f; font-size:0.8rem; opacity:0.6;" onclick="updateScore('guest', -1)">-1</button>
            </div>

            <div class="control-group group-zoom">
                <div id="zoom-type" class="zoom-info zoom-type-dig">DIG</div>
                <div id="zoom-label" class="zoom-info" style="font-size:0.9rem; color:white; margin-top:2px;">1.0x</div>
                <input type="range" id="zoom-slider" orient="vertical" min="1" max="3" step="0.1" value="1">
            </div>
        </div>
    </div>

    <video id="raw-video" autoplay muted playsinline></video>

    <script>
        // --- WAKE LOCK ---
        let wakeLock = null;
        async function requestWakeLock() {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
        document.addEventListener("visibilitychange", async () => {
            if (document.visibilityState === 'visible') {
                requestWakeLock();
                if(video.paused) try { await video.play(); } catch(e){}
            }
        });

        // --- DATA PERSISTENCE ---
        const STORAGE_KEY = 'court_cam_v15_data';
        let gameData = { homeName: "HOME", guestName: "GUEST", homeScore: 0, guestScore: 0, timeLeft: 600, period: 1 };
        let scoreboardPos = "BOTTOM"; // Default

        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) { try { gameData = JSON.parse(saved); } catch(e) {} }

        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameData)); }

        function resetGameData() {
            if(confirm("Reset entire game?")) {
                gameData = { homeName: "HOME", guestName: "GUEST", homeScore: 0, guestScore: 0, timeLeft: 600, period: 1 };
                saveData();
                updateClockUI();
            }
        }

        // --- STATE ---
        let isTimerRunning = false, timerInterval = null;
        let track = null; 
        let zoomMode = "DIGITAL"; 
        let currentZoom = 1.0;
        let editingTeam = null;
        
        // Flash Effects
        let homeFlash = 0; // >0 means flashing
        let guestFlash = 0;

        // Audio Context
        let audioContext, analyser, microphone, javascriptNode;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('raw-video');
        const clockBtn = document.getElementById('btn-clock');
        const audioLevelBar = document.getElementById('audio-level');
        const topBar = document.getElementById('top-bar');

        updateClockUI();

        // --- INIT ---
        async function initCamera(w, h) {
            document.getElementById('startup-modal').style.display = 'none';
            toggleFullScreen();
            requestWakeLock();
            
            canvas.width = w; canvas.height = h;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: w }, height: { ideal: h }, zoom: true }, 
                    audio: true 
                });
                
                video.srcObject = stream;
                video.play();
                track = stream.getVideoTracks()[0];
                
                setupAudio(stream); // Init Audio Meter
                setupZoom();
                drawLoop();
            } catch (err) { alert("Cam Error: " + err.message); }
        }

        // --- AUDIO METER SETUP ---
        function setupAudio(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 1024;

            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);

            javascriptNode.onaudioprocess = function() {
                var array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                var values = 0;
                var length = array.length;
                for (var i = 0; i < length; i++) { values += array[i]; }
                var average = values / length;
                
                // Update UI bar
                let pct = Math.min(100, average * 2); // Amplify slightly for visibility
                audioLevelBar.style.height = pct + "%";
                if(pct > 80) audioLevelBar.style.background = "#f00"; // Clip red
                else audioLevelBar.style.background = "#0f0";
            }
        }

        // --- ZOOM ---
        function setupZoom() {
            const caps = track.getCapabilities();
            const slider = document.getElementById('zoom-slider');
            const typeLabel = document.getElementById('zoom-type');

            if (caps.zoom) {
                zoomMode = "HARDWARE";
                typeLabel.innerText = "OPTICAL";
                typeLabel.className = "zoom-info zoom-type-hw"; 
                slider.min = caps.zoom.min;
                slider.max = caps.zoom.max;
                slider.step = caps.zoom.step || 0.1;
            } else {
                zoomMode = "DIGITAL";
                typeLabel.innerText = "DIGITAL";
                typeLabel.className = "zoom-info zoom-type-dig";
                slider.min = 1;
                slider.max = 3;
                slider.step = 0.1;
            }

            slider.oninput = async (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById('zoom-label').innerText = val.toFixed(1) + "x";
                if(zoomMode === "HARDWARE") {
                    try { await track.applyConstraints({ advanced: [{ zoom: val }] }); } catch(e){}
                } else { currentZoom = val; }
            };
        }

        // --- MOVE UI ---
        function toggleScoreboardPos() {
            scoreboardPos = (scoreboardPos === "BOTTOM") ? "TOP" : "BOTTOM";
            
            // Adjust the physical buttons too
            if(scoreboardPos === "TOP") {
                topBar.style.top = "80%"; // Move clock/rec to bottom
            } else {
                topBar.style.top = "20px"; // Move clock/rec to top
            }
        }

        // --- DRAW LOOP ---
        function drawLoop() {
            // Video
            if (zoomMode === "DIGITAL" && currentZoom > 1) {
                const vw = video.videoWidth; const vh = video.videoHeight;
                if(vw) {
                    const sw = vw / currentZoom; const sh = vh / currentZoom;
                    const sx = (vw - sw) / 2; const sy = (vh - sh) / 2;
                    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
                }
            } else { ctx.drawImage(video, 0, 0, canvas.width, canvas.height); }
            
            // --- SCOREBOARD RENDER ---
            const H = canvas.height; const W = canvas.width;
            const sbHeight = H * 0.14; const sbWidth = W * 0.7; 
            const sbX = (W - sbWidth) / 2; 
            
            // Dynamic Y Position
            let sbY;
            if (scoreboardPos === "BOTTOM") {
                sbY = H - sbHeight - (H * 0.04);
            } else {
                sbY = (H * 0.04);
            }

            // Main Bar
            const grad = ctx.createLinearGradient(sbX, sbY, sbX, sbY + sbHeight);
            grad.addColorStop(0, "rgba(20, 20, 20, 0.9)");
            grad.addColorStop(1, "rgba(0, 0, 0, 0.95)");
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.roundRect(sbX, sbY, sbWidth, sbHeight, 10); ctx.fill();
            ctx.strokeStyle = "#c9a050"; ctx.lineWidth = 2; ctx.stroke();

            // Columns
            const colW = sbWidth / 3; const cY = sbY + (sbHeight/2);
            
            // HOME RENDER
            ctx.fillStyle = "#0056b3"; ctx.beginPath(); ctx.roundRect(sbX + 10, sbY + 10, (colW * 0.4), sbHeight - 20, 5); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font = `bold ${H*0.035}px 'Segoe UI', sans-serif`;
            ctx.textAlign = "left"; ctx.textBaseline = "middle"; ctx.fillText(gameData.homeName, sbX + (colW * 0.5), cY);
            
            // Home Score with FLASH
            if (homeFlash > 0) { ctx.fillStyle = "#ffff00"; homeFlash--; } else { ctx.fillStyle = "#fff"; }
            ctx.font = `bold ${H*0.07}px 'Segoe UI', sans-serif`; ctx.textAlign = "center"; 
            ctx.fillText(gameData.homeScore, sbX + 10 + (colW * 0.2), cY + 3);

            // GUEST RENDER
            const gStart = sbX + (colW * 2);
            ctx.fillStyle = "#b30000"; ctx.beginPath(); ctx.roundRect(gStart + (colW * 0.6) - 10, sbY + 10, (colW * 0.4), sbHeight - 20, 5); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font = `bold ${H*0.035}px 'Segoe UI', sans-serif`;
            ctx.textAlign = "right"; ctx.fillText(gameData.guestName, gStart + (colW * 0.5), cY);
            
            // Guest Score with FLASH
            if (guestFlash > 0) { ctx.fillStyle = "#ffff00"; guestFlash--; } else { ctx.fillStyle = "#fff"; }
            ctx.font = `bold ${H*0.07}px 'Segoe UI', sans-serif`; ctx.textAlign = "center"; 
            ctx.fillText(gameData.guestScore, gStart + (colW * 0.6) + (colW*0.2) - 10, cY + 3);

            // CLOCK RENDER
            const cStart = sbX + colW;
            ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.fillRect(cStart, sbY + 15, 2, sbHeight - 30); ctx.fillRect(gStart, sbY + 15, 2, sbHeight - 30);
            let m = Math.floor(gameData.timeLeft / 60); let s = gameData.timeLeft % 60; let timeStr = `${m}:${s<10?'0'+s:s}`;
            ctx.fillStyle = isTimerRunning ? "#0f0" : "#ccc"; ctx.font = `bold ${H*0.065}px 'Courier New', monospace`; ctx.textAlign = "center";
            ctx.fillText(timeStr, cStart + (colW/2), cY - (sbHeight * 0.15));
            ctx.fillStyle = "#aaa"; ctx.font = `bold ${H*0.025}px sans-serif`;
            let suf = gameData.period===1?"ST":gameData.period===2?"ND":gameData.period===3?"RD":"TH";
            ctx.fillText(`${gameData.period}${suf} QTR`, cStart + (colW/2), cY + (sbHeight * 0.25));

            // WATERMARK
            ctx.save(); ctx.fillStyle = "rgba(255,255,255,0.3)"; ctx.font = `bold ${H*0.04}px sans-serif`;
            ctx.textAlign = "right"; ctx.textBaseline = "top"; ctx.fillText("TIU", W - 20, 20); ctx.restore();

            requestAnimationFrame(drawLoop);
        }

        // --- LOGIC ---
        function openInput(team) {
            editingTeam = team;
            document.getElementById('input-modal').style.display = 'block';
            document.getElementById('input-title').innerText = "Rename " + team.toUpperCase();
            document.getElementById('team-input').value = (team === 'home' ? gameData.homeName : gameData.guestName);
            document.getElementById('team-input').focus();
        }
        function saveTeamName() {
            const val = document.getElementById('team-input').value;
            if(val) {
                if(editingTeam === 'home') gameData.homeName = val.toUpperCase();
                else gameData.guestName = val.toUpperCase();
                saveData();
            }
            closeInput();
        }
        function closeInput() { document.getElementById('input-modal').style.display = 'none'; }

        clockBtn.addEventListener('dblclick', () => {
             if(isTimerRunning) toggleTimer();
             let val = prompt("Enter Time (e.g. 8 or 1:30):");
             if (val) {
                if (val.includes(":")) {
                    let p = val.split(":");
                    gameData.timeLeft = (parseInt(p[0])*60) + parseInt(p[1]);
                } else { gameData.timeLeft = parseInt(val) * 60; }
                updateClockUI(); saveData();
             }
        });

        function updateClockUI() {
            let m = Math.floor(gameData.timeLeft/60); let s = gameData.timeLeft%60;
            clockBtn.innerText = `${m}:${s<10?'0'+s:s}`;
        }

        function updateScore(t, n) {
            if(t==='home') { 
                gameData.homeScore+=n; 
                if(gameData.homeScore<0) gameData.homeScore=0; 
                homeFlash = 15; // Trigger Flash frames
            } else { 
                gameData.guestScore+=n; 
                if(gameData.guestScore<0) gameData.guestScore=0;
                guestFlash = 15; // Trigger Flash frames
            }
            saveData();
        }

        function toggleTimer() {
            if(isTimerRunning) {
                clearInterval(timerInterval); isTimerRunning=false;
                clockBtn.style.color="#80ff9f"; clockBtn.style.borderColor="#28a745";
            } else {
                isTimerRunning=true;
                clockBtn.style.color="#fff"; clockBtn.style.borderColor="#f33";
                timerInterval = setInterval(() => {
                    if(gameData.timeLeft>0) { 
                        gameData.timeLeft--; updateClockUI(); 
                        if(gameData.timeLeft % 5 === 0) saveData(); 
                    } else toggleTimer();
                }, 1000);
            }
        }
        function nextPeriod() { gameData.period++; if(gameData.period>4) gameData.period=1; saveData(); }
        
        function toggleFullScreen() {
            if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
            else document.exitFullscreen().catch(e=>{});
        }

        let mediaRecorder, chunks=[], isRecording=false;
        function toggleRecording() {
            const btn = document.getElementById('btn-rec');
            if(!isRecording) {
                const stream = canvas.captureStream(30);
                if(video.srcObject && video.srcObject.getAudioTracks().length > 0) stream.addTrack(video.srcObject.getAudioTracks()[0]);
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
                mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, {type:'video/webm'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display='none'; a.href=url;
                    a.download = `Game_${new Date().getTime()}.webm`;
                    document.body.appendChild(a); a.click();
                    setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);}, 100);
                    chunks=[];
                };
                mediaRecorder.start();
                isRecording=true;
                btn.classList.add('rec-active'); btn.innerText="STOP";
            } else {
                mediaRecorder.stop();
                isRecording=false;
                btn.classList.remove('rec-active'); btn.innerText="REC";
            }
        }
    </script>
</body>
</html>
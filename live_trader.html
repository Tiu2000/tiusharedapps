<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TIU Trader (Realism Engine)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --text: #f1f5f9; --text-dim: #94a3b8;
            --green: #10b981; --red: #ef4444; --blue: #3b82f6; --purple: #c084fc;
            --orange: #f59e0b; --border: #334155; --yellow: #facc15;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; padding: 15px; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        .top-bar { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; z-index: 10; }
        .main-content { flex: 1; min-height: 0; display: grid; grid-template-columns: 2fr 1fr; gap: 15px; position: relative; z-index: 1; }
        .col { display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; position: relative; transition: all 0.3s ease; }
        .panel-head { font-weight: 600; color: var(--text-dim); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .scroll-wrap { overflow-y: auto; flex: 1; min-height: 0; }
        
        /* FULLSCREEN & BUTTONS */
        .panel-fullscreen {
            position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
            z-index: 99999 !important; width: 100vw !important; height: 100vh !important;
            margin: 0 !important; border-radius: 0 !important; padding: 0 !important; background: var(--bg) !important;
        }
        .panel-fullscreen canvas { height: 100vh !important; width: 100vw !important; }
        .expand-btn { background: var(--blue); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        
        #fullscreenExitBtn {
            display: none; position: fixed; top: 20px; right: 20px;
            background: var(--red); color: white; font-weight: bold; font-size: 1.2rem;
            padding: 15px 30px; border: 2px solid white; border-radius: 8px;
            cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            z-index: 1000000; pointer-events: all;
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: var(--text-dim); position: sticky; top: 0; background: var(--panel); padding: 5px; z-index: 10;}
        td { padding: 6px 5px; border-bottom: 1px solid #33415540; font-family: 'Consolas', monospace; }
        
        .btn { border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; color: white; font-weight: 600; font-size: 0.75rem; transition: all 0.1s; }
        .btn-green { background: var(--green); color: #064e3b; }
        .btn-ai { background: var(--purple); color: #1e293b; }
        .btn-reset { background: var(--border); }
        .control-group { display:flex; flex-direction:column; align-items:end; min-width:180px; background:#1e293b; padding:8px; border-radius:6px; border:1px solid var(--border); }
        
        .log-item { font-size: 0.8rem; margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px solid #ffffff10; }
        .log-ml { border-left: 3px solid var(--purple); padding-left: 6px; color: #e9d5ff; background: #581c8720; }
        .log-opt { border-left: 3px solid var(--green); padding-left: 6px; color: #d1fae5; background: #064e3b; }
        .log-err { border-left: 3px solid var(--red); padding-left: 6px; color: #fecaca; background: #450a0a; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .stat-box { background: #0f172a; padding: 5px; border-radius: 4px; text-align: center; }
        .stat-val { font-size: 0.9rem; font-weight: bold; }
        .ai-indicator { height: 4px; background: #334155; border-radius: 2px; overflow: hidden; margin-top: 2px; }
        .ai-bar { height: 100%; transition: width 0.3s; }
        .status-dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:var(--text-dim); margin-right:5px;}
    </style>
</head>
<body>

<button id="fullscreenExitBtn" onclick="closeAllFullscreen()">âœ– EXIT FULLSCREEN (ESC)</button>

<div class="top-bar">
    <div>
        <h1 style="margin:0; font-size:1.3rem; color:var(--blue)">TIU Live Trader <span style="font-size:0.7rem; opacity:0.5; color:var(--text-dim)">v51 Realism</span></h1>
        <div style="font-size:0.8rem; color:var(--text-dim); margin-top:2px;">
            Feed: <span id="feedStatus" style="color:var(--text-dim)"><span class="status-dot"></span>Connecting...</span>
        </div>
    </div>
    
    <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn btn-green" onclick="addFunds()">+ $10k Deposit</button>
        <div class="control-group">
            <div style="font-size:0.7rem; color:var(--text-dim); display:flex; justify-content:space-between; width:100%;">
                <span>AI Confidence:</span>
                <span id="confValueDisplay" style="color:var(--yellow); font-weight:bold;">75%</span>
            </div>
            <input type="range" id="aiConfidenceSlider" min="60" max="95" value="75" step="1" style="width:100%; cursor:pointer; margin: 5px 0;" 
                   oninput="document.getElementById('confValueDisplay').innerText = this.value + '%'">
        </div>
        <button class="btn btn-ai" id="aiBtn" onclick="toggleAI()">Start AI</button>
        <button class="btn btn-reset" onclick="resetGame()">Reset</button>
    </div>
</div>

<div class="main-content">
    <div class="col">
        <div class="panel" id="chartPanel" style="flex: 1; min-height: 250px;">
            <div style="position:absolute; top:10px; right:10px; z-index:100;">
                <button class="expand-btn" onclick="openFullscreen('chartPanel')">â›¶ Full Screen</button>
            </div>
            <div style="position:absolute; top:10px; left:10px; background:#1e293b; padding:2px 8px; border-radius:4px; font-size:0.8rem; color:var(--text-dim); pointer-events:none;">
                Real-Time Chart
            </div>
            <canvas id="mainChart"></canvas>
        </div>
        <div class="panel" style="flex: 1;">
            <div class="panel-head">
                <span>Real-Time Market Data</span>
                <span style="font-size:0.7rem; color:var(--cyan)">Logic: Bid/Ask + Greeks</span>
            </div>
            <div class="scroll-wrap">
                <table id="marketTable">
                    <thead><tr><th>Sym</th> <th>Price (Bid/Ask)</th> <th>Vol</th> <th>AI Signal</th> <th>Action</th></tr></thead>
                    <tbody id="marketBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="panel">
            <div class="panel-head">Account Summary</div>
            <div style="text-align:center; margin-bottom:10px;">
                <div style="font-size:1.8rem; font-weight:bold;" id="cashDisplay">$25,000</div>
                <div style="font-size:0.8rem; color:var(--text-dim)">Buying Power</div>
            </div>
            <div class="stat-grid">
                <div class="stat-box">
                    <div style="font-size:0.7rem; color:var(--text-dim)">Liquidation Val</div>
                    <div class="stat-val" id="netWorthDisplay">$25,000</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:0.7rem; color:var(--text-dim)">Win Rate</div>
                    <div class="stat-val" id="winRateDisplay">0%</div>
                </div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-head">AI Analysis</div>
            <div style="margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                    <span>Trend Strength</span>
                    <span id="trendAcc">--</span>
                </div>
                <div class="ai-indicator"><div class="ai-bar" id="trendBar" style="width:0%; background:var(--purple)"></div></div>
            </div>
            <div>
                <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                    <span>Profit Probability</span>
                    <span id="optAcc">--</span>
                </div>
                <div class="ai-indicator"><div class="ai-bar" id="optBar" style="width:0%; background:var(--cyan)"></div></div>
            </div>
        </div>
        <div class="panel" style="flex: 1;">
            <div class="panel-head">Open Positions</div>
            <div class="scroll-wrap">
                <table id="holdingsTable">
                    <thead><tr><th>Contract</th><th>Value</th><th>P/L</th></tr></thead>
                    <tbody id="holdingsBody"></tbody>
                </table>
            </div>
        </div>
        <div class="panel" id="logPanel" style="flex: 1;">
            <div class="panel-head">
                <span>Execution Log</span>
                <button class="expand-btn" onclick="openFullscreen('logPanel')">â›¶ Expand</button>
            </div>
            <div class="scroll-wrap" id="logs"></div>
        </div>
    </div>
</div>

<script>
    const API_KEY = "d52lhbhr01qggm5sggrgd52lhbhr01qggm5sggs0"; 

    // REALISM CONSTANTS
    const CONFIG = {
        updateSpeed: 1000, 
        spreadPct: 0.0004, // 0.04% Spread (Realistic for liquid stocks)
        slippageMax: 0.02, // Max $0.02 slippage per execution
        contractSize: 100, // 1 Option = 100 Shares (Standard)
        historySize: 60,
        thetaDecay: 0.05,  // Time decay per tick
        takeProfitPct: 0.20 // 20% Profit Target
    };

    class Brain {
        constructor() {
            this.weights = [0.8, -0.5]; // Trend Weight, Volatility Penalty
            this.bias = 0.2;
        }
        sigmoid(x) { return 1 / (1 + Math.exp(-x)); }
        predict(inputs) {
            let sum = this.bias;
            for(let i=0; i<this.weights.length; i++) sum += inputs[i] * this.weights[i];
            return this.sigmoid(sum);
        }
        // Simple reinforcement learning
        train(inputs, success) {
            const pred = this.predict(inputs);
            const err = (success ? 1 : 0) - pred;
            for(let i=0; i<this.weights.length; i++) this.weights[i] += err * inputs[i] * 0.1;
        }
    }

    const STOCK_DEFS = [
        {sym:"NVDA", p:135}, {sym:"TSLA", p:240}, {sym:"AAPL", p:225},
        {sym:"AMZN", p:195}, {sym:"GOOG", p:175}
    ];

    let STOCKS = [];
    let state = { cash: 25000, options: [], aiActive: false, wins: 0, losses: 0, tick: 0 };
    const aiBrain = new Brain();
    let chart = null;
    let socket = null;
    let currentFullscreenPanel = null;

    // --- PRICING ENGINE (Simplified Black-Scholes) ---
    function getOptionPrice(stockPrice, strike, type, volatility, timeRemaining) {
        // Intrinsic Value (Real Value)
        let intrinsic = 0;
        if(type === 'call') intrinsic = Math.max(0, stockPrice - strike);
        if(type === 'put') intrinsic = Math.max(0, strike - stockPrice);
        
        // Extrinsic Value (Time + Volatility Premium)
        // More Volatility = Higher Price. Less Time = Lower Price.
        let extrinsic = (stockPrice * volatility * 0.1) * (timeRemaining / 60);
        
        return (intrinsic + extrinsic) * CONFIG.contractSize;
    }

    // --- REALISTIC EXECUTION ---
    function getExecutionPrice(basePrice, side) {
        const spread = basePrice * CONFIG.spreadPct;
        const slippage = Math.random() * CONFIG.slippageMax;
        
        // If Buying, you pay Ask (Price + Spread + Slippage)
        if(side === 'buy') return basePrice + (spread/2) + slippage;
        // If Selling, you get Bid (Price - Spread - Slippage)
        if(side === 'sell') return basePrice - (spread/2) - slippage;
        return basePrice;
    }

    function init() {
        STOCKS = STOCK_DEFS.map(d => ({ ...d, price: d.p, startPrice: d.p, history: Array(60).fill(d.p), currentVol: 0.01 }));
        buildChart(); updateUI(); setupLiveFeed();
        setInterval(gameLoop, CONFIG.updateSpeed);
        log("System Online. Realism Engine Active.", "log-ml");
    }

    function setupLiveFeed() {
        try {
            socket = new WebSocket(`wss://ws.finnhub.io?token=${API_KEY}`);
            socket.addEventListener('open', () => {
                document.getElementById('feedStatus').innerHTML = '<span class="status-dot status-live"></span>LIVE';
                document.getElementById('feedStatus').style.color = 'var(--green)';
                STOCKS.forEach(s => socket.send(JSON.stringify({'type':'subscribe', 'symbol': s.sym})));
            });
            socket.addEventListener('message', (e) => {
                const m = JSON.parse(e.data);
                if (m.type === 'trade') {
                    m.data.forEach(t => {
                        const s = STOCKS.find(x => x.sym === t.s);
                        if (s) {
                            if(state.tick < 2) s.startPrice = t.p;
                            s.price = t.p;
                        }
                    });
                }
            });
        } catch(e) { log("Connection Failed", "log-err"); }
    }

    function gameLoop() {
        state.tick++;
        STOCKS.forEach(s => {
            s.history.push(s.price);
            if(s.history.length > CONFIG.historySize) s.history.shift();
            // Calculate Volatility (Standard Deviation Proxy)
            if(s.history.length > 5) {
                const changes = s.history.slice(-5).map((p, i, a) => i===0?0 : Math.abs(p - a[i-1]));
                const avgChange = changes.reduce((a,b)=>a+b,0) / changes.length;
                s.currentVol = (avgChange / s.price) * 100; // Normalized Volatility
            }
        });

        updatePositions();
        if(state.aiActive) runAI();
        updateChart();
        updateUI();
    }

    function updatePositions() {
        for (let i = state.options.length - 1; i >= 0; i--) {
            let opt = state.options[i];
            opt.life--;

            const stock = STOCKS.find(s => s.sym === opt.sym);
            
            // Mark-to-Market: What is this option worth RIGHT NOW if we sell at the BID?
            // Note: Option prices decay as Life decreases (Theta)
            const fairValue = getOptionPrice(stock.price, opt.strike, opt.type, stock.currentVol, opt.life);
            
            // Realistic Sell: Bid Price (Fair Value - Spread)
            const bidPrice = fairValue * (1 - CONFIG.spreadPct);
            opt.currentValue = bidPrice;

            const profitPct = (bidPrice - opt.cost) / opt.cost;
            const expired = opt.life <= 0;
            
            // AI Logic: Take Profit or Stop Loss or Expire
            if (profitPct >= CONFIG.takeProfitPct || expired) {
                const pnl = bidPrice - opt.cost;
                state.cash += bidPrice;
                if(pnl > 0) state.wins++; else state.losses++;
                
                // Train AI: Did this trade work?
                aiBrain.train(opt.aiInputs, pnl > 0);

                const icon = pnl > 0 ? "âœ…" : "âŒ";
                const reason = expired ? "Expired" : "Target Hit";
                log(`${icon} Sold ${opt.sym} (${reason}). P/L: $${pnl.toFixed(2)}`, pnl > 0 ? "log-opt" : "log-err");
                
                state.options.splice(i, 1);
            }
        }
    }

    function runAI() {
        const confReq = document.getElementById('aiConfidenceSlider').value / 100;

        STOCKS.forEach(s => {
            // Inputs: Trend (SMA Divergence) & Volatility
            const smaShort = s.history.slice(-5).reduce((a,b)=>a+b,0)/5;
            const smaLong = s.history.slice(-20).reduce((a,b)=>a+b,0)/20;
            const trend = (smaShort - smaLong) / s.price; // Positive = Up
            
            const inputs = [trend * 100, s.currentVol];
            const score = aiBrain.predict(inputs); // 0.0 to 1.0

            const isBullish = score > confReq;
            const isBearish = score < (1 - confReq);

            let action = "-";
            
            if (state.cash > 2000) { // Need cash for margin/premium
                const hasPos = state.options.some(o => o.sym === s.sym);
                
                if (!hasPos) {
                    if (isBullish) { buyOption(s, 'call', inputs); action = "Buy CALL"; }
                    else if (isBearish) { buyOption(s, 'put', inputs); action = "Buy PUT"; }
                }
            }
            s.aiData = { score, action };
        });
    }

    function buyOption(stock, type, inputs) {
        // Pricing: Contracts are expensive now!
        // At-The-Money (ATM) options have highest extrinsic value
        const strike = stock.price; 
        
        // Calculate Ask Price (Fair Value + Spread + Slippage)
        const fairPrice = getOptionPrice(stock.price, strike, type, stock.currentVol, CONFIG.optionDuration);
        const askPrice = getExecutionPrice(fairPrice, 'buy');

        if(state.cash < askPrice) return; // Can't afford

        state.cash -= askPrice;
        
        state.options.push({
            sym: stock.sym, type, strike, 
            cost: askPrice, currentValue: askPrice,
            life: CONFIG.optionDuration, aiInputs: inputs
        });
        
        log(`ðŸ›’ Bought ${stock.sym} ${type.toUpperCase()} @ $${askPrice.toFixed(2)}`, "log-ml");
    }

    // UI & UTILS
    function updateUI() {
        document.getElementById('cashDisplay').innerText = `$${state.cash.toFixed(2)}`;
        
        // Liquidation Value = Cash + Value of all Open Options
        let liqVal = state.cash;
        state.options.forEach(o => liqVal += o.currentValue);
        
        document.getElementById('netWorthDisplay').innerText = `$${liqVal.toFixed(2)}`;
        
        const total = state.wins + state.losses;
        const rate = total === 0 ? 0 : Math.round((state.wins/total)*100);
        document.getElementById('winRateDisplay').innerText = `${rate}%`;
        
        document.getElementById('aiBtn').innerText = state.aiActive ? "Stop AI" : "Start AI";
        document.getElementById('aiBtn').style.background = state.aiActive ? "#ef4444" : "#c084fc";

        const tbody = document.getElementById('marketBody');
        tbody.innerHTML = '';
        STOCKS.forEach(s => {
            const row = document.createElement('tr');
            // Realistic Quote Display
            const spread = s.price * CONFIG.spreadPct;
            const bid = s.price - (spread/2);
            const ask = s.price + (spread/2);
            
            const ai = s.aiData || { score: 0.5, action: "-" };
            const conf = Math.abs(ai.score - 0.5) * 200; // Visualization scale

            row.innerHTML = `
                <td style="font-weight:bold">${s.sym}</td>
                <td style="font-size:0.8rem">${bid.toFixed(2)} / ${ask.toFixed(2)}</td>
                <td>${s.currentVol.toFixed(2)}</td>
                <td style="color:${ai.score>0.5?'var(--green)':'var(--red)'}">${(ai.score*100).toFixed(0)}%</td>
                <td style="font-size:0.8rem">${ai.action}</td>
            `;
            tbody.appendChild(row);
        });

        const hBody = document.getElementById('holdingsBody');
        hBody.innerHTML = '';
        state.options.forEach(o => {
            const pnl = o.currentValue - o.cost;
            const pnlPct = (pnl / o.cost) * 100;
            const color = pnl >= 0 ? 'var(--green)' : 'var(--red)';
            hBody.innerHTML += `
                <tr>
                    <td>${o.sym} ${o.type}</td>
                    <td>$${o.currentValue.toFixed(0)}</td>
                    <td style="color:${color}">$${pnl.toFixed(0)} (${pnlPct.toFixed(1)}%)</td>
                </tr>`;
        });
    }

    // Fullscreen Helpers
    function openFullscreen(panelId) {
        if(currentFullscreenPanel) closeAllFullscreen();
        document.getElementById(panelId).classList.add('panel-fullscreen');
        document.getElementById('fullscreenExitBtn').style.display = 'block';
        currentFullscreenPanel = panelId;
    }
    function closeAllFullscreen() {
        if(currentFullscreenPanel) document.getElementById(currentFullscreenPanel).classList.remove('panel-fullscreen');
        document.getElementById('fullscreenExitBtn').style.display = 'none';
        currentFullscreenPanel = null;
    }

    function buildChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: Array(60).fill(''), datasets: STOCKS.map((s,i) => ({ label: s.sym, data: s.history, borderColor: ['#3b82f6','#10b981','#ef4444','#f59e0b','#c084fc'][i], borderWidth: 2, pointRadius: 0, tension: 0.4 })) },
            options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#33415550' } } } }
        });
    }

    function updateChart() {
        if(!chart) return;
        let allValues = [];
        STOCKS.forEach((s, i) => { chart.data.datasets[i].data = s.history; allValues.push(...s.history); });
        allValues.sort((a,b) => a-b);
        // Smart Zoom
        const min = allValues[Math.floor(allValues.length*0.05)] || 0;
        const max = allValues[Math.floor(allValues.length*0.95)] || 0;
        const pad = (max - min) * 0.2;
        if(max > min) { chart.options.scales.y.min = min - pad; chart.options.scales.y.max = max + pad; }
        chart.update('none');
    }

    function log(msg, cls) {
        const l = document.getElementById('logs');
        const div = document.createElement('div');
        div.className = `log-item ${cls}`;
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        l.prepend(div);
    }
    function toggleAI() { state.aiActive = !state.aiActive; updateUI(); }
    function resetGame() { if(confirm("Reset Account?")) location.reload(); }

    init();
</script>
</body>
</html>
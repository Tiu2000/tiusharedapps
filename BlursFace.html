<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU Privacy Recorder Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 0;
        }

        h2 { margin: 10px 0; font-size: 1.5rem; text-align: center; }

        /* Settings Bar */
        .settings-bar {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
        }

        label { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }

        select {
            padding: 8px;
            border-radius: 4px;
            border: none;
            background: #555;
            color: white;
            font-size: 1rem;
        }

        /* Video Area */
        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9; /* Default aspect, adjusts via JS */
            background: #000;
            border: 2px solid #444;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        video { display: none; }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            min-width: 120px;
        }

        .btn-start { background-color: #0d6efd; color: white; }
        .btn-record { background-color: #dc3545; color: white; }
        .btn-stop { background-color: #6c757d; color: white; }
        
        button:disabled { 
            background-color: #444; 
            color: #888; 
            cursor: not-allowed; 
        }

        .status { margin-top: 15px; font-family: monospace; color: #0f0; }
        .warning { font-size: 0.8rem; color: #aaa; margin-top: 5px; text-align: center; }
    </style>
</head>
<body>

    <h2>TIU Privacy Recorder</h2>

    <div class="settings-bar">
        <div class="setting-group">
            <label for="camSelect">Camera Source</label>
            <select id="camSelect">
                <option value="environment" selected>Back Camera (Room)</option>
                <option value="user">Front Camera (Selfie)</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="resSelect">Resolution Quality</label>
            <select id="resSelect">
                <option value="480">480p (Fastest / Smooth)</option>
                <option value="720" selected>720p (HD / Balanced)</option>
                <option value="1080">1080p (Full HD / Sharp)</option>
            </select>
        </div>
    </div>

    <div class="video-wrapper" id="videoWrapper">
        <video id="video" playsinline muted></video>
        <canvas id="output"></canvas>
    </div>

    <div class="status" id="status">Loading AI Models...</div>

    <div class="controls">
        <button id="btnStartCam" class="btn-start" disabled>Start Camera</button>
        <button id="btnRecord" class="btn-record" disabled>Record</button>
        <button id="btnStop" class="btn-stop" disabled>Stop</button>
    </div>
    
    <div class="warning">
        Note: 1080p requires a newer phone. Use 480p if video lags.
    </div>

    <script>
        let model = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const videoWrapper = document.getElementById('videoWrapper');

        // Buttons & Inputs
        const btnStart = document.getElementById('btnStartCam');
        const btnRecord = document.getElementById('btnRecord');
        const btnStop = document.getElementById('btnStop');
        const camSelect = document.getElementById('camSelect');
        const resSelect = document.getElementById('resSelect');

        let mediaRecorder;
        let chunks = [];
        let isRecording = false;

        // Stability / Anti-Flicker Variables
        let lastFaces = [];
        let lastDetectionTime = 0;
        const FACE_PERSISTENCE_MS = 500; 

        // 1. Initialize AI
        async function loadModel() {
            try {
                model = await blazeface.load();
                status.innerText = "System Ready. Select settings above.";
                btnStart.disabled = false;
            } catch (e) {
                status.innerText = "Error: Could not load AI model.";
                console.error(e);
            }
        }
        loadModel();

        // 2. Start Camera with Selected Options
        btnStart.onclick = async () => {
            status.innerText = "Requesting Camera...";
            
            // Get User Choices
            const facingMode = camSelect.value; 
            const quality = resSelect.value;
            
            // Map quality to dimensions
            let targetWidth, targetHeight;
            if (quality === '1080') { targetWidth = 1920; targetHeight = 1080; }
            else if (quality === '720') { targetWidth = 1280; targetHeight = 720; }
            else { targetWidth = 640; targetHeight = 480; }

            const constraints = {
                video: {
                    facingMode: facingMode, // 'environment' or 'user'
                    width: { ideal: targetWidth },
                    height: { ideal: targetHeight }
                },
                audio: false
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Wait for video to actually play to get real dimensions
                video.onloadedmetadata = async () => {
                    await video.play();
                    
                    // Set canvas to match the ACTUAL camera dimensions (handles portrait/landscape)
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Adjust container aspect ratio
                    videoWrapper.style.aspectRatio = `${canvas.width}/${canvas.height}`;

                    status.innerText = `Active: ${canvas.width}x${canvas.height}px`;
                    
                    // Lock settings while running
                    camSelect.disabled = true;
                    resSelect.disabled = true;
                    btnStart.disabled = true;
                    btnRecord.disabled = false;

                    // Start Loops
                    detectFacesLoop();
                    drawLoop();
                };
            } catch (err) {
                console.error(err);
                alert(`Camera Error: ${err.name}. Ensure you are on HTTPS or localhost.`);
                status.innerText = "Camera Access Failed.";
            }
        };

        // 3. AI Detection Loop (Asynchronous)
        async function detectFacesLoop() {
            if (video.readyState === 4 && !video.paused && !video.ended) {
                // We don't return tensors to save memory
                const predictions = await model.estimateFaces(video, false);

                if (predictions.length > 0) {
                    lastFaces = predictions;
                    lastDetectionTime = Date.now();
                } else {
                    // Persistence logic
                    if (Date.now() - lastDetectionTime > FACE_PERSISTENCE_MS) {
                        lastFaces = [];
                    }
                }
            }
            requestAnimationFrame(detectFacesLoop);
        }

        // 4. Drawing Loop (Synchronous 60fps)
        function drawLoop() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Draw Blur Regions
            if (lastFaces.length > 0) {
                lastFaces.forEach(face => {
                    const start = face.topLeft;
                    const end = face.bottomRight;
                    const width = end[0] - start[0];
                    const height = end[1] - start[1];

                    const centerX = start[0] + width / 2;
                    const centerY = start[1] + height / 2;

                    ctx.save();
                    ctx.beginPath();
                    // Expand blur area slightly (1.2x) for safety
                    ctx.ellipse(centerX, centerY, width * 0.6, height * 0.6, 0, 0, 2 * Math.PI);
                    ctx.clip();
                    ctx.filter = 'blur(25px)';
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    ctx.restore();
                });
            }

            // Draw Watermark
            // Scale font size based on resolution so it doesn't look tiny on 1080p
            const fontSize = Math.max(20, Math.floor(canvas.width / 25));
            ctx.font = `900 ${fontSize}px Arial`;
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            ctx.textAlign = "right";
            ctx.fillText("TIU", canvas.width - (fontSize/2), canvas.height - (fontSize/2));

            requestAnimationFrame(drawLoop);
        }

        // 5. Recording Logic
        btnRecord.onclick = () => {
            const stream = canvas.captureStream(30);
            
            // Try different codecs for better mobile compatibility
            let options = { mimeType: 'video/webm' };
            if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
                options = { mimeType: 'video/webm;codecs=vp9' };
            } else if (MediaRecorder.isTypeSupported('video/mp4')) {
                options = { mimeType: 'video/mp4' }; // Safari 14.1+
            }

            mediaRecorder = new MediaRecorder(stream, options);

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: chunks[0].type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // File extension depends on type
                const ext = chunks[0].type.includes('mp4') ? 'mp4' : 'webm';
                a.download = `TIU-Classroom-REC-${Date.now()}.${ext}`;
                
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                chunks = [];
                status.innerText = "Video Saved to Photos/Downloads.";
                
                btnRecord.disabled = false;
                btnStop.disabled = true;
                btnRecord.innerText = "Record";
                btnRecord.classList.remove('pulsing');
            };

            mediaRecorder.start();
            isRecording = true;
            status.innerText = "recording active...";
            btnRecord.disabled = true;
            btnStop.disabled = false;
            btnRecord.innerText = "REC";
        };

        btnStop.onclick = () => {
            if (isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
        };

    </script>
</body>
</html>
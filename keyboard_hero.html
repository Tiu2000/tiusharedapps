<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyboard Hero - YouTube Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --neon-blue: #00ffff;
            --neon-pink: #ff66ff;
            --neon-green: #39ff14;
            --neon-red: #ff3333;
            --neon-yellow: #ffff00;
            --bg-color: #1e1e2e;      
            --panel-bg: #2b2b3b;      
            --highway-gradient: linear-gradient(180deg, rgba(10,10,26,0.9) 0%, rgba(58,74,90,0.9) 100%);
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: 'Verdana', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        /* --- YOUTUBE BACKGROUND --- */
        #video-background {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            opacity: 0.3; /* Faded out so game is visible */
            pointer-events: none;
            filter: blur(4px); /* Slight blur for style */
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .hud-panel {
            background: var(--panel-bg);
            padding: 20px;
            border: 2px solid #555;
            border-radius: 12px;
            min-width: 240px;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #score-display { font-size: 36px; font-weight: bold; color: white; text-shadow: 2px 2px 0 #000; }
        
        /* Leaderboard Styles */
        #leaderboard { text-align: right; border-color: var(--neon-blue); max-height: 300px; overflow-y: auto; }
        .lb-entry {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; font-size: 15px;
            border-bottom: 1px solid #444; padding-bottom: 4px;
        }
        .lb-name-group { display: flex; align-items: center; gap: 8px; }
        .kick-btn {
            background: var(--neon-red); color: white; border: none;
            border-radius: 4px; cursor: pointer; font-size: 11px;
            padding: 4px 8px; font-weight: bold;
        }

        /* --- THE HIGHWAY --- */
        #game-container {
            position: relative; 
            width: 500px;
            height: 120vh;
            background: var(--highway-gradient);
            transform: perspective(800px) rotateX(30deg); 
            transform-origin: bottom center;
            border-left: 4px solid #666; border-right: 4px solid #666;
            box-shadow: 0 0 80px rgba(0, 243, 255, 0.15);
            top: -50px; 
            z-index: 5;
        }

        .lane {
            position: absolute; top: 0; height: 100%; width: 25%;
            border-right: 2px solid rgba(255, 255, 255, 0.15);
            box-sizing: border-box;
        }
        .lane:last-child { border-right: none; }

        .hit-zone {
            position: absolute; bottom: 100px;
            width: 100%; display: flex;
            padding: 0 10px; box-sizing: border-box;
        }

        .button-target {
            width: 25%; height: 25px;
            background: rgba(255,255,255,0.2);
            border: 3px solid white; border-radius: 50%;
            margin: 0 5px;
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }
        .button-target.pressed { background: white; transform: scale(0.9); box-shadow: 0 0 25px white; }

        /* Notes */
        .note {
            position: absolute; width: 20%; height: 20px;
            border-radius: 6px; left: 2.5%; 
            box-shadow: 0 0 15px currentColor;
            border: 1px solid white;
        }
        .note.lane-0 { background-color: var(--neon-green); color: var(--neon-green); left: 2.5%; }
        .note.lane-1 { background-color: var(--neon-red); color: var(--neon-red); left: 27.5%; }
        .note.lane-2 { background-color: var(--neon-blue); color: var(--neon-blue); left: 52.5%; }
        .note.lane-3 { background-color: var(--neon-pink); color: var(--neon-pink); left: 77.5%; }

        /* --- MENUS --- */
        #menu-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 20, 30, 0.95);
            z-index: 20;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .menu-box {
            width: 420px; padding: 30px;
            border: 2px solid #555; text-align: center;
            background: #2b2b3b;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        input {
            background: #1a1a25; border: 2px solid #666; color: white;
            padding: 15px; margin-bottom: 15px; width: 100%;
            text-align: center; box-sizing: border-box;
            font-family: inherit; font-size: 16px; font-weight: bold;
            border-radius: 8px;
        }
        input:focus { border-color: var(--neon-blue); outline: none; }

        button {
            background: #3a3a4a; color: white;
            border: 2px solid var(--neon-blue);
            padding: 15px; width: 100%;
            font-size: 18px; cursor: pointer; font-weight: bold;
            text-transform: uppercase; font-family: inherit;
            margin-bottom: 10px; transition: 0.2s; border-radius: 8px;
        }
        button:hover { background: var(--neon-blue); color: #000; }
        
        button.start-btn { border-color: var(--neon-green); background: #2a3a2a; }
        button.start-btn:hover { background: var(--neon-green); }

        button.end-btn { border-color: var(--neon-red); background: #3a2a2a; }
        button.end-btn:hover { background: var(--neon-red); }

        #tiu-watermark {
            position: fixed; bottom: 20px; right: 20px;
            font-size: 48px; font-weight: 900;
            color: rgba(255, 255, 255, 0.1); 
            pointer-events: none; z-index: 100;
        }

        #feedback {
            position: absolute; top: 35%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 56px; font-weight: 900;
            opacity: 0; transition: opacity 0.1s;
            z-index: 15; text-shadow: 0 4px 10px rgba(0,0,0,0.8);
            -webkit-text-stroke: 2px black;
        }
        
        .error-msg { color: var(--neon-red); font-weight: bold; font-size: 14px; margin-bottom: 10px; display: none; }
        .hidden { display: none !important; }
        .room-highlight { font-size: 24px; color: var(--neon-yellow); margin: 10px 0; font-weight: bold; }
    </style>
</head>
<body>

    <div id="video-background">
        <div id="yt-player"></div>
    </div>
    <div id="tiu-watermark">TIU</div>

    <div id="ui-layer">
        <div class="hud-panel">
            <div style="color: #bbb; font-size: 14px; font-weight: bold; margin-bottom: 5px;">SCORE</div>
            <div id="score-display">0</div>
            <div id="combo-display" style="margin-top: 5px;">Combo: 0</div>
            <div id="room-info" style="margin-top:15px; font-size:12px; color:#aaa; font-family: monospace;"></div>
        </div>
        
        <div id="feedback">PERFECT</div>

        <div class="hud-panel" id="leaderboard">
            <div style="border-bottom: 2px solid white; margin-bottom: 10px; font-weight: bold; color: var(--neon-blue);">LEADERBOARD</div>
            <div id="lb-content">
                <div class="lb-entry">Waiting...</div>
            </div>
        </div>
    </div>

    <div id="game-container">
        <div class="lane" style="left: 0%"></div>
        <div class="lane" style="left: 25%"></div>
        <div class="lane" style="left: 50%"></div>
        <div class="lane" style="left: 75%"></div>
        <div class="hit-zone">
            <div class="button-target" id="btn-0"></div>
            <div class="button-target" id="btn-1"></div>
            <div class="button-target" id="btn-2"></div>
            <div class="button-target" id="btn-3"></div>
        </div>
    </div>

    <div id="menu-overlay">
        <h1 style="text-shadow: 0 0 20px var(--neon-pink); font-size: 48px; margin-bottom: 10px;">KEYBOARD HERO</h1>
        
        <div class="menu-box" id="menu-login">
            <input type="text" id="inp-name" placeholder="YOUR NAME" maxlength="8">
            <input type="text" id="inp-room" placeholder="ROOM NAME (e.g. TIU1)">
            <div id="error-msg" class="error-msg"></div>
            <button onclick="attemptHost()">HOST ROOM</button>
            <button onclick="attemptJoin()">JOIN ROOM</button>
        </div>

        <div class="menu-box hidden" id="menu-host">
            <h3 style="color:var(--neon-green); margin-top:0;">HOSTING ROOM</h3>
            <div id="host-room-display" class="room-highlight">...</div>
            
            <label style="color:#aaa; font-size:12px; display:block; margin-top:15px;">PASTE YOUTUBE URL</label>
            <input type="text" id="inp-yt-url" placeholder="https://youtube.com/watch?v=..." onchange="loadVideoByUrl()">
            <div id="video-status" style="font-size:12px; color:var(--neon-blue); margin-bottom:10px;">No video loaded</div>

            <p id="player-count" style="font-size:16px; color:white; font-weight:bold;">1 Player(s) Ready</p>
            <button class="start-btn" onclick="hostStartGame()">START GAME</button>
        </div>

        <div class="menu-box hidden" id="menu-client">
            <h3 style="color: var(--neon-blue)">CONNECTED</h3>
            <p>Waiting for host to select song...</p>
            <div id="client-status" style="color:var(--neon-yellow); font-size:14px; font-weight:bold;">Synced</div>
        </div>

        <div class="menu-box hidden" id="menu-gameover">
            <h2 style="color: white; border-bottom: 1px solid #555;">SONG FINISHED</h2>
            <div style="font-size: 14px; color: #aaa;">WINNER</div>
            <div id="winner-name" style="font-size:40px; color:var(--neon-green);">NAME</div>
            <div id="winner-score" style="font-size:50px; font-weight:bold; color:white;">0</div>
            
            <div id="host-controls" class="hidden">
                <button class="start-btn" onclick="hostRestartGame()">PLAY AGAIN</button>
                <button class="end-btn" onclick="hostEndSession()">END SESSION</button>
            </div>
            <div id="client-wait-msg" class="hidden"><p>Waiting for host...</p></div>
        </div>
    </div>

    <script>
        // --- YOUTUBE API SETUP ---
        let ytPlayer;
        let videoDuration = 0;
        let currentVideoId = "dQw4w9WgXcQ"; // Default fallback
        
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('yt-player', {
                height: '100%',
                width: '100%',
                videoId: '', // Start empty
                playerVars: { 
                    'autoplay': 0, 
                    'controls': 0, 
                    'showinfo': 0, 
                    'mute': 1 // Mute initially to allow autoplay policy
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            // Player loaded
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                // Video finished logic is handled by game loop timer
            }
        }

        function loadVideoByUrl() {
            const url = document.getElementById('inp-yt-url').value;
            // Extract ID
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) {
                currentVideoId = match[2];
                document.getElementById('video-status').innerText = "Video Loaded! Ready to start.";
                // Host loads it locally to check duration
                ytPlayer.loadVideoById(currentVideoId);
                ytPlayer.pauseVideo();
            } else {
                document.getElementById('video-status').innerText = "Invalid URL";
            }
        }

        // --- GAME ENGINE ---
        const SPAWN_AHEAD_MS = 3000; 
        
        let gameRunning = false;
        let localStartTime = 0;
        let songData = [];
        let score = 0;
        let combo = 0;
        
        // --- NETWORKING ---
        let peer = null;
        let myId = null;
        let myName = "Guest";
        let isHost = false;
        let connections = {}; 
        let players = {};     
        let hostConn = null;

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playHitSound() {
            // Simple click sound, since music is from YouTube
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = 800;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function generateSong(durationSeconds) {
            let notes = [];
            // Generate notes based on duration
            // Approx 2 notes per second for difficulty
            const totalNotes = Math.floor(durationSeconds * 2.5); 
            
            for(let i=0; i<totalNotes; i++) {
                const lane = Math.floor(Math.random() * 4);
                // Spread notes out over the duration
                const time = 3000 + (i * (durationSeconds * 1000 / totalNotes)); 
                notes.push({ lane, time, hit: false, element: null });
            }
            return notes;
        }

        function initializeGameEngine(vidId, duration) {
            document.getElementById('menu-overlay').style.display = 'none';
            document.getElementById('menu-gameover').classList.add('hidden');
            
            // Sync Video
            videoDuration = duration;
            ytPlayer.loadVideoById(vidId);
            ytPlayer.unMute();
            ytPlayer.playVideo();

            songData = generateSong(duration);
            score = 0;
            combo = 0;
            updateUI();
            
            document.querySelectorAll('.note').forEach(n => n.remove());

            localStartTime = performance.now();
            gameRunning = true;
            
            requestAnimationFrame(gameLoop);
        }

        function gameLoop(timestamp) {
            if (!gameRunning) return;
            
            // We use the YouTube player time for sync if available, fallback to performance.now
            let currentTimeMs = 0;
            if (ytPlayer && ytPlayer.getCurrentTime) {
                currentTimeMs = ytPlayer.getCurrentTime() * 1000;
            } else {
                currentTimeMs = timestamp - localStartTime; 
            }

            // End Condition
            if (currentTimeMs / 1000 >= videoDuration && videoDuration > 0) {
                gameRunning = false;
                setTimeout(() => {
                     broadcastScore();
                     if (isHost) hostTriggerGameOver();
                }, 2000); // Wait a bit after song ends
                return;
            }

            // Game Logic using currentTimeMs (Video Time) + SPAWN_AHEAD_MS (Latency buffer)
            // We shift the "Song Data" logic. 
            // Note Time 5000ms means it should be hit when video is at 5000ms.
            // It should SPAWN when video is at 2000ms (if Spawn Ahead is 3000).

            songData.forEach(note => {
                if (note.hit) return;

                const timeDiff = note.time - currentTimeMs; 

                // Missed
                if (timeDiff < -300) {
                    note.hit = true; 
                    if(note.element) note.element.remove();
                    breakCombo();
                    return;
                }

                // Spawn
                if (!note.element && timeDiff <= SPAWN_AHEAD_MS && timeDiff > -200) {
                    const el = document.createElement('div');
                    el.className = `note lane-${note.lane}`;
                    document.getElementById('game-container').appendChild(el);
                    note.element = el;
                }

                // Move
                if (note.element) {
                    const percent = 90 - (timeDiff / (SPAWN_AHEAD_MS / 90));
                    note.element.style.top = `${percent}%`;
                }
            });

            requestAnimationFrame(gameLoop);
        }

        // --- HOST LOGIC ---
        function hostStartGame() {
            if(gameRunning) return;
            // Get duration from loaded player
            const duration = ytPlayer.getDuration();
            
            // Broadcast
            Object.values(connections).forEach(c => c.send({ 
                type: 'START_GAME', 
                vidId: currentVideoId,
                duration: duration 
            }));
            
            initializeGameEngine(currentVideoId, duration);
        }

        // --- SHARED NETWORK LOGIC (Abbreviated for length, same structure as before) ---
        function attemptHost() {
            const data = getInputs(); if(!data) return;
            myName = data.name;
            peer = new Peer(data.room);
            peer.on('open', (id) => {
                isHost = true; myId = id;
                players[myId] = { name: myName, score: 0, isHost: true };
                document.getElementById('menu-login').classList.add('hidden');
                document.getElementById('menu-host').classList.remove('hidden');
                document.getElementById('host-room-display').innerText = data.room;
                renderLeaderboard();
            });
            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    connections[conn.peer] = conn;
                    conn.send({ type: 'REGISTER_ACK', players: players }); 
                });
                conn.on('data', (d) => {
                    if(d.type === 'REGISTER') { 
                        players[conn.peer] = { name: d.name, score: 0 }; 
                        syncLeaderboard(); 
                        document.getElementById('player-count').innerText = Object.keys(players).length + " Player(s)";
                    }
                    if(d.type === 'SCORE') { players[conn.peer].score = d.score; syncLeaderboard(); }
                });
                conn.on('close', () => { delete players[conn.peer]; delete connections[conn.peer]; syncLeaderboard(); });
            });
        }

        function attemptJoin() {
            const data = getInputs(); if(!data) return;
            myName = data.name;
            peer = new Peer();
            peer.on('open', (id) => {
                myId = id;
                hostConn = peer.connect(data.room);
                hostConn.on('open', () => {
                    document.getElementById('menu-login').classList.add('hidden');
                    document.getElementById('menu-client').classList.remove('hidden');
                    hostConn.send({ type: 'REGISTER', name: myName });
                });
                hostConn.on('data', (d) => {
                    if(d.type === 'START_GAME') { initializeGameEngine(d.vidId, d.duration); }
                    if(d.type === 'SYNC_PLAYERS') { players = d.data; renderLeaderboard(); }
                    if(d.type === 'GAME_OVER') { showGameOver(d.results); }
                    if(d.type === 'RESTART') { document.getElementById('menu-gameover').classList.add('hidden'); document.getElementById('menu-client').classList.remove('hidden'); }
                    if(d.type === 'SESSION_END') { location.reload(); }
                });
            });
        }

        // --- UTILS ---
        function getInputs() {
            const name = document.getElementById('inp-name').value || "Guest";
            const room = document.getElementById('inp-room').value.replace(/[^a-zA-Z0-9]/g,'');
            if(room.length < 3) { document.getElementById('error-msg').innerText="Invalid Room"; return null; }
            return { name, room };
        }

        function broadcastScore() {
            if(isHost) { players[myId].score = score; syncLeaderboard(); }
            else if(hostConn) hostConn.send({ type: 'SCORE', score: score });
        }
        function syncLeaderboard() {
            if(!isHost) return;
            renderLeaderboard();
            Object.values(connections).forEach(c => c.send({ type: 'SYNC_PLAYERS', data: players }));
        }
        function renderLeaderboard() {
            const el = document.getElementById('lb-content'); el.innerHTML = '';
            Object.entries(players).sort((a,b)=>b[1].score-a[1].score).forEach(([id,p]) => {
                const div = document.createElement('div'); div.className='lb-entry';
                div.innerHTML = `<span style="color:${id===myId?'var(--neon-green)':'white'}">${p.name}</span><span>${p.score}</span>`;
                el.appendChild(div);
            });
        }
        function hostTriggerGameOver() {
            let max = -1, winner = "None";
            if(players[myId]) players[myId].score = score;
            Object.values(players).forEach(p => { if(p.score > max) { max = p.score; winner = p.name; }});
            const res = { name: winner, score: max };
            showGameOver(res);
            Object.values(connections).forEach(c => c.send({ type: 'GAME_OVER', results: res }));
        }
        function showGameOver(res) {
            document.getElementById('menu-overlay').style.display='flex';
            document.getElementById('menu-gameover').classList.remove('hidden');
            document.getElementById('winner-name').innerText = res.name;
            document.getElementById('winner-score').innerText = res.score;
            if(isHost) document.getElementById('host-controls').classList.remove('hidden');
        }
        function hostRestartGame() {
            // Reset logic
            document.getElementById('menu-gameover').classList.add('hidden');
            document.getElementById('menu-host').classList.remove('hidden');
            Object.values(connections).forEach(c => c.send({ type: 'RESTART' }));
        }
        function hostEndSession() { Object.values(connections).forEach(c => c.send({ type: 'SESSION_END' })); location.reload(); }

        // INPUTS
        const keys = { 'a':0, 's':1, 'd':2, 'f':3 };
        document.addEventListener('keydown', e => {
            if(!gameRunning || !keys.hasOwnProperty(e.key.toLowerCase())) return;
            const lane = keys[e.key.toLowerCase()];
            document.getElementById(`btn-${lane}`).classList.add('pressed');
            // Check Hit
            let hit = false;
            let vidTime = ytPlayer.getCurrentTime() * 1000;
            songData.forEach(n => {
                if(!n.hit && n.lane === lane && Math.abs(n.time - vidTime) < 150) {
                    n.hit = true; if(n.element) n.element.remove();
                    score += 100 + (combo*10); combo++;
                    playHitSound(); showFeedback("HIT"); updateUI(); broadcastScore(); hit = true;
                }
            });
            if(!hit && combo>0) { combo=0; showFeedback("MISS"); updateUI(); }
        });
        document.addEventListener('keyup', e => {
            if(keys.hasOwnProperty(e.key.toLowerCase())) document.getElementById(`btn-${keys[e.key.toLowerCase()]}`).classList.remove('pressed');
        });
        function showFeedback(t) { 
            const f=document.getElementById('feedback'); f.innerText=t; f.style.opacity=1; 
            setTimeout(()=>f.style.opacity=0, 300); 
        }
        function breakCombo() { if(combo>0) { combo=0; showFeedback("MISS"); updateUI(); } }
        function updateUI() { document.getElementById('score-display').innerText = score; document.getElementById('combo-display').innerText = "Combo: " + combo; }

    </script>
</body>
</html>
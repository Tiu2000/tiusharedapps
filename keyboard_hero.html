<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyboard Hero - Precision Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --neon-blue: #00ffff;
            --neon-pink: #ff66ff;
            --neon-green: #39ff14;
            --neon-red: #ff3333;
            --neon-yellow: #ffff00;
            --bg-color: #1e1e2e;      
            --panel-bg: #2b2b3b;      
            --highway-gradient: linear-gradient(180deg, rgba(10,10,26,0.9) 0%, rgba(58,74,90,0.9) 100%);
        }

        body {
            margin: 0; background-color: var(--bg-color); color: white;
            font-family: 'Verdana', sans-serif; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; height: 100vh;
        }

        /* --- LAYERS --- */
        #video-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; opacity: 0.4; pointer-events: none;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; justify-content: space-between; padding: 20px; box-sizing: border-box;
        }

        /* --- HUD PANELS --- */
        .hud-panel {
            background: var(--panel-bg); padding: 15px;
            border: 2px solid #555; border-radius: 12px;
            min-width: 200px; pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #score-display { font-size: 32px; font-weight: bold; text-shadow: 2px 2px 0 #000; }
        
        #leaderboard-panel { text-align: right; }
        .lb-entry {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 5px; font-size: 14px; border-bottom: 1px solid #444; padding-bottom: 2px;
        }

        /* --- THE HIGHWAY --- */
        #game-container {
            position: relative; width: 500px; height: 110vh;
            background: var(--highway-gradient);
            transform: perspective(800px) rotateX(30deg); 
            transform-origin: bottom center;
            border-left: 4px solid #666; border-right: 4px solid #666;
            box-shadow: 0 0 80px rgba(0, 243, 255, 0.15);
            top: -50px; z-index: 5;
        }

        .lane {
            position: absolute; top: 0; height: 100%; width: 25%;
            border-right: 2px solid rgba(255, 255, 255, 0.15); box-sizing: border-box;
        }
        .lane:last-child { border-right: none; }

        .hit-zone {
            position: absolute; bottom: 120px; width: 100%; display: flex;
            padding: 0 10px; box-sizing: border-box;
        }

        .button-target {
            width: 25%; height: 25px; background: rgba(255,255,255,0.2);
            border: 3px solid white; border-radius: 50%; margin: 0 5px;
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }
        .button-target.pressed { background: white; transform: scale(0.9); box-shadow: 0 0 25px white; }

        .note {
            position: absolute; width: 20%; height: 20px; border-radius: 6px;
            box-shadow: 0 0 15px currentColor; border: 2px solid white; z-index: 100;
        }
        .note.lane-0 { background: var(--neon-green); color: var(--neon-green); left: 2.5%; }
        .note.lane-1 { background: var(--neon-red); color: var(--neon-red); left: 27.5%; }
        .note.lane-2 { background: var(--neon-blue); color: var(--neon-blue); left: 52.5%; }
        .note.lane-3 { background: var(--neon-pink); color: var(--neon-pink); left: 77.5%; }

        /* --- MENUS --- */
        #menu-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 20, 30, 0.98); z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .menu-box {
            width: 500px; padding: 30px; border: 2px solid #555; text-align: center;
            background: #2b2b3b; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        input {
            background: #1a1a25; border: 2px solid #666; color: white;
            padding: 15px; margin-bottom: 15px; width: 100%;
            text-align: center; font-size: 16px; font-weight: bold; border-radius: 8px;
        }

        button {
            background: #3a3a4a; color: white; border: 2px solid var(--neon-blue);
            padding: 15px; width: 100%; font-size: 18px; cursor: pointer; font-weight: bold;
            text-transform: uppercase; margin-bottom: 10px; border-radius: 8px;
        }
        button:hover { background: var(--neon-blue); color: #000; }
        
        button.ready-btn { border-color: var(--neon-yellow); background: #4a4a2a; }
        button.ready-btn:hover { background: var(--neon-yellow); }
        button.start-btn { border-color: var(--neon-green); background: #2a3a2a; }
        button.start-btn:hover { background: var(--neon-green); }

        /* LOBBY LIST STYLES */
        .lobby-list {
            background: #1a1a20; padding: 10px; border-radius: 8px;
            margin: 15px 0; max-height: 150px; overflow-y: auto; text-align: left;
        }
        .lobby-item {
            display: flex; justify-content: space-between; padding: 5px;
            border-bottom: 1px solid #333; font-size: 14px;
        }
        .status-badge {
            font-size: 10px; padding: 3px 6px; border-radius: 4px; font-weight: bold;
        }
        .st-wait { background: #444; color: #aaa; }
        .st-ready { background: var(--neon-green); color: black; }

        #feedback {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 60px; font-weight: 900; opacity: 0; transition: opacity 0.1s;
            z-index: 15; -webkit-text-stroke: 2px black; pointer-events: none;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="video-background"><div id="yt-player"></div></div>

    <div id="ui-layer">
        <div class="hud-panel">
            <div style="color:#aaa; font-size:12px;">SCORE</div>
            <div id="score-display">0</div>
            <div id="combo-display" style="font-size:14px; color:#ddd;">Combo: 0</div>
        </div>
        
        <div id="feedback">PERFECT</div>

        <div class="hud-panel" id="leaderboard-panel">
            <div style="color:var(--neon-blue); font-weight:bold; margin-bottom:5px;">LIVE RANKING</div>
            <div id="lb-content"></div>
        </div>
    </div>

    <div id="game-container">
        <div class="lane" style="left: 0%"></div>
        <div class="lane" style="left: 25%"></div>
        <div class="lane" style="left: 50%"></div>
        <div class="lane" style="left: 75%"></div>
        <div class="hit-zone">
            <div class="button-target" id="btn-0"></div>
            <div class="button-target" id="btn-1"></div>
            <div class="button-target" id="btn-2"></div>
            <div class="button-target" id="btn-3"></div>
        </div>
    </div>

    <div id="menu-overlay">
        <h1 style="text-shadow: 0 0 20px var(--neon-pink); margin-bottom: 20px;">KEYBOARD HERO</h1>
        
        <div class="menu-box" id="menu-login">
            <input type="text" id="inp-name" placeholder="YOUR NAME" maxlength="10">
            <input type="text" id="inp-room" placeholder="ROOM NAME (e.g. TIU1)">
            <button onclick="attemptHost()">HOST ROOM</button>
            <button onclick="attemptJoin()">JOIN ROOM</button>
            <div id="error-msg" style="color:var(--neon-red); font-size:12px; height:20px;"></div>
        </div>

        <div class="menu-box hidden" id="menu-host">
            <h3 style="color:var(--neon-green); margin:0;">HOST PANEL</h3>
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;">ROOM: <span id="host-room-name" style="color:white; font-weight:bold;"></span></div>
            
            <input type="text" id="inp-yt-url" placeholder="Paste YouTube URL Here..." onchange="loadVideoByUrl()">
            <div id="video-status" style="font-size:12px; color:var(--neon-blue); margin-bottom:10px;">Waiting for link...</div>

            <div style="text-align:left; color:#aaa; font-size:12px;">LOBBY STATUS:</div>
            <div class="lobby-list" id="host-lobby-list">
                </div>

            <button class="start-btn" onclick="hostStartGame()">START GAME</button>
        </div>

        <div class="menu-box hidden" id="menu-client">
            <h3 style="color:var(--neon-blue);">CONNECTED</h3>
            <p id="client-msg">Waiting for Host...</p>
            
            <div id="client-ready-area" class="hidden">
                <p style="color:var(--neon-yellow); font-size:14px;">Song Loaded!</p>
                <button class="ready-btn" onclick="clientReadyUp()">CLICK TO READY UP</button>
            </div>
            <div id="client-done-msg" class="hidden" style="color:var(--neon-green); font-weight:bold;">YOU ARE READY</div>
        </div>

        <div class="menu-box hidden" id="menu-gameover">
            <h2>GAME OVER</h2>
            <div style="font-size:14px;">WINNER</div>
            <div id="winner-name" style="font-size:36px; color:var(--neon-green);"></div>
            <div id="winner-score" style="font-size:48px; font-weight:bold;"></div>
            <button class="end-btn" onclick="location.reload()">MAIN MENU</button>
        </div>
    </div>

    <script>
        // --- PRECISE TIMING LOGIC ---
        // YouTube's 'getCurrentTime' is choppy. We use performance.now() to smooth it.
        let lastYtTime = 0;
        let lastPerfTime = 0;
        let isVideoPlaying = false;

        function getSmoothedTime() {
            if (!ytPlayer || !ytPlayer.getCurrentTime) return 0;
            const currYt = ytPlayer.getCurrentTime();
            
            // If YouTube updated its time significantly, resync our offset
            if (Math.abs(currYt - lastYtTime) > 0.05) { 
                lastYtTime = currYt;
                lastPerfTime = performance.now();
            }

            // Interpolate: Last Known YT Time + (Time passed since then)
            if (isVideoPlaying) {
                return (lastYtTime * 1000) + (performance.now() - lastPerfTime);
            }
            return lastYtTime * 1000;
        }

        // --- YOUTUBE SETUP ---
        let ytPlayer;
        let currentVideoId = "";
        
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('yt-player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'autoplay':0, 'controls':0, 'disablekb':1, 'iv_load_policy':3 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) isVideoPlaying = true;
            else isVideoPlaying = false;
        }

        // --- GAME VARIABLES ---
        const SPAWN_AHEAD = 2500; // ms
        const HIT_WINDOW = 200;   // ms (Widened for better feel)
        let gameRunning = false;
        let songData = [];
        let score = 0;
        let combo = 0;

        // --- NETWORKING VARIABLES ---
        let peer = null;
        let myId = null;
        let myName = "Guest";
        let isHost = false;
        let players = {};
        let connections = {};
        let hostConn = null;

        // --- GENERATE SONG ---
        function generateSong(duration) {
            let notes = [];
            const density = 2; // Notes per second (approx)
            const count = Math.floor(duration * density);
            for(let i=0; i<count; i++) {
                // Start notes at 3 seconds
                const time = 3000 + (i * (1000/density)); 
                if(time < duration * 1000) {
                    notes.push({ lane: Math.floor(Math.random()*4), time: time, hit: false, el: null });
                }
            }
            return notes;
        }

        // --- GAME LOOP ---
        function startGame() {
            document.getElementById('menu-overlay').style.display = 'none';
            const duration = ytPlayer.getDuration();
            songData = generateSong(duration);
            score = 0; combo = 0; updateHUD();
            
            // Clean old notes
            document.querySelectorAll('.note').forEach(e => e.remove());
            
            ytPlayer.playVideo();
            gameRunning = true;
            lastPerfTime = performance.now(); // Init timer
            requestAnimationFrame(loop);
        }

        function loop() {
            if(!gameRunning) return;

            const timeMs = getSmoothedTime();

            // End Check
            if(ytPlayer.getPlayerState() === 0) {
                gameRunning = false;
                if(isHost) sendGameOver();
                return;
            }

            songData.forEach(n => {
                if(n.hit) return;
                
                const diff = n.time - timeMs;

                // Missed
                if(diff < -300) {
                    n.hit = true; if(n.el) n.el.remove();
                    combo = 0; updateHUD(); showFeedback("MISS");
                    return;
                }

                // Spawn
                if(!n.el && diff <= SPAWN_AHEAD && diff > -200) {
                    const d = document.createElement('div');
                    d.className = `note lane-${n.lane}`;
                    document.getElementById('game-container').appendChild(d);
                    n.el = d;
                }

                // Move
                if(n.el) {
                    // Map time diff to percentage (90% is hit line)
                    const p = 90 - (diff / (SPAWN_AHEAD / 90));
                    n.el.style.top = `${p}%`;
                }
            });
            requestAnimationFrame(loop);
        }

        // --- INPUT HANDLING ---
        const keys = {'a':0, 's':1, 'd':2, 'f':3};
        document.addEventListener('keydown', e => {
            if(!gameRunning || !keys.hasOwnProperty(e.key.toLowerCase())) return;
            if(e.repeat) return; // Prevent hold-down spam

            const lane = keys[e.key.toLowerCase()];
            const btn = document.getElementById(`btn-${lane}`);
            btn.classList.add('pressed');
            
            const timeMs = getSmoothedTime();
            let hit = false;

            // Find closest note in this lane
            for(let n of songData) {
                if(!n.hit && n.lane === lane) {
                    const diff = Math.abs(n.time - timeMs);
                    if(diff < HIT_WINDOW) {
                        n.hit = true; if(n.el) n.el.remove();
                        hit = true;
                        
                        // Score Calculation
                        let points = 100;
                        let text = "GOOD";
                        if(diff < 80) { points = 300; text = "PERFECT"; }
                        else if(diff < 150) { points = 200; text = "GREAT"; }
                        
                        score += points + (combo * 5);
                        combo++;
                        showFeedback(text);
                        updateHUD();
                        sendScore();
                        break; 
                    }
                }
            }

            if(!hit && combo > 0) {
                combo = 0; showFeedback("MISS"); updateHUD();
            }
        });

        document.addEventListener('keyup', e => {
            if(keys.hasOwnProperty(e.key.toLowerCase())) {
                document.getElementById(`btn-${keys[e.key.toLowerCase()]}`).classList.remove('pressed');
            }
        });

        // --- HOST FUNCTIONS ---
        function attemptHost() {
            const {name, room} = getInfo(); if(!name) return;
            myName = name;
            peer = new Peer(room);
            peer.on('open', id => {
                isHost = true; myId = id;
                players[myId] = { name: myName, score: 0, ready: true }; // Host is always ready
                showScreen('menu-host');
                document.getElementById('host-room-name').innerText = room;
                renderLobby();
            });
            peer.on('connection', conn => {
                setupConnection(conn);
            });
            peer.on('error', err => document.getElementById('error-msg').innerText = "Room ID taken or error.");
        }

        function loadVideoByUrl() {
            const url = document.getElementById('inp-yt-url').value;
            const match = url.match(/v=([^#&?]*)/);
            if(match && match[1]) {
                currentVideoId = match[1];
                document.getElementById('video-status').innerText = "ID: " + currentVideoId;
                ytPlayer.loadVideoById(currentVideoId);
                setTimeout(() => ytPlayer.pauseVideo(), 1000);
                broadcast({ type: 'PRELOAD', vid: currentVideoId });
            }
        }

        function hostStartGame() {
            broadcast({ type: 'START' });
            startGame();
        }

        // --- CLIENT FUNCTIONS ---
        function attemptJoin() {
            const {name, room} = getInfo(); if(!name) return;
            myName = name;
            peer = new Peer();
            peer.on('open', id => {
                myId = id;
                hostConn = peer.connect(room);
                hostConn.on('open', () => {
                    showScreen('menu-client');
                    hostConn.send({ type: 'JOIN', name: myName });
                });
                hostConn.on('data', handleData);
            });
        }

        function clientReadyUp() {
            // Unblock Autoplay
            ytPlayer.loadVideoById(currentVideoId);
            ytPlayer.mute(); ytPlayer.playVideo();
            setTimeout(() => {
                ytPlayer.pauseVideo(); ytPlayer.seekTo(0); ytPlayer.unMute();
                document.getElementById('client-ready-area').classList.add('hidden');
                document.getElementById('client-done-msg').classList.remove('hidden');
                hostConn.send({ type: 'READY' });
            }, 1000);
        }

        // --- SHARED NETWORK LOGIC ---
        function setupConnection(conn) {
            connections[conn.peer] = conn;
            conn.on('data', data => {
                if(data.type === 'JOIN') {
                    players[conn.peer] = { name: data.name, score: 0, ready: false };
                    syncLobby();
                }
                if(data.type === 'READY') {
                    if(players[conn.peer]) players[conn.peer].ready = true;
                    syncLobby();
                }
                if(data.type === 'SCORE') {
                    if(players[conn.peer]) players[conn.peer].score = data.score;
                    updateLeaderboard();
                }
            });
            conn.on('close', () => { delete players[conn.peer]; delete connections[conn.peer]; syncLobby(); });
        }

        function handleData(data) {
            if(data.type === 'PRELOAD') {
                currentVideoId = data.vid;
                document.getElementById('client-msg').style.display='none';
                document.getElementById('client-ready-area').classList.remove('hidden');
            }
            if(data.type === 'START') startGame();
            if(data.type === 'LOBBY_UPDATE') { players = data.players; updateLeaderboard(); }
            if(data.type === 'GAME_OVER') showGameOver(data.res);
        }

        // --- UTILS ---
        function broadcast(msg) { Object.values(connections).forEach(c => c.send(msg)); }
        function sendScore() { if(hostConn) hostConn.send({type:'SCORE', score:score}); else if(isHost) { players[myId].score = score; updateLeaderboard(); } }
        function syncLobby() { renderLobby(); broadcast({ type: 'LOBBY_UPDATE', players: players }); }
        
        function renderLobby() {
            const list = document.getElementById('host-lobby-list'); list.innerHTML = '';
            Object.values(players).forEach(p => {
                const div = document.createElement('div'); div.className = 'lobby-item';
                div.innerHTML = `<span>${p.name}</span> <span class="status-badge ${p.ready?'st-ready':'st-wait'}">${p.ready?'READY':'WAIT'}</span>`;
                list.appendChild(div);
            });
        }
        
        function updateLeaderboard() {
            // Also syncs for Host
            if(isHost) broadcast({ type: 'LOBBY_UPDATE', players: players });
            
            const el = document.getElementById('lb-content'); el.innerHTML = '';
            Object.entries(players).sort((a,b)=>b[1].score-a[1].score).forEach(([id,p]) => {
                const div = document.createElement('div'); div.className='lb-entry';
                div.innerHTML = `<span style="color:${id===myId?'var(--neon-green)':'white'}">${p.name}</span><span>${p.score}</span>`;
                el.appendChild(div);
            });
        }

        function sendGameOver() {
            // Calculate winner
            let max = -1, winner = "";
            Object.values(players).forEach(p => { if(p.score > max) { max = p.score; winner = p.name; }});
            const res = { name: winner, score: max };
            showGameOver(res);
            broadcast({ type: 'GAME_OVER', res: res });
        }

        function showGameOver(res) {
            document.getElementById('menu-overlay').style.display = 'flex';
            showScreen('menu-gameover');
            document.getElementById('winner-name').innerText = res.name;
            document.getElementById('winner-score').innerText = res.score;
        }

        function getInfo() {
            const name = document.getElementById('inp-name').value || "User";
            const room = document.getElementById('inp-room').value;
            if(!room) { document.getElementById('error-msg').innerText="Enter Room Name"; return {}; }
            return {name, room};
        }
        function showScreen(id) {
            ['menu-login','menu-host','menu-client','menu-gameover'].forEach(i => document.getElementById(i).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function showFeedback(t) { const f=document.getElementById('feedback'); f.innerText=t; f.style.opacity=1; setTimeout(()=>f.style.opacity=0,300); }
        function updateHUD() { document.getElementById('score-display').innerText = score; document.getElementById('combo-display').innerText = "Combo: "+combo; }

    </script>
</body>
</html>
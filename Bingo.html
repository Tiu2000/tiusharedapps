<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Win Bingo</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --highlight: #f1c40f;
            --success: #2ecc71;
            --light: #ecf0f1;
            --dark: #1a252f;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary);
            color: var(--light);
            text-align: center;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        /* --- UI Sections --- */
        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.5s; }

        /* --- Login --- */
        .login-box {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 15px;
            max-width: 450px;
            margin: 50px auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .input-group { margin: 15px 0; }

        input {
            padding: 12px;
            border-radius: 8px;
            border: none;
            width: 75%;
            font-size: 1.1rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            color: var(--dark);
        }

        button {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            margin: 10px;
            transition: transform 0.1s, filter 0.2s;
        }

        button:hover { filter: brightness(1.1); }
        button:active { transform: scale(0.95); }
        .btn-host { background-color: var(--accent); color: white; width: 80%; }
        .btn-join { background-color: var(--highlight); color: var(--primary); width: 80%; }
        .btn-draw { background-color: var(--highlight); color: var(--primary); font-size: 1.5rem; padding: 15px 40px; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* --- Host Info --- */
        .room-info {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .qr-container {
            margin: 10px auto;
            background: white;
            padding: 10px;
            width: 150px;
            height: 150px;
            border-radius: 5px;
        }
        .qr-container img { width: 100%; height: 100%; }

        /* --- Bingo Ball --- */
        #current-ball {
            width: 160px;
            height: 160px;
            background: radial-gradient(circle at 30% 30%, #fff, #e0e0e0);
            border-radius: 50%;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4.5rem;
            font-weight: bold;
            margin: 20px auto;
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.2), 0 10px 30px rgba(0,0,0,0.5);
            border: 5px solid #fff;
            position: relative;
        }

        .ball-anim { animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes bounceIn {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            60% { transform: scale(1.1) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        @keyframes pulseMatch {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .match-anim { animation: pulseMatch 0.5s ease-out; }

        /* --- Player Lists --- */
        .player-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .player-card {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 100px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Player Bingo Card --- */
        .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-width: 400px;
            margin: 0 auto;
            background: var(--dark);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .bingo-header {
            color: var(--highlight);
            font-weight: 900;
            padding: 5px;
            font-size: 1.5rem;
            text-shadow: 2px 2px 0 #000;
        }

        .bingo-cell {
            background: #fff;
            color: #333;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
            user-select: none;
            transition: background 0.3s;
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.2);
        }

        .bingo-cell.marked {
            background: var(--success); 
            color: white;
            position: relative;
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.2);
        }

        /* --- Winner Overlay --- */
        #winner-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--highlight);
        }

        .winner-text {
            font-size: 4rem;
            font-weight: 900;
            text-transform: uppercase;
            animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 20px;
        }

        .winner-name {
            font-size: 3rem;
            color: white;
            margin-bottom: 40px;
        }

        @keyframes zoomIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- Watermark --- */
        .watermark {
            position: fixed;
            bottom: 15px;
            right: 20px;
            font-size: 2.5rem;
            font-weight: 900;
            color: rgba(255,255,255,0.03);
            pointer-events: none;
            z-index: 9999;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .copy-link {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 5px 10px;
            font-size: 0.8rem;
            color: #fff;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div class="watermark">TIU</div>

    <div id="winner-overlay">
        <div class="winner-text">BINGO!</div>
        <div class="winner-name" id="winner-display-name">...</div>
        <button class="btn-host" onclick="closeOverlay()">Close</button>
    </div>

    <div id="screen-login" class="screen active">
        <h1 style="font-size: 3rem; margin-bottom: 0; color: var(--highlight);">BINGO P2P</h1>
        <p style="opacity: 0.7; margin-top: 5px;">Auto-Mark & Auto-Win</p>
        
        <div class="login-box">
            <div style="border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 25px; margin-bottom: 25px;">
                <h3>üë®‚Äçüè´ Teacher / Host</h3>
                <div class="input-group">
                    <input type="text" id="host-room-name" placeholder="CREATE ROOM NAME">
                </div>
                <button class="btn-host" onclick="initHost()">Start Room</button>
            </div>

            <div>
                <h3>üë®‚Äçüéì Student / Player</h3>
                <div class="input-group">
                    <input type="text" id="join-id" placeholder="ENTER ROOM NAME">
                </div>
                <div class="input-group">
                    <input type="text" id="player-name" placeholder="YOUR NAME" style="text-transform: none;">
                </div>
                <button class="btn-join" onclick="joinGame()">Join Game</button>
            </div>
        </div>
    </div>

    <div id="screen-host" class="screen">
        <div class="room-info">
            <h2 style="margin:0">Room: <span id="display-room-id" style="color:var(--highlight); font-family: monospace;">...</span></h2>
            <button class="copy-link" onclick="copyLink()">üîó Copy Link for Students</button>
            <div class="qr-container">
                <img id="qr-code" src="" alt="QR Code">
            </div>
        </div>

        <div id="current-ball">--</div>
        <button class="btn-draw" onclick="hostDrawBall()">DRAW BALL</button>
        
        <div style="background: rgba(0,0,0,0.2); margin-top: 20px; padding: 10px; border-radius: 8px;">
            <h4 style="margin:5px 0; opacity: 0.8;">History</h4>
            <div id="host-history" style="font-size: 0.9rem; letter-spacing: 1px; line-height: 1.4; color: var(--highlight);"></div>
        </div>

        <h3 style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            Players (<span id="player-count">0</span>)
        </h3>
        <div id="player-monitor" class="player-list"></div>
    </div>

    <div id="screen-player" class="screen">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 400px; margin: 0 auto 10px auto;">
            <h3 id="player-display-name" style="margin:0;">Player</h3>
            <div style="text-align: right;">
                <span style="font-size: 0.8rem; opacity: 0.7;">Current Call</span><br>
                <span id="player-current-ball" style="font-weight:bold; color: var(--highlight); font-size: 1.8rem;">--</span>
            </div>
        </div>
        
        <div class="bingo-card" id="bingo-card">
            <div class="bingo-header">B</div>
            <div class="bingo-header">I</div>
            <div class="bingo-header">N</div>
            <div class="bingo-header">G</div>
            <div class="bingo-header">O</div>
            </div>
        <p id="game-status" style="margin-top: 20px; font-style: italic; color: var(--highlight);">Waiting for host...</p>
    </div>

<script>
    // --- AUDIO SYSTEM ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        
        if (type === 'pop') {
            // Ball Reveal
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        } else if (type === 'match') {
            // Success Chime
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now);
            osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0.4, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
            osc.start(now); osc.stop(now + 0.6);
        } else if (type === 'victory') {
            // VICTORY FANFARE
            // Creates a chord arpeggio
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C Major
            notes.forEach((freq, i) => {
                const oscV = audioCtx.createOscillator();
                const gainV = audioCtx.createGain();
                oscV.type = 'triangle';
                oscV.connect(gainV);
                gainV.connect(audioCtx.destination);
                
                const start = now + (i * 0.1);
                oscV.frequency.setValueAtTime(freq, start);
                gainV.gain.setValueAtTime(0, start);
                gainV.gain.linearRampToValueAtTime(0.3, start + 0.1);
                gainV.gain.exponentialRampToValueAtTime(0.01, start + 2);
                
                oscV.start(start);
                oscV.stop(start + 2);
            });
        }
    }

    // --- GLOBAL STATE ---
    let peer = null;
    let connections = [];
    let hostConn = null;
    let myName = "";
    let calledNumbers = [];
    const APP_PREFIX = "tiu-bingo-v3-"; 
    let hasWon = false; // Prevent double sending

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomParam = urlParams.get('room');
        if(roomParam) document.getElementById('join-id').value = roomParam;
    };

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function closeOverlay() {
        document.getElementById('winner-overlay').style.display = 'none';
        // Reset winner flag so game can continue if desired
        hasWon = false; 
    }

    // --- HOST LOGIC ---
    function initHost() {
        let roomName = document.getElementById('host-room-name').value.trim().toUpperCase();
        if(!roomName) return alert("Please create a Room Name");
        roomName = roomName.replace(/[^A-Z0-9]/g, '');
        const fullId = APP_PREFIX + roomName;

        document.getElementById('display-room-id').innerText = roomName;
        switchScreen('screen-host');

        const joinUrl = window.location.href.split('?')[0] + "?room=" + roomName;
        document.getElementById('qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(joinUrl)}`;

        peer = new Peer(fullId); 

        peer.on('error', (err) => {
            if(err.type === 'unavailable-id') {
                alert("Room Taken! Try another.");
                window.location.reload();
            }
        });

        peer.on('connection', (conn) => {
            connections.push(conn);
            conn.on('data', (data) => {
                if(data.type === 'JOIN') {
                    updatePlayerMonitor(conn.peer, data.name, 0);
                    updatePlayerCount();
                    conn.send({ type: 'SYNC', called: calledNumbers });
                }
                if(data.type === 'UPDATE_SCORE') {
                    updatePlayerMonitor(conn.peer, data.name, data.matches);
                }
                if(data.type === 'BINGO_WIN') {
                    handleWin(data.name);
                }
            });
            conn.on('close', () => {
                const el = document.getElementById('p-' + conn.peer);
                if(el) el.remove();
                connections = connections.filter(c => c !== conn);
                updatePlayerCount();
            });
        });
    }

    function handleWin(winnerName) {
        // 1. Show Host Overlay
        showWinnerOverlay(winnerName);
        
        // 2. Broadcast to all players
        connections.forEach(conn => conn.send({ type: 'GAME_OVER', winner: winnerName }));
    }

    function showWinnerOverlay(name) {
        document.getElementById('winner-display-name').innerText = name;
        document.getElementById('winner-overlay').style.display = 'flex';
        playSound('victory');
        
        // Confetti effect
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    }

    function hostDrawBall() {
        if(calledNumbers.length >= 75) return;
        let num;
        do { num = Math.floor(Math.random() * 75) + 1; } while (calledNumbers.includes(num));
        calledNumbers.push(num);
        
        let displayTxt = getLetter(num) + " " + num;

        // Host Animation
        const ballEl = document.getElementById('current-ball');
        ballEl.classList.remove('ball-anim');
        void ballEl.offsetWidth; 
        ballEl.innerText = num; 
        ballEl.classList.add('ball-anim');
        
        document.getElementById('host-history').innerText = calledNumbers.map(n => getLetter(n)+n).join(', ');
        playSound('pop');

        connections.forEach(conn => conn.send({ type: 'BALL', number: num, display: displayTxt }));
    }

    function updatePlayerMonitor(id, name, matches) {
        let el = document.getElementById('p-' + id);
        if(!el) {
            el = document.createElement('div');
            el.id = 'p-' + id;
            el.className = 'player-card';
            document.getElementById('player-monitor').appendChild(el);
        }
        let statusColor = matches >= 5 ? '#2ecc71' : 'rgba(255,255,255,0.7)';
        el.innerHTML = `<div style="font-weight:bold">${name}</div><div style="color:${statusColor}; font-size:0.9rem;">Marked: ${matches}</div>`;
    }

    function updatePlayerCount() {
        document.getElementById('player-count').innerText = connections.length;
    }

    function copyLink() {
        const roomName = document.getElementById('display-room-id').innerText;
        const url = window.location.href.split('?')[0] + "?room=" + roomName;
        navigator.clipboard.writeText(url).then(() => alert("Link copied!"));
    }

    // --- PLAYER LOGIC ---
    function joinGame() {
        let roomName = document.getElementById('join-id').value.trim().toUpperCase();
        myName = document.getElementById('player-name').value || "Student";
        if(!roomName) return alert("Enter Room Name");
        roomName = roomName.replace(/[^A-Z0-9]/g, '');
        const fullId = APP_PREFIX + roomName;

        switchScreen('screen-player');
        document.getElementById('player-display-name').innerText = myName;
        generateBingoCard();

        peer = new Peer(); 
        peer.on('open', () => {
            hostConn = peer.connect(fullId);
            
            hostConn.on('open', () => {
                document.getElementById('game-status').innerText = "‚úÖ Connected: " + roomName;
                hostConn.send({ type: 'JOIN', name: myName });
            });

            hostConn.on('data', (data) => {
                if(data.type === 'BALL') handleNewBall(data);
                if(data.type === 'SYNC') data.called.forEach(num => autoMarkNumber(num, false)); 
                if(data.type === 'GAME_OVER') showWinnerOverlay(data.winner);
            });
            
            hostConn.on('error', () => { alert("Room not found!"); location.reload(); });
        });
    }

    function generateBingoCard() {
        const cardContainer = document.getElementById('bingo-card');
        while(cardContainer.children.length > 5) cardContainer.removeChild(cardContainer.lastChild);

        let cols = [
            getUniqueRandoms(1, 15, 5), getUniqueRandoms(16, 30, 5),
            getUniqueRandoms(31, 45, 5), getUniqueRandoms(46, 60, 5),
            getUniqueRandoms(61, 75, 5)
        ];

        // Transpose for row rendering
        for(let r=0; r<5; r++) {
            for(let c=0; c<5; c++) {
                let cellDiv = document.createElement('div');
                cellDiv.className = 'bingo-cell';
                if(r===2 && c===2) {
                    cellDiv.innerText = "‚òÖ";
                    cellDiv.classList.add('marked');
                    cellDiv.dataset.value = "FREE";
                } else {
                    let val = cols[c][r];
                    cellDiv.innerText = val;
                    cellDiv.dataset.value = val; 
                }
                cardContainer.appendChild(cellDiv);
            }
        }
    }

    function handleNewBall(data) {
        document.getElementById('player-current-ball').innerText = data.display;
        autoMarkNumber(data.number, true); 
    }

    function autoMarkNumber(number, withSound) {
        const cell = document.querySelector(`.bingo-cell[data-value='${number}']`);
        
        if (cell && !cell.classList.contains('marked')) {
            cell.classList.add('marked');
            cell.classList.add('match-anim'); 
            
            if(withSound) playSound('match'); 
            else playSound('pop');
            
            // Check for Win immediately after marking
            checkForBingo();

            // Notify Host of Score
            const markedCount = document.querySelectorAll('.bingo-cell.marked').length;
            if(hostConn) hostConn.send({ type: 'UPDATE_SCORE', name: myName, matches: markedCount });
        } else {
            if(withSound) playSound('pop');
        }
    }

    // --- WIN DETECTION LOGIC ---
    function checkForBingo() {
        if(hasWon) return; // Don't check if already won

        const cells = Array.from(document.querySelectorAll('.bingo-cell'));
        // Convert to boolean matrix (true if marked)
        // Note: Headers are children 0-4, cells are 5-29.
        // We only want the 25 actual cells.
        const grid = cells.slice(5).map(c => c.classList.contains('marked'));

        const winningCombos = [
            // Rows
            [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
            // Cols
            [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
            // Diagonals
            [0,6,12,18,24], [4,8,12,16,20]
        ];

        let bingo = winningCombos.some(combo => combo.every(index => grid[index]));

        if (bingo) {
            hasWon = true;
            // Notify Host
            hostConn.send({ type: 'BINGO_WIN', name: myName });
        }
    }

    // --- UTILS ---
    function getLetter(num) {
        if(num<=15) return 'B'; if(num<=30) return 'I'; if(num<=45) return 'N'; if(num<=60) return 'G'; return 'O';
    }
    function getUniqueRandoms(min, max, count) {
        let arr = [];
        while(arr.length < count) {
            let r = Math.floor(Math.random() * (max - min + 1)) + min;
            if(!arr.includes(r)) arr.push(r);
        }
        return arr;
    }
</script>
</body>
</html>
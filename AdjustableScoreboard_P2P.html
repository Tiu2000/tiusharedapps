<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro TV Scoreboard (P2P)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --border-color: #222;
            --accent-color: #2ed573;
            --highlight: #2196F3;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- TIU Watermark --- */
        #watermark {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 1.2rem;
            color: #fff;
            opacity: 0.1; /* Subtle */
            pointer-events: none;
            letter-spacing: 0.2em;
            font-weight: 300;
            z-index: 1000;
            font-family: 'Courier New', Courier, monospace;
        }

        /* --- CONNECTION MODAL --- */
        #connection-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .modal-content {
            background: #222;
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #444;
            max-width: 400px;
            width: 90%;
        }
        .modal-title { font-size: 2rem; margin-bottom: 20px; font-weight: bold; color: var(--accent-color); }
        .conn-btn {
            display: block; width: 100%; margin: 10px 0; padding: 15px;
            font-size: 1.2rem; cursor: pointer; border-radius: 8px; border: none;
            color: white; font-weight: bold;
        }
        .btn-host { background: var(--accent-color); color: #000; }
        .btn-join { background: var(--highlight); }
        input.room-input {
            width: 100%; padding: 15px; font-size: 1.5rem; text-align: center;
            margin: 10px 0; border-radius: 8px; border: 1px solid #555;
            background: #111; color: white; text-transform: uppercase;
        }
        .status-msg { margin-top: 15px; color: #888; min-height: 1.2em; }
        
        #conn-status-bar {
            position: absolute; top: 10px; right: 10px;
            background: #333; padding: 5px 15px; border-radius: 20px;
            font-size: 0.8rem; color: #aaa; z-index: 50; border: 1px solid #444;
        }

        /* --- TOP BAR --- */
        .top-bar {
            flex: 0 0 20vh;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
            background: #111;
            border-bottom: 3px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            z-index: 10;
        }

        .timer-container {
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .timer-display {
            font-size: 15vh;
            font-family: 'Courier New', monospace;
            font-weight: 800;
            color: #ff3838;
            text-shadow: 0 0 15px rgba(255, 56, 56, 0.4);
            cursor: pointer;
            line-height: 1;
        }

        .timer-edit { display: none; gap: 10px; }
        .timer-edit.active { display: flex; }
        
        .timer-input {
            background: #222; border: 1px solid #444; color: white;
            font-size: 3vh; width: 3em; text-align: center; padding: 5px;
        }

        .controls-side { display: flex; gap: 15px; }

        /* --- TEAMS AREA --- */
        #teams-container {
            flex: 1;
            display: flex;
            width: 100%;
            height: 80vh;
            overflow-x: auto; /* Handle many teams */
        }

        .team-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            border-right: 1px solid var(--border-color);
            position: relative;
            padding-top: 5vh;
            transition: background 0.3s;
            min-width: 250px; /* Ensure space on mobile */
        }

        .color-strip {
            width: 100%; height: 15px; position: absolute;
            top: 0; left: 0; cursor: pointer;
        }
        .color-input { opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        .team-name {
            background: transparent; border: none; border-bottom: 2px solid transparent;
            color: #eee; font-size: 5vw; font-weight: 700; text-align: center;
            text-transform: uppercase; width: 80%; margin-bottom: 2vh;
        }
        .team-name:focus { outline: none; border-bottom: 2px solid #555; background: rgba(255,255,255,0.05); }

        .score-display {
            font-size: 30vh; font-weight: 800; line-height: 1;
            margin: 2vh 0; user-select: none;
        }

        .score-controls {
            display: flex; gap: 20px; opacity: 0.2; transition: opacity 0.2s;
        }
        .team-card:hover .score-controls { opacity: 1; }

        /* --- BUTTONS --- */
        button {
            border: none; padding: 10px 20px; border-radius: 6px;
            font-weight: bold; cursor: pointer; text-transform: uppercase;
            font-family: inherit; transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }

        .btn-start { background: var(--accent-color); color: black; font-size: 1.2rem; }
        .btn-stop { background: #ff4757; color: white; font-size: 1.2rem; }
        .btn-std { background: #444; color: white; }

        .btn-score {
            width: 80px; height: 80px; border-radius: 50%;
            font-size: 3rem; display: flex; align-items: center; justify-content: center;
            background: #333; color: white;
        }
        .btn-score:hover { background: white; color: black; }

        .btn-close-team {
            position: absolute; bottom: 15px; right: 15px;
            background: transparent; color: #444; font-size: 1.5rem;
        }
        .btn-close-team:hover { color: red; }

        @media (max-width: 800px) {
            .score-display { font-size: 15vh; }
            .team-name { font-size: 2rem; }
            .timer-display { font-size: 4rem; }
            .top-bar { padding: 0 10px; flex-direction: column; height: auto; padding-bottom: 10px; }
            .timer-container { position: relative; left: auto; transform: none; margin: 10px 0; }
            .score-controls { opacity: 1; } /* Always show controls on mobile */
        }
    </style>
</head>
<body>

    <div id="connection-modal">
        <div class="modal-content">
            <div class="modal-title">TIU SCOREBOARD</div>
            
            <div id="setup-step-1">
                <button class="conn-btn btn-host" onclick="startHost()">HOST GAME</button>
                <div style="margin:10px; color:#666">- OR -</div>
                <button class="conn-btn btn-join" onclick="showJoinInput()">JOIN GAME</button>
            </div>

            <div id="setup-step-host" style="display:none;">
                <p>Your Game ID is:</p>
                <input type="text" id="host-id-display" class="room-input" readonly>
                <div class="status-msg">Waiting for remote...</div>
                <button class="conn-btn btn-join" onclick="enterGame()">OPEN BOARD</button>
            </div>

            <div id="setup-step-join" style="display:none;">
                <p>Enter Game ID:</p>
                <input type="text" id="remote-id-input" class="room-input" placeholder="e.g. A1B2">
                <button class="conn-btn btn-host" onclick="joinGame()">CONNECT</button>
                <button class="conn-btn" style="background:#333" onclick="backToMain()">BACK</button>
                <div id="join-status" class="status-msg"></div>
            </div>
        </div>
    </div>

    <div id="conn-status-bar" style="display:none">Offline</div>

    <div class="top-bar">
        <div class="controls-side">
            <button class="btn-std" onclick="handleInput('addTeam')">+ Team</button>
            <button class="btn-std" onclick="toggleFullScreen()">[ ] Full</button>
        </div>

        <div class="timer-container">
            <div class="timer-display" id="timer" onclick="toggleTimerEdit()">10:00</div>
            
            <div class="timer-edit" id="timer-edit">
                <input type="number" id="t-min" class="timer-input" value="10">
                <span style="font-size:2rem; padding-top:5px;">:</span>
                <input type="number" id="t-sec" class="timer-input" value="00">
                <button class="btn-std" onclick="saveTimer()">Set</button>
            </div>
        </div>

        <div class="controls-side">
            <button class="btn-start" onclick="handleInput('startTimer')">Start</button>
            <button class="btn-stop" onclick="handleInput('stopTimer')">Stop</button>
        </div>
    </div>

    <div id="teams-container">
        </div>

    <div id="watermark">TIU</div>

    <script>
        // --- AUDIO SYSTEM ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx; 

        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); }

        function playSound(type) {
            initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'buzzer') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 1.5);
                gainNode.gain.setValueAtTime(0.5, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
                osc.start(now); osc.stop(now + 1.5);
            } else if (type === 'blip') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
        }

        // --- STATE & P2P ---
        let state = {
            timerSeconds: 600,
            timerRunning: false,
            teams: [
                { id: 1, name: "TEAM 1", score: 0, color: "#3498db" },
                { id: 2, name: "TEAM 2", score: 0, color: "#e74c3c" }
            ]
        };

        let peer = null, conn = null, isHost = false, myId = "";
        let timerInterval = null;

        // --- P2P SETUP ---
        function generateId() { return Math.random().toString(36).substring(2, 6).toUpperCase(); }

        function startHost() {
            myId = "TIU-" + generateId();
            document.getElementById('setup-step-1').style.display = 'none';
            document.getElementById('setup-step-host').style.display = 'block';
            document.getElementById('host-id-display').value = myId;

            peer = new Peer(myId);
            peer.on('open', (id) => { isHost = true; updateStatus('Waiting...'); });
            peer.on('connection', (c) => {
                conn = c;
                updateStatus('Remote Connected');
                document.querySelector('.status-msg').textContent = "Remote Connected!";
                setTimeout(() => sendState(), 500);
                conn.on('data', (d) => { if(d.command) processCommand(d.command, d.payload); });
            });
        }

        function showJoinInput() {
            document.getElementById('setup-step-1').style.display = 'none';
            document.getElementById('setup-step-join').style.display = 'block';
        }

        function backToMain() {
            document.getElementById('setup-step-join').style.display = 'none';
            document.getElementById('setup-step-1').style.display = 'block';
        }

        function joinGame() {
            let hostId = document.getElementById('remote-id-input').value.trim().toUpperCase();
            if(!hostId) return;
            document.getElementById('join-status').textContent = "Connecting...";

            peer = new Peer();
            peer.on('open', (id) => {
                conn = peer.connect(hostId);
                conn.on('open', () => {
                    isHost = false;
                    enterGame();
                    updateStatus('Connected to Host');
                });
                conn.on('data', (d) => { if(d.state) receiveState(d.state); });
            });
        }

        function enterGame() {
            document.getElementById('connection-modal').style.display = 'none';
            initAudio();
            render();
        }

        function updateStatus(msg) {
            const bar = document.getElementById('conn-status-bar');
            bar.style.display = 'block';
            bar.textContent = (isHost ? "HOST: " : "REMOTE: ") + msg;
        }

        // --- LOGIC ---

        function handleInput(type, payload = {}) {
            initAudio();
            // If Host, process locally then sync. If Remote, send to Host.
            if (isHost || !conn) {
                processCommand(type, payload);
            } else {
                conn.send({ command: type, payload: payload });
                if(type === 'changeScore') playSound('blip'); // Instant feedback
            }
        }

        function sendState() {
            if(conn && conn.open) conn.send({ state: state });
        }

        function receiveState(newState) {
            state = newState;
            render();
        }

        function processCommand(type, p) {
            let updateNeeded = true;

            switch(type) {
                case 'addTeam':
                    const newId = (state.teams.length > 0 ? Math.max(...state.teams.map(t=>t.id)) : 0) + 1;
                    const color = newId % 2 === 0 ? '#e74c3c' : '#3498db';
                    state.teams.push({ id: newId, name: `TEAM ${newId}`, score: 0, color: color });
                    break;
                case 'removeTeam':
                    state.teams = state.teams.filter(t => t.id !== p.id);
                    break;
                case 'changeScore':
                    const tm = state.teams.find(t => t.id === p.id);
                    if(tm) {
                        tm.score = Math.max(0, tm.score + p.amount);
                        playSound('blip');
                    }
                    break;
                case 'updateName':
                    const tmn = state.teams.find(t => t.id === p.id);
                    if(tmn) tmn.name = p.name;
                    updateNeeded = false; // Don't full re-render on typing
                    break;
                case 'updateColor':
                    const tmc = state.teams.find(t => t.id === p.id);
                    if(tmc) tmc.color = p.color;
                    break;
                case 'startTimer':
                    if (!state.timerRunning && state.timerSeconds > 0) {
                        state.timerRunning = true;
                        runTimerHost();
                    }
                    break;
                case 'stopTimer':
                    state.timerRunning = false;
                    clearInterval(timerInterval);
                    break;
                case 'setTimer':
                    state.timerSeconds = p.seconds;
                    renderTimer();
                    break;
            }

            if(updateNeeded) render();
            if(isHost) sendState();
        }

        // --- TIMER HOST LOGIC ---
        function runTimerHost() {
            if(!isHost) return; 
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(state.timerRunning && state.timerSeconds > 0) {
                    state.timerSeconds--;
                    // Sync every second so remote stays accurate
                    sendState(); 
                    renderTimer();
                } else if (state.timerSeconds <= 0) {
                    state.timerRunning = false;
                    clearInterval(timerInterval);
                    playSound('buzzer');
                    sendState();
                    renderTimer();
                    document.body.style.background = "#550000"; 
                    setTimeout(() => document.body.style.background = "#000", 1000);
                }
            }, 1000);
        }

        // --- RENDER ---
        function render() {
            renderTimer();
            const container = document.getElementById('teams-container');
            
            // Simple DOM Diffing: 
            // If team ID exists, update it. If not, create it. If extra, remove.
            
            // 1. Remove deleted teams
            const currentIds = state.teams.map(t => t.id);
            Array.from(container.children).forEach(child => {
                const childId = parseInt(child.id.split('-')[1]);
                if (!currentIds.includes(childId)) child.remove();
            });

            // 2. Add or Update teams
            state.teams.forEach(team => {
                let card = document.getElementById(`card-${team.id}`);
                if (!card) {
                    card = createTeamCard(team);
                    container.appendChild(card);
                }
                updateTeamCard(card, team);
            });
        }

        function renderTimer() {
            const m = Math.floor(state.timerSeconds / 60);
            const s = state.timerSeconds % 60;
            document.getElementById('timer').textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function createTeamCard(team) {
            const div = document.createElement('div');
            div.className = 'team-card';
            div.id = `card-${team.id}`;
            div.innerHTML = `
                <div class="color-strip" id="strip-${team.id}">
                    <input type="color" class="color-input" onchange="handleInput('updateColor', {id:${team.id}, color:this.value})">
                </div>
                <input type="text" class="team-name" id="name-${team.id}" onchange="handleInput('updateName', {id:${team.id}, name:this.value})">
                <div class="score-display" id="score-${team.id}">0</div>
                <div class="score-controls">
                    <button class="btn-score" onclick="handleInput('changeScore', {id:${team.id}, amount:-1})">-</button>
                    <button class="btn-score" onclick="handleInput('changeScore', {id:${team.id}, amount:1})">+</button>
                </div>
                <button class="btn-close-team" onclick="handleInput('removeTeam', {id:${team.id}})">&times;</button>
            `;
            return div;
        }

        function updateTeamCard(card, team) {
            // Update Score
            card.querySelector(`#score-${team.id}`).textContent = team.score;
            
            // Update Name (Only if not currently focused to avoid typing interruption)
            const nameInput = card.querySelector(`#name-${team.id}`);
            if (document.activeElement !== nameInput) {
                nameInput.value = team.name;
            }

            // Update Color
            const strip = card.querySelector(`#strip-${team.id}`);
            strip.style.background = team.color;
            card.style.background = `linear-gradient(to bottom, ${team.color}22, transparent)`;
        }

        // --- LOCAL TIMER CONTROLS ---
        function toggleTimerEdit() {
            if(state.timerRunning) return;
            document.getElementById('timer').style.display = 'none';
            document.getElementById('timer-edit').classList.add('active');
        }

        function saveTimer() {
            const m = parseInt(document.getElementById('t-min').value) || 0;
            const s = parseInt(document.getElementById('t-sec').value) || 0;
            const total = (m * 60) + s;
            handleInput('setTimer', { seconds: total });
            
            document.getElementById('timer-edit').classList.remove('active');
            document.getElementById('timer').style.display = 'block';
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        // Init
        render();

    </script>
</body>
</html>
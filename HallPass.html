<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Pass Diagnostic</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: monospace; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .card { background: var(--card); max-width: 600px; width: 100%; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;}
        h1 { text-align: center; margin: 0 0 20px 0; font-family: sans-serif; }
        
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; min-height: 250px; }
        
        /* Status */
        #status-box { padding: 15px; text-align: center; font-weight: bold; background: #eee; margin: 10px 0; border-radius: 6px; font-family: sans-serif; }
        .s-ready { background: #dbeafe !important; color: #1e40af; }
        .s-wait { background: #ffedd5 !important; color: #9a3412; }
        .s-success { background: #dcfce7 !important; color: #166534; }

        /* Controls */
        #flow-controls { display: none; flex-direction: column; gap: 10px; }
        .grid-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; }
        .btn-bath { background: #3b82f6; }
        .btn-office { background: #8b5cf6; }
        .btn-cancel { background: #64748b; width: 100%; }
        
        /* Diagnostic Console */
        #debug-area { width: 100%; max-width: 600px; display: none; }
        #console-log { background: #1e293b; color: #38bdf8; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; font-size: 12px; white-space: pre-wrap; }
        .log-err { color: #f87171; }
        .log-success { color: #4ade80; }
    </style>
</head>
<body>

<div class="card">
    <h1>üè´ Hall Pass Scanner</h1>
    
    <div id="scanner-wrapper"><div id="reader"></div></div>

    <div id="status-box" class="s-ready">Initializing Camera...</div>

    <div id="flow-controls">
        <div style="text-align:center; margin-bottom:5px; font-family:sans-serif;">
            Destination for: <b id="student-name" style="font-size:1.2em">...</b>
        </div>
        <div class="grid-btns">
            <button class="btn-bath" onclick="submitPass('Bathroom')">üöΩ Bathroom</button>
            <button class="btn-office" onclick="submitPass('Office')">üè¢ Office</button>
        </div>
        <button class="btn-cancel" onclick="resetApp()">Cancel</button>
    </div>

    <div style="margin-top:20px; border-top:1px solid #ddd; padding-top:10px;">
        <h3 style="font-family:sans-serif; margin:0 0 10px 0;">Active Passes</h3>
        <div id="active-list" style="font-family:sans-serif;">Loading...</div>
    </div>
</div>

<label style="margin-bottom: 5px; font-family:sans-serif;">
    <input type="checkbox" onchange="toggleDebug(this)"> Enable Diagnostic Mode
</label>

<div id="debug-area">
    <div id="console-log"></div>
    <button onclick="document.getElementById('console-log').innerHTML=''" style="background:#334155; margin-top:5px; padding:5px;">Clear Log</button>
</div>

<script>
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyguMXl5KoFb7N2KbXfQd08P-P2CNzFnbEIwx-XiQxSl23ONUHVoqAdis4zOrxBcHnFPA/exec"; 
    // ==========================================

    let scanner = null;
    let activePasses = [];
    let pendingStudent = null;
    let isLocked = false;
    let debugMode = false;

    // --- SOUND EFFECT ---
    const beep = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");

    // --- MAIN LOGIC ---

    function onScan(decodedText) {
        if (isLocked) return;

        // 1. FILTER: Ignore empty or whitespace-only scans
        if (!decodedText || decodedText.trim().length === 0) {
            // We ignore these silently now
            return;
        }

        // 2. LOCK: Stop scanning immediately
        isLocked = true;
        log(`üì∑ SCAN DETECTED: [${decodedText}]`);
        beep.play().catch(e=>{}); // Try to beep
        
        try { scanner.pause(); } catch(e) { log("Pause failed: " + e, "err"); }

        const student = decodedText.trim();
        const existing = activePasses.find(p => p.student === student);

        if (existing) {
            log(`üîÑ Auto-Checkin for ${student}`);
            processCheckIn(student);
        } else {
            log(`‚û°Ô∏è New Check-out for ${student}`);
            pendingStudent = student;
            showControls(student);
        }
    }

    function showControls(name) {
        document.getElementById('scanner-wrapper').style.display = 'none';
        document.getElementById('flow-controls').style.display = 'flex';
        document.getElementById('student-name').innerText = name;
        setStatus("Select Destination", "wait");
    }

    async function submitPass(dest) {
        log(`üíæ Sending OUT: ${pendingStudent} -> ${dest}`);
        setStatus("Saving...", "wait");
        
        // Optimistic Update
        activePasses.push({ student: pendingStudent, destination: dest, startTime: Date.now() });
        renderList();
        
        // Hide UI immediately
        document.getElementById('flow-controls').style.display = 'none';
        document.getElementById('scanner-wrapper').style.display = 'block';

        // Fetch
        try {
            await fetch(`${SCRIPT_URL}?action=checkout&name=${encodeURIComponent(pendingStudent)}&dest=${encodeURIComponent(dest)}`);
            log("‚úÖ Cloud Save Success", "success");
            setStatus(`Passed: ${dest}`, "success");
        } catch(e) {
            log("‚ùå Cloud Error: " + e.message, "err");
            setStatus("Saved Locally (Connection Error)", "err");
        }

        setTimeout(resetApp, 2000);
    }

    async function processCheckIn(name) {
        setStatus("Checking In...", "wait");
        
        // Optimistic Update
        activePasses = activePasses.filter(p => p.student !== name);
        renderList();

        try {
            await fetch(`${SCRIPT_URL}?action=checkin&name=${encodeURIComponent(name)}`);
            log("‚úÖ Check-in Success", "success");
            setStatus(`Welcome Back ${name}`, "success");
        } catch(e) {
            log("‚ùå Cloud Error: " + e.message, "err");
        }

        setTimeout(resetApp, 2000);
    }

    function resetApp() {
        log("üîÑ Resetting Scanner...");
        pendingStudent = null;
        isLocked = false;
        
        document.getElementById('flow-controls').style.display = 'none';
        document.getElementById('scanner-wrapper').style.display = 'block';
        setStatus("Ready to Scan", "ready");
        
        try { scanner.resume(); } catch(e) { /* ignore resume errors */ }
    }

    // --- DATA SYNC ---
    async function syncData() {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=get_active&_t=${Date.now()}`);
            const text = await res.text();
            
            try {
                activePasses = JSON.parse(text);
                renderList();
                log("‚òÅÔ∏è List Synced (" + activePasses.length + " active)");
            } catch(e) {
                log("‚ö†Ô∏è Sync Error: script might be private/locked.", "err");
            }
        } catch(e) {
            // Silence standard network polling errors to keep log clean
        }
    }

    // --- UI HELPERS ---
    function setStatus(msg, type) {
        const el = document.getElementById('status-box');
        el.innerText = msg;
        el.className = `s-${type}`;
    }

    function renderList() {
        const list = document.getElementById('active-list');
        if (activePasses.length === 0) { list.innerHTML = "No students out."; return; }
        
        list.innerHTML = activePasses.map(p => {
            const m = Math.floor((Date.now() - p.startTime)/60000);
            return `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:5px;">
                <span><b>${p.student}</b> (${p.destination})</span>
                <span style="color:red">${m} min</span>
            </div>`;
        }).join('');
    }

    // --- DIAGNOSTICS ---
    function toggleDebug(cb) {
        debugMode = cb.checked;
        document.getElementById('debug-area').style.display = debugMode ? 'block' : 'none';
        log(debugMode ? "Diagnostics Enabled" : "Diagnostics Disabled");
    }

    function log(msg, type="info") {
        if (!debugMode) return;
        const d = new Date();
        const time = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();
        const div = document.getElementById('console-log');
        div.innerHTML += `<div class="${type === 'err' ? 'log-err' : (type === 'success' ? 'log-success' : '')}">[${time}] ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }

    // --- STARTUP ---
    scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, aspectRatio: 1.0 });
    
    // CHANGED: Second argument (error callback) is now empty
    scanner.render(onScan, (err) => { 
        // SILENCED
    });

    syncData();
    setInterval(syncData, 30000); // Sync every 30s

</script>
</body>
</html>
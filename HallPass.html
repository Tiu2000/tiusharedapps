<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Pass Pro</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .card { background: var(--card); max-width: 600px; width: 100%; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;}
        h1 { text-align: center; margin: 0 0 15px 0; color: #1e293b; }
        
        /* Scanner Area */
        #scanner-wrapper { position: relative; border-radius: 8px; overflow: hidden; background: #000; min-height: 250px; }
        #reader { width: 100%; }
        
        /* Flash Effect */
        @keyframes flash-green {
            0% { box-shadow: inset 0 0 0 50px rgba(34, 197, 94, 0.5); }
            100% { box-shadow: inset 0 0 0 0 transparent; }
        }
        .scan-success { animation: flash-green 0.3s ease-out; }

        /* Status & Manual Input */
        #status-box { padding: 12px; text-align: center; font-weight: bold; background: #e2e8f0; margin: 10px 0; border-radius: 6px; }
        .s-wait { background: #ffedd5 !important; color: #9a3412; }
        .s-success { background: #dcfce7 !important; color: #166534; }
        .s-error { background: #fee2e2 !important; color: #991b1b; }

        .manual-group { display: flex; gap: 10px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;}
        .manual-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .btn-manual { background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }

        /* Destination Controls */
        #flow-controls { display: none; flex-direction: column; gap: 10px; }
        .grid-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 1rem; }
        .btn-bath { background: #3b82f6; }
        .btn-office { background: #8b5cf6; }
        .btn-cancel { background: #94a3b8; width: 100%; }

        /* Logs */
        #debug-area { width: 100%; max-width: 600px; display: none; }
        #console-log { background: #0f172a; color: #38bdf8; padding: 10px; border-radius: 8px; height: 120px; overflow-y: auto; font-family: monospace; font-size: 11px; }
        .log-warn { color: #fbbf24; }
    </style>
</head>
<body>

<div class="card">
    <h1>üè´ Hall Pass Scanner</h1>
    
    <div id="scanner-wrapper">
        <div id="reader"></div>
    </div>
    
    <div class="manual-group">
        <input type="text" id="manual-name" class="manual-input" placeholder="Or type name here..." onkeypress="if(event.key==='Enter') manualEntry()">
        <button class="btn-manual" onclick="manualEntry()">Enter</button>
    </div>

    <div id="status-box">Ready to Scan</div>

    <div id="flow-controls">
        <div style="text-align:center; margin-bottom:10px;">
            Destination for: <b id="student-name" style="font-size:1.2em">...</b>
        </div>
        <div class="grid-btns">
            <button class="btn-bath" onclick="submitPass('Bathroom')">üöΩ Bathroom</button>
            <button class="btn-office" onclick="submitPass('Office')">üè¢ Office</button>
        </div>
        <button class="btn-cancel" onclick="resetApp()">Cancel</button>
    </div>

    <div style="margin-top:20px; border-top:1px solid #ddd; padding-top:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Currently Out:</h3>
            <button onclick="syncData()" style="padding:5px 10px; font-size:0.8rem; background:#cbd5e1; color:#334155; border:none; border-radius:4px; cursor:pointer;">Force Refresh</button>
        </div>
        <div id="active-list">Loading...</div>
    </div>
</div>

<label style="font-size: 0.9rem; color: #64748b;">
    <input type="checkbox" onchange="toggleDebug(this)"> Show Diagnostic Log
</label>
<div id="debug-area">
    <div id="console-log"></div>
</div>

<script>
    // ==========================================
    // YOUR NEW URL IS INSERTED HERE:
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyoWmZGMu54rpHRT6TMmWM4n96lepOpvu7gJeZVuKopO7bDOKWO0-z1WDyc0JFAgHYubg/exec"; 
    // ==========================================

    let scanner = null;
    let activePasses = [];
    let pendingStudent = null;
    let isLocked = false;
    let debugMode = false;

    // --- 1. SCAN LOGIC ---

    function onScan(decodedText) {
        if (isLocked) return;
        if (!decodedText || decodedText.trim().length === 0) return;
        handleValidInput(decodedText.trim());
    }

    function manualEntry() {
        const name = document.getElementById('manual-name').value;
        if(name) handleValidInput(name.trim());
    }

    function handleValidInput(name) {
        isLocked = true;
        log(`üéØ DETECTED: [${name}]`);
        
        // Flash Effect
        const wrapper = document.getElementById('scanner-wrapper');
        wrapper.classList.remove('scan-success');
        void wrapper.offsetWidth; 
        wrapper.classList.add('scan-success');

        try { scanner.pause(); } catch(e) {}
        document.getElementById('manual-name').value = ""; 

        // Check local list first
        const existing = activePasses.find(p => p.student === name);

        if (existing) {
            processCheckIn(name);
        } else {
            pendingStudent = name;
            showControls(name);
        }
    }

    // --- 2. UI FLOW ---

    function showControls(name) {
        document.getElementById('scanner-wrapper').style.display = 'none';
        document.getElementById('flow-controls').style.display = 'flex';
        document.getElementById('student-name').innerText = name;
        setStatus("Select Destination", "wait");
    }

    async function submitPass(dest) {
        setStatus("Saving...", "wait");
        
        // 1. Show it on screen IMMEDIATELY
        activePasses.push({ student: pendingStudent, destination: dest, startTime: Date.now() });
        renderList();
        
        // 2. Hide controls
        document.getElementById('flow-controls').style.display = 'none';
        document.getElementById('scanner-wrapper').style.display = 'block';

        // 3. Send to Google
        try {
            await fetch(`${SCRIPT_URL}?action=checkout&name=${encodeURIComponent(pendingStudent)}&dest=${encodeURIComponent(dest)}`);
            log("‚úÖ Save Success", "success");
            setStatus(`‚úÖ Pass Created: ${dest}`, "success");
        } catch(e) {
            log("‚ùå Network Fail: " + e.message, "warn");
            setStatus("Saved Locally (Offline)", "error");
        }
        
        setTimeout(resetApp, 2000);
    }

    async function processCheckIn(name) {
        setStatus("Checking In...", "wait");
        
        // 1. Remove from screen IMMEDIATELY
        activePasses = activePasses.filter(p => p.student !== name);
        renderList();

        // 2. Send to Google
        try {
            await fetch(`${SCRIPT_URL}?action=checkin&name=${encodeURIComponent(name)}`);
            log("‚úÖ Check-in Success", "success");
            setStatus(`üëã Welcome Back, ${name}`, "success");
        } catch(e) {
            log("‚ùå Network Fail: " + e.message, "warn");
        }

        setTimeout(resetApp, 2000);
    }

    function resetApp() {
        isLocked = false;
        pendingStudent = null;
        document.getElementById('flow-controls').style.display = 'none';
        document.getElementById('scanner-wrapper').style.display = 'block';
        document.getElementById('scanner-wrapper').classList.remove('scan-success');
        setStatus("Ready to Scan");
        try { scanner.resume(); } catch(e) {}
    }

    // --- 3. CORE & SYNC ---

    async function syncData() {
        if(isLocked) return;

        try {
            const res = await fetch(`${SCRIPT_URL}?action=get_active&_t=${Date.now()}`);
            const text = await res.text();
            
            try {
                const newData = JSON.parse(text);
                activePasses = newData;
                renderList();
                log("‚òÅÔ∏è Synced (" + activePasses.length + " active)");
            } catch(e) {
                log("‚ö†Ô∏è Sync Error: Invalid Data. Check Deployment!", "warn");
            }

        } catch(e) {
            // silent fail on network error
        }
    }

    function renderList() {
        const list = document.getElementById('active-list');
        if (activePasses.length === 0) { list.innerHTML = "<div style='color:#94a3b8'>No students out.</div>"; return; }
        
        list.innerHTML = activePasses.map(p => {
            const m = Math.floor((Date.now() - p.startTime)/60000);
            return `<div style="padding:8px; border-bottom:1px dashed #eee; display:flex; justify-content:space-between;">
                <span><b>${p.student}</b> (${p.destination})</span>
                <span style="color:#ef4444; font-size:0.9em">${m} min</span>
            </div>`;
        }).join('');
    }

    function setStatus(msg, type="") {
        const el = document.getElementById('status-box');
        el.innerText = msg;
        el.className = type === "success" ? "s-success" : (type === "wait" ? "s-wait" : (type === "error" ? "s-error" : ""));
    }

    function log(msg, type) {
        if(!debugMode) return;
        const d = new Date();
        const time = d.toTimeString().split(' ')[0];
        document.getElementById('console-log').innerHTML += `<div class="${type==='warn'?'log-warn':''}"><span style="color:#64748b">[${time}]</span> ${msg}</div>`;
        document.getElementById('console-log').scrollTop = 9999;
    }

    function toggleDebug(cb) {
        debugMode = cb.checked;
        document.getElementById('debug-area').style.display = debugMode ? 'block' : 'none';
    }

    // STARTUP
    scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    scanner.render(onScan, (err) => { });

    syncData();
    setInterval(syncData, 20000);

</script>
</body>
</html>
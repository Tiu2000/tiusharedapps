<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Pass Pro</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --card: #ffffff; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .card { background: var(--card); max-width: 600px; width: 100%; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #1e293b; margin-top: 0; font-size: 1.5rem;}
        
        /* Scanner container */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: black; min-height: 300px; }

        /* Status Bar */
        #status-bar {
            text-align: center; font-weight: bold; margin: 15px 0; padding: 12px;
            border-radius: 8px; background: #e2e8f0; color: #475569;
            transition: all 0.3s;
        }
        .status-success { background: #dcfce7 !important; color: #166534 !important; }
        .status-wait { background: #fff7ed !important; color: #9a3412 !important; }
        .status-error { background: #fee2e2 !important; color: #991b1b !important; }

        /* Destination Selection (Hidden by default) */
        #checkout-flow { display: none; flex-direction: column; gap: 15px; }
        
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; color: white; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        
        .btn-bath { background: #3b82f6; }
        .btn-office { background: #8b5cf6; }
        .btn-cancel { background: #94a3b8; width: 100%; margin-top: 10px;}
        .btn-go { background: #10b981; width: 80px; }

        /* Custom Input Area */
        .custom-input-group { display: flex; gap: 10px; margin-top: 5px; }
        input[type="text"] {
            flex-grow: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; outline: none;
        }
        input[type="text"]:focus { border-color: var(--primary); }

        /* Active List */
        #active-list { margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px; }
        .student-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #e2e8f0; }
        .time-tag { font-size: 0.85rem; color: #ef4444; background: #fee2e2; padding: 2px 8px; border-radius: 12px; }
    </style>
</head>
<body>

<div class="card">
    <h1>üè´ Hall Pass Scanner</h1>
    
    <div id="scanner-wrapper">
        <div id="reader"></div>
    </div>

    <div id="status-bar">Starting Camera...</div>

    <div id="checkout-flow">
        <div style="text-align:center; color:#64748b; margin-bottom:10px;">
            Select destination for <b id="student-name" style="color:#000"></b>:
        </div>

        <div class="quick-actions">
            <button class="btn btn-bath" onclick="submitPass('Bathroom')">üöΩ Bathroom</button>
            <button class="btn btn-office" onclick="submitPass('Office')">üè¢ Office</button>
        </div>

        <div class="custom-input-group">
            <input type="text" id="room-input" placeholder="Type Room # (e.g. 104)" onkeypress="handleEnter(event)">
            <button class="btn btn-go" onclick="submitCustom()">GO</button>
        </div>

        <button class="btn btn-cancel" onclick="resetToScan()">Cancel</button>
    </div>

    <div id="active-list">
        <h3>Currently Out</h3>
        <div id="list-content">Loading...</div>
    </div>
</div>

<script>
    // ==========================================
    // YOUR URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyguMXl5KoFb7N2KbXfQd08P-P2CNzFnbEIwx-XiQxSl23ONUHVoqAdis4zOrxBcHnFPA/exec"; 
    // ==========================================

    let activePasses = []; // Local copy of data
    let scanner = null;
    let pendingStudent = null;
    let isLocked = false; // Prevents "Double Scanning"

    // --- 1. CORE FUNCTIONS ---

    async function refreshData() {
        try {
            // FIX 1: Add timestamp to prevent caching (&_t=...)
            const res = await fetch(`${SCRIPT_URL}?action=get_active&_t=${Date.now()}`);
            
            const text = await res.text();
            let data;
            
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error("PERMISSION ERROR: Set Script Access to 'Anyone'.");
            }

            activePasses = data;
            renderList();
            if(!isLocked) updateStatus("Ready to Scan");

        } catch(e) {
            console.error("Sync error", e);
            updateStatus("Connection Error", "error");
        }
    }

    // Triggered when a QR code is detected
    function onScanMatch(decodedText) {
        if (isLocked) return; 
        isLocked = true;     

        scanner.pause(); 

        const existingPass = activePasses.find(p => p.student === decodedText);

        if (existingPass) {
            processCheckIn(decodedText);
        } else {
            pendingStudent = decodedText;
            showDestinationScreen(decodedText);
        }
    }

    // --- 2. CHECK OUT FLOW ---

    function showDestinationScreen(name) {
        document.getElementById('scanner-wrapper').style.display = 'none';
        document.getElementById('checkout-flow').style.display = 'flex';
        document.getElementById('student-name').innerText = name;
        updateStatus("Select Destination", "wait");
        setTimeout(() => document.getElementById('room-input').focus(), 100);
    }

    function submitCustom() {
        const room = document.getElementById('room-input').value;
        if (!room) return alert("Please type a room number");
        submitPass("Room " + room);
    }

    function handleEnter(e) {
        if(e.key === "Enter") submitCustom();
    }

    async function submitPass(destination) {
        updateStatus("Saving...", "wait");
        
        // Hide controls immediately
        document.getElementById('checkout-flow').style.display = 'none'; 
        document.getElementById('scanner-wrapper').style.display = 'block';

        // FIX 2: OPTIMISTIC UPDATE (Add to screen BEFORE Google replies)
        // This ensures the next scan knows they are already out.
        activePasses.push({
            student: pendingStudent,
            destination: destination,
            startTime: Date.now()
        });
        renderList();

        // Send to cloud in background
        await fetch(`${SCRIPT_URL}?action=checkout&name=${encodeURIComponent(pendingStudent)}&dest=${encodeURIComponent(destination)}`);
        
        updateStatus(`‚úÖ Pass Created: ${destination}`, "success");
        
        // Wait 2 seconds then unlock
        setTimeout(resetToScan, 2000);
    }

    // --- 3. CHECK IN FLOW ---

    async function processCheckIn(name) {
        updateStatus("Checking In...", "wait");

        // Optimistic Remove
        activePasses = activePasses.filter(p => p.student !== name);
        renderList();
        
        await fetch(`${SCRIPT_URL}?action=checkin&name=${encodeURIComponent(name)}`);
        
        updateStatus(`üëã Welcome Back, ${name}`, "success");
        await refreshData(); // Fetch real list to be sure
        
        setTimeout(resetToScan, 2000);
    }

    // --- 4. HELPERS ---

    function resetToScan() {
        document.getElementById('checkout-flow').style.display = 'none';
        document.getElementById('scanner-wrapper').style.display = 'block';
        document.getElementById('room-input').value = "";
        
        isLocked = false;
        pendingStudent = null;
        updateStatus("Ready to Scan");
        
        try { scanner.resume(); } catch(e) {}
    }

    function updateStatus(msg, type="") {
        const el = document.getElementById('status-bar');
        el.innerText = msg;
        el.className = ""; 
        if (type === "success") el.classList.add("status-success");
        if (type === "wait") el.classList.add("status-wait");
        if (type === "error") el.classList.add("status-error");
    }

    function renderList() {
        const list = document.getElementById('list-content');
        if (activePasses.length === 0) {
            list.innerHTML = "<div style='color:#94a3b8; text-align:center'>No students out</div>";
            return;
        }
        
        list.innerHTML = activePasses.map(p => {
            const mins = Math.floor((Date.now() - p.startTime) / 60000);
            return `
                <div class="student-row">
                    <div>
                        <strong>${p.student}</strong>
                        <span style="color:#64748b; font-size:0.9rem"> &rarr; ${p.destination}</span>
                    </div>
                    <div class="time-tag">${mins} min</div>
                </div>
            `;
        }).join('');
    }

    // --- 5. INITIALIZATION ---
    
    scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, aspectRatio: 1.0 });
    scanner.render(onScanMatch, (err) => { });

    refreshData();
    setInterval(refreshData, 20000);

</script>
</body>
</html>
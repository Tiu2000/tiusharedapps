<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TIU P2P Chess</title>
  
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <style>
    :root {
      --bg-color: #ffffff;
      --board-border: #333;
      --light-sq: #f0d9b5; 
      --dark-sq: #b58863;
      --accent: #2b6cb0;
      --highlight: rgba(255, 255, 0, 0.5);
      --move-dot: rgba(0, 0, 0, 0.3);
      --check-red: rgba(255, 0, 0, 0.6);
    }

    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0; padding: 10px;
      background: #f4f4f4; color: #111;
      overscroll-behavior: none;
    }

    .app {
      display: flex; flex-direction: column; gap: 16px;
      max-width: 600px; margin: 0 auto; padding-bottom: 40px;
    }

    h1 { font-size: 22px; margin: 0; font-weight: 700; color: #222; text-align: center; }

    .panel {
      background: #fff; border-radius: 8px; padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd;
    }

    /* --- CONNECTION UI --- */
    .connection-ui {
      display: flex; flex-direction: column; gap: 10px;
      text-align: center;
    }
    .conn-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    
    input[type="text"] {
      padding: 8px; border: 1px solid #ccc; border-radius: 4px;
      width: 160px; font-family: monospace; text-align: center;
    }

    .status-bar {
      font-weight: 600; text-align: center; padding: 10px;
      background: #eef; border-radius: 4px; color: #333;
      border-left: 4px solid var(--accent);
    }
    .status-bar.alert { border-color: red; background: #ffebeb; color: #a00; }
    .status-bar.success { border-color: green; background: #eaffea; }

    /* --- BOARD STYLING --- */
    .board-wrap { display: flex; flex-direction: column; align-items: center; gap: 10px; position: relative; }

    .board {
      width: 100%;
      max-width: 90vw;
      /* Force square aspect ratio */
      height: 90vw; 
      max-height: 500px; max-width: 500px;
      
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      
      border: 3px solid #333;
      user-select: none;
      background: #eee;
      position: relative;
      transition: transform 0.6s ease;
    }

    /* Desktop constraint */
    @media (min-width: 555px) { .board { height: 500px; } }

    .square {
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-size: clamp(24px, 8vw, 42px);
      position: relative; cursor: pointer;
    }

    .sq-light { background: var(--light-sq); }
    .sq-dark { background: var(--dark-sq); }

    .piece {
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      line-height: 1; pointer-events: none; z-index: 2;
      transition: transform 0.6s ease;
    }

    /* --- BRANDING --- */
    .brand-watermark {
      position: absolute; bottom: 5px; right: 5px;
      font-size: 14px; font-weight: 900; color: rgba(0,0,0,0.15);
      pointer-events: none; z-index: 1; font-family: monospace; letter-spacing: 1px;
    }

    /* --- GAME ELEMENTS --- */
    .selected { background: var(--highlight) !important; }
    .in-check { background: var(--check-red) !important; }
    
    .legal-dot {
      position: absolute; width: 25%; height: 25%;
      background: var(--move-dot); border-radius: 50%; pointer-events: none;
    }
    .legal-capture::before {
      content: ''; position: absolute; width: 80%; height: 80%;
      border: 5px solid rgba(0,0,0,0.3); border-radius: 50%;
    }

    .btn {
      background: #fff; border: 1px solid #ccc; padding: 8px 16px;
      border-radius: 6px; font-size: 14px; cursor: pointer; color: #333; font-weight: 600;
      transition: all 0.2s;
    }
    .btn:hover { background: #f0f0f0; }
    .btn.primary { background: var(--accent); color: #fff; border: none; }
    .btn.primary:hover { background: #205081; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Flip board classes */
    .flipped { transform: rotate(180deg); }
    .flipped .piece { transform: rotate(180deg); }
    .flipped .brand-watermark { transform: rotate(180deg); }

  </style>
</head>
<body>

<div class="app">
  <header>
    <h1>TIU Chess <span style="font-size:0.6em; color:#777; font-weight:400;">(P2P)</span></h1>
  </header>

  <div class="panel connection-ui" id="connPanel">
    <div id="setupControls">
      <p style="margin:0 0 10px 0; font-size:14px; color:#555;">Start a room or join a friend to play.</p>
      <div class="conn-row">
        <button class="btn primary" onclick="hostGame()">Host Game</button>
        <span style="align-self:center; font-size:12px; color:#999;">— OR —</span>
        <input type="text" id="remoteId" placeholder="Enter Friend's ID">
        <button class="btn" onclick="joinGame()">Join</button>
      </div>
    </div>

    <div id="lobbyDisplay" style="display:none;">
      <p style="margin:0; font-size:13px; color:#555;">Share this ID with your student/friend:</p>
      <div class="conn-row" style="margin-top:5px;">
        <input type="text" id="myIdDisplay" readonly style="font-weight:bold; color:var(--accent);">
        <button class="btn" onclick="copyId()">Copy</button>
      </div>
    </div>
  </div>

  <div id="gameStatus" class="status-bar">Connect to play</div>

  <main class="panel board-wrap">
    <div id="board" class="board"></div>
  </main>
  
  <p style="text-align:center; font-size:12px; color:#999; margin-top:-10px;">
    Sound: On • Auto-Flip: On
  </p>
</div>

<script>
  // --- AUDIO ENGINE (Synthesized sounds so no external files needed) ---
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  
  function playTone(freq, type, duration) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  const Sounds = {
    move: () => playTone(300, 'sine', 0.1),
    capture: () => { playTone(150, 'triangle', 0.15); setTimeout(()=>playTone(100, 'triangle', 0.15), 50); },
    check: () => { playTone(600, 'sine', 0.1); setTimeout(()=>playTone(800, 'sine', 0.2), 100); },
    start: () => { playTone(400, 'sine', 0.2); setTimeout(()=>playTone(600, 'sine', 0.4), 200); },
    invalid: () => playTone(150, 'sawtooth', 0.2)
  };

  // --- GAME VARIABLES ---
  let chess = new Chess();
  let peer = null;
  let conn = null;
  let myColor = 'w'; // 'w' or 'b'
  let selectedSquare = null;
  let gameActive = false;

  // --- INIT BOARD ---
  (function drawEmptyBoard() {
    const boardEl = document.getElementById('board');
    let html = '';
    for (let r = 0; r < 8; r++) {
      for (let c = 0; c < 8; c++) {
        const squareColor = (r + c) % 2 === 0 ? 'sq-light' : 'sq-dark';
        const squareName = String.fromCharCode(97 + c) + (8 - r);
        html += `<div class="square ${squareColor}" data-square="${squareName}" id="sq-${squareName}" onclick="onSquareClick('${squareName}')"></div>`;
      }
    }
    html += '<div class="brand-watermark">TIU</div>';
    boardEl.innerHTML = html;
    renderPieces();
  })();

  // --- P2P NETWORKING ---
  function initPeer() {
    // Generate a short random ID to make it easier to type
    const shortId = Math.random().toString(36).substr(2, 5).toUpperCase();
    peer = new Peer(shortId); 
    
    peer.on('open', (id) => {
      document.getElementById('myIdDisplay').value = id;
    });

    peer.on('connection', (c) => {
      // HOST LOGIC: A guest connected
      conn = c;
      setupConnection();
      document.getElementById('setupControls').style.display = 'none';
      document.getElementById('lobbyDisplay').style.display = 'none';
      setStatus("Connected! You are White.", "success");
      myColor = 'w';
      gameActive = true;
      Sounds.start();
      // Send initial start signal
      setTimeout(() => conn.send({ type: 'start' }), 500);
    });

    peer.on('error', (err) => {
      alert("Connection Error: " + err.type);
    });
  }

  function hostGame() {
    initPeer();
    document.getElementById('setupControls').style.display = 'none';
    document.getElementById('lobbyDisplay').style.display = 'block';
    setStatus("Waiting for opponent...", "");
  }

  function joinGame() {
    const destId = document.getElementById('remoteId').value.trim().toUpperCase();
    if (!destId) return alert("Please enter an ID");
    
    peer = new Peer(); // Guest gets random ID
    peer.on('open', () => {
      conn = peer.connect(destId);
      setupConnection();
    });
    setStatus("Connecting...", "");
  }

  function setupConnection() {
    conn.on('open', () => {
      console.log("Connected");
    });

    conn.on('data', (data) => {
      handleNetworkData(data);
    });
  }

  function handleNetworkData(data) {
    if (data.type === 'start') {
      // GUEST LOGIC: Received start signal
      document.getElementById('setupControls').style.display = 'none';
      setStatus("Connected! You are Black.", "success");
      myColor = 'b';
      gameActive = true;
      Sounds.start();
      
      // Auto flip for black
      document.getElementById('board').classList.add('flipped');
    } 
    else if (data.type === 'move') {
      // Received a move
      chess.move(data.move); // Execute move locally
      renderPieces();
      
      // Play sound based on move type
      const history = chess.history({verbose:true});
      const lastMove = history[history.length-1];
      if (chess.in_check()) Sounds.check();
      else if (lastMove.captured) Sounds.capture();
      else Sounds.move();

      updateStatusUI();
    }
  }

  function sendMove(moveObj) {
    if (conn && conn.open) {
      conn.send({ type: 'move', move: moveObj });
    }
  }

  // --- CHESS INTERACTION ---

  function onSquareClick(sq) {
    if (!gameActive) {
      // Allow local play/testing if not connected, but warn
      // or simply return; Let's allow clicking to visualize but not move if game not active
      if(!conn) { renderPieces(); selectSquare(sq); return; } 
    }

    // 1. If we have a selected piece, try to move
    if (selectedSquare) {
      // Attempt move
      const moveConfig = { 
        from: selectedSquare, 
        to: sq, 
        promotion: 'q' // Always promote to queen for simplicity
      };

      // Check legality via Chess.js
      // IMPORTANT: Check if it's MY turn
      if (chess.turn() !== myColor) {
        selectSquare(sq); // Just change selection if not my turn
        return; 
      }

      const move = chess.move(moveConfig);
      
      if (move) {
        // Legal move made
        selectedSquare = null;
        renderPieces();
        sendMove(moveConfig); // Network

        // Sounds
        if (chess.in_check()) Sounds.check();
        else if (move.captured) Sounds.capture();
        else Sounds.move();

        updateStatusUI();
        return;
      }
    }

    // 2. Select the square (if it has a piece of my color OR simply strictly following chess logic)
    selectSquare(sq);
  }

  function selectSquare(sq) {
    const piece = chess.get(sq);
    
    // Only allow selecting own pieces if it's my turn (optional, but good UX)
    if (piece && piece.color === chess.turn()) {
      selectedSquare = sq;
      renderPieces();
      showLegalMoves(sq);
    } else {
      selectedSquare = null;
      renderPieces();
    }
  }

  function showLegalMoves(sq) {
    const moves = chess.moves({ square: sq, verbose: true });
    moves.forEach(m => {
      const target = document.getElementById(`sq-${m.to}`);
      if (target) {
        const dot = document.createElement('div');
        dot.className = m.captured ? 'legal-capture' : 'legal-dot';
        target.appendChild(dot);
      }
    });
  }

  function renderPieces() {
    // Clear pieces & markers
    document.querySelectorAll('.piece').forEach(e => e.remove());
    document.querySelectorAll('.legal-dot').forEach(e => e.remove());
    document.querySelectorAll('.legal-capture').forEach(e => e.remove());
    document.querySelectorAll('.square').forEach(e => {
      e.classList.remove('selected', 'in-check');
    });

    const board = chess.board();
    for (let r = 0; r < 8; r++) {
      for (let c = 0; c < 8; c++) {
        const piece = board[r][c];
        const squareName = String.fromCharCode(97 + c) + (8 - r);
        const sqDiv = document.getElementById(`sq-${squareName}`);
        
        if (piece && sqDiv) {
          const pDiv = document.createElement('div');
          pDiv.className = 'piece';
          pDiv.innerText = getPieceSymbol(piece);
          // Ensure piece stays upright if board is flipped
          // CSS handles this via .flipped .piece rules
          sqDiv.appendChild(pDiv);
          
          // Highlight King if in Check
          if (piece.type === 'k' && piece.color === chess.turn() && chess.in_check()) {
            sqDiv.classList.add('in-check');
          }
        }
        
        if (selectedSquare === squareName && sqDiv) {
          sqDiv.classList.add('selected');
        }
      }
    }
  }

  function getPieceSymbol(p) {
    const symbols = {
      wK:'♔', wQ:'♕', wR:'♖', wB:'♗', wN:'♘', wP:'♙',
      bK:'♚', bQ:'♛', bR:'♜', bB:'♝', bN:'♞', bP:'♟'
    };
    return symbols[(p.color === 'w' ? 'w' : 'b') + p.type.toUpperCase()];
  }

  function updateStatusUI() {
    let status = '';
    let type = '';

    if (chess.in_checkmate()) {
      status = `Game Over: ${chess.turn() === 'w' ? 'Black' : 'White'} wins by Checkmate!`;
      type = 'alert';
    } else if (chess.in_draw()) {
      status = 'Game Over: Draw';
      type = 'alert';
    } else {
      const turn = chess.turn() === 'w' ? 'White' : 'Black';
      if (chess.in_check()) {
        status = `${turn} is in Check!`;
        type = 'alert';
      } else {
        const isMyTurn = chess.turn() === myColor;
        status = isMyTurn ? "Your Turn" : `Waiting for ${turn}...`;
        type = isMyTurn ? 'success' : '';
      }
    }
    setStatus(status, type);
  }

  function setStatus(msg, type) {
    const el = document.getElementById('gameStatus');
    el.innerText = msg;
    el.className = 'status-bar ' + type;
  }

  function copyId() {
    const copyText = document.getElementById("myIdDisplay");
    copyText.select();
    document.execCommand("copy");
    alert("ID Copied: " + copyText.value);
  }

</script>
</body>
</html>

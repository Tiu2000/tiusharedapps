<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU Comprehensive Tax Calculator (Fed + NJ)</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --accent: #8b5cf6; /* For State Tax */
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
            --success: #10b981;
            --watermark: rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        /* TIU Watermark */
        .watermark {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 8rem;
            font-weight: 900;
            color: var(--watermark);
            pointer-events: none;
            user-select: none;
            z-index: 0;
            font-family: 'Times New Roman', serif;
        }

        h1, h2, h3 { margin-top: 0; color: var(--text); }
        h1 { margin-bottom: 2rem; text-align: center; }
        h2 { border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }

        .input-group { margin-bottom: 15px; }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        button:hover { background-color: var(--secondary); }

        .results-section {
            background-color: #f1f5f9;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            display: none;
            position: relative;
            z-index: 1;
        }

        .results-section.visible {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .highlight-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .breakdown-table th, .breakdown-table td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }

        .breakdown-table th {
            background-color: #e2e8f0;
            font-weight: 600;
        }

        .breakdown-table tr:last-child td {
            border-bottom: none;
            font-weight: 700;
            background-color: #f8fafc;
        }

        /* Graph Styles */
        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .bar-chart-wrapper {
            margin-bottom: 30px;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .bar-track {
            height: 35px;
            background: #e2e8f0;
            border-radius: 6px;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .bar-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            border-right: 1px solid rgba(255,255,255,0.2);
            position: relative;
        }

        /* Tooltip for segments */
        .bar-segment:hover::after {
            content: attr(data-rate);
            position: absolute;
            top: -30px;
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        /* Marker for user income */
        .income-marker {
            position: absolute;
            top: -5px;
            bottom: -5px;
            width: 4px;
            background-color: #ef4444; /* Red line */
            z-index: 10;
            box-shadow: 0 0 4px rgba(0,0,0,0.4);
        }

        .income-marker::before {
            content: "You are here";
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }

        /* Colors for brackets */
        .c-10 { background-color: #93c5fd; }
        .c-12 { background-color: #60a5fa; }
        .c-22 { background-color: #3b82f6; }
        .c-24 { background-color: #2563eb; }
        .c-32 { background-color: #1d4ed8; }
        .c-35 { background-color: #1e40af; }
        .c-37 { background-color: #1e3a8a; }
        
        /* NJ Colors */
        .nj-low { background-color: #d8b4fe; }
        .nj-mid { background-color: #a855f7; }
        .nj-high { background-color: #7e22ce; }

        .legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .color-box { width: 12px; height: 12px; border-radius: 2px; }

    </style>
</head>
<body>

<div class="container">
    <div class="watermark">TIU</div>
    
    <h1>US & NJ Tax Liability Calculator</h1>
    
    <div class="grid">
        <div class="input-section">
            <div class="input-group">
                <label for="taxYear">Tax Year</label>
                <select id="taxYear">
                    <option value="2024">2024 (File in 2025)</option>
                    <option value="2025">2025 (File in 2026)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="filingStatus">Filing Status</label>
                <select id="filingStatus">
                    <option value="single">Single</option>
                    <option value="married_joint">Married Filing Jointly</option>
                    <option value="head_household">Head of Household</option>
                    <option value="married_separate">Married Filing Separately</option>
                </select>
            </div>

            <div class="input-group">
                <label for="income">Gross Annual Income ($)</label>
                <input type="number" id="income" placeholder="e.g. 75000" min="0">
            </div>

            <button onclick="calculateTax()">Calculate My Taxes</button>
        </div>

        <div class="info-section">
            <h3>How this works</h3>
            <p>This calculator estimates taxes for residents of <strong>New Jersey</strong>.</p>
            <ul>
                <li><strong>Federal Tax:</strong> Uses progressive brackets based on "Taxable Income" (Income minus Standard Deduction).</li>
                <li><strong>NJ State Tax:</strong> Uses NJ's specific progressive brackets and personal exemptions.</li>
                <li><strong>FICA:</strong> Social Security (6.2%) and Medicare (1.45%) are flat taxes on earnings.</li>
            </ul>
            <p style="font-size:0.85rem; color:#64748b; margin-top:10px;">
                *Note: This does not account for pre-tax deductions like 401(k) or health insurance, or specific credits (like Child Tax Credit).
            </p>
        </div>
    </div>

    <div id="results" class="results-section">
        <h2>Your Tax Breakdown</h2>

        <div class="summary-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span>Total Estimated Tax (Fed + State + FICA)</span>
                <span id="totalTaxDisplay" class="highlight-value">$0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                <span>Combined Effective Tax Rate</span>
                <span id="effectiveRateDisplay">0%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; margin-top: 5px;">
                <span>Approximate Monthly Net Pay</span>
                <span id="monthlyNetDisplay" style="font-weight: 600;">$0</span>
            </div>
        </div>

        <div class="chart-container">
            <h3>Tax Bracket Visualization</h3>
            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 15px;">
                These bars show how your income fills up the "buckets" of the tax system. You only pay higher rates on the income that falls into the higher buckets.
            </p>

            <div class="bar-chart-wrapper">
                <div class="bar-label">
                    <span>Federal Brackets</span>
                    <span id="fedTopRate">Top Rate: 22%</span>
                </div>
                <div class="bar-track" id="fedBarTrack">
                    </div>
                <div class="legend">
                    <div class="legend-item"><div class="color-box c-10"></div>10%</div>
                    <div class="legend-item"><div class="color-box c-12"></div>12%</div>
                    <div class="legend-item"><div class="color-box c-22"></div>22%</div>
                    <div class="legend-item"><div class="color-box c-24"></div>24%</div>
                    <div class="legend-item"><div class="color-box c-32"></div>32%</div>
                    <div class="legend-item"><div class="color-box c-35"></div>35%</div>
                </div>
            </div>

            <div class="bar-chart-wrapper">
                <div class="bar-label">
                    <span>New Jersey Brackets</span>
                    <span id="njTopRate">Top Rate: 5.525%</span>
                </div>
                <div class="bar-track" id="njBarTrack">
                    </div>
                <div class="legend">
                    <div class="legend-item"><div class="color-box nj-low"></div>1.4% - 3.5%</div>
                    <div class="legend-item"><div class="color-box nj-mid"></div>5.525% - 6.37%</div>
                    <div class="legend-item"><div class="color-box nj-high"></div>8.97% +</div>
                </div>
            </div>
        </div>

        <h3>Detailed Calculation Table</h3>
        <table class="breakdown-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Notes</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Gross Income</td>
                    <td></td>
                    <td id="tableGross">$0</td>
                </tr>
                <tr>
                    <td colspan="3" style="background-color: #f1f5f9; font-weight:bold; font-size: 0.9rem;">Federal Income Tax</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;Standard Deduction</td>
                    <td id="fedDeductionNote">Single Filer</td>
                    <td id="tableFedDed" style="color: var(--success);">-$0</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;Federal Taxable Income</td>
                    <td>Gross - Deduction</td>
                    <td id="tableFedTaxable" style="font-weight:600;">$0</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;<strong>Federal Tax Owed</strong></td>
                    <td>Sum of progressive brackets</td>
                    <td id="tableFedTax" style="color: #dc2626;">$0</td>
                </tr>

                <tr>
                    <td colspan="3" style="background-color: #f1f5f9; font-weight:bold; font-size: 0.9rem;">State Income Tax (New Jersey)</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;NJ Exemptions</td>
                    <td id="njExemptionNote">Personal Exemption</td>
                    <td id="tableNJDed" style="color: var(--success);">-$0</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;NJ Taxable Income</td>
                    <td>Gross - Exemption</td>
                    <td id="tableNJTaxable" style="font-weight:600;">$0</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;<strong>State Tax Owed</strong></td>
                    <td>Sum of progressive NJ brackets</td>
                    <td id="tableNJTax" style="color: #dc2626;">$0</td>
                </tr>

                <tr>
                    <td colspan="3" style="background-color: #f1f5f9; font-weight:bold; font-size: 0.9rem;">FICA (Payroll Taxes)</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;Social Security</td>
                    <td>6.2% of Gross (capped)</td>
                    <td id="tableSS" style="color: #dc2626;">$0</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;Medicare</td>
                    <td>1.45% of Gross (no cap)</td>
                    <td id="tableMed" style="color: #dc2626;">$0</td>
                </tr>
                
                <tr style="border-top: 2px solid var(--text);">
                    <td><strong>Total Tax Liability</strong></td>
                    <td>Fed + State + FICA</td>
                    <td id="tableTotalTax" style="font-weight: 700; color: #dc2626;">$0</td>
                </tr>
                <tr style="background-color: #dcfce7;">
                    <td><strong>Net Pay (Take Home)</strong></td>
                    <td>Gross - Total Tax</td>
                    <td id="tableNetPay" style="font-weight: 700; color: #15803d; font-size: 1.1rem;">$0</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    /* --- DATA SOURCES --- */
    const TAX_DATA = {
        2024: {
            federal: {
                deduction: { single: 14600, married_joint: 29200, head_household: 21900, married_separate: 14600 },
                brackets: {
                    single: [
                        { limit: 11600, rate: 0.10, class: 'c-10' },
                        { limit: 47150, rate: 0.12, class: 'c-12' },
                        { limit: 100525, rate: 0.22, class: 'c-22' },
                        { limit: 191950, rate: 0.24, class: 'c-24' },
                        { limit: 243725, rate: 0.32, class: 'c-32' },
                        { limit: 609350, rate: 0.35, class: 'c-35' },
                        { limit: Infinity, rate: 0.37, class: 'c-37' }
                    ],
                    married_joint: [
                        { limit: 23200, rate: 0.10, class: 'c-10' },
                        { limit: 94300, rate: 0.12, class: 'c-12' },
                        { limit: 201050, rate: 0.22, class: 'c-22' },
                        { limit: 383900, rate: 0.24, class: 'c-24' },
                        { limit: 487450, rate: 0.32, class: 'c-32' },
                        { limit: 731200, rate: 0.35, class: 'c-35' },
                        { limit: Infinity, rate: 0.37, class: 'c-37' }
                    ],
                    head_household: [
                        { limit: 16550, rate: 0.10, class: 'c-10' },
                        { limit: 63100, rate: 0.12, class: 'c-12' },
                        { limit: 100500, rate: 0.22, class: 'c-22' },
                        { limit: 191950, rate: 0.24, class: 'c-24' },
                        { limit: 243700, rate: 0.32, class: 'c-32' },
                        { limit: 609350, rate: 0.35, class: 'c-35' },
                        { limit: Infinity, rate: 0.37, class: 'c-37' }
                    ],
                    married_separate: [
                        { limit: 11600, rate: 0.10, class: 'c-10' },
                        { limit: 47150, rate: 0.12, class: 'c-12' },
                        { limit: 100525, rate: 0.22, class: 'c-22' },
                        { limit: 191950, rate: 0.24, class: 'c-24' },
                        { limit: 243725, rate: 0.32, class: 'c-32' },
                        { limit: 365600, rate: 0.35, class: 'c-35' },
                        { limit: Infinity, rate: 0.37, class: 'c-37' }
                    ]
                }
            },
            nj: {
                // NJ "Standard Deduction" is essentially a personal exemption
                exemption: { single: 1000, married_joint: 2000, head_household: 1000, married_separate: 1000 },
                brackets: {
                    // NJ Brackets for Single and Married Separate
                    single: [
                        { limit: 20000, rate: 0.014, class: 'nj-low' },
                        { limit: 35000, rate: 0.0175, class: 'nj-low' },
                        { limit: 40000, rate: 0.035, class: 'nj-low' },
                        { limit: 75000, rate: 0.05525, class: 'nj-mid' },
                        { limit: 500000, rate: 0.0637, class: 'nj-mid' },
                        { limit: 1000000, rate: 0.0897, class: 'nj-high' },
                        { limit: Infinity, rate: 0.1075, class: 'nj-high' }
                    ],
                    // NJ Brackets for Married Joint and Head of Household
                    married_joint: [
                        { limit: 20000, rate: 0.014, class: 'nj-low' },
                        { limit: 50000, rate: 0.0175, class: 'nj-low' },
                        { limit: 70000, rate: 0.0245, class: 'nj-low' },
                        { limit: 80000, rate: 0.035, class: 'nj-low' },
                        { limit: 150000, rate: 0.05525, class: 'nj-mid' },
                        { limit: 500000, rate: 0.0637, class: 'nj-mid' },
                        { limit: 1000000, rate: 0.0897, class: 'nj-high' },
                        { limit: Infinity, rate: 0.1075, class: 'nj-high' }
                    ]
                }
            },
            fica: {
                ssRate: 0.062, ssLimit: 168600, medRate: 0.0145
            }
        },
        2025: {
            federal: {
                deduction: { single: 15000, married_joint: 30000, head_household: 22500, married_separate: 15000 },
                brackets: {
                    single: [
                        { limit: 11925, rate: 0.10, class: 'c-10' },
                        { limit: 48475, rate: 0.12, class: 'c-12' },
                        { limit: 103350, rate: 0.22, class: 'c-22' },
                        { limit: 197300, rate: 0.24, class: 'c-24' },
                        { limit: 250525, rate: 0.32, class: 'c-32' },
                        { limit: 626350, rate: 0.35, class: 'c-35' },
                        { limit: Infinity, rate: 0.37, class: 'c-37' }
                    ],
                    married_joint: [
                        { limit: 23850, rate: 0.10, class: 'c-10' },
                        { limit: 96950, rate: 0.12, class: 'c-12' },
                        { limit: 206700, rate: 0.22, class: 'c-22' },
                        { limit: 394600, rate: 0.24, class: 'c-24' },
                        { limit: 501050, rate: 0.32, class: 'c-32' },
                        { limit: 751600, rate: 0.35, class: 'c-35' },
                        { limit: Infinity, rate: 0.37, class: 'c-37' }
                    ],
                    head_household: [
                        { limit: 17000, rate: 0.10, class: 'c-10' },
                        { limit: 64850, rate: 0.12, class: 'c-12' },
                        { limit: 103350, rate: 0.22, class: 'c-22' },
                        { limit: 197300, rate: 0.24, class: 'c-24' },
                        { limit: 250500, rate: 0.32, class: 'c-32' },
                        { limit: 626350, rate: 0.35, class: 'c-35' },
                        { limit: Infinity, rate: 0.37, class: 'c-37' }
                    ],
                    married_separate: [
                        { limit: 11925, rate: 0.10, class: 'c-10' },
                        { limit: 48475, rate: 0.12, class: 'c-12' },
                        { limit: 103350, rate: 0.22, class: 'c-22' },
                        { limit: 197300, rate: 0.24, class: 'c-24' },
                        { limit: 250525, rate: 0.32, class: 'c-32' },
                        { limit: 375800, rate: 0.35, class: 'c-35' },
                        { limit: Infinity, rate: 0.37, class: 'c-37' }
                    ]
                }
            },
            nj: {
                exemption: { single: 1000, married_joint: 2000, head_household: 1000, married_separate: 1000 },
                brackets: {
                    single: [
                        { limit: 20000, rate: 0.014, class: 'nj-low' },
                        { limit: 35000, rate: 0.0175, class: 'nj-low' },
                        { limit: 40000, rate: 0.035, class: 'nj-low' },
                        { limit: 75000, rate: 0.05525, class: 'nj-mid' },
                        { limit: 500000, rate: 0.0637, class: 'nj-mid' },
                        { limit: 1000000, rate: 0.0897, class: 'nj-high' },
                        { limit: Infinity, rate: 0.1075, class: 'nj-high' }
                    ],
                    married_joint: [
                        { limit: 20000, rate: 0.014, class: 'nj-low' },
                        { limit: 50000, rate: 0.0175, class: 'nj-low' },
                        { limit: 70000, rate: 0.0245, class: 'nj-low' },
                        { limit: 80000, rate: 0.035, class: 'nj-low' },
                        { limit: 150000, rate: 0.05525, class: 'nj-mid' },
                        { limit: 500000, rate: 0.0637, class: 'nj-mid' },
                        { limit: 1000000, rate: 0.0897, class: 'nj-high' },
                        { limit: Infinity, rate: 0.1075, class: 'nj-high' }
                    ]
                }
            },
            fica: {
                ssRate: 0.062, ssLimit: 176100, medRate: 0.0145
            }
        }
    };

    function formatCurrency(num) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
    }

    function calculateProgressiveTax(taxableIncome, brackets) {
        let tax = 0;
        let previousLimit = 0;
        let marginalRate = 0;

        for (let bracket of brackets) {
            if (taxableIncome > previousLimit) {
                const incomeInBracket = Math.min(taxableIncome, bracket.limit) - previousLimit;
                tax += incomeInBracket * bracket.rate;
                marginalRate = bracket.rate;
                previousLimit = bracket.limit;
            } else {
                break;
            }
        }
        return { tax, marginalRate };
    }

    function renderGraph(trackId, brackets, taxableIncome, topRateId) {
        const track = document.getElementById(trackId);
        track.innerHTML = '';
        
        // Find the bracket that contains the income, or the last one if income is very high
        // For visualization purposes, we want to show a reasonable max range. 
        // Let's set the graph max width to either the next bracket limit above income, or 1.5x income.
        
        let displayMax = 0;
        let maxBracketFound = false;
        
        for(let b of brackets) {
            if (b.limit > taxableIncome) {
                displayMax = Math.min(b.limit, taxableIncome * 1.5); // Cap visualization width
                if (b.limit === Infinity) displayMax = taxableIncome * 1.2;
                maxBracketFound = true;
                break;
            }
        }
        if (!displayMax) displayMax = taxableIncome * 1.2; // Fallback if income is super high
        if (taxableIncome === 0) displayMax = brackets[1].limit; // Fallback for 0

        let accumulatedWidth = 0;
        let previousLimit = 0;

        brackets.forEach((bracket, index) => {
            const limit = (bracket.limit === Infinity) ? displayMax : bracket.limit;
            
            // If this segment starts after our display max, don't render it
            if (previousLimit >= displayMax) return;

            // Calculate width of this segment relative to displayMax
            const segmentSize = Math.min(limit, displayMax) - previousLimit;
            const widthPct = (segmentSize / displayMax) * 100;
            
            const div = document.createElement('div');
            div.className = `bar-segment ${bracket.class}`;
            div.style.width = `${widthPct}%`;
            div.dataset.rate = `${(bracket.rate*100).toFixed(2).replace(/[.,]00$/, "")}%`;
            
            // Add label inside if wide enough
            if (widthPct > 10) {
                div.innerText = div.dataset.rate;
            }

            track.appendChild(div);
            previousLimit = limit;
        });

        // Add the "You are here" marker
        const markerPos = Math.min((taxableIncome / displayMax) * 100, 100);
        const marker = document.createElement('div');
        marker.className = 'income-marker';
        marker.style.left = `${markerPos}%`;
        track.appendChild(marker);
    }

    function calculateTax() {
        const year = document.getElementById('taxYear').value;
        const status = document.getElementById('filingStatus').value;
        const grossIncome = parseFloat(document.getElementById('income').value);

        if (isNaN(grossIncome) || grossIncome < 0) {
            alert("Please enter a valid positive income.");
            return;
        }

        const data = TAX_DATA[year];

        // --- FEDERAL CALC ---
        const fedDeduction = data.federal.deduction[status];
        const fedTaxable = Math.max(0, grossIncome - fedDeduction);
        const fedBrackets = data.federal.brackets[status];
        const fedResult = calculateProgressiveTax(fedTaxable, fedBrackets);

        // --- NJ STATE CALC ---
        // NJ brackets map differently to filing status
        let njStatusKey = 'single'; // default
        if (status === 'married_joint' || status === 'head_household') {
            njStatusKey = 'married_joint';
        } else if (status === 'married_separate') {
            njStatusKey = 'single';
        }
        
        const njExemption = data.nj.exemption[status];
        const njTaxable = Math.max(0, grossIncome - njExemption);
        const njBrackets = data.nj.brackets[njStatusKey];
        const njResult = calculateProgressiveTax(njTaxable, njBrackets);

        // --- FICA CALC ---
        const ssTax = Math.min(grossIncome, data.fica.ssLimit) * data.fica.ssRate;
        const medTax = grossIncome * data.fica.medRate;

        // --- TOTALS ---
        const totalTax = fedResult.tax + njResult.tax + ssTax + medTax;
        const netPay = grossIncome - totalTax;
        const effectiveRate = grossIncome > 0 ? (totalTax / grossIncome) * 100 : 0;
        const monthlyNet = netPay / 12;

        // --- RENDER TEXT RESULTS ---
        document.getElementById('results').classList.add('visible');
        
        document.getElementById('totalTaxDisplay').innerText = formatCurrency(totalTax);
        document.getElementById('effectiveRateDisplay').innerText = effectiveRate.toFixed(2) + '%';
        document.getElementById('monthlyNetDisplay').innerText = "~" + formatCurrency(monthlyNet) + " /mo";

        document.getElementById('tableGross').innerText = formatCurrency(grossIncome);
        
        // Fed Table
        document.getElementById('tableFedDed').innerText = "-" + formatCurrency(fedDeduction);
        document.getElementById('fedDeductionNote').innerText = `${year} Standard Deduction`;
        document.getElementById('tableFedTaxable').innerText = formatCurrency(fedTaxable);
        document.getElementById('tableFedTax').innerText = formatCurrency(fedResult.tax);
        
        // NJ Table
        document.getElementById('tableNJDed').innerText = "-" + formatCurrency(njExemption);
        document.getElementById('tableNJTaxable').innerText = formatCurrency(njTaxable);
        document.getElementById('tableNJTax').innerText = formatCurrency(njResult.tax);

        // FICA Table
        document.getElementById('tableSS').innerText = formatCurrency(ssTax);
        document.getElementById('tableMed').innerText = formatCurrency(medTax);
        document.getElementById('tableTotalTax').innerText = formatCurrency(totalTax);
        document.getElementById('tableNetPay').innerText = formatCurrency(netPay);

        // --- RENDER GRAPHS ---
        renderGraph('fedBarTrack', fedBrackets, fedTaxable, 'fedTopRate');
        document.getElementById('fedTopRate').innerText = `Top Rate: ${(fedResult.marginalRate * 100).toFixed(0)}%`;

        renderGraph('njBarTrack', njBrackets, njTaxable, 'njTopRate');
        document.getElementById('njTopRate').innerText = `Top Rate: ${(njResult.marginalRate * 100).toFixed(2)}%`;
    }
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wheel of Knowledge - TIU Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* --- TIU WATERMARK --- */
        .watermark {
            position: fixed;
            bottom: 1rem;
            right: 1.5rem;
            font-size: 3rem;
            font-weight: 900;
            color: white;
            opacity: 0.15;
            pointer-events: none;
            z-index: 30;
            user-select: none;
            font-family: 'Courier New', Courier, monospace;
        }

        /* --- TILE & ANIMATIONS --- */
        .puzzle-letter {
            width: clamp(2rem, 4vw, 3.5rem);
            height: clamp(2.5rem, 5vw, 4.5rem);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.2rem, 3vw, 2.5rem);
            font-weight: 900;
            color: #1e3a8a;
            background-color: #fef3c7;
            border: 2px solid #f59e0b;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            border-radius: 0.3rem;
            transition: all 0.2s ease-in-out;
            user-select: none;
        }
        .puzzle-space {
            width: clamp(1rem, 2vw, 2.5rem);
            height: clamp(2.5rem, 5vw, 4.5rem);
            background-color: transparent;
        }
        .revealed {
            background-color: #3b82f6;
            color: #fef3c7;
            border-color: #1d4ed8;
            animation: flip 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes flip {
            0% { transform: perspective(600px) rotateY(90deg); opacity: 0; }
            100% { transform: perspective(600px) rotateY(0deg); opacity: 1; }
        }
        .letter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        /* --- WHEEL CANVAS --- */
        .wheel-container {
            position: relative;
            width: 350px;
            height: 350px;
            max-width: 100%;
        }
        canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 35px solid #fbbf24;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        /* --- UI ELEMENTS --- */
        .btn-primary { @apply bg-gradient-to-br from-green-600 to-green-800 hover:from-green-500 hover:to-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition transform active:scale-95; }
        .btn-secondary { @apply bg-gradient-to-br from-amber-600 to-amber-800 hover:from-amber-500 hover:to-amber-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition transform active:scale-95; }
        .btn-action { @apply bg-gradient-to-br from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-xl transition transform hover:scale-105; }
        
        .team-card { @apply p-3 rounded-lg bg-slate-700 border border-slate-600 text-center transition-all duration-300; }
        
        /* UPDATED: High visibility active state */
        .active-team {
            @apply bg-gradient-to-br from-green-600 to-green-800 border-green-400 transform scale-110 ring-4 ring-green-400/50;
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.6);
            z-index: 10;
        }

        .team-name-input {
            background: transparent;
            border: 1px dashed #475569;
            border-radius: 4px;
            color: white;
            text-align: center;
            width: 100%;
            font-weight: bold;
            padding: 4px;
        }
        .team-name-input:focus { outline: none; border-color: #fbbf24; background: #1e293b; }

        /* REMOTE CONTROLLER UI - MOBILE OPTIMIZED */
        #remote-interface { display: none; }
        
        .remote-key {
            /* Changed from fixed width/height to flexible height and font size */
            @apply w-full h-16 bg-slate-700 rounded-lg font-black text-2xl shadow-md active:bg-amber-500 transition-colors flex items-center justify-center select-none cursor-pointer text-slate-200 border border-slate-600;
        }
        .remote-key:active { transform: scale(0.95); }
        .remote-key.disabled { opacity: 0.2; pointer-events: none; border-color: transparent; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div class="watermark">TIU</div>

    <div id="host-interface" class="flex flex-col h-full">
        <header class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center shadow-md z-20 h-16 shrink-0">
            <h1 class="text-xl md:text-2xl font-black text-amber-400 tracking-wider font-['Orbitron']">WHEEL<span class="text-white">OF</span>KNOWLEDGE</h1>
            <div class="flex space-x-2 items-center">
                <div id="connectionStatus" class="text-[10px] md:text-xs font-mono text-slate-500 mr-2 hidden md:block">OFFLINE</div>
                <button class="bg-slate-700 hover:bg-slate-600 text-xs md:text-sm font-bold py-2 px-3 rounded transition" onclick="openAddPuzzleModal()">+ Puzzle</button>
                <button class="bg-slate-700 hover:bg-slate-600 text-xs md:text-sm font-bold py-2 px-3 rounded transition" onclick="toggleTeamsModal()">Teams</button>
                <button class="bg-indigo-600 hover:bg-indigo-500 text-xs md:text-sm font-bold py-2 px-3 rounded transition" onclick="showConnectModal()">ðŸ“± Remote</button>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row flex-grow h-full overflow-hidden relative z-10">
            <div class="lg:w-5/12 w-full bg-slate-800 flex flex-col items-center justify-center p-4 border-r border-slate-700 relative shadow-2xl overflow-y-auto">
                <div class="wheel-container mb-4 scale-75 md:scale-100">
                    <div class="pointer"></div>
                    <canvas id="wheelCanvas" width="800" height="800"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-3 w-full max-w-md">
                    <button id="spinButton" class="btn-action col-span-2 text-xl tracking-widest uppercase border-2 border-blue-400" onclick="spinWheel()">SPIN</button>
                    <button id="buyVowelButton" class="btn-secondary" onclick="openVowelModal()">Buy Vowel ($250)</button>
                    <button id="solveButton" class="btn-primary" onclick="solvePuzzle()">Solve Puzzle</button>
                </div>
                <div id="leftMessageArea" class="mt-4 text-center h-8 flex items-center justify-center">
                    <p class="text-slate-400 text-sm">Spin to begin...</p>
                </div>
            </div>

            <div class="lg:w-7/12 w-full bg-slate-900 flex flex-col p-4 overflow-y-auto relative">
                
                <div id="turnBanner" class="bg-green-900/50 border-b border-green-500 mb-2 text-center py-1 hidden">
                    <span class="text-green-300 text-xs font-bold uppercase tracking-widest">CURRENT TURN:</span>
                    <span id="turnBannerName" class="text-white font-black ml-2 uppercase">TEAM 1</span>
                </div>

                <div class="bg-gradient-to-r from-blue-900 to-slate-900 p-3 rounded-xl border-l-4 border-amber-400 mb-4 shadow-lg flex justify-between items-center">
                    <div>
                        <span class="text-blue-300 text-xs font-bold tracking-widest uppercase">Category</span>
                        <h2 id="puzzleCategory" class="text-2xl md:text-3xl font-black text-white italic drop-shadow-md">LOADING...</h2>
                    </div>
                    <button onclick="newGame()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 px-3 rounded border border-slate-600 transition">Next &rarr;</button>
                </div>

                <div id="puzzleContainer" class="flex flex-wrap justify-center content-center gap-1 md:gap-2 p-4 md:p-8 bg-slate-800 rounded-2xl border border-slate-700 shadow-inner min-h-[150px] md:min-h-[200px] mb-6"></div>

                <div id="gameInputArea" class="mb-4">
                    <div id="guessInputContainer" class="hidden bg-amber-900/50 border border-amber-600/50 p-4 rounded-xl animate-fade-in">
                        <h2 id="guessPrompt" class="text-amber-200 font-bold mb-2 text-center text-sm md:text-base">Spin Result: Guess a Consonant!</h2>
                        <div class="flex gap-2 max-w-xs mx-auto">
                            <input id="letterInput" type="text" maxlength="1" class="w-full p-2 rounded text-slate-900 font-black text-center text-xl uppercase outline-none focus:ring-4 focus:ring-amber-500" placeholder="?">
                            <button class="btn-secondary" onclick="handleManualGuess()">GUESS</button>
                        </div>
                    </div>

                    <div id="solveInputContainer" class="hidden bg-green-900/50 border border-green-600/50 p-4 rounded-xl animate-fade-in">
                        <h2 class="text-green-200 font-bold mb-2 text-center">Solve the Puzzle</h2>
                        <div class="flex gap-2 max-w-md mx-auto">
                            <input id="solveInput" type="text" class="w-full p-2 rounded text-slate-900 font-black text-center text-xl uppercase outline-none focus:ring-4 focus:ring-green-500" placeholder="TYPE FULL PHRASE">
                            <button class="btn-primary" onclick="submitSolveAttempt()">SOLVE</button>
                        </div>
                    </div>
                </div>

                <div class="mt-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                            <h3 class="text-slate-400 text-xs font-bold uppercase mb-2">Scoreboard</h3>
                            <div id="teamsContainer" class="grid grid-cols-2 gap-2"></div>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700 flex flex-col">
                            <h3 class="text-slate-400 text-xs font-bold uppercase mb-2">Used Letters</h3>
                            <p id="guessedLettersDisplay" class="text-lg font-mono text-cyan-400 break-words tracking-widest leading-relaxed flex-grow"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="remote-interface" class="h-full w-full bg-slate-900 flex flex-col p-4 relative overflow-y-auto">
        <div class="text-center pb-2 border-b border-slate-800 flex justify-between items-center shrink-0">
            <h2 class="text-amber-400 font-black text-lg tracking-wider font-['Orbitron']">CONTROLLER</h2>
            <div class="flex items-center gap-2">
                <div id="remote-status" class="text-[10px] text-slate-400 font-mono">CONNECTING...</div>
                <button onclick="window.location.reload()" class="bg-slate-700 text-white rounded-md px-2 py-1 flex items-center justify-center text-xs font-bold shadow hover:bg-slate-600 border border-slate-600">
                   â†º REFRESH
                </button>
            </div>
        </div>
        
        <div class="flex-grow flex flex-col justify-start gap-4 py-4 overflow-y-auto">
            <button id="remoteSpin" class="bg-blue-600 active:bg-blue-500 text-white font-black text-2xl py-6 rounded-xl shadow-lg uppercase tracking-widest transition-transform active:scale-95 touch-manipulation">
                SPIN WHEEL
            </button>
            
            <div class="grid grid-cols-2 gap-3">
                <button id="remoteVowel" class="bg-amber-600 active:bg-amber-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 touch-manipulation">BUY VOWEL</button>
                <button id="remoteSolve" class="bg-green-600 active:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 touch-manipulation">SOLVE</button>
            </div>
            
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                <div id="remote-keyboard" class="grid grid-cols-5 gap-2">
                    </div>
            </div>

            <button onclick="document.getElementById('remotePuzzleModal').classList.remove('hidden')" class="mt-2 bg-slate-800 hover:bg-slate-700 text-slate-400 font-bold py-4 rounded-xl border border-slate-700 border-dashed flex items-center justify-center gap-2 text-sm">
                <span>+</span> Create Custom Puzzle
            </button>
            
            <div class="h-12"></div>
        </div>

        <div id="remote-msg" class="bg-slate-800 p-3 rounded text-center text-white font-bold animate-pulse mt-auto fixed bottom-0 left-0 right-0 border-t border-slate-700 z-50 shadow-2xl">
            Initializing...
        </div>

        <div id="remotePuzzleModal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center z-[60] p-4">
            <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600">
                <h2 class="text-xl font-bold text-white mb-4">New Puzzle</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-slate-400 text-xs font-bold uppercase">Category</label>
                        <input id="remoteCatInput" type="text" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:border-amber-500 mt-1" placeholder="e.g. MOVIE">
                    </div>
                    <div>
                        <label class="text-slate-400 text-xs font-bold uppercase">Phrase</label>
                        <textarea id="remotePhraseInput" rows="3" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white uppercase focus:border-amber-500 mt-1" placeholder="HIDDEN PHRASE"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <button class="bg-slate-700 text-white py-3 rounded font-bold" onclick="document.getElementById('remotePuzzleModal').classList.add('hidden')">Cancel</button>
                        <button class="bg-green-600 text-white font-bold py-3 rounded" onclick="sendRemotePuzzle()">Play Now</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="connectModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full border border-indigo-500 text-center">
            <h2 class="text-2xl font-bold text-white mb-4">Connect Remote</h2>
            <div id="qrcode" class="bg-white p-4 rounded-lg mx-auto w-48 h-48 flex items-center justify-center mb-4"></div>
            <p class="text-slate-400 text-sm mb-4">Scan this code with your phone to control the board.</p>
            <p id="hostIdDisplay" class="text-xs font-mono text-indigo-300 break-all mb-4 select-all"></p>
            <button class="text-white bg-slate-700 hover:bg-slate-600 py-2 px-6 rounded font-bold" onclick="document.getElementById('connectModal').classList.add('hidden')">Close</button>
        </div>
    </div>

    <div id="setupModal" class="fixed inset-0 bg-slate-900 z-[60] flex items-center justify-center">
        <div class="text-center space-y-6 animate-fade-in px-4">
            <h1 class="text-4xl md:text-5xl font-black text-amber-400 tracking-wider mb-8 font-['Orbitron']">WHEEL<span class="text-white">OF</span>KNOWLEDGE</h1>
            <div class="flex flex-col gap-4 w-full max-w-xs mx-auto">
                <button onclick="startAsHost()" class="btn-action text-xl py-5 px-8">HOST GAME (Display)</button>
                <div class="text-slate-500 text-sm">- or -</div>
                 <button onclick="manualJoin()" class="bg-slate-700 text-white font-bold py-3 rounded hover:bg-slate-600">JOIN EXISTING GAME</button>
            </div>
            <p class="text-slate-600 mt-8 font-mono text-xs">TIU Edition</p>
        </div>
    </div>

    <div id="addPuzzleModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-slate-600">
            <h2 class="text-2xl font-bold text-white mb-4">Add Custom Puzzle</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-slate-400 text-sm font-bold mb-1">Category</label>
                    <input id="newCategory" type="text" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:border-amber-500 focus:outline-none" placeholder="e.g. Movie Quote">
                </div>
                <div>
                    <label class="block text-slate-400 text-sm font-bold mb-1">Phrase</label>
                    <textarea id="newPhrase" rows="3" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white uppercase focus:border-amber-500 focus:outline-none" placeholder="e.g. MAY THE FORCE BE WITH YOU"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button class="text-slate-400 hover:text-white font-bold px-4" onclick="document.getElementById('addPuzzleModal').classList.add('hidden')">Cancel</button>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg" onclick="saveCustomPuzzle()">Add & Play</button>
                </div>
            </div>
        </div>
    </div>

    <div id="vowelModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full border-2 border-indigo-500">
            <h2 class="text-2xl font-bold text-white mb-2 text-center">Buy a Vowel</h2>
            <p class="text-indigo-300 text-center mb-6 font-bold text-sm uppercase tracking-wide">Cost: $250</p>
            <div id="vowelButtons" class="flex justify-center flex-wrap gap-3 mb-6"></div>
            <button class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg" onclick="document.getElementById('vowelModal').classList.add('hidden')">Cancel</button>
        </div>
    </div>

    <div id="teamModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-slate-600">
            <h2 class="text-xl font-bold text-white mb-6 text-center">Manage Teams</h2>
            <div id="teamListEditor" class="space-y-3 mb-4 max-h-60 overflow-y-auto">
                </div>
            <div class="flex flex-col space-y-3 pt-4 border-t border-slate-700">
                <button class="btn-primary w-full" onclick="addTeam();">Add Team</button>
                <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg w-full" onclick="removeLastTeam();">Remove Last Team</button>
            </div>
            <button class="mt-6 w-full text-slate-400 hover:text-white font-bold" onclick="toggleTeamsModal()">Close</button>
        </div>
    </div>

    <div id="messageOverlay" class="fixed top-20 right-6 max-w-sm w-full z-50 pointer-events-none opacity-0 transition-opacity duration-500">
         <div id="messageBox" class="bg-slate-800 border-l-4 border-amber-500 text-white p-4 rounded shadow-2xl font-bold text-lg"></div>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function resumeAudio() {
             if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, dur, type='sine') {
            resumeAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + dur);
        }
        function playTick() { playTone(600, 0.05, 'triangle'); }
        function playClick() { playTone(1200, 0.03, 'square'); }
        function playSuccess() { playTone(880, 0.1, 'sine'); setTimeout(()=>playTone(1760, 0.2, 'sine'), 100); }
        function playFail() { playTone(200, 0.3, 'sawtooth'); setTimeout(()=>playTone(150, 0.4, 'sawtooth'), 250); }
        function playSolveFanfare() {
             resumeAudio();
             const now = audioCtx.currentTime;
             const notes = [523.25, 659.25, 783.99, 1046.50];
             notes.forEach((freq, i) => {
                 setTimeout(() => playTone(freq, 0.4, 'triangle'), i * 150);
             });
        }
        
        // Simulates ticking sound during CSS transition
        function playWheelSound(duration) {
            resumeAudio();
            let count = 0;
            // Play faster ticks at start, slower at end
            const totalTicks = 25; 
            const interval = duration / totalTicks;
            
            const ticker = setInterval(() => {
                playTick();
                count++;
                if(count >= totalTicks) clearInterval(ticker);
            }, interval);
        }

        // --- GLOBAL STATE ---
        let teams = [{name: "Team 1", score: 0}, {name: "Team 2", score: 0}];
        let currentTeamIndex = 0;
        const defaultPuzzles = [
            { category: "Phrase", word: "A PIECE OF CAKE" },
            { category: "Thing", word: "DIAMOND RING" },
            { category: "Title", word: "WAR AND PEACE" },
            { category: "Person", word: "ABRAHAM LINCOLN" },
            { category: "Event", word: "THE SUPER BOWL" }
        ];
        let customPuzzles = JSON.parse(localStorage.getItem('wof_custom_puzzles')) || [];
        let currentPuzzle = { category: "", word: "", revealed: [], guessedLetters: new Set() };
        let currentSpinValue = 0;
        const VOWELS = ['A', 'E', 'I', 'O', 'U'];
        const CONSONANTS = "BCDFGHJKLMNPQRSTVWXYZ".split('');
        
        // --- PEERJS / P2P SETUP ---
        let peer = null;
        let conn = null;
        let isHost = false;
        let targetHostId = null; // Store ID for auto-reconnect
        let heartbeatInterval = null;

        function initNetwork() {
            // Check URL params to see if we are joining
            const urlParams = new URLSearchParams(window.location.search);
            const remoteId = urlParams.get('connect');

            if (remoteId) {
                startAsClient(remoteId);
            } else {
                document.getElementById('setupModal').classList.remove('hidden');
            }
        }

        function manualJoin() {
            const id = prompt("Enter Host ID:");
            if(id) startAsClient(id);
        }

        // --- HOST LOGIC ---
        function startAsHost() {
            isHost = true;
            document.getElementById('setupModal').classList.add('hidden');
            document.getElementById('host-interface').classList.remove('hidden');
            
            // Random ID generation
            const myId = Math.random().toString(36).substring(2, 6).toUpperCase();
            peer = new Peer(myId);

            peer.on('open', (id) => {
                console.log('My ID is: ' + id);
                document.getElementById('hostIdDisplay').innerText = id;
                document.getElementById('connectionStatus').innerText = "WAITING FOR REMOTE: " + id;
                
                // Generate QR Code
                const connectUrl = window.location.href.split('?')[0] + '?connect=' + id;
                new QRCode(document.getElementById("qrcode"), {
                    text: connectUrl,
                    width: 180,
                    height: 180
                });
                
                showConnectModal();
            });

            peer.on('connection', (c) => {
                if(conn && conn.open) conn.close(); // Only one controller allowed
                conn = c;
                console.log("Connected to client");
                document.getElementById('connectModal').classList.add('hidden');
                document.getElementById('connectionStatus').innerText = "REMOTE CONNECTED";
                document.getElementById('connectionStatus').classList.remove('text-slate-500', 'text-red-500');
                document.getElementById('connectionStatus').classList.add('text-green-500');
                notify("Remote Control Connected!", "success");

                conn.on('data', (data) => {
                    handleRemoteCommand(data);
                });
                
                conn.on('close', () => {
                     document.getElementById('connectionStatus').innerText = "REMOTE DISCONNECTED";
                     document.getElementById('connectionStatus').classList.add('text-red-500');
                     notify("Remote Disconnected", "error");
                });

                // Send initial state immediately
                syncRemoteState();
            });

            initGame();
        }

        // --- CLIENT LOGIC ---
        function startAsClient(hostId) {
            isHost = false;
            targetHostId = hostId;
            document.getElementById('setupModal').classList.add('hidden');
            document.getElementById('host-interface').classList.add('hidden');
            document.getElementById('remote-interface').style.display = 'flex';
            setupRemoteUI();
            connectToHost();
        }

        function connectToHost() {
            if (peer) peer.destroy(); // Clean slate

            document.getElementById('remote-status').innerText = "CONNECTING...";
            document.getElementById('remote-status').className = "text-[10px] text-yellow-400 font-mono animate-pulse";
            
            peer = new Peer();

            peer.on('open', (id) => {
                conn = peer.connect(targetHostId);

                conn.on('open', () => {
                    document.getElementById('remote-status').innerText = "CONNECTED";
                    document.getElementById('remote-status').className = "text-[10px] text-green-400 font-mono";
                    document.getElementById('remote-msg').innerText = "Connected! Control the board.";
                    
                    // Start Heartbeat
                    if(heartbeatInterval) clearInterval(heartbeatInterval);
                    heartbeatInterval = setInterval(() => {
                        if(conn && conn.open) conn.send({type: 'heartbeat'});
                    }, 2000);
                });

                conn.on('data', (data) => {
                    handleHostUpdate(data);
                });

                conn.on('close', () => {
                    document.getElementById('remote-status').innerText = "RECONNECTING...";
                    document.getElementById('remote-status').className = "text-[10px] text-red-400 font-mono animate-pulse";
                    document.getElementById('remote-msg').innerText = "Connection Lost. Retrying...";
                    if(heartbeatInterval) clearInterval(heartbeatInterval);
                    // Auto-reconnect
                    setTimeout(connectToHost, 1000);
                });
            });
            
            peer.on('error', (err) => {
                console.log(err);
                setTimeout(connectToHost, 2000);
            });
        }

        // --- COMMAND HANDLING ---
        function handleRemoteCommand(data) {
            if(data.type === 'heartbeat') return; // Ignore pings
            
            if(data.action === 'spin') spinWheel();
            if(data.action === 'guess') {
                if(VOWELS.includes(data.letter)) {
                     // Check if can afford
                     if(teams[currentTeamIndex].score >= 250) {
                         teams[currentTeamIndex].score -= 250;
                         processGuess(data.letter, 0);
                     } else {
                         notify("Not enough money!", "error");
                     }
                } else {
                    processGuess(data.letter, currentSpinValue);
                }
            }
            if(data.action === 'solve') checkSolve(data.phrase);
            if(data.action === 'add_puzzle') {
                customPuzzles.push({category: data.category.toUpperCase(), word: data.phrase.toUpperCase()});
                startPuzzle(customPuzzles[customPuzzles.length-1]);
                notify("Custom Puzzle Loaded", "success");
            }
        }

        function handleHostUpdate(data) {
            if(data.type === 'state') {
                document.getElementById('remote-msg').innerText = data.message;
                // Update keyboard
                document.querySelectorAll('.remote-key').forEach(btn => {
                    const l = btn.innerText;
                    if(data.guessed.includes(l)) {
                        btn.classList.add('disabled', 'bg-slate-900', 'text-slate-600');
                    } else {
                        btn.classList.remove('disabled', 'bg-slate-900', 'text-slate-600');
                    }
                });
            }
        }

        function syncRemoteState(msgOverride) {
            if(!conn || !conn.open) return;
            const msg = msgOverride || `Turn: ${teams[currentTeamIndex].name} ($${teams[currentTeamIndex].score})`;
            conn.send({
                type: 'state',
                message: msg,
                guessed: Array.from(currentPuzzle.guessedLetters)
            });
        }

        // --- REMOTE UI ---
        function setupRemoteUI() {
            const kb = document.getElementById('remote-keyboard');
            kb.innerHTML = '';
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
            alphabet.forEach(l => {
                const btn = document.createElement('div');
                btn.className = "remote-key";
                btn.innerText = l;
                btn.onclick = () => {
                    if(btn.classList.contains('disabled')) return;
                    playClick(); // Local sound for feedback
                    if(conn && conn.open) conn.send({ action: 'guess', letter: l });
                };
                kb.appendChild(btn);
            });

            document.getElementById('remoteSpin').onclick = () => { if(conn) conn.send({ action: 'spin' }); };
            
            document.getElementById('remoteVowel').onclick = () => {
                const v = prompt("Enter Vowel (A E I O U):");
                if(v && VOWELS.includes(v.toUpperCase())) {
                    if(conn) conn.send({ action: 'guess', letter: v.toUpperCase() });
                }
            };
            
            document.getElementById('remoteSolve').onclick = () => {
                const s = prompt("Enter Solution:");
                if(s && conn) conn.send({ action: 'solve', phrase: s.toUpperCase() });
            }
        }

        function sendRemotePuzzle() {
            const cat = document.getElementById('remoteCatInput').value;
            const phr = document.getElementById('remotePhraseInput').value;
            if(!cat || !phr) { alert("Please fill both."); return; }
            if(conn && conn.open) conn.send({ action: 'add_puzzle', category: cat, phrase: phr });
            else alert("Not Connected!");
            
            document.getElementById('remoteCatInput').value = "";
            document.getElementById('remotePhraseInput').value = "";
            document.getElementById('remotePuzzleModal').classList.add('hidden');
        }

        // --- GAME LOGIC ---
        
        // Wheel Configuration
        const WOF_WEDGES = [
            { color: "#ef4444", text: "BANKRUPT", value: 0, type: "bankrupt" },
            { color: "#3b82f6", text: "500", value: 500, type: "money" },
            { color: "#eab308", text: "900", value: 900, type: "money" },
            { color: "#22c55e", text: "700", value: 700, type: "money" },
            { color: "#a855f7", text: "600", value: 600, type: "money" },
            { color: "#ef4444", text: "LOSE TURN", value: 0, type: "lose" },
            { color: "#3b82f6", text: "800", value: 800, type: "money" },
            { color: "#f97316", text: "400", value: 400, type: "money" },
            { color: "#14b8a6", text: "2500", value: 2500, type: "money" },
            { color: "#ec4899", text: "550", value: 550, type: "money" },
            { color: "#6366f1", text: "650", value: 650, type: "money" },
            { color: "#14b8a6", text: "450", value: 450, type: "money" },
        ];
        
        let currentAngle = 0;
        let isSpinning = false;

        function drawWheel() {
            if(!isHost) return;
            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = canvas.width / 2;
            const sliceAngle = (2 * Math.PI) / WOF_WEDGES.length;

            ctx.clearRect(0,0, canvas.width, canvas.height);

            WOF_WEDGES.forEach((wedge, i) => {
                const start = (i * sliceAngle) - (Math.PI / 2);
                const end = start + sliceAngle;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, start, end);
                ctx.fillStyle = wedge.color;
                ctx.fill();
                ctx.strokeStyle = "#1e293b";
                ctx.lineWidth = 4;
                ctx.stroke();

                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(start + sliceAngle/2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 40px 'Inter'";
                ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.shadowBlur = 4;
                let label = wedge.type === 'money' ? `$${wedge.text}` : wedge.text.toUpperCase();
                if(label.length > 8) ctx.font = "bold 30px 'Inter'";
                ctx.fillText(label, radius - 40, 12);
                ctx.restore();
            });
        }

        function spinWheel() {
            if (isSpinning) return;
            if(teams.length === 0) { notify("Add a team first!", "error"); return; }
            
            document.getElementById('guessInputContainer').classList.add('hidden');
            document.getElementById('solveInputContainer').classList.add('hidden');
            
            isSpinning = true;
            document.getElementById('spinButton').disabled = true;
            syncRemoteState("SPINNING...");
            
            const spinDuration = 5000;
            const spinRotations = (Math.random() * 10 + 20) * 360;
            const finalAngle = currentAngle + spinRotations + Math.random() * 360;
            const canvas = document.getElementById('wheelCanvas');
            
            canvas.style.transition = `transform ${spinDuration}ms cubic-bezier(0.25, 0.1, 0.25, 1)`;
            canvas.style.transform = `rotate(-${finalAngle}deg)`;
            
            playWheelSound(spinDuration); // Added sound

            setTimeout(() => {
                isSpinning = false;
                document.getElementById('spinButton').disabled = false;
                currentAngle = finalAngle % 360;
                canvas.style.transition = 'none';
                canvas.style.transform = `rotate(-${currentAngle}deg)`;
                
                const sliceAngleDeg = 360 / WOF_WEDGES.length;
                const index = Math.floor(currentAngle / sliceAngleDeg);
                const result = WOF_WEDGES[index];
                
                currentSpinValue = result.value;
                
                if(result.type === 'bankrupt') {
                    playFail();
                    notify("BANKRUPT!", "error");
                    teams[currentTeamIndex].score = 0;
                    nextTurn();
                } else if (result.type === 'lose') {
                    playFail();
                    notify("LOSE A TURN", "error");
                    nextTurn();
                } else {
                    // Check if there are any consonants left to guess
                    const availableConsonants = CONSONANTS.filter(c => !currentPuzzle.guessedLetters.has(c));
                    
                    if(availableConsonants.length === 0) {
                        notify(`SPIN: $${result.value} (No consonants left!)`, "neutral");
                        playSuccess();
                        // Do not show guess input, just let them buy vowel or solve
                        syncRemoteState(`Value $${result.value} - No Consonants!`);
                    } else {
                        playSuccess();
                        notify(`SPIN: $${result.value}`, "success");
                        document.getElementById('guessInputContainer').classList.remove('hidden');
                        document.getElementById('guessPrompt').innerText = `Value $${result.value}: Guess a Consonant`;
                        document.getElementById('letterInput').focus();
                        syncRemoteState(`Spin: $${result.value} - Pick Consonant`);
                    }
                }
                renderTeams();
            }, spinDuration);
        }

        function initGame() {
            drawWheel();
            startPuzzle(defaultPuzzles[0]);
        }

        function newGame() {
            // Pick random puzzle
            const allPuzzles = [...defaultPuzzles, ...customPuzzles];
            const rand = allPuzzles[Math.floor(Math.random() * allPuzzles.length)];
            startPuzzle(rand);
        }

        function startPuzzle(puzzle) {
            currentPuzzle = { 
                category: puzzle.category, 
                word: puzzle.word.toUpperCase(), 
                revealed: Array(puzzle.word.length).fill(false),
                guessedLetters: new Set()
            };
            
            // Auto reveal symbols
            for(let i=0; i<currentPuzzle.word.length; i++){
                if(!/[A-Z]/.test(currentPuzzle.word[i])) currentPuzzle.revealed[i] = true;
            }

            document.getElementById('puzzleCategory').innerText = currentPuzzle.category.toUpperCase();
            document.getElementById('guessedLettersDisplay').innerText = "";
            document.getElementById('guessInputContainer').classList.add('hidden');
            document.getElementById('solveInputContainer').classList.add('hidden');
            
            renderPuzzle();
            updateTeams();
            notify("New Puzzle Started!", "neutral");
            syncRemoteState("New Puzzle: " + currentPuzzle.category);
        }

        function renderPuzzle() {
            const container = document.getElementById('puzzleContainer');
            container.innerHTML = '';
            
            let currentGroup = document.createElement('div');
            currentGroup.className = 'letter-group';

            for(let i=0; i<currentPuzzle.word.length; i++) {
                const char = currentPuzzle.word[i];
                if(char === ' ') {
                    container.appendChild(currentGroup);
                    const space = document.createElement('div');
                    space.className = "puzzle-space";
                    container.appendChild(space);
                    currentGroup = document.createElement('div');
                    currentGroup.className = 'letter-group';
                } else {
                    const tile = document.createElement('div');
                    tile.className = `puzzle-letter ${currentPuzzle.revealed[i] ? 'revealed' : ''}`;
                    tile.innerText = currentPuzzle.revealed[i] ? char : '';
                    currentGroup.appendChild(tile);
                }
            }
            container.appendChild(currentGroup);
        }

        function handleManualGuess() {
            const input = document.getElementById('letterInput');
            const letter = input.value.toUpperCase().trim();
            input.value = '';
            
            if(!letter || !/[A-Z]/.test(letter)) { notify("Enter a valid letter.", "error"); return; }
            if(VOWELS.includes(letter)) { notify("Vowels must be bought!", "error"); return; }
            if(currentPuzzle.guessedLetters.has(letter)) { notify("Already guessed!", "error"); return; }
            
            processGuess(letter, currentSpinValue);
            document.getElementById('guessInputContainer').classList.add('hidden');
        }

        function processGuess(letter, value) {
            currentPuzzle.guessedLetters.add(letter);
            document.getElementById('guessedLettersDisplay').innerText = Array.from(currentPuzzle.guessedLetters).join(' ');
            
            let count = 0;
            for(let i=0; i<currentPuzzle.word.length; i++) {
                if(currentPuzzle.word[i] === letter) {
                    currentPuzzle.revealed[i] = true;
                    count++;
                }
            }
            
            renderPuzzle();
            
            if(count > 0) {
                const total = count * value;
                teams[currentTeamIndex].score += total;
                notify(`Found ${count} ${letter}'s! (+$${total})`, "success");
                playSuccess();
                renderTeams();
                syncRemoteState(`Found ${count} ${letter}'s! Go Again?`);
            } else {
                notify(`No ${letter}'s found.`, "error");
                playFail();
                nextTurn();
            }
            syncRemoteState();
        }

        function openVowelModal() {
            if(teams[currentTeamIndex].score < 250) {
                notify("Not enough money! Need $250.", "error");
                return;
            }
            const modal = document.getElementById('vowelModal');
            const container = document.getElementById('vowelButtons');
            container.innerHTML = '';
            VOWELS.forEach(v => {
                const btn = document.createElement('button');
                btn.innerText = v;
                btn.className = "bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded text-xl";
                if(currentPuzzle.guessedLetters.has(v)) {
                    btn.disabled = true;
                    btn.className = "bg-slate-700 text-slate-500 py-3 px-6 rounded text-xl";
                } else {
                    btn.onclick = () => {
                        playClick();
                        modal.classList.add('hidden');
                        teams[currentTeamIndex].score -= 250;
                        renderTeams();
                        processGuess(v, 0); // Vowels worth $0
                    }
                }
                container.appendChild(btn);
            });
            modal.classList.remove('hidden');
        }

        function solvePuzzle() {
            document.getElementById('solveInputContainer').classList.remove('hidden');
            document.getElementById('solveInput').focus();
        }

        function submitSolveAttempt() {
            const input = document.getElementById('solveInput');
            checkSolve(input.value);
            input.value = '';
            document.getElementById('solveInputContainer').classList.add('hidden');
        }

        // FIXED: Helper to normalize string for comparison
        function normalizeText(str) {
            return str.toUpperCase().trim().replace(/\s+/g, ' ');
        }

        function checkSolve(phrase) {
            // FIXED: Compare normalized strings to avoid whitespace errors
            const attempt = normalizeText(phrase);
            const actual = normalizeText(currentPuzzle.word);

            if(attempt === actual) {
                // Reveal all
                for(let i=0; i<currentPuzzle.word.length; i++) currentPuzzle.revealed[i] = true;
                renderPuzzle();
                notify(`${teams[currentTeamIndex].name} WINS!`, "success");
                playSolveFanfare(); // Added Fanfare
                // Bonus
                if(teams[currentTeamIndex].score < 1000) teams[currentTeamIndex].score = 1000;
                renderTeams();
                syncRemoteState(`${teams[currentTeamIndex].name} SOLVED IT!`);
            } else {
                notify("WRONG ANSWER!", "error");
                playFail();
                nextTurn();
            }
        }

        function saveCustomPuzzle() {
            const cat = document.getElementById('newCategory').value;
            const phrase = document.getElementById('newPhrase').value;
            if(cat && phrase) {
                const p = {category: cat, word: phrase};
                customPuzzles.push(p);
                localStorage.setItem('wof_custom_puzzles', JSON.stringify(customPuzzles));
                document.getElementById('addPuzzleModal').classList.add('hidden');
                startPuzzle(p);
            }
        }
        
        function openAddPuzzleModal() {
            document.getElementById('newCategory').value = "";
            document.getElementById('newPhrase').value = "";
            document.getElementById('addPuzzleModal').classList.remove('hidden');
        }

        function notify(msg, type) {
            const box = document.getElementById('messageBox');
            const overlay = document.getElementById('messageOverlay');
            
            box.innerText = msg;
            
            if(type === 'error') { box.className = "bg-red-900 border-l-4 border-red-500 text-white p-4 rounded shadow-2xl font-bold text-lg"; }
            else if(type === 'success') { box.className = "bg-green-900 border-l-4 border-green-500 text-white p-4 rounded shadow-2xl font-bold text-lg"; }
            else { box.className = "bg-slate-800 border-l-4 border-blue-500 text-white p-4 rounded shadow-2xl font-bold text-lg"; }

            overlay.classList.remove('opacity-0');
            setTimeout(() => {
                overlay.classList.add('opacity-0');
            }, 3000);
        }

        // --- TEAM MANAGEMENT WITH RENAMING ---
        function renderTeams() {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = '';
            
            // NEW: Update top banner
            const banner = document.getElementById('turnBanner');
            const bannerName = document.getElementById('turnBannerName');
            
            if(teams.length > 0) {
                 banner.classList.remove('hidden');
                 bannerName.innerText = teams[currentTeamIndex].name;
            } else {
                 banner.classList.add('hidden');
            }

            teams.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = `team-card ${i === currentTeamIndex ? 'active-team' : ''}`;
                div.innerHTML = `<div class="font-bold text-slate-300 text-sm truncate">${t.name}</div><div class="text-2xl font-black text-white">$${t.score}</div>`;
                container.appendChild(div);
            });
        }

        function updateTeams() {
            renderTeams();
        }

        function addTeam() {
            if(teams.length < 4) teams.push({name: `Team ${teams.length+1}`, score: 0});
            renderTeams();
            renderTeamEditor();
        }

        function removeLastTeam() {
            if(teams.length > 1) teams.pop();
            renderTeams();
            renderTeamEditor();
        }

        function nextTurn() {
            currentTeamIndex = (currentTeamIndex + 1) % teams.length;
            renderTeams();
            syncRemoteState(`It is ${teams[currentTeamIndex].name}'s Turn`);
        }

        // Renaming Logic
        function renderTeamEditor() {
            const list = document.getElementById('teamListEditor');
            list.innerHTML = '';
            teams.forEach((t, i) => {
                const row = document.createElement('div');
                row.className = "flex items-center gap-2";
                
                const label = document.createElement('span');
                label.className = "text-slate-400 font-mono text-xs w-6";
                label.innerText = (i+1) + ".";
                
                const input = document.createElement('input');
                input.type = "text";
                input.value = t.name;
                input.className = "team-name-input";
                input.oninput = (e) => {
                    teams[i].name = e.target.value;
                    renderTeams(); // Real-time update
                };
                
                row.appendChild(label);
                row.appendChild(input);
                list.appendChild(row);
            });
        }

        function toggleTeamsModal() {
            const el = document.getElementById('teamModal');
            if(el.classList.contains('hidden')) {
                renderTeamEditor();
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        function showConnectModal() {
            document.getElementById('connectModal').classList.remove('hidden');
        }

        // Init
        window.onload = initNetwork;

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Hoops Edge | Final Fix</title>
    <style>
        :root { --primary: #f97316; --bg-dark: #111827; --bg-card: #1f2937; --text-light: #f3f4f6; --text-gray: #9ca3af; --success: #10b981; --danger: #ef4444; --border: #374151; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-light); margin: 0; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-size: 1.5rem; } h1 span { color: var(--primary); }
        button.refresh-btn { background: var(--primary); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        button.refresh-btn:hover { opacity: 0.9; } button.refresh-btn:disabled { background: var(--text-gray); cursor: not-allowed; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-gray); padding: 10px 20px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .section { display: none; } .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--bg-card); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .controls { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 15px; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #374151; color: var(--text-gray); font-size: 0.85rem; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,0.05); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-fa { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-inj { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .trade-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .trade-side { background: var(--bg-card); padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
        .trade-result { grid-column: 1 / -1; background: #2d3748; padding: 20px; text-align: center; border-radius: 8px; margin-top: 20px; }
        select { width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); color: white; border-radius: 6px; margin-bottom: 10px; }
        .player-chip { display: flex; justify-content: space-between; background: var(--bg-dark); padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9rem; }
        .score-val { font-weight: bold; color: var(--primary); }
        .equity-positive { color: var(--success); font-size: 1.5rem; font-weight: bold; }
        .equity-negative { color: var(--danger); font-size: 1.5rem; font-weight: bold; }
        #error-log { display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 10px; margin-bottom: 20px; border-radius: 6px; font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <h1>Fantasy <span>Hoops Edge</span></h1>
    <button class="refresh-btn" onclick="app.fetchLiveStats()">↻ Fetch Live Stats (Final Fix)</button>
</header>

<div id="error-log"></div>

<div class="tabs">
    <button class="tab-btn active" onclick="app.switchTab('rankings')">Top Players</button>
    <button class="tab-btn" onclick="app.switchTab('waiver')">Waiver Wire</button>
    <button class="tab-btn" onclick="app.switchTab('injury')">Injury Report</button>
    <button class="tab-btn" onclick="app.switchTab('trade')">Trade Calculator</button>
</div>

<div id="rankings" class="section active">
    <div class="card">
        <div class="controls"><span>Sorted by Fantasy Avg (Basketball Ref)</span></div>
        <div class="table-container">
            <table>
                <thead><tr><th>Rank</th><th>Player</th><th>Team</th><th>FPts</th><th>Status</th></tr></thead>
                <tbody id="rankings-body"><tr><td colspan="5">Click "Fetch Live Stats" to load data...</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<div id="waiver" class="section">
    <div class="card">
        <div class="controls"><h3>Available Free Agents (Simulated)</h3></div>
        <table>
            <thead><tr><th>Player</th><th>Team</th><th>FPts</th><th>Action</th></tr></thead>
            <tbody id="waiver-body"></tbody>
        </table>
    </div>
</div>

<div id="injury" class="section">
    <div class="card">
        <div class="controls">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="sort-return-date" onchange="app.renderInjured()"> <strong>Sort by Earliest Return</strong>
            </label>
        </div>
        <table>
            <thead><tr><th>Player</th><th>Status</th><th>FPts</th><th>Est. Return</th></tr></thead>
            <tbody id="injury-body"></tbody>
        </table>
    </div>
</div>

<div id="trade" class="section">
    <div class="trade-container">
        <div class="trade-side">
            <h3>Team A</h3>
            <select id="team-a-select" onchange="app.addToTrade('A')"><option value="">+ Add Player</option></select>
            <div id="team-a-roster"></div>
            <p>Total: <span id="val-a">0</span></p>
        </div>
        <div class="trade-side">
            <h3>Team B</h3>
            <select id="team-b-select" onchange="app.addToTrade('B')"><option value="">+ Add Player</option></select>
            <div id="team-b-roster"></div>
            <p>Total: <span id="val-b">0</span></p>
        </div>
        <div class="trade-result">
            <h3>Trade Equity</h3>
            <div id="trade-equity">0.0</div>
            <p id="trade-message" style="color: var(--text-gray); margin-top: 10px;">Add players to compare</p>
        </div>
    </div>
</div>

<script>
// --------------------------------------------------------
// CONFIGURATION: THIS IS YOUR LINK
// --------------------------------------------------------
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRjXx4Qj9T0pewiLLDUqrPZCwJDaxjuWZSwq6zwjmBgrkREOTEkDyNal-87_YR-_6JokM-R2ywkLDcu/pub?output=csv";

// --------------------------------------------------------
// APP LOGIC
// --------------------------------------------------------
const app = {
    data: [],
    tradeState: { A: [], B: [] },

    fetchLiveStats: async function() {
        const btn = document.querySelector('.refresh-btn');
        const errBox = document.getElementById('error-log');
        errBox.style.display = 'none';
        btn.textContent = "Fetching via Proxy...";
        btn.disabled = true;

        try {
            // THE FIX: Route through a CORS Proxy to bypass "Failed to Fetch" error
            const proxy = "https://corsproxy.io/?";
            const response = await fetch(proxy + encodeURIComponent(SHEET_CSV_URL));

            if (!response.ok) throw new Error(`Network Error: ${response.status}`);
            
            const csvText = await response.text();
            
            // --- PARSING BASKETBALL REFERENCE CSV ---
            // Headers usually: Rk,Player,Pos,Age,Tm,G,GS,MP,FG... [PTS is last]
            const rows = csvText.split('\n');
            const headers = rows[0].split(',');
            
            const findCol = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
            
            const idxName = findCol("Player");
            const idxTm = findCol("Tm");
            const idxPTS = findCol("PTS");
            const idxTRB = findCol("TRB");
            const idxAST = findCol("AST");
            const idxSTL = findCol("STL");
            const idxBLK = findCol("BLK");
            const idxTOV = findCol("TOV");

            if(idxName === -1 || idxPTS === -1) throw new Error("Could not find stat headers. Did you paste the data into the sheet?");

            const parsedData = rows.slice(1).map((row, i) => {
                const cols = row.split(',');
                // Skip empty rows or repeated headers
                if(cols.length < 10 || cols[idxName] === "Player") return null;

                const getVal = (idx) => parseFloat(cols[idx]) || 0;

                // Calc Fantasy Points
                const fpts = (getVal(idxPTS) * 1) + (getVal(idxTRB) * 1.2) + (getVal(idxAST) * 1.5) + 
                             (getVal(idxSTL) * 3) + (getVal(idxBLK) * 3) - (getVal(idxTOV) * 1);

                const isInjured = Math.random() < 0.15; // Simulating injury data
                const isFA = Math.random() < 0.2; 

                // Simple simulated return date
                let rDate = null;
                if(isInjured) {
                    const d = new Date(); d.setDate(d.getDate() + Math.floor(Math.random() * 20));
                    rDate = d.toISOString().split('T')[0];
                }

                return {
                    id: i,
                    name: cols[idxName].replace('*', '').replace(/"/g, ''),
                    team: cols[idxTm],
                    fpts: parseFloat(fpts.toFixed(1)),
                    status: isFA ? "FA" : "ROSTERED",
                    injured: isInjured,
                    returnDate: rDate
                };
            }).filter(p => p !== null && p.fpts > 0);

            this.data = parsedData.sort((a, b) => b.fpts - a.fpts).slice(0, 150); // Top 150

            if(this.data.length === 0) throw new Error("Sheet appears empty. Paste B-Ref stats into A1.");

            this.renderAll();
            this.populateTradeDropdowns();
            btn.textContent = "✔ Data Loaded";

        } catch (error) {
            console.error(error);
            errBox.style.display = 'block';
            errBox.innerHTML = `<strong>Connection Error:</strong> ${error.message}<br><small>Trying to load mock data instead...</small>`;
            // Fallback so the app doesn't break completely
            this.loadMockFallback();
        } finally {
            btn.disabled = false;
        }
    },

    loadMockFallback: function() {
         const mock = [
            {id:1, name:"Jokic (Mock)", team:"DEN", fpts:60.5, status:"ROSTERED", injured:false},
            {id:2, name:"Luka (Mock)", team:"DAL", fpts:58.2, status:"ROSTERED", injured:false},
            {id:3, name:"Embiid (Mock)", team:"PHI", fpts:57.0, status:"ROSTERED", injured:true, returnDate:"2024-11-20"}
         ];
         this.data = mock;
         this.renderAll();
         this.populateTradeDropdowns();
    },

    // UI Functions
    switchTab: function(tabId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(b => { if(b.getAttribute('onclick').includes(tabId)) b.classList.add('active'); });
    },
    renderAll: function() { this.renderRankings(); this.renderWaiver(); this.renderInjured(); },
    renderRankings: function() {
        const tbody = document.getElementById('rankings-body'); tbody.innerHTML = '';
        this.data.forEach((p, i) => {
            const statusClass = p.status === 'FA' ? 'badge-fa' : 'badge-ros';
            const injHtml = p.injured ? '<span class="badge badge-inj">INJ</span>' : '';
            tbody.innerHTML += `<tr><td>#${i+1}</td><td>${p.name} ${injHtml}</td><td>${p.team}</td><td style="font-weight:bold; color:var(--primary)">${p.fpts}</td><td><span class="badge ${statusClass}">${p.status}</span></td></tr>`;
        });
    },
    renderWaiver: function() {
        const tbody = document.getElementById('waiver-body'); tbody.innerHTML = '';
        const av = this.data.filter(p => p.status === 'FA');
        if(!av.length) { tbody.innerHTML = '<tr><td colspan="4">No FAs in top 150.</td></tr>'; return; }
        av.forEach(p => tbody.innerHTML += `<tr><td>${p.name}</td><td>${p.team}</td><td style="font-weight:bold">${p.fpts}</td><td><button style="padding:4px 8px;">Claim</button></td></tr>`);
    },
    renderInjured: function() {
        const tbody = document.getElementById('injury-body'); tbody.innerHTML = '';
        let inj = this.data.filter(p => p.injured);
        if(document.getElementById('sort-return-date').checked && inj.length) inj.sort((a,b) => new Date(a.returnDate) - new Date(b.returnDate));
        if(!inj.length) { tbody.innerHTML = '<tr><td colspan="4">No injuries in top 150.</td></tr>'; return; }
        inj.forEach(p => {
             const diff = Math.ceil(Math.abs(new Date(p.returnDate) - new Date()) / (86400000));
             tbody.innerHTML += `<tr><td>${p.name}</td><td><span class="badge badge-inj">OUT</span></td><td>${p.fpts}</td><td>${p.returnDate} (${diff}d)</td></tr>`;
        });
    },
    populateTradeDropdowns: function() {
        const opts = `<option value="">+ Add Player</option>` + this.data.map(p => `<option value="${p.id}">${p.name} (${p.fpts})</option>`).join('');
        document.getElementById('team-a-select').innerHTML = opts; document.getElementById('team-b-select').innerHTML = opts;
    },
    addToTrade: function(side) {
        const sel = document.getElementById(`team-${side.toLowerCase()}-select`);
        const pid = parseInt(sel.value);
        if(!pid || this.tradeState[side].find(p=>p.id===pid)) return;
        this.tradeState[side].push(this.data.find(p=>p.id===pid));
        this.renderTrade(side); this.calcEquity(); sel.value = "";
    },
    renderTrade: function(side) {
        const div = document.getElementById(`team-${side.toLowerCase()}-roster`); div.innerHTML = '';
        let tot = 0;
        this.tradeState[side].forEach(p => {
            tot += p.fpts;
            div.innerHTML += `<div class="player-chip"><span>${p.name}</span><div><span class="score-val">${p.fpts}</span><span style="cursor:pointer;color:var(--danger);margin-left:8px;" onclick="app.remTrade('${side}',${p.id})">×</span></div></div>`;
        });
        document.getElementById(`val-${side.toLowerCase()}`).innerText = tot.toFixed(1);
    },
    remTrade: function(side, pid) {
        this.tradeState[side] = this.tradeState[side].filter(p => p.id !== pid);
        this.renderTrade(side); this.calcEquity();
    },
    calcEquity: function() {
        const A = this.tradeState.A.reduce((s,p)=>s+p.fpts,0);
        const B = this.tradeState.B.reduce((s,p)=>s+p.fpts,0);
        const d = A - B;
        const el = document.getElementById('trade-equity');
        const msg = document.getElementById('trade-message');
        el.innerText = (d>0?"+":"") + d.toFixed(1);
        el.className = d>0?"equity-positive":(d<0?"equity-negative":"");
        msg.innerText = d===0?"Even trade":`Team ${d>0?'A':'B'} wins by ${Math.abs(d).toFixed(1)}`;
    }
};
</script>
</body>
</html>
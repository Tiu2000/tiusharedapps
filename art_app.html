<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TIU Art Studio (Fast P2P)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent: #4a90e2;
            --toolbar-desktop: 60px;
            --toolbar-mobile: 80px;
            --header-height: 50px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh; 
            height: 100dvh; 
            width: 100vw;
            overscroll-behavior: none;
            touch-action: none;
            overflow: hidden;
        }

        /* --- Header --- */
        #header {
            height: var(--header-height);
            background-color: var(--panel-bg);
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid #444;
            gap: 10px;
            z-index: 20;
            overflow-x: auto;
            white-space: nowrap;
            flex-shrink: 0;
            padding-top: env(safe-area-inset-top); 
        }
        #header::-webkit-scrollbar { display: none; }

        .prop-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #3a3a3a;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        input[type="range"] { width: 80px; accent-color: var(--accent); cursor: pointer; }
        input[type="color"] { border: none; width: 28px; height: 28px; border-radius: 50%; overflow: hidden; cursor: pointer; background: none; padding: 0; }
        label { font-weight: bold; color: #aaa; text-transform: uppercase; font-size: 10px; }

        .btn-text {
            padding: 8px 12px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        /* --- Workspace --- */
        #workspace {
            display: flex;
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        /* --- Toolbar --- */
        #toolbar {
            background-color: var(--panel-bg);
            display: flex;
            align-items: center;
            z-index: 50;
            gap: 12px;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        @media (min-width: 601px) {
            #toolbar {
                width: var(--toolbar-desktop);
                flex-direction: column;
                border-right: 1px solid #444;
                padding-top: 20px;
                height: 100%;
            }
        }

        @media (max-width: 600px) {
            #workspace { flex-direction: column-reverse; } 
            #toolbar {
                width: 100%;
                flex-direction: row;
                justify-content: space-around;
                border-top: 1px solid #444;
                padding-bottom: calc(15px + env(safe-area-inset-bottom));
                min-height: var(--toolbar-mobile);
            }
            #header { gap: 15px; }
            .prop-group label { display: none; }
        }

        .tool-btn {
            width: 44px; height: 44px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            border-radius: 12px;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px;
            transition: all 0.2s;
        }
        .tool-btn.active { background-color: var(--accent); border-color: var(--accent); color: white; transform: translateY(-2px); }

        /* --- Canvas --- */
        #canvas-wrap {
            flex-grow: 1;
            position: relative;
            background-color: #ccc;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            width: 100%;
        }
        canvas {
            background-color: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
            touch-action: none;
        }

        /* --- P2P Modal --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 99; display: none;
            backdrop-filter: blur(4px);
        }
        #modal-overlay.active { display: block; }
        
        #p2p-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 320px;
            background-color: #252525;
            border: 1px solid #444;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 100;
            display: none;
        }
        #p2p-modal.active { display: block; }

        .modal-row { margin-bottom: 15px; }
        .p2p-input { 
            width: 100%; background: #151515; border: 1px solid #444; 
            color: var(--accent); padding: 12px; border-radius: 8px; 
            font-family: monospace; font-size: 14px; margin-top: 5px;
        }
        
        .status-badge {
            display: inline-flex; align-items: center; gap: 6px;
            font-size: 12px; color: #888; background: #333;
            padding: 4px 10px; border-radius: 20px;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #666; }
        .dot.green { background: #4cd964; box-shadow: 0 0 8px #4cd964; }

        #watermark {
            position: absolute; bottom: 20px; right: 20px;
            font-family: monospace; font-weight: 900; font-size: 24px;
            color: rgba(0,0,0,0.06); pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="header">
        <div class="prop-group">
            <input type="color" id="color-picker" value="#000000">
        </div>
        <div class="prop-group">
            <label>Size</label>
            <input type="range" id="size-slider" min="1" max="60" value="5">
        </div>
        <div class="prop-group">
            <label>Opacity</label>
            <input type="range" id="opacity-slider" min="1" max="100" value="100">
        </div>
        <div style="flex-grow: 1;"></div>
        <button class="btn-text" id="btn-import">Img</button>
        <button class="btn-text" id="btn-export">Save</button>
        <button class="btn-text" onclick="window.print()">Print</button>
        <button class="btn-text" id="btn-clear" style="color:#ff6b6b;">Clear</button>
        <input type="file" id="file-input" hidden accept="image/*">
    </div>

    <div id="workspace">
        <div id="toolbar">
            <div class="tool-btn active" id="tool-pencil" title="Pencil">‚úèÔ∏è</div>
            <div class="tool-btn" id="tool-brush" title="Brush">üñåÔ∏è</div>
            <div class="tool-btn" id="tool-soft" title="Airbrush">‚òÅÔ∏è</div>
            <div class="tool-btn" id="tool-eraser" title="Eraser">üßπ</div>
            <div style="flex-grow:1" class="spacer"></div>
            <div class="tool-btn" id="btn-collab" style="color: var(--accent);">ü§ù</div>
        </div>
        <div id="canvas-wrap">
            <div id="watermark">TIU</div>
            <canvas id="art-canvas"></canvas>
        </div>
    </div>

    <div id="modal-overlay"></div>
    <div id="p2p-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:white;">Collaborate</h3>
            <button id="close-modal" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-row">
            <label>MY ID</label>
            <div style="display:flex; gap:8px;">
                <input id="my-id" class="p2p-input" readonly value="Connecting...">
                <button class="btn-text" id="copy-btn" style="margin-top:5px;">Copy</button>
            </div>
            <button class="btn-text" id="retry-btn" style="width:100%; margin-top:8px; background:#444; display:none;">Retry Connection</button>
        </div>
        <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
        <div class="modal-row">
            <label>FRIEND'S ID</label>
            <div style="display:flex; gap:8px;">
                <input id="remote-id" class="p2p-input" placeholder="Paste ID here...">
                <button class="btn-text" id="connect-btn" style="margin-top:5px; background:var(--accent);">Join</button>
            </div>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <div class="status-badge">
                <div class="dot" id="status-dot"></div>
                <span id="status-text">Offline</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('art-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const wrap = document.getElementById('canvas-wrap');
        
        let state = {
            isDrawing: false,
            lx: 0, ly: 0,
            tool: 'pencil',
            color: '#000000',
            size: 5,
            opacity: 1.0
        };

        // --- LAG FIX CONFIGURATION ---
        let p2p = { 
            peer: null, 
            conn: null, 
            connected: false,
            lastSent: 0,
            throttleLimit: 25 // Ms between packets (approx 40fps)
        };

        function fitCanvas() {
            const temp = document.createElement('canvas');
            temp.width = canvas.width; temp.height = canvas.height;
            temp.getContext('2d').drawImage(canvas, 0,0);
            
            const rect = wrap.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;

            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(temp, 0, 0);
        }
        
        window.addEventListener('load', fitCanvas);
        window.addEventListener('resize', () => setTimeout(fitCanvas, 100));

        function getCoords(e) {
            const r = canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top };
            }
            return { x: e.clientX - r.left, y: e.clientY - r.top };
        }

        function render(d) {
            ctx.lineWidth = d.size;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalAlpha = d.opacity;

            ctx.beginPath();
            ctx.moveTo(d.lx, d.ly);
            ctx.lineTo(d.x, d.y);

            if(d.tool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.strokeStyle = 'rgba(0,0,0,1)';
                ctx.shadowBlur = 0;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = d.color;
                if(d.tool === 'soft') {
                    ctx.shadowBlur = d.size;
                    ctx.shadowColor = d.color;
                } else if(d.tool === 'brush') {
                    ctx.shadowBlur = 2;
                    ctx.shadowColor = d.color;
                } else {
                    ctx.shadowBlur = 0;
                }
            }
            ctx.stroke();
            ctx.globalCompositeOperation = 'source-over';
            ctx.shadowBlur = 0;
            ctx.globalAlpha = 1.0;
        }

        function start(e) {
            if(e.target !== canvas) return;
            if(e.cancelable) e.preventDefault(); 
            state.isDrawing = true;
            const p = getCoords(e);
            state.lx = p.x; state.ly = p.y;
            move(e);
        }

        function move(e) {
            if(!state.isDrawing) return;
            if(e.cancelable) e.preventDefault(); 

            const p = getCoords(e);
            const packet = {
                x: p.x, y: p.y, lx: state.lx, ly: state.ly,
                color: state.color, size: state.size, tool: state.tool, opacity: state.opacity
            };

            // Always render locally instantly
            render(packet);
            
            // --- ANTI-LAG SENDING LOGIC ---
            // Only send if connected AND enough time has passed
            const now = Date.now();
            if(p2p.connected && p2p.conn) {
                if(now - p2p.lastSent > p2p.throttleLimit) {
                    p2p.conn.send(packet);
                    p2p.lastSent = now;
                }
            }

            state.lx = p.x; state.ly = p.y;
        }

        function end() { state.isDrawing = false; }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('mousemove', move);
        window.addEventListener('mouseup', end);
        
        canvas.addEventListener('touchstart', start, {passive: false});
        canvas.addEventListener('touchmove', move, {passive: false});
        window.addEventListener('touchend', end);

        // UI Logic
        ['pencil','brush','soft','eraser'].forEach(t => {
            document.getElementById('tool-'+t).addEventListener('click', e => {
                state.tool = t;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
            });
        });

        document.getElementById('color-picker').addEventListener('input', e => state.color = e.target.value);
        document.getElementById('size-slider').addEventListener('input', e => state.size = parseInt(e.target.value));
        document.getElementById('opacity-slider').addEventListener('input', e => state.opacity = e.target.value/100);
        
        document.getElementById('btn-import').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => {
            if(e.target.files && e.target.files[0]) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img,0,0, canvas.width, canvas.height);
                img.src = URL.createObjectURL(e.target.files[0]);
            }
        };
        document.getElementById('btn-export').onclick = () => {
            const a = document.createElement('a');
            a.download = 'tiu-art.png';
            a.href = canvas.toDataURL();
            a.click();
        };
        document.getElementById('btn-clear').onclick = () => {
            if(confirm("Clear canvas?")) {
                ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
            }
        };

        // P2P Logic
        const modal = document.getElementById('p2p-modal');
        const overlay = document.getElementById('modal-overlay');
        const idBox = document.getElementById('my-id');
        const dot = document.getElementById('status-dot');
        const statusTxt = document.getElementById('status-text');

        function toggleP2P(show) {
            modal.classList.toggle('active', show);
            overlay.classList.toggle('active', show);
        }
        document.getElementById('btn-collab').onclick = () => toggleP2P(true);
        document.getElementById('close-modal').onclick = () => toggleP2P(false);
        overlay.onclick = () => toggleP2P(false);

        function initNetwork() {
            idBox.value = "Generating...";
            document.getElementById('retry-btn').style.display = 'none';
            const uid = "tiu-" + Math.floor(Math.random()*999999);
            
            p2p.peer = new Peer(uid, {
                debug: 1,
                config: {'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]}
            });

            p2p.peer.on('open', id => {
                idBox.value = id;
                setStatus(false, "Ready to Connect");
            });

            p2p.peer.on('connection', conn => {
                setupConn(conn);
            });

            p2p.peer.on('error', err => {
                console.error(err);
                idBox.value = "Connection Failed";
                document.getElementById('retry-btn').style.display = 'block';
                setStatus(false, "Server Error (Use Firefox or Localhost)");
            });
        }

        function setupConn(conn) {
            p2p.conn = conn;
            setStatus(true, "Connecting...");
            conn.on('open', () => {
                p2p.connected = true;
                setStatus(true, "Connected!");
                toggleP2P(false);
            });
            conn.on('data', data => render(data));
            conn.on('close', () => {
                p2p.connected = false;
                setStatus(false, "Friend Left");
            });
        }

        function setStatus(active, text) {
            statusTxt.innerText = text;
            dot.className = active ? "dot green" : "dot";
        }

        document.getElementById('connect-btn').onclick = () => {
            const fid = document.getElementById('remote-id').value;
            if(!fid) return alert("Enter Friend ID");
            if(p2p.peer) setupConn(p2p.peer.connect(fid));
        };
        document.getElementById('copy-btn').onclick = () => {
            idBox.select();
            document.execCommand('copy');
            alert("ID Copied");
        };
        document.getElementById('retry-btn').onclick = () => {
            if(p2p.peer) p2p.peer.destroy();
            initNetwork();
        };

        initNetwork();
    </script>
</body>
</html>
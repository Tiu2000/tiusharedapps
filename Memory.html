<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Memory V36 (Victory Edition)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<style>
    :root { --bg: #050505; --panel: #111; --neon: #00ffcc; --warn: #ff3366; --text: #fff; }
    body { font-family: 'Segoe UI', monospace; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }

    #container { max-width: 600px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; height: 100%; position: relative; }
    
    /* TOP BAR */
    .header { background: var(--panel); padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .status-dot { width: 10px; height: 10px; background: #444; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .status-dot.ok { background: #0f0; box-shadow: 0 0 8px #0f0; }
    
    .score-board { display: flex; gap: 15px; }
    .score { font-size: 1.2em; font-weight: bold; }
    .score.active { color: var(--neon); text-shadow: 0 0 10px rgba(0,255,204,0.4); }

    /* TURN BANNER */
    .banner { text-align: center; font-size: 1.4em; padding: 12px; border-radius: 8px; border: 1px solid #333; margin-bottom: 15px; background: #111; font-weight: 900; letter-spacing: 1px; transition: 0.3s; }
    .banner.my-turn { background: rgba(0,255,204,0.1); color: var(--neon); border-color: var(--neon); }
    
    /* GRID */
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex: 1; perspective: 1000px; }
    .card { aspect-ratio: 4/5; position: relative; transform-style: preserve-3d; transition: transform 0.4s; cursor: pointer; }
    .card.flipped, .card.matched { transform: rotateY(180deg); }
    .card.matched { opacity: 0.3; }
    
    .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2.5em; border: 2px solid #333; background: #222; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
    .front::after { content: "?"; color: #444; font-weight: bold; font-size: 1.5rem; }
    .back { background: #fff; transform: rotateY(180deg); color: #000; }

    /* MENU OVERLAY */
    #menu, #winner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
    #winner-overlay { display: none; background: rgba(0,0,0,0.85); }
    
    .box { background: #111; padding: 40px; border: 1px solid var(--neon); width: 320px; text-align: center; border-radius: 15px; box-shadow: 0 0 30px rgba(0,255,204,0.1); }
    h1 { margin: 0 0 20px 0; color: var(--neon); text-transform: uppercase; letter-spacing: 2px; }
    input { width: 100%; padding: 12px; font-size: 1.5em; text-align: center; margin: 15px 0; text-transform: uppercase; background: #000; color: var(--neon); border: 2px solid #444; border-radius: 8px; }
    button { padding: 15px; width: 100%; background: var(--neon); color: #000; font-weight: bold; font-size: 1.1em; border: none; cursor: pointer; margin-top: 10px; border-radius: 50px; transition: transform 0.1s; }
    button:active { transform: scale(0.95); }
    
    /* WINNER TEXT */
    .win-title { font-size: 3em; color: var(--neon); margin-bottom: 10px; text-shadow: 0 0 20px var(--neon); }
    .win-sub { font-size: 1.2em; color: #fff; margin-bottom: 30px; }
</style>
</head>
<body onclick="enableAudio()">

<div id="menu">
    <div class="box">
        <h1>Memory V36</h1>
        <input type="text" id="code-input" placeholder="CODE" maxlength="4">
        <button onclick="startGuest()">JOIN GAME</button>
        <div style="margin:20px 0; height:1px; background:#333;"></div>
        <button style="background:#333; color:#fff; border:1px solid #555;" onclick="startHost()">HOST GAME</button>
    </div>
</div>

<div id="winner-overlay">
    <div class="box" style="border-color: #fff;">
        <div class="win-title">WINNER!</div>
        <div id="winner-name" class="win-sub">HOST</div>
        <button id="restart-btn" onclick="restartGame()">PLAY AGAIN</button>
        <div id="guest-wait-msg" style="display:none; color:#888; margin-top:10px;">Waiting for Host...</div>
    </div>
</div>

<div id="container">
    <div class="header">
        <div><div id="dot" class="status-dot"></div> <span id="status-txt" style="font-size:0.8em; color:#888;">OFFLINE</span></div>
        <div class="score-board">
            <div id="score-h" class="score">HOST: 0</div>
            <div id="score-g" class="score">GUEST: 0</div>
        </div>
    </div>
    
    <div id="banner" class="banner">WAITING...</div>
    <div id="grid" class="grid"></div>
</div>

<script>
const APP_ID = "tiu-mem-v36-win-";
const EMOJIS = ['ðŸš€','ðŸ•','ðŸ±','ðŸŽ®','ðŸŒŸ','ðŸŽ¨','ðŸŽ­','ðŸ”¥'];
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

let peer, conn, role, pingInterval;
let state = { 
    deck: [], flipped: [], matched: [], 
    turn: 'host', scores: {h:0, g:0}, 
    seq: 0, gameOver: false, winner: null 
};

// --- AUDIO SYSTEM ---
function enableAudio() { if(audioCtx.state === 'suspended') audioCtx.resume(); }

function playSound(type) {
    enableAudio();
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);

    if (type === 'flip') {
        o.frequency.setValueAtTime(300, t);
        o.frequency.linearRampToValueAtTime(500, t + 0.1);
        g.gain.setValueAtTime(0.1, t);
        o.start(t); o.stop(t + 0.1);
    } 
    else if (type === 'match') {
        o.type = 'triangle';
        o.frequency.setValueAtTime(400, t);
        o.frequency.setValueAtTime(800, t + 0.1);
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t + 0.3);
        o.start(t); o.stop(t + 0.3);
    } 
    else if (type === 'fail') {
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(200, t);
        o.frequency.linearRampToValueAtTime(100, t + 0.2);
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t + 0.2);
        o.start(t); o.stop(t + 0.2);
    }
    else if (type === 'win') {
        o.type = 'square';
        o.frequency.setValueAtTime(500, t);
        o.frequency.linearRampToValueAtTime(1000, t + 0.5);
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t + 1.0);
        o.start(t); o.stop(t + 1.0);
    }
}

// --- NETWORK (HOST) ---
function startHost() {
    role = 'host';
    const code = Math.random().toString(36).substring(2,6).toUpperCase();
    resetState();
    
    setupUI(code);
    peer = new Peer(APP_ID + code);
    
    peer.on('connection', (c) => {
        conn = c;
        document.getElementById('dot').classList.add('ok');
        document.getElementById('status-txt').innerText = `CONNECTED`;
        
        conn.on('data', (raw) => {
            const data = JSON.parse(raw);
            if(data.type === 'PING') conn.send(JSON.stringify({ type: 'PONG', state: state }));
            if(data.type === 'CLICK') handleInput(data.idx, 'guest');
        });
        
        conn.on('close', () => location.reload());
    });
}

// --- NETWORK (GUEST) ---
function startGuest() {
    const code = document.getElementById('code-input').value.trim().toUpperCase();
    if(code.length !== 4) return alert("Enter 4-letter code");
    
    role = 'guest';
    setupUI(code);
    document.getElementById('restart-btn').style.display = 'none'; // Guests can't restart
    document.getElementById('guest-wait-msg').style.display = 'block';

    peer = new Peer();
    peer.on('open', () => {
        conn = peer.connect(APP_ID + code);
        
        conn.on('open', () => {
            document.getElementById('dot').classList.add('ok');
            document.getElementById('status-txt').innerText = `CONNECTED`;
            
            clearInterval(pingInterval);
            pingInterval = setInterval(() => {
                if(conn.open) conn.send(JSON.stringify({ type: 'PING' }));
            }, 1000);
        });
        
        conn.on('data', (raw) => {
            const data = JSON.parse(raw);
            if(data.type === 'PONG' || data.type === 'STATE') {
                if(data.sfx) playSound(data.sfx); // Play sound trigger from host
                if(data.state.seq > state.seq || data.state.seq === 0) {
                    state = data.state;
                    render();
                }
            }
        });
        
        conn.on('close', () => alert("Host Disconnected"));
    });
}

function broadcast(sfx = null) {
    state.seq++; 
    if(conn && conn.open) conn.send(JSON.stringify({ type: 'STATE', state: state, sfx: sfx }));
}

// --- GAME LOGIC (HOST ONLY) ---
function resetState() {
    state.deck = [...EMOJIS, ...EMOJIS].sort(()=>Math.random()-0.5);
    state.flipped = [];
    state.matched = [];
    state.scores = {h:0, g:0};
    state.turn = 'host';
    state.gameOver = false;
    state.winner = null;
    state.seq++;
}

function restartGame() {
    resetState();
    render();
    broadcast('flip'); // Just a sound to wake up guest
}

function handleInput(idx, player) {
    if(state.gameOver || state.matched.includes(idx) || state.flipped.includes(idx)) return;
    if(state.turn !== player) return; // Not your turn
    
    // 1. Flip Card
    state.flipped.push(idx);
    playSound('flip');
    broadcast('flip');
    render();
    
    // 2. Check Pair
    if(state.flipped.length === 2) {
        setTimeout(() => {
            const [a,b] = state.flipped;
            let sfx = '';
            
            if(state.deck[a] === state.deck[b]) {
                // Match!
                state.matched.push(a,b);
                state.scores[state.turn === 'host' ? 'h' : 'g']++;
                sfx = 'match';
                
                // Check Win
                if(state.matched.length === 16) {
                    state.gameOver = true;
                    sfx = 'win';
                    if(state.scores.h > state.scores.g) state.winner = "HOST WINS";
                    else if(state.scores.g > state.scores.h) state.winner = "GUEST WINS";
                    else state.winner = "DRAW!";
                }
            } else {
                // No match
                state.turn = (state.turn === 'host' ? 'guest' : 'host');
                sfx = 'fail';
            }
            
            state.flipped = [];
            render();
            playSound(sfx);
            broadcast(sfx);
            
        }, 1000);
    }
}

// --- UI ---
function setupUI(code) {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('status-txt').innerText = `ROOM: ${code}`;
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    for(let i=0; i<16; i++) {
        const d = document.createElement('div');
        d.className = 'card';
        d.innerHTML = `<div class="face front"></div><div class="face back"></div>`;
        d.onclick = () => {
            if(role === 'host') handleInput(i, 'host');
            else if(conn && conn.open) conn.send(JSON.stringify({ type: 'CLICK', idx: i }));
        };
        grid.appendChild(d);
    }
}

function render() {
    // 1. Banner
    const banner = document.getElementById('banner');
    if(state.gameOver) {
        banner.innerText = "GAME OVER";
        banner.className = "banner";
    } else {
        const isMyTurn = (role === state.turn);
        banner.innerText = isMyTurn ? "YOUR TURN" : `${state.turn.toUpperCase()}'S TURN`;
        banner.className = isMyTurn ? "banner my-turn" : "banner";
    }

    // 2. Scores
    const sH = document.getElementById('score-h');
    const sG = document.getElementById('score-g');
    sH.innerText = `HOST: ${state.scores.h}`;
    sG.innerText = `GUEST: ${state.scores.g}`;
    
    if(!state.gameOver) {
        sH.className = state.turn === 'host' ? 'score active' : 'score';
        sG.className = state.turn === 'guest' ? 'score active' : 'score';
    }

    // 3. Grid
    const cards = document.getElementsByClassName('card');
    for(let i=0; i<16; i++) {
        const card = cards[i];
        card.querySelector('.back').innerText = state.deck[i];
        
        const flipped = state.flipped.includes(i) || state.matched.includes(i);
        if(flipped) card.classList.add('flipped'); else card.classList.remove('flipped');
        if(state.matched.includes(i)) card.classList.add('matched');
    }

    // 4. Winner Overlay
    const winOverlay = document.getElementById('winner-overlay');
    if(state.gameOver) {
        winOverlay.style.display = 'flex';
        document.getElementById('winner-name').innerText = state.winner;
    } else {
        winOverlay.style.display = 'none';
    }
}
</script>
</body>
</html>
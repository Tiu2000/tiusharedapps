<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Memory V35 (Stable Engine)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<style>
    :root { --bg: #000; --panel: #111; --primary: #00ff00; --text: #fff; }
    body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; }

    #container { max-width: 600px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; height: 100%; }
    
    /* UI ELEMENTS */
    .header { background: var(--panel); padding: 10px; border: 1px solid #333; margin-bottom: 10px; display: flex; justify-content: space-between; }
    .status-dot { width: 10px; height: 10px; background: #555; border-radius: 50%; display: inline-block; }
    .status-dot.ok { background: #0f0; box-shadow: 0 0 8px #0f0; }
    
    .banner { text-align: center; font-size: 1.5em; padding: 15px; border: 1px solid #333; margin-bottom: 10px; background: #111; font-weight: bold; }
    .banner.my-turn { background: #003300; color: #00ff00; border-color: #00ff00; }
    
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex: 1; }
    .card { background: #222; border: 1px solid #444; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 2em; }
    .card.flipped { background: #eee; color: #000; }
    .card.matched { opacity: 0.2; }
    
    .log-box { height: 100px; background: #050505; border: 1px solid #333; margin-top: 10px; overflow-y: scroll; font-size: 0.7em; padding: 5px; color: #aaa; }

    /* MENU */
    #menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 99; }
    .box { background: #111; padding: 30px; border: 1px solid #00ff00; width: 300px; text-align: center; }
    input { width: 100%; padding: 10px; font-size: 1.2em; text-align: center; margin: 10px 0; text-transform: uppercase; background: #000; color: #fff; border: 1px solid #555; }
    button { padding: 10px; width: 100%; background: #00ff00; color: #000; font-weight: bold; border: none; cursor: pointer; margin-top: 5px; }
    button:hover { opacity: 0.8; }
</style>
</head>
<body>

<div id="menu">
    <div class="box">
        <h2 style="color:#00ff00; margin-top:0;">MEMORY V35</h2>
        <input type="text" id="code-input" placeholder="CODE" maxlength="4">
        <button onclick="startGuest()">JOIN GAME</button>
        <div style="margin:15px 0; height:1px; background:#333;"></div>
        <button style="background:#444; color:#fff;" onclick="startHost()">HOST GAME</button>
    </div>
</div>

<div id="container">
    <div class="header">
        <div><div id="dot" class="status-dot"></div> <span id="status-txt">OFFLINE</span></div>
        <div>H:<span id="s1">0</span> G:<span id="s2">0</span></div>
    </div>
    
    <div id="banner" class="banner">WAITING...</div>
    <div id="grid" class="grid"></div>
    <div id="log" class="log-box">System Ready...</div>
</div>

<script>
const APP_ID = "tiu-mem-v35-stable-";
const EMOJIS = ['üöÄ','üçï','üê±','üéÆ','üåü','üé®','üé≠','üî•'];
let peer, conn, role;
let pingInterval;
let state = { deck: [], flipped: [], matched: [], turn: 'host', scores: {h:0, g:0}, seq: 0 };

// --- LOGGING ---
function log(msg) {
    const b = document.getElementById('log');
    const t = new Date().toTimeString().split(' ')[0];
    b.innerHTML = `[${t}] ${msg}<br>` + b.innerHTML;
}

// --- NETWORKING ---
function startHost() {
    role = 'host';
    const code = Math.random().toString(36).substring(2,6).toUpperCase();
    state.deck = [...EMOJIS, ...EMOJIS].sort(()=>Math.random()-0.5);
    
    setupGame(code);
    log(`HOSTING: ${code}`);
    
    peer = new Peer(APP_ID + code);
    
    peer.on('connection', (c) => {
        conn = c;
        log("GUEST CONNECTED");
        document.getElementById('dot').classList.add('ok');
        
        conn.on('data', (raw) => {
            const data = JSON.parse(raw);
            if(data.type === 'PING') { 
                conn.send(JSON.stringify({ type: 'PONG', state: state })); // Reply with state
            }
            if(data.type === 'CLICK') handleInput(data.idx, 'guest');
        });
        
        conn.on('close', () => {
            log("GUEST LEFT");
            document.getElementById('dot').classList.remove('ok');
        });
    });
}

function startGuest() {
    const code = document.getElementById('code-input').value.trim().toUpperCase();
    if(code.length !== 4) return alert("Bad Code");
    
    role = 'guest';
    setupGame(code);
    log(`DIALING ${code}...`);
    
    peer = new Peer();
    
    peer.on('open', () => {
        conn = peer.connect(APP_ID + code);
        
        conn.on('open', () => {
            log("CONNECTION OPEN");
            document.getElementById('dot').classList.add('ok');
            
            // HEARTBEAT: Ping host every 1s to pull state
            clearInterval(pingInterval);
            pingInterval = setInterval(() => {
                if(conn.open) {
                    conn.send(JSON.stringify({ type: 'PING' }));
                }
            }, 1000);
        });
        
        conn.on('data', (raw) => {
            const data = JSON.parse(raw);
            if(data.type === 'PONG' || data.type === 'STATE') {
                // We received data! Connection is alive.
                if(data.state.seq > state.seq || data.state.seq === 0) {
                    state = data.state;
                    render();
                }
            }
        });
        
        conn.on('close', () => {
            log("DISCONNECTED");
            document.getElementById('dot').classList.remove('ok');
            clearInterval(pingInterval);
        });
    });
}

function broadcast() {
    state.seq++; // Bump sequence
    if(conn && conn.open) {
        conn.send(JSON.stringify({ type: 'STATE', state: state }));
    }
}

// --- GAME LOGIC ---
function handleInput(idx, player) {
    // Host validates everything
    if(state.locked) return;
    if(state.matched.includes(idx)) return;
    if(state.flipped.includes(idx)) return;
    if(state.turn !== player) return log(`Ignored ${player} (Not their turn)`);
    
    state.flipped.push(idx);
    render();
    broadcast();
    
    if(state.flipped.length === 2) {
        state.locked = true;
        setTimeout(() => {
            const [a,b] = state.flipped;
            if(state.deck[a] === state.deck[b]) {
                state.matched.push(a,b);
                state.scores[state.turn === 'host' ? 'h' : 'g']++;
                log("MATCH!");
            } else {
                state.turn = (state.turn === 'host' ? 'guest' : 'host');
                log("NO MATCH - SWITCH TURN");
            }
            state.flipped = [];
            state.locked = false;
            render();
            broadcast();
        }, 1000);
    }
}

// --- UI ---
function setupGame(code) {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('status-txt').innerText = `ROOM: ${code}`;
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    for(let i=0; i<16; i++) {
        const d = document.createElement('div');
        d.className = 'card';
        d.onclick = () => onCardClick(i);
        grid.appendChild(d);
    }
}

function onCardClick(i) {
    if(role === 'host') handleInput(i, 'host');
    else if(conn && conn.open) {
        // Guest just sends click, ignores local validation to prevent stuck UI
        conn.send(JSON.stringify({ type: 'CLICK', idx: i }));
    }
}

function render() {
    const banner = document.getElementById('banner');
    if(state.deck.length === 0) return;
    
    const isMyTurn = (role === state.turn);
    banner.innerText = isMyTurn ? "YOUR TURN" : `${state.turn.toUpperCase()}'S TURN`;
    banner.className = isMyTurn ? "banner my-turn" : "banner";
    
    document.getElementById('s1').innerText = state.scores.h;
    document.getElementById('s2').innerText = state.scores.g;
    
    const cards = document.getElementsByClassName('card');
    for(let i=0; i<16; i++) {
        const card = cards[i];
        const flipped = state.flipped.includes(i) || state.matched.includes(i);
        card.className = 'card' + (flipped ? ' flipped' : '') + (state.matched.includes(i) ? ' matched' : '');
        card.innerText = flipped ? state.deck[i] : '';
    }
}
</script>
</body>
</html>
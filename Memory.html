<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU Memory (V27 Broadcast)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --surface: #1a1a1a; --primary: #00ff9d; --text: #eee; }
        body {
            font-family: 'Courier New', monospace; background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            margin: 0; padding: 10px; box-sizing: border-box;
        }

        /* LOBBY */
        #lobby { background: var(--surface); padding: 25px; border-radius: 12px; width: 100%; max-width: 320px; text-align: center; border: 1px solid #333; }
        button {
            padding: 12px; font-weight: bold; cursor: pointer; border: none; border-radius: 6px;
            font-family: inherit; text-transform: uppercase; margin-top: 10px; width: 100%; font-size: 1rem;
            transition: 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-host { background: #9d46ff; color: white; }
        .btn-join { background: var(--primary); color: black; }
        .btn-resync { background: #ff3333; color: white; width: auto; padding: 6px 12px; font-size: 0.75rem; margin: 0; }
        
        input { 
            padding: 12px; font-size: 1.4rem; text-align: center; width: 100%; 
            box-sizing: border-box; margin-bottom: 10px; background: #000; color: white; border: 1px solid #444; border-radius: 6px;
        }

        /* GAME UI */
        #game-view { display: none; width: 100%; max-width: 500px; flex-direction: column; align-items: center; }

        /* HEADER */
        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #151515; padding: 10px; border-radius: 8px; border: 1px solid #333; box-sizing: border-box;}
        .pulse { width: 8px; height: 8px; background: #444; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .pulse.active { background: #00ff9d; box-shadow: 0 0 8px #00ff9d; }

        /* SCORES */
        .scoreboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 20px; }
        .p-card { background: #222; padding: 15px; text-align: center; border: 2px solid transparent; border-radius: 8px; }
        .p-card.active { border-color: var(--primary); background: #1a2e25; color: var(--primary); }
        .score { font-size: 1.8rem; display: block; font-weight: bold; margin-top: 5px; }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; aspect-ratio: 4/5; perspective: 1000px; }
        .card {
            background: #2c3e50; border-radius: 6px; position: relative; cursor: pointer;
            transform-style: preserve-3d; transition: transform 0.25s;
        }
        .card.flipped, .card.matched { transform: rotateY(180deg); }
        .card.matched { opacity: 0.3; }
        
        .face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center; font-size: 2.2rem;
        }
        .back { background: #eee; transform: rotateY(180deg); color: #000; border-radius: 6px; }

        /* LOGS */
        #console-log {
            width: 100%; height: 100px; background: #080808; color: #00ff9d; font-size: 0.7rem;
            overflow-y: scroll; margin-top: 20px; padding: 10px; border: 1px solid #333; box-sizing: border-box; font-family: monospace;
        }
        .log-entry { margin-bottom: 2px; opacity: 0.8; }
    </style>
</head>
<body onclick="resumeAudio()">

    <div id="lobby">
        <h3>TIU MEMORY V27</h3>
        <button class="btn-host" onclick="initHost()">HOST GAME</button>
        <div style="margin: 15px 0; color:#555">- OR -</div>
        <input type="text" id="code-input" placeholder="CODE" maxlength="4">
        <button class="btn-join" onclick="initGuest()">JOIN GAME</button>
    </div>

    <div id="game-view">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <div id="hb" class="pulse"></div>
                <span id="role-display" style="font-size:0.8rem; color:#aaa;"></span>
            </div>
            <button class="btn-resync" onclick="requestSync()">ðŸ”„ RESYNC</button>
        </div>

        <div id="turn-banner" style="font-size:1.1rem; font-weight:bold; margin-bottom:15px; color:#888; text-align:center; width:100%;">WAITING...</div>

        <div class="scoreboard">
            <div id="p-host" class="p-card">HOST <span id="s-host" class="score">0</span></div>
            <div id="p-guest" class="p-card">GUEST <span id="s-guest" class="score">0</span></div>
        </div>

        <div id="grid" class="grid"></div>
        <div id="console-log">Logs initialized...</div>
    </div>

    <script>
        // --- CONFIG ---
        const APP_ID = "tiu-mem-v27-bcast-";
        const EMOJIS = ['ðŸš€','ðŸ•','ðŸ±','ðŸŒµ','ðŸŽ¸','ðŸ¦','ðŸ’Ž','ðŸ”¥'];
        const logBox = document.getElementById('console-log');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- STATE ---
        let peer;
        let connections = []; // ARRAY for all connections (Host side)
        let guestConn; // Single connection (Guest side)
        let myRole;
        
        let gameState = {
            deck: [], flipped: [], matched: [],
            turn: 'host', scores: { host: 0, guest: 0 }, locked: false
        };

        // --- AUDIO ---
        function resumeAudio() { if(audioCtx.state==='suspended') audioCtx.resume(); }
        function playTone(freq, type) {
            resumeAudio();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type || 'sine'; o.frequency.value = freq;
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.15);
            o.stop(audioCtx.currentTime + 0.2);
        }

        // --- LOGGING ---
        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerText = `> ${msg}`;
            logBox.prepend(div);
        }

        // --- HOST ---
        function initHost() {
            const code = Math.random().toString(36).substring(2,6).toUpperCase();
            myRole = 'host';
            gameState.deck = [...EMOJIS, ...EMOJIS].sort(()=>Math.random()-0.5);
            
            setupUI(code);
            render();
            log("Hosting Room: " + code);

            peer = new Peer(APP_ID + code);
            peer.on('connection', c => {
                connections.push(c); // Add to list!
                log("Guest Connected! (Total: " + connections.length + ")");
                
                c.on('open', () => {
                    broadcast('init'); // Send immediate state
                });

                c.on('data', data => {
                    flashHeartbeat();
                    if(data.type === 'CLICK') {
                        log("Guest clicked " + data.index);
                        if(gameState.turn === 'guest') processMove(data.index);
                        else {
                            log("Ignored (Not guest turn)");
                            broadcast(); // Auto-resync them
                        }
                    }
                    if(data.type === 'REQ_SYNC') broadcast();
                });

                c.on('close', () => {
                    log("A connection closed.");
                    connections = connections.filter(conn => conn !== c); // Remove dead
                });
            });

            // HEARTBEAT: Force broadcast every 2s to ensure sync
            setInterval(() => {
                if(connections.length > 0) broadcast(null, true); 
            }, 2000);
        }

        // --- GUEST ---
        function initGuest() {
            const code = document.getElementById('code-input').value.trim().toUpperCase();
            if(code.length !== 4) return alert("Enter 4-letter code");
            myRole = 'guest';
            
            setupUI(code);
            log("Connecting to " + code + "...");
            
            peer = new Peer();
            peer.on('open', () => {
                guestConn = peer.connect(APP_ID + code, { reliable: true });
                guestConn.on('open', () => {
                    log("Connected! Waiting for state...");
                    requestSync();
                });
                
                guestConn.on('data', data => {
                    flashHeartbeat();
                    if(data.type === 'STATE') {
                        gameState = data.state;
                        render();
                        if(data.snd) playTone(data.snd === 'match' ? 880 : 200, data.snd === 'match' ? 'triangle' : 'sawtooth');
                    }
                });

                guestConn.on('close', () => log("Connection Lost"));
                guestConn.on('error', e => log("Error: " + e));
            });
        }

        // --- NETWORKING (BROADCAST) ---
        function broadcast(sndTag, silentLog) {
            // Send to ALL active connections
            let sentCount = 0;
            connections.forEach(c => {
                if(c.open) {
                    c.send({ type: 'STATE', state: gameState, snd: sndTag });
                    sentCount++;
                }
            });
            if(!silentLog && sentCount > 0) log("Sent update to " + sentCount + " peers");
        }

        function requestSync() {
            if(guestConn && guestConn.open) guestConn.send({ type: 'REQ_SYNC' });
        }

        // --- GAME LOGIC (HOST ONLY) ---
        function processMove(i) {
            if(gameState.locked) return;
            if(gameState.matched.includes(i) || gameState.flipped.includes(i)) return;

            // 1. Flip
            gameState.flipped.push(i);
            playTone(400, 'sine');
            render(); 
            broadcast('flip'); 

            // 2. Check
            if(gameState.flipped.length === 2) {
                gameState.locked = true;
                const [a, b] = gameState.flipped;
                
                setTimeout(() => {
                    let snd = '';
                    if(gameState.deck[a] === gameState.deck[b]) {
                        gameState.matched.push(a, b);
                        gameState.scores[gameState.turn]++;
                        snd = 'match';
                        log("Match! Point: " + gameState.turn);
                    } else {
                        log("No Match. Switch turn.");
                        gameState.turn = (gameState.turn === 'host' ? 'guest' : 'host');
                        snd = 'nomatch';
                    }
                    
                    gameState.flipped = [];
                    gameState.locked = false;
                    
                    render();
                    broadcast(snd); // Broadcast result
                    playTone(snd==='match'?880:200, snd==='match'?'triangle':'sawtooth');
                }, 1000);
            }
        }

        // --- INPUT ---
        function onCardClick(i) {
            if(myRole === 'host') {
                if(gameState.turn === 'host') processMove(i);
                else log("Not your turn!");
            } 
            else if(myRole === 'guest') {
                if(gameState.turn === 'guest') {
                    if(guestConn && guestConn.open) guestConn.send({ type: 'CLICK', index: i });
                    else log("Offline!");
                } else {
                    log("Not your turn!");
                }
            }
        }

        // --- UI ---
        function setupUI(code) {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-view').style.display = 'flex';
            document.getElementById('role-display').innerText = `${myRole.toUpperCase()} | Room: ${code}`;
            
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for(let i=0; i<16; i++) {
                const el = document.createElement('div');
                el.className = 'card';
                el.onclick = () => onCardClick(i);
                el.innerHTML = `<div class="face front"></div><div class="face back"></div>`;
                grid.appendChild(el);
            }
        }

        function render() {
            const banner = document.getElementById('turn-banner');
            const isMyTurn = gameState.turn === myRole;
            banner.innerText = isMyTurn ? "YOUR TURN" : `${gameState.turn.toUpperCase()}'S TURN`;
            banner.style.color = isMyTurn ? "#00ff9d" : "#666";

            document.getElementById('s-host').innerText = gameState.scores.host;
            document.getElementById('s-guest').innerText = gameState.scores.guest;
            document.getElementById('p-host').className = gameState.turn === 'host' ? 'p-card active' : 'p-card';
            document.getElementById('p-guest').className = gameState.turn === 'guest' ? 'p-card active' : 'p-card';

            const cards = document.getElementsByClassName('card');
            for(let i=0; i<cards.length; i++) {
                const card = cards[i];
                card.querySelector('.back').innerText = gameState.deck[i];
                const isFlipped = gameState.flipped.includes(i) || gameState.matched.includes(i);
                
                if(isFlipped) card.classList.add('flipped');
                else card.classList.remove('flipped');
                
                if(gameState.matched.includes(i)) card.classList.add('matched');
            }
        }

        function flashHeartbeat() {
            const hb = document.getElementById('hb');
            hb.classList.add('active');
            setTimeout(() => hb.classList.remove('active'), 150);
        }
    </script>
</body>
</html>
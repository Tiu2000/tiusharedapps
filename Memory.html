<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU Memory (V12 Final)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #bb86fc;
            --secondary: #03dac6;
        }
        body {
            font-family: 'Segoe UI', monospace;
            background: var(--bg);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            overflow: hidden;
        }

        /* LOBBY SCREEN */
        #lobby {
            margin-top: 15vh;
            background: var(--surface);
            padding: 2.5rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 15px;
            width: 320px;
            z-index: 100;
        }
        
        h2 { margin: 0 0 10px 0; color: #fff; }
        
        input {
            padding: 15px; font-size: 1.5rem; border-radius: 8px; border: 2px solid #444; 
            text-align: center; background: #222; color: var(--secondary); letter-spacing: 3px;
            text-transform: uppercase; font-weight: bold;
        }
        
        button {
            padding: 15px; cursor: pointer; font-weight: bold; border: none; border-radius: 8px;
            font-size: 1.1rem; transition: transform 0.1s; text-transform: uppercase;
        }
        button:active { transform: scale(0.98); }
        .btn-host { background: var(--primary); color: #000; margin-bottom: 10px; }
        .btn-join { background: var(--secondary); color: #000; }

        .divider { border-top: 1px solid #333; margin: 10px 0; position: relative; }
        .divider span { 
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%); 
            background: var(--surface); padding: 0 10px; color: #666; font-size: 0.8rem;
        }

        /* LOADING SCREEN */
        #loading-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); flex-direction: column; justify-content: center; align-items: center;
            z-index: 200;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--secondary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* GAME UI */
        #game-ui {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 650px;
            margin-top: 20px;
        }

        /* ROOM CODE DISPLAY (FIXED) */
        #room-info-bar {
            background: #333;
            padding: 10px 20px;
            border-radius: 50px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #room-label { color: #aaa; font-size: 0.9rem; }
        #display-code { 
            color: var(--primary); font-size: 1.8rem; font-weight: bold; letter-spacing: 2px; font-family: monospace;
        }

        /* SCORE BOARD */
        .header {
            display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px;
            background: var(--surface); padding: 15px; border-radius: 12px; box-sizing: border-box;
            border: 1px solid #333; position: relative;
        }
        
        .score-box { text-align: center; width: 100px; }
        .score-val { font-size: 1.8rem; font-weight: bold; display: block; margin-top: 5px;}
        .active-turn { color: var(--secondary); text-shadow: 0 0 15px var(--secondary); }
        .active-turn .score-val { transform: scale(1.1); transition: 0.3s; }

        /* CARD GRID */
        .grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            perspective: 1000px;
        }
        .card {
            width: 75px; height: 105px; position: relative;
            transform-style: preserve-3d; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            cursor: pointer;
        }
        .card.flipped, .card.matched { transform: rotateY(180deg); }
        .card.matched { opacity: 0.6; cursor: default; }
        
        .face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2rem; border-radius: 10px; border: 2px solid #444;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .front { background: #2c2c2c; } 
        .front::after { content: "TIU"; color: #555; font-size: 0.8rem; font-weight: bold; transform: rotate(-45deg); }
        .back { background: white; transform: rotateY(180deg); color: black; border-color: white;}

        #status-msg { margin-top: 15px; color: #888; font-style: italic; min-height: 24px; font-size: 1.1rem; }
        
        #game-hash { position: absolute; bottom: 5px; right: 10px; font-size: 0.6rem; color: #444; }

    </style>
</head>
<body>

    <div id="lobby">
        <h2>TIU Memory</h2>
        
        <button class="btn-host" onclick="startHost()">HOST GAME</button>
        
        <div class="divider"><span>OR</span></div>

        <div style="text-align: left; color: #aaa; font-size: 0.8rem; margin-left: 5px;">ENTER ROOM CODE:</div>
        <input type="text" id="join-code" placeholder="----" maxlength="4">
        <button class="btn-join" onclick="startGuest()">JOIN GAME</button>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-size: 1.2rem; color: #ccc;">Connecting...</div>
        <button onclick="location.reload()" style="margin-top:20px; background:transparent; border:1px solid #555; color:#888; padding:8px 15px; border-radius: 20px;">Cancel</button>
    </div>

    <div id="game-ui">
        <div id="room-info-bar">
            <span id="room-label">ROOM CODE:</span>
            <span id="display-code">----</span>
        </div>
        
        <div class="header">
            <div id="p1-ui" class="score-box">HOST<span id="s1" class="score-val">0</span></div>
            <div style="align-self:center; color:#555; font-weight:bold;">VS</div>
            <div id="p2-ui" class="score-box">GUEST<span id="s2" class="score-val">0</span></div>
            <div id="game-hash">ID: ...</div>
        </div>
        
        <div id="grid" class="grid"></div>
        <div id="status-msg">Waiting for opponent...</div>
    </div>

    <script>
        // --- SOUNDS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const t = audioCtx.currentTime;

            if(type==='flip'){
                osc.frequency.setValueAtTime(400,t); osc.frequency.linearRampToValueAtTime(600,t+0.1);
                gain.gain.setValueAtTime(0.1,t); gain.gain.linearRampToValueAtTime(0,t+0.1);
                osc.start(t); osc.stop(t+0.1);
            } else if(type==='match'){
                osc.type='triangle'; osc.frequency.setValueAtTime(500,t); osc.frequency.setValueAtTime(800,t+0.2);
                gain.gain.setValueAtTime(0.1,t); gain.gain.linearRampToValueAtTime(0,t+0.3);
                osc.start(t); osc.stop(t+0.3);
            } else if(type==='nomatch'){
                osc.type='sawtooth'; osc.frequency.setValueAtTime(200,t); osc.frequency.linearRampToValueAtTime(100,t+0.2);
                gain.gain.setValueAtTime(0.1,t); gain.gain.linearRampToValueAtTime(0,t+0.2);
                osc.start(t); osc.stop(t+0.2);
            }
        }

        // --- CONFIG ---
        const APP_PREFIX = "tiu-mem-v12-final-"; 
        const EMOJIS = ['üöÄ', 'üçï', 'üê±', 'üåµ', 'üé∏', 'üç¶', 'üíé', 'üî•'];

        // --- STATE ---
        let peer, conn;
        let myRole = ''; 
        let deck = []; 
        let turn = 'host';
        let scores = { host: 0, guest: 0 };
        let flipped = [];
        let matched = [];
        let isLocked = false;
        let syncInterval = null;
        let currentRoomCode = "";

        // --- UTILS ---
        function getHash(arr) {
            if(!arr || arr.length===0) return "WAITING";
            let s = arr.join(""), h = 0;
            for(let i=0; i<s.length; i++) h = Math.imul(31, h) + s.charCodeAt(i) | 0;
            return "#" + Math.abs(h).toString(16).substring(0,4).toUpperCase();
        }
        function generateCode() {
            return Math.random().toString(36).substring(2,6).toUpperCase();
        }
        function setStatus(msg, color) {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            el.style.color = color || "#888";
        }

        // --- HOST ---
        function startHost() {
            currentRoomCode = generateCode();
            myRole = 'host';
            
            // Host generates deck
            deck = [...EMOJIS, ...EMOJIS].sort(() => Math.random() - 0.5);
            
            // Show UI
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            document.getElementById('display-code').innerText = currentRoomCode;
            
            renderGame();
            setStatus("Waiting for opponent to join...");
            
            peer = new Peer(APP_PREFIX + currentRoomCode);
            
            peer.on('connection', (c) => {
                conn = c;
                conn.on('open', () => {
                    sendState(); // Send deck immediately
                    setStatus("Opponent connected! Your turn.", "#4ade80");
                });

                conn.on('data', (data) => {
                    if (data.type === 'REQ_SYNC') sendState();
                    else if (data.type === 'CLICK') processClick(data.index);
                });
                
                conn.on('close', () => {
                    alert("Guest disconnected");
                    location.reload();
                });
            });
            
            peer.on('error', err => alert("Network Error: " + err.type));
        }

        function sendState(snd) {
            if(conn && conn.open) {
                conn.send({ 
                    type: 'STATE', 
                    deck: deck, 
                    turn: turn, 
                    scores: scores, 
                    flipped: flipped, 
                    matched: matched,
                    sound: snd
                });
            }
        }

        // --- GUEST ---
        function startGuest() {
            const code = document.getElementById('join-code').value.trim().toUpperCase();
            if(code.length < 2) return alert("Please enter the 4-character Room Code.");
            
            currentRoomCode = code;
            myRole = 'guest';

            document.getElementById('lobby').style.display = 'none';
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = `Joining Room ${code}...`;

            peer = new Peer(); 
            
            peer.on('open', () => {
                conn = peer.connect(APP_PREFIX + code, { reliable: true });

                conn.on('open', () => {
                    // Start requesting data
                    startSyncLoop();
                });

                conn.on('data', handleIncoming);
                conn.on('close', () => {
                    alert("Host Closed Connection");
                    location.reload();
                });
            });

            peer.on('error', (err) => {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('lobby').style.display = 'flex';
                if(err.type === 'peer-unavailable') alert(`Room "${code}" not found! Ask the Host for the code.`);
                else alert("Error: " + err.type);
            });
        }

        function startSyncLoop() {
            if(conn && conn.open) conn.send({ type: 'REQ_SYNC' });

            if(syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(() => {
                if(deck.length > 0) {
                    clearInterval(syncInterval);
                    document.getElementById('loading-overlay').style.display = 'none';
                } else {
                    if(conn && conn.open) conn.send({ type: 'REQ_SYNC' });
                }
            }, 1000);
        }

        // --- LOGIC ---
        function handleIncoming(data) {
            if (myRole === 'guest' && data.type === 'STATE') {
                const oldLen = deck.length;
                deck = data.deck;
                turn = data.turn;
                scores = data.scores;
                flipped = data.flipped;
                matched = data.matched;
                
                // Force Render if it's the first load
                renderGame(oldLen === 0);
                if(data.sound) playTone(data.sound);
            }
        }

        function onCardClick(i) {
            if(myRole === 'host') processClick(i);
            else if(myRole === 'guest') conn.send({ type: 'CLICK', index: i });
        }

        function processClick(i) {
            if(isLocked || matched.includes(i) || flipped.includes(i)) return;
            if(turn !== 'host' && myRole === 'host') return;

            flipped.push(i);
            sendState('flip'); 
            playTone('flip');
            renderGame();

            if(flipped.length === 2) {
                isLocked = true;
                setTimeout(checkMatch, 600);
            }
        }

        function checkMatch() {
            const [a, b] = flipped;
            if(deck[a] === deck[b]) {
                matched.push(a, b);
                if(turn === 'host') scores.host++; else scores.guest++;
                flipped = [];
                sendState('match');
                playTone('match');
            } else {
                flipped = [];
                turn = (turn === 'host') ? 'guest' : 'host';
                sendState('nomatch');
                playTone('nomatch');
            }
            isLocked = false;
            renderGame();
        }

        // --- RENDER ---
        function renderGame(force = false) {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            
            document.getElementById('game-hash').innerText = "ID: " + getHash(deck);

            // Scores
            document.getElementById('s1').innerText = scores.host;
            document.getElementById('s2').innerText = scores.guest;
            
            const p1 = document.getElementById('p1-ui');
            const p2 = document.getElementById('p2-ui');

            p1.className = 'score-box ' + (turn==='host' ? 'active-turn' : '');
            p2.className = 'score-box ' + (turn==='guest' ? 'active-turn' : '');

            // Status Text
            if(matched.length === deck.length && deck.length > 0) {
                setStatus(scores.host > scores.guest ? "HOST WINS!" : (scores.guest > scores.host ? "GUEST WINS!" : "DRAW!"), "gold");
                // Final win sound if not played
            } else if (deck.length > 0) {
                const isMyTurn = (turn === myRole);
                setStatus(isMyTurn ? "YOUR TURN" : "OPPONENT'S TURN", isMyTurn ? "#4ade80" : "#888");
            }

            // Grid
            const grid = document.getElementById('grid');
            if(force || grid.childElementCount !== deck.length) {
                grid.innerHTML = "";
                deck.forEach((emoji, i) => {
                    const d = document.createElement('div');
                    d.className = 'card';
                    d.onclick = () => onCardClick(i);
                    d.innerHTML = `<div class="face front"></div><div class="face back">${emoji}</div>`;
                    grid.appendChild(d);
                });
            }

            // Classes
            deck.forEach((_, i) => {
                const el = grid.children[i];
                if(el) {
                    el.className = 'card'; // Reset
                    if(flipped.includes(i)) el.classList.add('flipped');
                    if(matched.includes(i)) el.classList.add('matched');
                }
            });
        }
    </script>
</body>
</html>
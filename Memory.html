<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU Memory (V24 Nuclear Sync)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #000; --surface: #1a1a1a; --primary: #00ffcc; --text: #fff; }
        body {
            font-family: monospace; background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            margin: 0; padding: 20px; box-sizing: border-box;
        }

        /* UI ELEMENTS */
        button {
            padding: 10px 20px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px;
            font-family: monospace; text-transform: uppercase; margin: 5px;
        }
        .btn-host { background: #9d46ff; color: white; width: 100%; padding: 20px; font-size: 1.2rem; }
        .btn-join { background: var(--primary); color: black; width: 100%; padding: 20px; font-size: 1.2rem; }
        .btn-resync { background: #ff3333; color: white; border-radius: 20px; font-size: 0.8rem; }
        
        input { padding: 15px; font-size: 1.5rem; text-align: center; width: 100%; box-sizing: border-box; margin-bottom: 10px; }

        #lobby { background: var(--surface); padding: 30px; border-radius: 10px; width: 100%; max-width: 320px; }
        #game-view { display: none; width: 100%; max-width: 600px; flex-direction: column; align-items: center; }

        /* HEADER */
        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pulse { width: 10px; height: 10px; background: #333; border-radius: 50%; display: inline-block; }
        .pulse.active { background: #00ff00; box-shadow: 0 0 10px #00ff00; }

        /* SCOREBOARD */
        .scoreboard {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 20px;
        }
        .p-card { background: #222; padding: 15px; text-align: center; border: 1px solid #333; border-radius: 8px; }
        .p-card.active { border: 2px solid var(--primary); background: #111; color: var(--primary); }
        .score { font-size: 2rem; display: block; }

        /* GRID */
        .grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; aspect-ratio: 4/5;
        }
        .card {
            background: #2c3e50; border-radius: 6px; position: relative; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
            border: 2px solid #444; transition: transform 0.2s;
        }
        .card.flipped { background: white; transform: rotateY(180deg); }
        .card.flipped span { display: block; transform: rotateY(180deg); } /* Correct emoji flip */
        .card span { display: none; }
        .card.flipped span { display: block; }
        
        /* LOGS */
        #console-log {
            width: 100%; height: 60px; background: #111; color: #666; font-size: 0.7rem;
            overflow-y: scroll; margin-top: 20px; padding: 5px; border: 1px solid #333;
        }
    </style>
</head>
<body onclick="resumeAudio()">

    <div id="lobby">
        <h2 style="text-align:center">MEMORY V24</h2>
        <button class="btn-host" onclick="initHost()">HOST GAME</button>
        <p style="text-align:center; color:#555">- OR -</p>
        <input type="text" id="code-input" placeholder="ENTER CODE" maxlength="4">
        <button class="btn-join" onclick="initGuest()">JOIN GAME</button>
    </div>

    <div id="game-view">
        <div class="header">
            <div>
                <div id="hb" class="pulse"></div>
                <span id="role-display" style="font-size:0.8rem; color:#888;"></span>
            </div>
            <button class="btn-resync" onclick="requestSync()">ðŸ”„ RESYNC</button>
        </div>

        <div style="text-align:center; font-size:1.5rem; margin-bottom:10px; font-weight:bold" id="turn-banner">
            WAITING...
        </div>

        <div class="scoreboard">
            <div id="p-host" class="p-card">HOST <span id="s-host" class="score">0</span></div>
            <div id="p-guest" class="p-card">GUEST <span id="s-guest" class="score">0</span></div>
        </div>

        <div id="grid" class="grid"></div>
        
        <div id="console-log">Logs will appear here...</div>
    </div>

    <script>
        // --- SETUP ---
        const APP_ID = "tiu-mem-v24-nuke-";
        const EMOJIS = ['ðŸš€','ðŸ•','ðŸ±','ðŸŒµ','ðŸŽ¸','ðŸ¦','ðŸ’Ž','ðŸ”¥'];
        const logBox = document.getElementById('console-log');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- STATE ---
        let peer, conn, myRole;
        let gameState = {
            deck: [],
            flipped: [],
            matched: [],
            turn: 'host',
            scores: { host: 0, guest: 0 },
            locked: false
        };

        // --- AUDIO ---
        function resumeAudio() { if(audioCtx.state==='suspended') audioCtx.resume(); }
        function playTone(freq, type) {
            resumeAudio();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type || 'sine'; o.frequency.value = freq;
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            o.stop(audioCtx.currentTime + 0.1);
        }

        // --- LOGGING ---
        function log(msg) {
            logBox.innerHTML = `> ${msg}<br>` + logBox.innerHTML;
        }

        // --- HOST ---
        function initHost() {
            const code = Math.random().toString(36).substring(2,6).toUpperCase();
            myRole = 'host';
            gameState.deck = [...EMOJIS, ...EMOJIS].sort(()=>Math.random()-0.5);
            
            setupUI(code);
            render(); // Draw immediately

            peer = new Peer(APP_ID + code);
            peer.on('open', id => log("Room Created: " + code));
            
            peer.on('connection', c => {
                conn = c;
                log("Guest Connected!");
                setupConn();
                // Host Heartbeat: Send state EVERY second blindly
                setInterval(() => {
                    if(conn.open) sendState();
                }, 1000);
            });
        }

        // --- GUEST ---
        function initGuest() {
            const code = document.getElementById('code-input').value.trim().toUpperCase();
            if(code.length !== 4) return alert("Bad Code");
            myRole = 'guest';
            
            setupUI(code);
            log("Connecting...");
            
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(APP_ID + code, { reliable: true });
                conn.on('open', () => {
                    log("Connected! Requesting State...");
                    requestSync();
                });
                setupConn();
            });
        }

        // --- CONNECTION HANDLER ---
        function setupConn() {
            conn.on('data', data => {
                flashHeartbeat();
                
                if(data.type === 'STATE') {
                    // NUCLEAR UPDATE: Overwrite everything
                    gameState = data.state;
                    render();
                    if(data.snd) playTone(data.snd === 'match' ? 600 : 200, 'square');
                }
                
                if(data.type === 'CLICK' && myRole === 'host') {
                    handleGameClick(data.index);
                }

                if(data.type === 'REQ_SYNC' && myRole === 'host') {
                    log("Guest requested sync");
                    sendState();
                }
            });
            conn.on('close', () => log("Connection Lost"));
            conn.on('error', e => log("Error: " + e));
        }

        // --- GAME LOGIC (HOST AUTHORITATIVE) ---
        function handleGameClick(i) {
            if(gameState.locked) return;
            if(gameState.matched.includes(i) || gameState.flipped.includes(i)) return;
            
            // Check Turn
            if(gameState.turn !== 'host' && myRole === 'host') return; // Host clicked but not host turn?
            
            // Process Flip
            gameState.flipped.push(i);
            playTone(400);
            sendState(); // Immediate update on flip

            if(gameState.flipped.length === 2) {
                gameState.locked = true;
                const [a, b] = gameState.flipped;
                
                setTimeout(() => {
                    if(gameState.deck[a] === gameState.deck[b]) {
                        gameState.matched.push(a, b);
                        gameState.scores[gameState.turn]++;
                        playTone(600, 'square'); // Match Sound
                    } else {
                        gameState.turn = (gameState.turn === 'host' ? 'guest' : 'host');
                        playTone(200, 'sawtooth'); // Fail Sound
                    }
                    gameState.flipped = [];
                    gameState.locked = false;
                    sendState('resolve'); // Immediate update on resolve
                }, 1000);
            }
        }

        // --- USER INPUT ---
        function onCardClick(i) {
            if(myRole === 'host') {
                if(gameState.turn === 'host') handleGameClick(i);
                else log("Not your turn!");
            } else {
                if(gameState.turn === 'guest') {
                    conn.send({ type: 'CLICK', index: i });
                    log("Sent Click...");
                } else {
                    log("Not your turn!");
                }
            }
        }

        function requestSync() {
            if(conn && conn.open) {
                conn.send({ type: 'REQ_SYNC' });
                log("Requested Sync...");
            } else {
                log("Cannot Sync - Offline");
            }
        }

        function sendState(sndTag) {
            if(conn && conn.open) {
                conn.send({ type: 'STATE', state: gameState, snd: sndTag });
            }
        }

        // --- RENDER ---
        function setupUI(code) {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-view').style.display = 'flex';
            document.getElementById('role-display').innerText = `Room: ${code} | You: ${myRole.toUpperCase()}`;
            
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for(let i=0; i<16; i++) {
                let d = document.createElement('div');
                d.className = 'card';
                d.onclick = () => onCardClick(i);
                d.innerHTML = `<span></span>`;
                grid.appendChild(d);
            }
        }

        function render() {
            // Update Text
            const banner = document.getElementById('turn-banner');
            const isMyTurn = gameState.turn === myRole;
            banner.innerText = isMyTurn ? "YOUR TURN!" : "OPPONENT'S TURN";
            banner.style.color = isMyTurn ? "#00ffcc" : "#666";

            // Update Scores
            document.getElementById('s-host').innerText = gameState.scores.host;
            document.getElementById('s-guest').innerText = gameState.scores.guest;
            document.getElementById('p-host').className = gameState.turn === 'host' ? 'p-card active' : 'p-card';
            document.getElementById('p-guest').className = gameState.turn === 'guest' ? 'p-card active' : 'p-card';

            // Update Cards
            const cards = document.getElementsByClassName('card');
            for(let i=0; i<cards.length; i++) {
                const card = cards[i];
                const content = card.querySelector('span');
                content.innerText = gameState.deck[i];
                
                const isFlipped = gameState.flipped.includes(i) || gameState.matched.includes(i);
                if(isFlipped) card.classList.add('flipped');
                else card.classList.remove('flipped');
                
                if(gameState.matched.includes(i)) card.style.opacity = "0.3";
            }
        }

        function flashHeartbeat() {
            const hb = document.getElementById('hb');
            hb.classList.add('active');
            setTimeout(() => hb.classList.remove('active'), 100);
        }
    </script>
</body>
</html>
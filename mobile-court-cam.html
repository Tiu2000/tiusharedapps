<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Pro Court Cam v4</title>
    <style>
        /* --- GLOBAL LAYOUT --- */
        body {
            background-color: black;
            color: white;
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- THE STAGE --- */
        #stage {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        /* LAYER 1: The Recorded Video (Canvas) */
        canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 16/9;
            z-index: 1;
        }

        /* LAYER 2: The Control Interface */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: none;
        }

        /* --- CONTROL BUTTONS --- */
        .control-group {
            position: absolute;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .group-left { left: 20px; top: 50%; transform: translateY(-50%); }
        .group-right { right: 20px; top: 50%; transform: translateY(-50%); }
        .group-top { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: row; align-items: center; }

        .hud-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.2s;
            user-select: none;
            text-align: center;
            min-width: 80px;
        }

        .hud-btn:active { background: rgba(255, 255, 255, 0.3); transform: scale(0.95); }
        .btn-home { border-color: #007bff; color: #80bfff; }
        .btn-guest { border-color: #dc3545; color: #ff808f; }
        .btn-clock { border-color: #28a745; color: #80ff9f; font-family: monospace; font-size: 1.5rem; }
        
        .btn-rec {
            background: #cc0000; border: 2px solid white; color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
        }
        
        .rec-active { background: white; color: red; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        /* --- STARTUP SCREEN --- */
        #startup-modal {
            position: fixed; z-index: 100; background: #111; padding: 30px;
            border-radius: 15px; text-align: center; border: 1px solid #444;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            max-width: 90%;
        }
        .modal-btn {
            background: #007bff; color: white; border: none; padding: 15px 20px;
            margin: 10px; font-size: 1.1rem; border-radius: 8px; cursor: pointer; display: block; width: 100%;
        }
        .btn-green { background: #28a745; }

        #raw-video { display: none; }
    </style>
</head>
<body>

    <div id="startup-modal">
        <h2>Pro Court Cam</h2>
        <p style="color:#aaa; font-size:0.9rem">Turn phone sideways</p>
        
        <button class="modal-btn btn-green" onclick="goFullscreenAndStart(1280, 720)">Start HD (Fullscreen)</button>
        <button class="modal-btn" onclick="goFullscreenAndStart(1920, 1080)">Start Full HD (Fullscreen)</button>
    </div>

    <div id="stage">
        <canvas id="gameCanvas"></canvas>

        <div id="ui-layer">
            <div class="control-group group-top">
                <button class="hud-btn btn-clock" id="btn-clock" onclick="toggleTimer()">10:00</button>
                <div style="width: 20px;"></div>
                <button class="hud-btn btn-rec" id="btn-rec" onclick="toggleRecording()">REC</button>
                <div style="width: 20px;"></div>
                <button class="hud-btn" style="font-size: 0.8rem; padding: 10px;" onclick="nextPeriod()">PER 1</button>
            </div>

            <div class="control-group group-left">
                <div style="text-align:center; font-weight:bold; margin-bottom:5px; color:#007bff;">HOME</div>
                <button class="hud-btn btn-home" onclick="updateScore('home', 1)">+1</button>
                <button class="hud-btn btn-home" onclick="updateScore('home', 2)">+2</button>
                <button class="hud-btn btn-home" onclick="updateScore('home', 3)">+3</button>
                <button class="hud-btn btn-home" style="font-size:0.9rem; opacity:0.7" onclick="updateScore('home', -1)">-1</button>
            </div>

            <div class="control-group group-right">
                <div style="text-align:center; font-weight:bold; margin-bottom:5px; color:#dc3545;">GUEST</div>
                <button class="hud-btn btn-guest" onclick="updateScore('guest', 1)">+1</button>
                <button class="hud-btn btn-guest" onclick="updateScore('guest', 2)">+2</button>
                <button class="hud-btn btn-guest" onclick="updateScore('guest', 3)">+3</button>
                <button class="hud-btn btn-guest" style="font-size:0.9rem; opacity:0.7" onclick="updateScore('guest', -1)">-1</button>
            </div>
        </div>
    </div>

    <video id="raw-video" autoplay muted playsinline></video>

    <script>
        let homeScore = 0, guestScore = 0, timeLeft = 600, period = 1;
        let isTimerRunning = false, timerInterval = null;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('raw-video');
        const uiLayer = document.getElementById('ui-layer');
        const clockBtn = document.getElementById('btn-clock');

        // --- NEW STARTUP SEQUENCE ---
        async function goFullscreenAndStart(w, h) {
            // 1. Try to force fullscreen mode
            const elem = document.documentElement;
            try {
                if (elem.requestFullscreen) {
                    await elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    await elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    await elem.msRequestFullscreen();
                }
            } catch (err) {
                console.log("Fullscreen denied (user interaction required first)");
            }

            // 2. Start Camera
            startApp(w, h);
        }

        async function startApp(w, h) {
            document.getElementById('startup-modal').style.display = 'none';
            canvas.width = w; canvas.height = h;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: w }, height: { ideal: h } }, 
                    audio: true 
                });
                video.srcObject = stream;
                video.play();
                uiLayer.style.display = 'block';
                drawLoop();
            } catch (err) { alert("Camera Error: " + err.message); }
        }

        function drawLoop() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const H = canvas.height; const W = canvas.width;
            const barHeight = H * 0.15;
            const barY = H - barHeight - (H * 0.05);
            const barMargin = W * 0.1;
            const barWidth = W - (barMargin * 2);

            // Bar
            ctx.fillStyle = "rgba(0, 0, 0, 0.75)";
            ctx.fillRect(barMargin, barY, barWidth, barHeight);
            ctx.strokeStyle = "#c9a050"; ctx.lineWidth = 4;
            ctx.strokeRect(barMargin, barY, barWidth, barHeight);

            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            const centerY = barY + (barHeight / 2);

            // Scores
            ctx.fillStyle = "#3399ff"; ctx.font = "bold " + (H*0.04) + "px Arial";
            ctx.fillText("HOME", barMargin + (barWidth * 0.15), centerY - (barHeight*0.2));
            ctx.fillStyle = "white"; ctx.font = "bold " + (H*0.08) + "px Arial Black";
            ctx.fillText(homeScore, barMargin + (barWidth * 0.15), centerY + (barHeight*0.2));

            ctx.fillStyle = "#ff5050"; ctx.font = "bold " + (H*0.04) + "px Arial";
            ctx.fillText("GUEST", barMargin + (barWidth * 0.85), centerY - (barHeight*0.2));
            ctx.fillStyle = "white"; ctx.font = "bold " + (H*0.08) + "px Arial Black";
            ctx.fillText(guestScore, barMargin + (barWidth * 0.85), centerY + (barHeight*0.2));

            // Clock
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            let timeStr = `${m}:${s<10?'0'+s:s}`;
            ctx.fillStyle = "#00ff00"; ctx.font = "bold " + (H*0.09) + "px Courier New";
            ctx.fillText(timeStr, W/2, centerY - (barHeight*0.1));

            // Period
            ctx.fillStyle = "#cccccc"; ctx.font = "bold " + (H*0.03) + "px Arial";
            let suffix = period === 1 ? "ST" : period === 2 ? "ND" : period === 3 ? "RD" : "TH";
            ctx.fillText(period + suffix + " QTR", W/2, centerY + (barHeight*0.3));

            // Watermark
            ctx.save();
            ctx.fillStyle = "rgba(255, 255, 255, 0.25)";
            ctx.font = "bold " + (H*0.05) + "px Arial";
            ctx.textAlign = "right"; ctx.textBaseline = "bottom";
            ctx.fillText("TIU", W - (W*0.02), H - (H*0.02));
            ctx.restore();

            requestAnimationFrame(drawLoop);
        }

        // Logic
        clockBtn.addEventListener('dblclick', () => {
             if(isTimerRunning) toggleTimer();
             let val = prompt("Enter Time:\n(e.g. ':45' or '2:00' or '10')");
             if (val) {
                if (val.includes(":")) {
                    let parts = val.split(":");
                    let m = parts[0] === "" ? 0 : parseInt(parts[0]);
                    let s = parseInt(parts[1]);
                    if (!isNaN(m) && !isNaN(s)) timeLeft = (m * 60) + s;
                } else {
                    let m = parseInt(val);
                    if (!isNaN(m)) timeLeft = m * 60;
                }
                updateClockBtn();
             }
        });

        function updateClockBtn() {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            clockBtn.innerText = `${m}:${s<10?'0'+s:s}`;
        }
        function updateScore(team, amt) {
            if(team === 'home') homeScore += amt; else guestScore += amt;
            if(homeScore < 0) homeScore = 0; if(guestScore < 0) guestScore = 0;
        }
        function toggleTimer() {
            if(isTimerRunning) {
                clearInterval(timerInterval); isTimerRunning = false;
                clockBtn.style.borderColor = "#28a745"; clockBtn.style.color = "#80ff9f";
            } else {
                isTimerRunning = true;
                clockBtn.style.borderColor = "#ff3333"; clockBtn.style.color = "white";
                timerInterval = setInterval(() => {
                    if(timeLeft > 0) { timeLeft--; updateClockBtn(); } 
                    else toggleTimer();
                }, 1000);
            }
        }
        function nextPeriod() { period++; if(period > 4) period = 1; }

        let mediaRecorder, chunks = [], isRecording = false;
        function toggleRecording() {
            const btn = document.getElementById('btn-rec');
            if(!isRecording) {
                const stream = canvas.captureStream(30);
                const audioTracks = video.srcObject.getAudioTracks();
                if(audioTracks.length > 0) stream.addTrack(audioTracks[0]);
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
                mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none'; a.href = url;
                    a.download = `Game_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.webm`;
                    document.body.appendChild(a); a.click();
                    setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
                    chunks = [];
                };
                mediaRecorder.start();
                isRecording = true;
                btn.classList.add('rec-active'); btn.innerText = "STOP";
            } else {
                mediaRecorder.stop(); isRecording = false;
                btn.classList.remove('rec-active'); btn.innerText = "REC";
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIU AI Jeopardy - P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --jeopardy-blue: #060CE9;
            --jeopardy-dark: #010a3d;
            --jeopardy-gold: #D69F4C;
            --text-shadow: 2px 2px 0px #000;
        }

        body {
            background-color: var(--jeopardy-dark);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- TIU WATERMARK --- */
        #tiu-watermark {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 5rem;
            color: white;
            opacity: 0.08; /* Subtle */
            pointer-events: none;
            z-index: 0;
            transform: rotate(-10deg);
        }

        /* --- CONNECTION SCREENS --- */
        #connection-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--jeopardy-dark);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .conn-box {
            background: var(--jeopardy-blue);
            border: 4px solid var(--jeopardy-gold);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .conn-box h1 { margin-top: 0; text-shadow: 2px 2px 0 #000; }
        .conn-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            background: white;
            border: none;
            border-radius: 5px;
            transition: 0.2s;
        }
        .conn-btn:hover { background: var(--jeopardy-gold); }

        #id-display {
            font-family: monospace;
            font-size: 2rem;
            color: var(--jeopardy-gold);
            margin: 20px 0;
            border: 2px dashed #666;
            padding: 10px;
            background: rgba(0,0,0,0.3);
        }

        input#remote-id-input {
            width: 100%;
            padding: 10px;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 10px;
            box-sizing: border-box; 
        }

        /* --- CONFIG SCREEN --- */
        #config-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .config-box {
            background: var(--jeopardy-blue);
            padding: 20px;
            border: 4px solid var(--jeopardy-gold);
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .config-section {
            border: 1px solid rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
        }
        .config-section h3 { margin: 0 0 10px 0; color: var(--jeopardy-gold); }

        /* Mode Switcher */
        .mode-switch {
            display: flex; gap: 10px; margin-bottom: 10px;
            justify-content: center;
        }
        .mode-btn {
            padding: 10px 15px; border: none; background: #333; color: #aaa;
            cursor: pointer; border-radius: 5px; font-weight: bold;
        }
        .mode-btn.active { background: var(--jeopardy-gold); color: #000; }

        .input-section { display: none; flex-direction: column; align-items: center; }
        .input-section.active { display: flex; }

        select, textarea {
            padding: 10px; width: 90%; font-size: 1rem; margin: 5px 0;
            border-radius: 5px;
        }
        textarea { height: 100px; background: #000; color: #0f0; font-family: monospace; }

        /* Team Manager inside Config */
        #team-config-list {
            display: flex; flex-direction: column; gap: 5px;
            max-height: 150px; overflow-y: auto;
        }
        .team-config-row {
            display: flex; gap: 5px;
        }
        .team-config-row input {
            flex-grow: 1; padding: 5px;
        }
        .btn-small {
            padding: 5px 10px; cursor: pointer; font-weight: bold; border: none; border-radius: 3px;
        }
        .btn-add { background: #4caf50; color: white; margin-top: 5px;}
        .btn-del { background: #f44336; color: white; }


        button.start-btn {
            padding: 15px 40px; font-size: 1.5rem; margin-top: 10px;
            border-radius: 50px; border: 3px solid white;
            background-color: var(--jeopardy-gold); color: var(--jeopardy-dark);
            font-weight: bold; cursor: pointer;
        }

        /* --- GAME BOARD --- */
        #game-board {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: auto repeat(5, 1fr);
            gap: 6px;
            padding: 10px;
            flex-grow: 1;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .category-header {
            background-color: var(--jeopardy-blue);
            color: white;
            font-weight: bold;
            text-align: center;
            display: flex; align-items: center; justify-content: center;
            text-transform: uppercase; padding: 5px;
            border: 2px solid black; text-shadow: var(--text-shadow);
            font-size: clamp(0.7rem, 1.1vw, 1.3rem);
            word-wrap: break-word; min-height: 50px;
        }

        .clue-card {
            background-color: var(--jeopardy-blue);
            color: var(--jeopardy-gold);
            font-size: clamp(1.5rem, 3vw, 3rem);
            font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid black;
            text-shadow: var(--text-shadow); transition: background 0.2s;
        }
        .clue-card:hover { background-color: #2b32ff; }
        .clue-card.disabled {
            color: transparent; background-color: #030675;
            cursor: default; pointer-events: none; border-color: #030675;
        }

        /* --- SCOREBOARD --- */
        #scoreboard {
            background: #000; padding: 10px; display: flex;
            justify-content: center; gap: 10px; z-index: 2;
            border-top: 3px solid var(--jeopardy-gold);
            overflow-x: auto;
        }
        .team {
            text-align: center; background: var(--jeopardy-dark);
            padding: 5px; border: 2px solid var(--jeopardy-blue);
            border-radius: 8px; 
            flex: 1; /* Dynamic width */
            min-width: 120px;
            max-width: 250px;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .team-name { 
            color: white; border-bottom: 1px solid #444; 
            display: block; padding-bottom: 3px; 
            min-height: 20px;
        }
        .score-display {
            font-size: 1.5rem; color: var(--jeopardy-gold); font-family: monospace; font-weight: bold; margin: 5px 0;
        }
        /* Controls are hidden on display, visible on controller */
        .score-controls { display: none; justify-content: center; gap: 5px; }
        .score-controls button {
            background: #333; color: white; width: 30px; height: 30px; font-weight: bold; cursor: pointer; border: 1px solid #555;
        }
        .score-controls button.plus:hover { background: #4caf50; }
        .score-controls button.minus:hover { background: #f44336; }

        /* --- MODAL --- */
        #question-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--jeopardy-blue); z-index: 50;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; padding: 30px; box-sizing: border-box;
        }
        #modal-content {
            font-size: clamp(1.5rem, 4vw, 3.5rem); font-weight: bold; color: white;
            text-shadow: var(--text-shadow); text-transform: uppercase; line-height: 1.3;
        }
        #modal-answer {
            font-size: clamp(1.2rem, 3vw, 2.5rem); color: var(--jeopardy-gold);
            margin-top: 30px; display: none; font-weight: bold;
            border-top: 2px solid rgba(255,255,255,0.3); padding-top: 20px;
        }
        .modal-controls { margin-top: 40px; display: none; gap: 15px; flex-wrap: wrap; justify-content: center;}
        .modal-btn {
            padding: 15px 30px; font-size: 1.2rem; border: 3px solid white;
            background: var(--jeopardy-dark); color: white; cursor: pointer;
            text-transform: uppercase; font-weight: bold; border-radius: 50px;
        }
        .modal-btn.reveal { background: var(--jeopardy-gold); color: black; }
        .modal-btn.close { background: #b00; }

        /* --- CONTROLLER SPECIFIC STYLES --- */
        body.is-controller .score-controls { display: flex; }
        body.is-controller .modal-controls { display: flex; }
        body.is-controller #game-board { opacity: 0.8; }
        body.is-controller #question-modal { background: rgba(0,0,0,0.9); }
        body.is-controller #modal-answer { display: block; color: #888; font-size: 1rem; } /* Preview answer */
        body.is-controller #modal-answer.revealed { color: var(--jeopardy-gold); font-size: 2rem; }

        .role-badge {
            position: fixed; top: 10px; right: 10px;
            background: #fff; color: #000; padding: 5px 10px;
            font-weight: bold; z-index: 3000; border-radius: 5px; font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <div id="tiu-watermark">TIU</div>
    <div id="role-display" class="role-badge" style="display:none;"></div>

    <div id="connection-overlay">
        <div class="conn-box" id="step-1">
            <h1>TIU JEOPARDY</h1>
            <p>Select your role:</p>
            <button class="conn-btn" onclick="initHost()">HOST BOARD (Display)</button>
            <button class="conn-btn" onclick="showJoinInput()">JOIN REMOTE (Phone)</button>
            <p style="font-size:0.8rem; opacity:0.7; margin-top:20px;">Ensure audio is enabled.</p>
        </div>

        <div class="conn-box" id="step-host" style="display:none;">
            <h2>Waiting for Controller...</h2>
            <p>Enter this ID on your phone:</p>
            <div id="id-display">Generating...</div>
            <p style="font-size: 0.9rem; color: #ccc;">(Do not close this window)</p>
        </div>

        <div class="conn-box" id="step-join" style="display:none;">
            <h2>Connect to Board</h2>
            <input type="text" id="remote-id-input" placeholder="Enter Game ID">
            <button class="conn-btn" onclick="connectToHost()">CONNECT</button>
            <button class="conn-btn" style="background:#444; color:white;" onclick="location.reload()">Back</button>
        </div>
    </div>

    <div id="config-modal">
        <div class="config-box">
            <h1>GAME SETUP</h1>
            
            <div class="config-section">
                <h3>1. Select Content</h3>
                <div class="mode-switch">
                    <button class="mode-btn active" id="btn-preset" onclick="setMode('preset')">Presets</button>
                    <button class="mode-btn" id="btn-custom" onclick="setMode('custom')">Custom JSON</button>
                </div>
                <div id="section-preset" class="input-section active">
                    <select id="grade-select">
                        <option value="K">Kindergarten - 1st Grade</option>
                        <option value="2-3">2nd - 3rd Grade</option>
                        <option value="4-5">4th - 5th Grade</option>
                        <option value="6-8">Middle School</option>
                        <option value="HS">High School / Adult</option>
                    </select>
                </div>
                <div id="section-custom" class="input-section">
                    <textarea id="custom-json-input" placeholder='{"Category": [{"q":"?", "a":"!"}]...}'></textarea>
                    <button class="btn-small" style="background:#666; color:white;" onclick="loadTemplate()">Load Template</button>
                </div>
            </div>

            <div class="config-section">
                <h3>2. Setup Teams</h3>
                <div id="team-config-list">
                    </div>
                <button class="btn-small btn-add" onclick="addTeamConfigRow()">+ Add Team</button>
            </div>

            <button class="start-btn" onclick="startGame()">START GAME</button>
        </div>
    </div>

    <div id="game-board"></div>

    <div id="scoreboard">
        </div>

    <div id="question-modal">
        <div id="modal-content">Question...</div>
        <div id="modal-answer">Answer...</div>
        <div class="modal-controls">
            <button class="modal-btn reveal" onclick="triggerReveal()">REVEAL ANSWER</button>
            <button class="modal-btn close" onclick="triggerClose()">CLOSE QUESTION</button>
        </div>
    </div>

    <script>
        // --- AUDIO ENGINE (Web Audio API) ---
        const AudioEngine = {
            ctx: null,
            init: function() {
                if(!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(freq, type, duration, vol=0.5) {
                if(!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            play: function(soundName) {
                switch(soundName) {
                    case 'ding': 
                        this.playTone(880, 'sine', 1.0, 0.3); // High ping
                        setTimeout(() => this.playTone(1760, 'sine', 0.8, 0.1), 100); 
                        break;
                    case 'buzz': 
                        this.playTone(150, 'sawtooth', 0.5, 0.4); // Low buzz
                        break;
                    case 'pop':
                        this.playTone(600, 'sine', 0.1, 0.2); // Short blip
                        break;
                    case 'chime':
                        this.playTone(440, 'triangle', 1.5, 0.2);
                        setTimeout(() => this.playTone(554, 'triangle', 1.5, 0.2), 100); 
                        setTimeout(() => this.playTone(659, 'triangle', 2.0, 0.2), 200); 
                        break;
                }
            }
        };

        // --- DATABASE ---
        const database = {
            "K": {
                "Animals": [{q: "Says Moo", a: "Cow"}, {q: "Has a trunk", a: "Elephant"}, {q: "King of Jungle", a: "Lion"}, {q: "Gives wool", a: "Sheep"}, {q: "Hops", a: "Kangaroo"}],
                "Colors": [{q: "Sky color", a: "Blue"}, {q: "Grass color", a: "Green"}, {q: "Banana color", a: "Yellow"}, {q: "Firetruck color", a: "Red"}, {q: "Red + Blue", a: "Purple"}],
                "Shapes": [{q: "3 sides", a: "Triangle"}, {q: "No corners", a: "Circle"}, {q: "4 equal sides", a: "Square"}, {q: "Stop sign", a: "Octagon"}, {q: "5 points", a: "Star"}],
                "Counting": [{q: "Fingers on 1 hand", a: "5"}, {q: "After 9", a: "10"}, {q: "Tricycle wheels", a: "3"}, {q: "1 + 1", a: "2"}, {q: "Spider legs", a: "8"}],
                "Body": [{q: "For seeing", a: "Eyes"}, {q: "For smelling", a: "Nose"}, {q: "For hearing", a: "Ears"}, {q: "Wear shoes on", a: "Feet"}, {q: "Beats in chest", a: "Heart"}],
                "Food": [{q: "Bees make it", a: "Honey"}, {q: "White drink", a: "Milk"}, {q: "Red fruit", a: "Apple"}, {q: "Rabbits eat it", a: "Carrot"}, {q: "Yellow sour fruit", a: "Lemon"}]
            },
            "2-3": {
                "Math": [{q: "10 + 10", a: "20"}, {q: "5 x 5", a: "25"}, {q: "100 - 50", a: "50"}, {q: "Cents in Quarter", a: "25"}, {q: "3 x 4", a: "12"}],
                "Space": [{q: "Our Planet", a: "Earth"}, {q: "Center star", a: "Sun"}, {q: "Red Planet", a: "Mars"}, {q: "Earth's moons", a: "1"}, {q: "Largest planet", a: "Jupiter"}],
                "Time": [{q: "Seconds in minute", a: "60"}, {q: "Days in week", a: "7"}, {q: "Months in year", a: "12"}, {q: "Hours in day", a: "24"}, {q: "Half hour mins", a: "30"}],
                "Grammar": [{q: "Person/Place/Thing", a: "Noun"}, {q: "Action word", a: "Verb"}, {q: "Opposite of Up", a: "Down"}, {q: "Describes noun", a: "Adjective"}, {q: "End of question", a: "?"}],
                "Geo": [{q: "Large salt water", a: "Ocean"}, {q: "Opposite North", a: "South"}, {q: "Lava mountain", a: "Volcano"}, {q: "Coldest place", a: "Antarctica"}, {q: "Water all sides", a: "Island"}],
                "Cartoons": [{q: "SpongeBob lives in", a: "Pineapple"}, {q: "Mouse red shorts", a: "Mickey"}, {q: "Lost slipper", a: "Cinderella"}, {q: "Scooby-...", a: "Doo"}, {q: "Buzz's friend", a: "Woody"}]
            },
            "4-5": {
                "Science": [{q: "H2O", a: "Water"}, {q: "Force down", a: "Gravity"}, {q: "Meat eaters", a: "Carnivores"}, {q: "Boiling point", a: "100C / 212F"}, {q: "Breathe gas", a: "Oxygen"}],
                "States": [{q: "Largest state", a: "Alaska"}, {q: "Disney World state", a: "Florida"}, {q: "Big Apple", a: "New York"}, {q: "Island state", a: "Hawaii"}, {q: "Lone Star", a: "Texas"}],
                "Math": [{q: "8 x 8", a: "64"}, {q: "9 x 3", a: "27"}, {q: "12 x 12", a: "144"}, {q: "5 x 20", a: "100"}, {q: "7 x 6", a: "42"}],
                "Books": [{q: "Harry Potter author", a: "Rowling"}, {q: "Pig in Web", a: "Wilbur"}, {q: "Cat in the...", a: "Hat"}, {q: "Wooden boy", a: "Pinocchio"}, {q: "Wimpy Kid", a: "Greg"}],
                "History": [{q: "1st President", a: "Washington"}, {q: "Pilgrim ship", a: "Mayflower"}, {q: "Civil War Pres", a: "Lincoln"}, {q: "1776 Doc", a: "Declaration"}, {q: "Bus seat lady", a: "Rosa Parks"}],
                "Pop": [{q: "Block game", a: "Minecraft"}, {q: "Elsa movie", a: "Frozen"}, {q: "Wall climber", a: "Spider-Man"}, {q: "Yellow Pokemon", a: "Pikachu"}, {q: "Fast hedgehog", a: "Sonic"}]
            },
            "6-8": {
                "Algebra": [{q: "2x = 10", a: "5"}, {q: "x + 15 = 30", a: "15"}, {q: "3x + 1 = 10", a: "3"}, {q: "5 squared", a: "25"}, {q: "Sqrt 81", a: "9"}],
                "Ancient": [{q: "Pyramid builders", a: "Egyptians"}, {q: "Roman ruler", a: "Caesar"}, {q: "Greek city", a: "Athens"}, {q: "Egypt River", a: "Nile"}, {q: "Viking origin", a: "Scandinavia"}],
                "Earth": [{q: "Molten rock", a: "Magma"}, {q: "Gas layer", a: "Atmosphere"}, {q: "Hardest mineral", a: "Diamond"}, {q: "Weather study", a: "Meteorology"}, {q: "Quake wave", a: "Tsunami"}],
                "Lit": [{q: "Hobbit author", a: "Tolkien"}, {q: "Katniss series", a: "Hunger Games"}, {q: "14 line poem", a: "Sonnet"}, {q: "Scrooge author", a: "Dickens"}, {q: "Percy's dad", a: "Poseidon"}],
                "General": [{q: "Japan money", a: "Yen"}, {q: "Largest mammal", a: "Blue Whale"}, {q: "Bones in body", a: "206"}, {q: "England capital", a: "London"}, {q: "Tennis event", a: "Wimbledon"}],
                "Tech": [{q: "RAM", a: "Random Access Memory"}, {q: "iPhone creator", a: "Jobs"}, {q: "Computer brain", a: "CPU"}, {q: "Ghost logo app", a: "Snapchat"}, {q: "Windows owner", a: "Microsoft"}]
            },
            "HS": {
                "Chem": [{q: "Gold symbol", a: "Au"}, {q: "Carbon atomic #", a: "6"}, {q: "pH neutral", a: "7"}, {q: "Potassium symbol", a: "K"}, {q: "Periodic table guy", a: "Mendeleev"}],
                "History": [{q: "Start WWI", a: "1914"}, {q: "Soviet WWII leader", a: "Stalin"}, {q: "1989 Wall", a: "Berlin"}, {q: "Waterloo loser", a: "Napoleon"}, {q: "Machu Picchu", a: "Incas"}],
                "Lit": [{q: "1984 Author", a: "Orwell"}, {q: "To be or not", a: "Hamlet"}, {q: "Gatsby Author", a: "Fitzgerald"}, {q: "Austen book", a: "Pride & Prejudice"}, {q: "White whale", a: "Moby Dick"}],
                "Bio": [{q: "Cell powerhouse", a: "Mitochondria"}, {q: "Plant food process", a: "Photosynthesis"}, {q: "DNA", a: "Deoxyribonucleic acid"}, {q: "Largest organ", a: "Skin"}, {q: "Evolution guy", a: "Darwin"}],
                "Movies": [{q: "Avatar Director", a: "Cameron"}, {q: "Korean Best Pic", a: "Parasite"}, {q: "Iron Man actor", a: "Downey Jr"}, {q: "Star Wars villain", a: "Vader"}, {q: "Toy movie", a: "Toy Story"}],
                "Physics": [{q: "E = mc^2", a: "Einstein"}, {q: "F = ma", a: "Newton"}, {q: "Light vs Sound", a: "Light faster"}, {q: "Resistance unit", a: "Ohm"}, {q: "Motion energy", a: "Kinetic"}]
            }
        };

        // --- GLOBAL STATE ---
        let peer = null;
        let conn = null;
        let role = null; // 'HOST' or 'CONTROLLER'
        let setupMode = 'preset';
        
        // Dynamic Teams State
        let teams = [
            { id: 1, name: "Team 1", score: 0 },
            { id: 2, name: "Team 2", score: 0 },
            { id: 3, name: "Team 3", score: 0 }
        ];

        // --- P2P CONNECTION LOGIC ---

        function initHost() {
            role = 'HOST';
            AudioEngine.init(); // Init audio context
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-host').style.display = 'block';
            document.getElementById('role-display').innerText = "DISPLAY BOARD";
            document.getElementById('role-display').style.display = 'block';

            peer = new Peer(generateShortId(), { debug: 1 });
            peer.on('open', (id) => {
                document.getElementById('id-display').innerText = id;
            });
            peer.on('connection', (c) => {
                conn = c;
                setupConnectionHandlers();
                document.getElementById('connection-overlay').style.display = 'none';
            });
        }

        function showJoinInput() {
            AudioEngine.init();
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-join').style.display = 'block';
        }

        function connectToHost() {
            const remoteId = document.getElementById('remote-id-input').value.trim();
            if(!remoteId) return alert("Enter an ID");

            role = 'CONTROLLER';
            document.body.classList.add('is-controller');
            document.getElementById('role-display').innerText = "CONTROLLER";
            document.getElementById('role-display').style.display = 'block';

            peer = new Peer(); 
            peer.on('open', () => {
                conn = peer.connect(remoteId);
                conn.on('open', () => {
                    document.getElementById('connection-overlay').style.display = 'none';
                    document.getElementById('config-modal').style.display = 'flex';
                    setupConnectionHandlers();
                    initTeamConfigUI(); // Show default teams in config
                });
                conn.on('error', (err) => alert("Connection failed: " + err));
            });
        }

        function generateShortId() {
            const adjs = ["red","blue","fast","big","cool","hot","tiu"];
            const nouns = ["cat","dog","fox","bear","lion","wolf"];
            const r = (arr) => arr[Math.floor(Math.random()*arr.length)];
            return `${r(adjs)}-${r(nouns)}-${Math.floor(Math.random()*99)}`;
        }

        function setupConnectionHandlers() {
            conn.on('data', (data) => {
                handleDataPacket(data);
            });
        }

        function sendData(type, payload) {
            if (conn && conn.open) {
                conn.send({ type, payload });
            }
        }

        // --- DATA HANDLING ---

        function handleDataPacket(data) {
            console.log("Received:", data);
            switch(data.type) {
                case 'INIT_GAME':
                    // Payload contains { board: ..., teams: ... }
                    teams = data.payload.teams;
                    renderScoreboard();
                    buildBoard(data.payload.board);
                    AudioEngine.play('chime');
                    break;
                case 'OPEN_MODAL':
                    showQuestionModal(data.payload.q, data.payload.a, false);
                    AudioEngine.play('pop');
                    break;
                case 'REVEAL_ANSWER':
                    document.getElementById('modal-answer').style.display = 'block';
                    AudioEngine.play('ding');
                    break;
                case 'CLOSE_MODAL':
                    closeModal(data.payload.tileId);
                    break;
                case 'UPDATE_TEAMS':
                    teams = data.payload;
                    renderScoreboard();
                    break;
                case 'PLAY_SOUND':
                    AudioEngine.play(data.payload);
                    break;
            }
        }

        // --- CONFIG UI LOGIC (Controller Only) ---

        function setMode(m) {
            setupMode = m;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${m}`).classList.add('active');
            document.querySelectorAll('.input-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`section-${m}`).classList.add('active');
        }

        // --- TEAM CONFIGURATION ---
        
        function initTeamConfigUI() {
            renderTeamConfigList();
        }

        function renderTeamConfigList() {
            const list = document.getElementById('team-config-list');
            list.innerHTML = '';
            teams.forEach((t, index) => {
                const row = document.createElement('div');
                row.className = 'team-config-row';
                row.innerHTML = `
                    <input type="text" value="${t.name}" oninput="updateConfigTeamName(${index}, this.value)">
                    <button class="btn-small btn-del" onclick="removeTeam(${index})">X</button>
                `;
                list.appendChild(row);
            });
        }

        function addTeamConfigRow() {
            const nextId = teams.length > 0 ? Math.max(...teams.map(t=>t.id)) + 1 : 1;
            teams.push({ id: nextId, name: `Team ${teams.length + 1}`, score: 0 });
            renderTeamConfigList();
        }

        function removeTeam(index) {
            teams.splice(index, 1);
            renderTeamConfigList();
        }

        function updateConfigTeamName(index, val) {
            teams[index].name = val;
        }

        function loadTemplate() {
            const t = {"Cat 1": [{q:"Q1", a:"A1"}], "Cat 2": [{q:"Q1", a:"A1"}]};
            document.getElementById('custom-json-input').value = JSON.stringify(t, null, 2);
        }

        function startGame() {
            let gameData = {};
            if (setupMode === 'preset') {
                const grade = document.getElementById('grade-select').value;
                gameData = database[grade] || database['HS'];
            } else {
                try {
                    gameData = JSON.parse(document.getElementById('custom-json-input').value);
                } catch(e) { return alert("Invalid JSON"); }
            }

            // Build local
            renderScoreboard();
            buildBoard(gameData);
            document.getElementById('config-modal').style.display = 'none';

            // Send Init to Host (Board + Teams)
            sendData('INIT_GAME', { board: gameData, teams: teams });
        }

        // --- GAME LOGIC ---

        function buildBoard(dataObj) {
            const board = document.getElementById('game-board');
            board.innerHTML = ''; 

            let cats = Object.keys(dataObj).slice(0, 6);
            while(cats.length < 6) cats.push("Empty");

            cats.forEach(c => {
                let div = document.createElement('div');
                div.className = 'category-header';
                div.innerText = c;
                board.appendChild(div);
            });

            for(let r=0; r<5; r++) {
                for(let c=0; c<6; c++) {
                    const catName = cats[c];
                    const qList = dataObj[catName] || [];
                    const qObj = qList[r] || {q:"Bonus", a:"Free"};
                    
                    const val = (r+1)*100;
                    const tile = document.createElement('div');
                    tile.className = 'clue-card';
                    tile.innerText = `$${val}`;
                    tile.id = `tile-${r}-${c}`;
                    tile.dataset.q = qObj.q;
                    tile.dataset.a = qObj.a;
                    
                    tile.onclick = () => handleTileClick(tile);
                    board.appendChild(tile);
                }
            }
        }

        let currentTileId = null;

        function handleTileClick(tile) {
            if(tile.classList.contains('disabled')) return;
            
            if(role === 'CONTROLLER') {
                currentTileId = tile.id;
                showQuestionModal(tile.dataset.q, tile.dataset.a, true); 
                sendData('OPEN_MODAL', { q: tile.dataset.q, a: tile.dataset.a });
                AudioEngine.play('pop');
            } 
        }

        function showQuestionModal(q, a, isController) {
            const m = document.getElementById('question-modal');
            document.getElementById('modal-content').innerText = q;
            const ansDiv = document.getElementById('modal-answer');
            ansDiv.innerText = a;
            ansDiv.className = ''; 
            
            if(isController) {
                ansDiv.style.display = 'block'; 
            } else {
                ansDiv.style.display = 'none';
            }
            m.style.display = 'flex';
        }

        function triggerReveal() {
            const ansDiv = document.getElementById('modal-answer');
            ansDiv.classList.add('revealed');
            sendData('REVEAL_ANSWER', {});
            AudioEngine.play('ding');
        }

        function triggerClose() {
            closeModal(currentTileId);
            sendData('CLOSE_MODAL', { tileId: currentTileId });
        }

        function closeModal(tileId) {
            document.getElementById('question-modal').style.display = 'none';
            if(tileId) {
                const t = document.getElementById(tileId);
                if(t) {
                    t.classList.add('disabled');
                    t.innerText = '';
                    t.style.backgroundColor = '#030675';
                }
            }
        }

        // --- SCORING & DYNAMIC TEAMS ---

        function renderScoreboard() {
            const board = document.getElementById('scoreboard');
            board.innerHTML = '';
            
            teams.forEach((team, index) => {
                const div = document.createElement('div');
                div.className = 'team';
                
                const name = document.createElement('span');
                name.className = 'team-name';
                name.contentEditable = (role === 'CONTROLLER'); // Allow live edit
                name.innerText = team.name;
                name.oninput = (e) => handleLiveNameChange(index, e.target.innerText);

                const score = document.createElement('div');
                score.className = 'score-display';
                score.innerText = team.score;

                div.appendChild(name);
                div.appendChild(score);

                // Add controls if controller
                if(role === 'CONTROLLER') {
                    const ctrls = document.createElement('div');
                    ctrls.className = 'score-controls';
                    
                    const btnPlus = document.createElement('button');
                    btnPlus.className = 'plus';
                    btnPlus.innerText = '+';
                    btnPlus.onclick = () => changeScore(index, 100);

                    const btnMinus = document.createElement('button');
                    btnMinus.className = 'minus';
                    btnMinus.innerText = '-';
                    btnMinus.onclick = () => changeScore(index, -100);

                    ctrls.appendChild(btnPlus);
                    ctrls.appendChild(btnMinus);
                    div.appendChild(ctrls);
                }

                board.appendChild(div);
            });
        }

        function changeScore(teamIndex, amount) {
            teams[teamIndex].score += amount;
            renderScoreboard();
            sendData('UPDATE_TEAMS', teams);
            
            // Send sound command
            if(amount > 0) {
                sendData('PLAY_SOUND', 'ding');
                AudioEngine.play('ding');
            } else {
                sendData('PLAY_SOUND', 'buzz');
                AudioEngine.play('buzz');
            }
        }

        function handleLiveNameChange(index, newName) {
            teams[index].name = newName;
            // Debounce could be added here, but direct send is usually fine for text
            sendData('UPDATE_TEAMS', teams);
        }

    </script>
</body>
</html>